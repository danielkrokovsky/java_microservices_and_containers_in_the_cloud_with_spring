<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en">

<head>
  <title>Microservices Integration in Practice</title>
  <link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>

<body>

  <div epub:type="chapter" role="doc-chapter">

    <div class="ChapterContextInformation">

      <div class="ContextInformation" id="b979-8-8688-0555-4_5"><div class="ChapterCopyright">© The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature 2024</div><span class="ContextInformationAuthorEditorNames">B. A. Christudas</span><span class="ContextInformationBookTitles"><span class="BookTitle">Java Microservices and Containers in the Cloud</span></span><span class="ChapterDOI"><a href="https://doi.org/10.1007/979-8-8688-0555-4_5">https://doi.org/10.1007/979-8-8688-0555-4_5</a></span></div>

    </div>

    <!--Begin Abstract-->

    <div class="MainTitleSection">

      <h1 class="ChapterTitle" lang="en">5. Microservices Integration in Practice</h1>

    </div>

    <div class="AuthorGroup">

      <div class="AuthorNames"><span class="Author"><span class="AuthorName">Binildas A. Christudas</span><sup><a href="#Aff2">1</a> <span class="ContactIcon"> </span></sup></span></div>

      <div class="Affiliations">

        <div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">NBCRA 45, Christbin, Thiruvananthapuram, Kerala, India</div></div>

        <div class="ClearBoth"> </div>

      </div>

    </div>

    <!--End Abstract-->

    <div class="Fulltext">

      <p class="Para" id="Par2">You have seen how messaging middleware can play a key role in providing a bridge for microservices to communicate to each other in a loosely coupled manner. You have seen a few hands-on examples. Some engineers are still skeptical about whether they can use events and event paradigms for inter-microservices communication in comparison to the manner they use synchronous REST style. This chapter throws some light onto some of these issues. This chapter is hands on. It’s best if you read Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span> before this chapter, so that you understand the basics of running examples over the event infrastructure. Although, the chapter does provide step-by-step instructions if you want to start with this chapter.</p>

      <div class="Para" id="Par3">The following topics are covered in this chapter:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par4">Scalability schema in the context of microservices</p></li><li><p class="Para" id="Par5">The sync over async challenge</p></li><li><p class="Para" id="Par6">Types of microservices vs. instances of the same types of microservice</p></li><li><p class="Para" id="Par7">Sequential microservice consumers</p></li><li><p class="Para" id="Par8">Parallel microservice consumers</p></li></ul></div></div>

      <section class="Section1 RenderAsSection1" id="Sec1">

        <h2 class="Heading">Microservices Scalability in the Cloud</h2>

        <p class="Para" id="Par9">Thinking in terms of production quality and scalability is indispensable in microservices architecture for today’s operations, especially when public cloud is the norm. There needs to be a paradigm shift in your mindset on how to scale services when you move from the monolith to the microservices architecture. This section quickly reviews some of these aspects, which sets the stage for further discussions and examples in this chapter.</p>

        <section class="Section2 RenderAsSection2" id="Sec2">

          <h3 class="Heading">Vertical Scalability</h3>

          <div class="Para" id="Par10"><span id="ITerm1">Vertical scalability</span> has been practiced traditionally, especially during the monolith architecture days when developers used to increase the core or CPU of the machines hosting the applications. See Figure <span class="InternalRef"><a href="#Fig1">5-1</a></span>.<figure class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img alt="" aria-describedby="d64e202" src="../images/619782_1_En_5_Chapter/Imagem-049.jpg" style="width:29.12em"/><div class="TextObject" id="d64e202"><p class="Para" id="Par125">A diagram presents three transformations of microchips. The first microchip is blank. The second microchip contains the number 8. The third microchip features a lightning symbol.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-1</span><p class="SimplePara">Vertical scalability</p></div></figcaption></figure></div>

          <p class="Para" id="Par11"><span id="ITerm2">Vertically scaling</span><span id="ITerm3"></span> the application is comparatively straightforward, since it doesn’t disrupt existing deployment topology. A “lift and shift” of the existing process to a different host machine with more compute power is a straightforward step. However, to scale applications beyond that limit, vertical scalability doesn’t help, since you will be limited by the comparatively slow rate of advancements happening in the chip and memory technologies.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec3">

          <h3 class="Heading">Horizontal Scalability</h3>

          <div class="Para" id="Par12"><span id="ITerm4">Horizontally scaling</span><span id="ITerm5"></span> (see Figure <span class="InternalRef"><a href="#Fig2">5-2</a></span>) is orthogonal to vertical scaling in that, instead of increasing the capacity of the existing compute or memory modules, you improve the overall compute and\or memory by incorporating more modules.<figure class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img alt="" aria-describedby="d64e242" src="../images/619782_1_En_5_Chapter/Imagem-050.jpg" style="width:22.47em"/><div class="TextObject" id="d64e242"><p class="Para" id="Par126">A diagram depicts three microchips connected to a central horizontal bus line. Each microchip is blank.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-2</span><p class="SimplePara">Horizontal scalability</p></div></figcaption></figure></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec4">

          <h3 class="Heading">Microservices Scalability</h3>

          <p class="Para" id="Par13">Typically, <span id="ITerm6">microservices</span><span id="ITerm7"></span> represents a functional domain or a portion of a functional domain. Just like any application, microservices applications also grow over time. A balance between the size of a single microservice and the number of these microservices is required to affect an efficient operational schema.</p>

          <div class="Para" id="Par14">Just like with vertical scalability, it’s possible to add more functionality to the existing microservice, as shown in Figure <span class="InternalRef"><a href="#Fig3">5-3</a></span>.<figure class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img alt="" aria-describedby="d64e276" src="../images/619782_1_En_5_Chapter/Imagem-051.jpg" style="width:23.1em"/><div class="TextObject" id="d64e276"><p class="Para" id="Par127">An illustration depicts a small hexagon-shaped structure on the left, which is converted to a larger hexagon on the right. A larger hexagon is subdivided into smaller hexagonal sections.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-3</span><p class="SimplePara">Microservices vertical growth</p></div></figcaption></figure></div>

          <div class="Para" id="Par15">Endlessly adding more and more functionality to an existing microservice will transition microservices back to a monolith system. Instead, more microservice types can be added, as shown in Figure <span class="InternalRef"><a href="#Fig4">5-4</a></span>.<figure class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img alt="" aria-describedby="d64e293" src="../images/619782_1_En_5_Chapter/Imagem-052.jpg" style="width:30.35em"/><div class="TextObject" id="d64e293"><p class="Para" id="Par128">A diagram presents a bus topology, with three hexagonal shapes labeled mu S A, mu S B, and mu S C. Mu S A is connected to the left side of the bus. Mu S B is connected to the top of the bus. Mu S C is connected to the right side of the bus.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-4</span><p class="SimplePara">Microservices horizontal growth</p></div></figcaption></figure></div>

          <div class="Para" id="Par16">When you want to address scalability in operations, you also need to address the growing volumes of traffic. This necessitates cloning multiple instances of the microservice and routing traffic in a load-balanced manner, as shown in Figure <span class="InternalRef"><a href="#Fig5">5-5</a></span>.<figure class="Figure" id="Fig5"><div class="MediaObject" id="MO5"><img alt="" aria-describedby="d64e310" src="../images/619782_1_En_5_Chapter/Imagem-053.jpg" style="width:30.32em"/><div class="TextObject" id="d64e310"><p class="Para" id="Par129">A diagram presents a bus topology, with three hexagonal shapes labeled as mu S A, mu S B, and mu S C. Mu S A is connected to the left side of the bus. Mu S B is connected to the top of the bus. Mu S C is connected to the right side of the bus. Each hexagon includes multiple sections.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-5</span><p class="SimplePara">Microservices scale out</p></div></figcaption></figure></div>

          <p class="Para" id="Par17">Routing requests to different types of microservices and distributing the load to multiple instances of the same type of microservice is straightforward in a typical HTTP-based transport, but it’s non-trivial over message-based infrastructure. Let’s investigate that next.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec5">

        <h2 class="Heading">Sync over Async Dynamics</h2>

        <p class="Para" id="Par18">The messaging style of communication is inherently asynchronous, and messaging channels are one way. Both properties, when combined, bring a set of complexities for the developers to handle, especially if they have to mimic <span id="ITerm8">synchronous</span> style, inter-microservice communication over asynchronous natured event channels.</p>

        <section class="Section2 RenderAsSection2" id="Sec6">

          <h3 class="Heading">Publisher Subscriber Combinations</h3>

          <div class="Para" id="Par19">Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span> briefly described the return address pattern in Figure <span class="ExternalRef"><a href="Capítulo-06.html#Fig5"><span class="RefSource">4-5</span></a></span>. When microservices communicate, the same <span id="ITerm9">microservice</span> can send messages to different microservices, and different microservices can send messages to the same microservice. We can generalize this communication pattern, as shown in Figure <span class="InternalRef"><a href="#Fig6">5-6</a></span>.<figure class="Figure" id="Fig6"><div class="MediaObject" id="MO6"><img alt="" aria-describedby="d64e363" src="../images/619782_1_En_5_Chapter/Imagem-054.jpg" style="width:35.15em"/><div class="TextObject" id="d64e363"><p class="Para" id="Par130">A diagram presents how two publishers labeled order mu S and loyalty mu S, emit events into a central message bus. The events are distributed to multiple subscribers, with shipping mu S, dispatch mu S, and notification mu S.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-6</span><p class="SimplePara">Different kinds of microservices communicating</p></div></figcaption></figure></div>

          <p class="Para" id="Par20">Referring again to Figure <span class="ExternalRef"><a href="Capítulo-06.html#Fig5"><span class="RefSource">4-5</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>, each publisher microservice can have its own return address and, in that manner, response messages can be directed to the corresponding sender.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec7">

          <h3 class="Heading">Publisher Subscriber Instance Combinations</h3>

          <p class="Para" id="Par21">When you want to scale out microservices, this introduces more complexity if you need to send synchronous styled communications over an async channel.</p>

          <div class="Para" id="Par22">If you have multiple <span id="ITerm10">instances</span> of the same microservice, you must make sure that the reply is sent to the correct microservice instance. The Spring Kafka documentation suggests that each consumer use a unique reply topic so that <span id="ITerm11">reply messages</span> are not interchanged.<figure class="Figure" id="Fig7"><div class="MediaObject" id="MO7"><img alt="" aria-describedby="d64e420" src="../images/619782_1_En_5_Chapter/Imagem-055.jpg" style="width:35.15em"/><div class="TextObject" id="d64e420"><p class="Para" id="Par131">A diagram represents a request-reply interaction model between microservices. It involves multiple requestor and replier components communicating via various channels. These channels correspond to the instances of the requestor that initiated the original request.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-7</span><p class="SimplePara">Different reply <span id="ITerm12">channels</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par23">Figure <span class="InternalRef"><a href="#Fig7">5-7</a></span> depicts each consumer using a unique reply topic so that reply messages are not interchanged across consumers. A particular request thread from a specific requestor instance receives the response corresponding to the right request. The solution works, but it’s not elegant. Topics are managed objects, and they need housekeeping. Even if the housekeeping could be automated (like with dynamic queues), it’s not nice to have tens of hundreds of topics just like that.</p>

          <p class="Para" id="Par24">A better solution is to leverage partitions of <em class="EmphasisTypeItalic ">topics</em>, a feature provided by Kafka. As suggested by the Spring Kafka documentation, each consumer can use an additional <span class="EmphasisFontCategoryNonProportional ">KafkaHeaders.REPLY_PARTITION</span> header value, which is sent with the request. It’s a four-byte field containing a BIG-ENDIAN representation of the partition integer.</p>

          <div class="Para" id="Par25">The schema can be represented as shown in Figure <span class="InternalRef"><a href="#Fig8">5-8</a></span>.<figure class="Figure" id="Fig8"><div class="MediaObject" id="MO8"><img alt="" aria-describedby="d64e458" src="../images/619782_1_En_5_Chapter/Imagem-056.jpg" style="width:35.15em"/><div class="TextObject" id="d64e458"><p class="Para" id="Par132">A diagram presents the request-reply interaction model between microservices, with the concept of partitions and queues in the reply mechanism. Two requestor microservices send requests through channels. The channel is connected to a queue mechanism, which splits into partitions 1 and 2.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-8</span><p class="SimplePara">Different reply <span id="ITerm13">partitions</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par26">Kafka partitions are the main concurrency mechanism in Kafka. A topic is divided into one or more partitions, enabling producer and consumer loads to be scaled. The consumers are shared evenly across the partitions, allowing for the consumer load to be linearly scaled by increasing both consumers and partitions. You can use this feature for the reply address.</p>

          <p class="Para" id="Par27">The next section illustrates these topics with code.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec8">

        <h2 class="Heading">Microservices Sequential Processing</h2>

        <p class="Para" id="Par28">In this example, you see how to tweak the same set of microservices shown in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>. A consumer and a provider microservice communicate with each other using a messaging channel. The provider microservice stores the entity in an in-memory database, to keep the example simple. Moreover, when the browser sends the request to the first (consumer) microservice, it uses async HTTP.</p>

        <p class="Para" id="Par29">The complexity of this example compared to the example in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span> is that this example uses multiple instances of consumer and provider microservices and multiple clients while testing the service. When the same kinds of requests from different users reach the single instance of the (message consumer) microservice, the requests are serviced one by one, in sequence.</p>

        <section class="Section2 RenderAsSection2" id="Sec9">

          <h3 class="Heading">Design Sequential Processing Microservices</h3>

          <div class="Para" id="Par30">I slightly modify the hexagonal microservice view shown in Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span> so that both microservices communicate through an async channel. This example uses Apache Kafka as the messaging channel, which is inherently <span id="ITerm14">asynchronous</span>. Remember, the objective is to mimic synchronous styled communication over the Kafka-based async channel, as well as demonstrate that multiple consumer types or multiple instances of the same consumer type can connect to one or more instances of the provider microservice and still get the responses corresponding to the respective request alone. See Figure <span class="InternalRef"><a href="#Fig9">5-9</a></span>.<figure class="Figure" id="Fig9"><div class="MediaObject" id="MO9"><img alt="" aria-describedby="d64e523" src="../images/619782_1_En_5_Chapter/Imagem-057.jpg" style="width:35.15em"/><div class="TextObject" id="d64e523"><p class="Para" id="Par133">A diagram presents an event-driven microservice architecture that involves two primary components, product web microservice instances and product server microservice instances. The communication occurs through many to many or any to any channels with the event queue.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-9</span><p class="SimplePara">Microservice design over <span id="ITerm15">async channel</span> using partitions</p></div></figcaption></figure></div>

          <div class="Para" id="Par31">A few <span id="ITerm16">observations</span> to note are as follows:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par32">There are multiple instances of the Product Web (Request Consumer) microservice provisioned. If this schema works, it should work for different types of microservices too.</p></li><li><p class="Para" id="Par33">There are multiple instances of the Product Server (Request Provider) microservice provisioned. Hence, events can be picked up for processing by any instance in a round robin manner.</p></li><li><p class="Para" id="Par34">Even though the Product Web is the Request Consumer and the Product Server is the Request Provider from the Service Consumer and Service Provider perspective, they are both playing the role of Message Sender and Message Consumer at the same time over the Kafka topics.</p></li><li><p class="Para" id="Par35">Figure <span class="InternalRef"><a href="#Fig9">5-9</a></span> shows instances of the Product Server microservice listening to different topics, even though in this example, it listens to the same topic but leverages different partitions. </p></li></ul></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec10">

          <h3 class="Heading">Understanding the Code</h3>

          <p class="Para" id="Par36">The <span id="ITerm17">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for the example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch05\ch05-01</span> folder. This section looks at the changes in the consumer microservice—that is, the Product Web microservice, first.</p>

          <div class="Para" id="Par37">As explained earlier, using separate topics for different clients is not an elegant solution, since you should leverage the <span class="EmphasisFontCategoryNonProportional ">REPLY_PARTITION</span> explicitly. The consumer microservice in that case will need to know which partition it is assigned to. Explicit configuration to select a specific partition can be provided as follows:<div class="ProgramCode" id="PC1"><div class="LineGroup"><div class="FixedLine">@Value("${kafka.topic.product.reply.partition}")</div><div class="FixedLine">private int replyPartition;</div></div></div></div>

          <div class="Para" id="Par38">As shown in Listing <span class="ExternalRef"><a href="Capítulo-06.html#PC2"><span class="RefSource">4-2</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>, you now need to set the parameters explicitly, like those in Listing <span class="InternalRef"><a href="#PC2">5-1</a></span>.<div class="ProgramCode" id="PC2"><div class="LineGroup"><div class="FixedLine">productRecord.headers().add(new RecordHeader(</div><div class="FixedLine">    KafkaHeaders.REPLY_TOPIC, requestReplyTopic.getBytes()));</div><div class="FixedLine">productRecord.headers().add(new RecordHeader(</div><div class="FixedLine">    KafkaHeaders.REPLY_PARTITION,</div><div class="FixedLine">    intToBytesBigEndian(replyPartition)));</div><div class="FixedLine">RequestReplyFuture&lt;String, RequestReply,</div><div class="FixedLine">    RequestReply&gt; sendAndReceive =</div><div class="FixedLine">        requestReplyKafkaTemplate.sendAndReceive(</div><div class="FixedLine">            productRecord);</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-1</span><p class="SimplePara"><span id="ITerm18">Static Configuration</span> of Reply Topic and Partition</p></div></div></div></div>

          <p class="Para" id="Par39">However, this kind of static configuration will not help you in cases of dynamic horizontal scaling (adding more instances of the same microservice), so you would need a schema to address this.</p>

          <div class="Para" id="Par40">Bjorn Beskow from Callista Enterprise wrote a nice blog and provided a utility library on the Internet to do this, hence you will utilize that for this example. The requirement is to dynamically manage the Reply topic and the Reply partition required to implement the Return Address pattern, and this library does exactly that. The Reply topic needs to be wired into <span class="EmphasisFontCategoryNonProportional ">RequestReplyTemplate</span>, so you don’t need to handle it through the API while sending the record. For the Reply partition, you retrieve the partition(s) on which the reply topic listener has been assigned and pass that partition info. The <span id="ITerm19">utility library</span> is available in this source code subfolder:<div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine">ch05\ch05-01\kafka-request-reply-util</div></div></div></div>

          <div class="Para" id="Par41">A detailed explanation of the implementation of this utility is beyond the scope of this book. You are directed to refer to the blog for more information. Instead, this section looks at how to use this utility and implement the functionality. Listing <span class="InternalRef"><a href="#PC4">5-2</a></span> shows the configurations to use the utility library.<div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine">import se.callista.blog.synch_kafka.request_reply_util.</div><div class="FixedLine">    CompletableFutureReplyingKafkaOperations;</div><div class="FixedLine">import se.callista.blog.synch_kafka.request_reply_util.</div><div class="FixedLine">    CompletableFutureReplyingKafkaTemplate;</div></div><div class="LineGroup"><div class="FixedLine">@Configuration</div><div class="FixedLine">public class KafkaConfig {</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${spring.kafka.bootstrap-servers}")</div><div class="FixedLine">    private String bootstrapServers;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${spring.kafka.consumer.group-id}")</div><div class="FixedLine">    private String groupId;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.topic.product.request}")</div><div class="FixedLine">    private String requestTopic;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${product.topic.request.numPartitions}")</div><div class="FixedLine">    private int numPartitions;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.topic.product.reply}")</div><div class="FixedLine">    private String replyTopic;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.request-reply.timeout-ms}")</div><div class="FixedLine">    private Long replyTimeout;</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public CompletableFutureReplyingKafkaOperations&lt;</div><div class="FixedLine">            String, String, Products&gt; replyKafkaTemplate() {</div></div><div class="LineGroup"><div class="FixedLine">        CompletableFutureReplyingKafkaTemplate&lt;String,</div><div class="FixedLine">            String, Products&gt; requestReplyKafkaTemplate =</div><div class="FixedLine">                new CompletableFutureReplyingKafkaTemplate&lt;&gt;(</div><div class="FixedLine">                    requestProducerFactory(),</div><div class="FixedLine">                        replyListenerContainer());</div></div><div class="LineGroup"><div class="FixedLine">        requestReplyKafkaTemplate.setDefaultTopic(</div><div class="FixedLine">            requestTopic);</div><div class="FixedLine">        requestReplyKafkaTemplate.setDefaultReplyTimeout(</div><div class="FixedLine">            Duration.of(replyTimeout, ChronoUnit.MILLIS));</div><div class="FixedLine">        return requestReplyKafkaTemplate;</div><div class="FixedLine">    }</div><div class="FixedLine"><span id="ITerm20"></span></div><div class="FixedLine">    @Bean</div><div class="FixedLine">    public NewTopic replyTopic() {</div></div><div class="LineGroup"><div class="FixedLine">        Map&lt;String, String&gt; configs = new HashMap&lt;&gt;();</div><div class="FixedLine">        configs.put("retention.ms", replyTimeout.toString());</div><div class="FixedLine">        return new NewTopic(replyTopic, numPartitions,</div><div class="FixedLine">            (short) 1).configs(configs);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-2</span><p class="SimplePara"><span id="ITerm21">Kafka Configuration</span> for the Product Web Microservice (ch05\ch05-01\02-ProductWeb\src\main\java\com\acme\ecom\product\KafkaConfig.java)</p></div></div></div></div>

          <div class="Para" id="Par42">As you saw in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>, <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate &lt;K, V, R&gt;</span> offers a Return object or a Reply object once the message is consumed by the Kafka listener from the provider or producer side. The type <span id="ITerm22">parameters</span> represent:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par43">K – Key type</p></li><li><p class="Para" id="Par44">V – Outbound data type</p></li><li><p class="Para" id="Par45">R – Reply data type</p></li></ul></div></div>

          <div class="Para" id="Par46">When you have multiple sender microservices instances, you must make sure that the response is sent to the correct sender microservices instance. The Spring Kafka documentation suggests that each sender microservices use a unique topic, or that an additional <span class="EmphasisFontCategoryNonProportional ">KafkaHeaders.REPLY_PARTITION</span> header value be sent with the request. Topics are administered objects. You can also set the <span class="EmphasisFontCategoryNonProportional ">REPLY_PARTITION</span> explicitly. The <span class="EmphasisFontCategoryNonProportional ">REPLY_PARTITION</span> header denotes a partition number on which to send the reply. The sender microservices will then need to know which partition it is assigned to. The documentation suggests using explicit configuration to select a specific partition. Listing <span class="InternalRef"><a href="#PC5">5-3</a></span> shows one possible configuration.<div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">@Configuration</div><div class="FixedLine">public class KafkaConfig {</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.topic.product.reply}")</div><div class="FixedLine">    private String replyTopic;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.topic.product.reply.partition}")</div><div class="FixedLine">    private int replyPartition;</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public KafkaMessageListenerContainer&lt;String,</div><div class="FixedLine">            RequestReply&gt; replyListenerContainer() {</div></div><div class="LineGroup"><div class="FixedLine">        ContainerProperties containerProperties =</div><div class="FixedLine">            new ContainerProperties(replyTopic);</div><div class="FixedLine">        TopicPartitionInitialOffset initialOffset =</div><div class="FixedLine">            new TopicPartitionInitialOffset(replyTopic,</div><div class="FixedLine">                replyPartition);</div><div class="FixedLine">        return new KafkaMessageListenerContainer&lt;&gt;(</div><div class="FixedLine">            replyConsumerFactory(),</div><div class="FixedLine">            containerProperties, initialOffset);</div><div class="FixedLine">}<span id="ITerm23"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-3</span><p class="SimplePara"><span id="ITerm24">Kafka Configuration</span> for the Product Web Microservice, Specifying Partition</p></div></div></div></div>

          <div class="Para" id="Par47">An additional <span class="EmphasisFontCategoryNonProportional ">KafkaHeaders.REPLY_PARTITION</span> header value can be sent with the request, which is a four-byte field containing a BIG-ENDIAN representation of the partition integer, as shown in Listing <span class="InternalRef"><a href="#PC6">5-4</a></span>.<div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">record.headers().add(new RecordHeader(KafkaHeaders.REPLY_TOPIC,</div><div class="FixedLine">    requestReplyTopic.getBytes()));</div><div class="FixedLine">record.headers().add(new RecordHeader(KafkaHeaders.REPLY_PARTITION,</div><div class="FixedLine"> intToBytesBigEndian(replyPartition)));</div><div class="FixedLine">RequestReplyFuture&lt;String, RequestReply, RequestReply&gt; sendAndReceive =</div><div class="FixedLine">    requestReplyKafkaTemplate.sendAndReceive(record);</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-4</span><p class="SimplePara">Kafka <span id="ITerm25">Message Exchange</span> for the Product Web Microservice, Specifying Partition</p></div></div></div></div>

          <p class="Para" id="Par48">Using separate topics for different sender microservices is clearly not very flexible, as mentioned. The configuration and the programming needed is extensive, and the APIs are low level. Moreover, when you need to dynamically scale the number of sender microservices, this way of static configuration is not what you need. Hence, you can use the <span class="EmphasisFontCategoryNonProportional ">PartitionAwareReplyingKafkaTemplate&lt;K, V, R&gt;</span> utility, which extends <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate&lt;K, V, R&gt;</span>. It also implements <span class="EmphasisFontCategoryNonProportional ">PartitionAwareReplyingKafkaOperations&lt;K, V, R&gt;</span>. Subsequently, <span class="EmphasisFontCategoryNonProportional ">CompletableFutureReplyingKafkaTemplate&lt;K, V, R&gt;</span> extends <span class="EmphasisFontCategoryNonProportional ">PartitionAwareReplyingKafkaTemplate&lt;K, V, R&gt;</span>.</p>

          <div class="Para" id="Par49">You can enhance the Return Address pattern by passing the partition along with the Reply topic. The Reply topic is wired into the <span class="EmphasisFontCategoryNonProportional ">RequestReplyTemplate</span>, and hence needn’t be present in the API. For the partition info, you retrieve which partition(s) the reply topic listener has been assigned and pass that partition along automatically. This eliminates the need for the client to care about these headers. As mentioned earlier, Bjorn Beskow from Callista Enterprise placed this utility library on the Internet to do this, and it’s used in Listing <span class="InternalRef"><a href="#PC7">5-5</a></span>.<div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine">public class PartitionAwareReplyingKafkaTemplate&lt;K, V, R&gt;</div><div class="FixedLine">        extends ReplyingKafkaTemplate&lt;K, V, R&gt; {</div></div><div class="LineGroup"><div class="FixedLine">    public PartitionAwareReplyingKafkaTemplate(</div><div class="FixedLine">            ProducerFactory&lt;K, V&gt; producerFactory,</div><div class="FixedLine">            GenericMessageListenerContainer&lt;K, R&gt;</div><div class="FixedLine">            replyContainer) {</div><div class="FixedLine">        super(producerFactory, replyContainer);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    private TopicPartition</div><div class="FixedLine">            getFirstAssignedReplyTopicPartition() {</div></div><div class="LineGroup"><div class="FixedLine">        if (getAssignedReplyTopicPartitions() != null &amp;&amp;</div><div class="FixedLine">                getAssignedReplyTopicPartitions().iterator().</div><div class="FixedLine">                    hasNext()) {</div><div class="FixedLine">            TopicPartition replyPartition =</div><div class="FixedLine">                getAssignedReplyTopicPartitions().iterator().</div><div class="FixedLine">                    next();</div><div class="FixedLine">            if (this.logger.isDebugEnabled()) {</div><div class="FixedLine">                this.logger.debug("Using partition " +</div><div class="FixedLine">                    replyPartition.partition());</div><div class="FixedLine">            }</div><div class="FixedLine">            return replyPartition;</div><div class="FixedLine">        } else {</div><div class="FixedLine">            throw new KafkaException("Illegal state: No reply</div><div class="FixedLine">                partition is assigned to this instance");</div><div class="FixedLine">        }</div><div class="FixedLine">    }<span id="ITerm26"></span></div></div><div class="LineGroup"><div class="FixedLine">    protected RequestReplyFuture&lt;K, V, R&gt; doSendAndReceive(</div><div class="FixedLine">            ProducerRecord&lt;K, V&gt; record) {</div></div><div class="LineGroup"><div class="FixedLine">        TopicPartition replyPartition =</div><div class="FixedLine">            getFirstAssignedReplyTopicPartition();</div><div class="FixedLine">        record.headers()</div><div class="FixedLine">            .add(new RecordHeader(KafkaHeaders.REPLY_TOPIC,</div><div class="FixedLine">                replyPartition.topic().getBytes()))</div><div class="FixedLine">                    .add(new RecordHeader(</div><div class="FixedLine">                        KafkaHeaders.REPLY_PARTITION,</div><div class="FixedLine">                        intToBytesBigEndian(</div><div class="FixedLine">                            replyPartition.partition())));</div><div class="FixedLine">        return super.sendAndReceive(record);</div><div class="FixedLine">    }</div><div class="FixedLine">}<span id="ITerm27"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-5</span><p class="SimplePara"><span id="ITerm28">Encapsulating Partition</span> Info in Kafka Message Exchange (ch05\ch05-01\kafka-request-reply-util\src\main\java\se\callista\blog\synch_kafka\request_reply_util\PartitionAwareReplyingKafkaTemplate.java)</p></div></div></div></div>

          <div class="Para" id="Par50">Listing <span class="InternalRef"><a href="#PC7">5-5</a></span> is slightly non-trivial, so I attempt to explain it with the help of Figure <span class="InternalRef"><a href="#Fig10">5-10</a></span>, which depicts the complete <span id="ITerm29">abstraction</span> provided by <span class="EmphasisFontCategoryNonProportional ">CompletableFutureReplyingKafkaTemplate</span>.<figure class="Figure" id="Fig10"><div class="MediaObject" id="MO10"><img alt="" aria-describedby="d64e1116" src="../images/619782_1_En_5_Chapter/Imagem-058.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1116"><p class="Para" id="Par134">A diagram presents a request-reply interaction in a kafka-based event-driven microservice architecture for a product web microservice and a product server microservice. It illustrates how a user interacts with the system and how the request and reply are processed through the kafka template.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-10</span><p class="SimplePara">CompletableFutureReplyingKafkaTemplate <span id="ITerm30">abstraction</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par51">The labelled steps are in sequence in Figure <span class="InternalRef"><a href="#Fig10">5-10</a></span>, so you can simply follow those steps to understand the explanation provided earlier.</p>

          <div class="Para" id="Par52">Next, we will look at the REST controller for the Product Web microservice. This is shown in Listing <span class="InternalRef"><a href="#PC8">5-6</a></span>.<div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine">@CrossOrigin</div><div class="FixedLine">@RestController</div><div class="FixedLine">public class ProductRestController{</div></div><div class="LineGroup"><div class="FixedLine">    private static final String REQUEST_PAYLOAD = "All";</div><div class="FixedLine">        //Get All Data</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${spring.application.name:product-web}")</div><div class="FixedLine">    private String appName;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.topic.product.pinnedToPartition:false}")</div><div class="FixedLine">    private boolean pinnedToPartition;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.topic.product.request}")</div><div class="FixedLine">    private String requestTopic;</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    private CompletableFutureReplyingKafkaOperations&lt;String,</div><div class="FixedLine">        String, Products&gt; replyingKafkaTemplate;</div></div><div class="LineGroup"><div class="FixedLine">    @RequestMapping(value = "/productsweb", method =</div><div class="FixedLine">        RequestMethod.GET,</div><div class="FixedLine">        produces = {MediaType.APPLICATION_JSON_VALUE})</div><div class="FixedLine">    public DeferredResult&lt;Products&gt;  getAllProducts()</div><div class="FixedLine">            throws InterruptedException, ExecutionException {</div></div><div class="LineGroup"><div class="FixedLine">        DeferredResult&lt;Products&gt; deferredResult =</div><div class="FixedLine">            new DeferredResult&lt;&gt;();</div><div class="FixedLine">        CompletableFuture&lt;Products&gt; completableFuture =  null;</div><div class="FixedLine">        if(pinnedToPartition){</div><div class="FixedLine">            completableFuture =  replyingKafkaTemplate.</div><div class="FixedLine">                requestReply(requestTopic,</div><div class="FixedLine">                    appName, REQUEST_PAYLOAD);</div><div class="FixedLine">        }<span id="ITerm31"></span></div><div class="FixedLine">        else{</div><div class="FixedLine">            completableFuture =  replyingKafkaTemplate.</div><div class="FixedLine">                requestReply(requestTopic, REQUEST_PAYLOAD);</div><div class="FixedLine">        }</div><div class="FixedLine">        completableFuture.thenAccept(products -&gt;</div><div class="FixedLine">            deferredResult.setResult(products))</div><div class="FixedLine">            .exceptionally(ex -&gt; {</div><div class="FixedLine">                LOGGER.error(ex.getMessage());</div><div class="FixedLine">                return null;</div><div class="FixedLine">            });</div></div><div class="LineGroup"><div class="FixedLine">        return deferredResult;</div><div class="FixedLine">    }</div><div class="FixedLine">}<span id="ITerm32"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-6</span><p class="SimplePara"><span id="ITerm33">REST Controller</span> for the Product Web Microservice (ch05\ch05-01\02-ProductWeb\src\main\java\com\acme\ecom\product\controller\ProductRestController.java)</p></div></div></div></div>

          <div class="Para" id="Par53">Similar to <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate</span>, <span class="EmphasisFontCategoryNonProportional ">CompletableFutureReplyingKafkaOperations&lt;K, V, R&gt;</span> offers a Return or Reply object once the message is consumed by the Kafka listener from the provider or producer side. The type <span id="ITerm34">parameters</span> represent:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par54">K – Key type</p></li><li><p class="Para" id="Par55">V – Outbound data type</p></li><li><p class="Para" id="Par56">R – Reply data type</p></li></ul></div></div>

          <div class="Para" id="Par57">Next, we introduce a <span id="ITerm35">Boolean flag</span> <span class="EmphasisFontCategoryNonProportional ">pinnedToPartition</span>, intended to demonstrate the various test cases. This flag can be configured in the <span class="EmphasisFontCategoryNonProportional ">application.yml</span> configuration file for the Product Web microservice. See Listing <span class="InternalRef"><a href="#PC9">5-7</a></span>.<div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine">server:</div><div class="FixedLine">    port: 8080</div><div class="FixedLine">spring:</div><div class="FixedLine">    application:</div><div class="FixedLine">        name: product-web</div><div class="FixedLine">    autoconfigure:</div><div class="FixedLine">        exclude: org.springframework.boot.autoconfigure.kafka.</div><div class="FixedLine">            KafkaAutoConfiguration</div><div class="FixedLine">    kafka:</div><div class="FixedLine">        bootstrap-servers: localhost:9092</div><div class="FixedLine">        consumer:</div><div class="FixedLine">            auto-offset-reset: earliest</div><div class="FixedLine">            group-id: product-web</div><div class="FixedLine">kafka:</div><div class="FixedLine">    topic:</div><div class="FixedLine">        product:</div><div class="FixedLine">            request: product-req-topic</div><div class="FixedLine">            pinnedToPartition: true</div><div class="FixedLine">            reply: product-req-reply-topic</div><div class="FixedLine">    request-reply:</div><div class="FixedLine">        timeout-ms: 60000</div><div class="FixedLine">product:</div><div class="FixedLine">    topic:</div><div class="FixedLine">        request:</div><div class="FixedLine">            numPartitions: 2</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-7</span><p class="SimplePara">Configuration for the Product Web Microservice (ch05\ch05-01\02-ProductWeb\src\main\resources\application.yml)</p></div></div></div></div>

          <div class="Para" id="Par58">If <span class="EmphasisFontCategoryNonProportional ">pinnedToPartition</span> is configured with <span class="EmphasisFontCategoryNonProportional ">false</span>, the sender microservices are intended to send request messages to receiver microservices in a random, load balanced manner, as shown here:<div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">completableFuture =  replyingKafkaTemplate.requestReply(requestTopic, REQUEST_PAYLOAD);</div></div></div></div>

          <div class="Para" id="Par59">Instead, if <span id="ITerm36"><span class="EmphasisFontCategoryNonProportional ">pinnedToPartition</span></span> is configured with <span class="EmphasisFontCategoryNonProportional ">true</span>, the sender microservices are intended to send request messages to receiver microservices in a fixed or pinned manner, as shown here:<div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">completableFuture =  replyingKafkaTemplate.requestReply(requestTopic, appName,</div><div class="FixedLine">    REQUEST_PAYLOAD);</div></div></div></div>

          <div class="Para" id="Par60">As you saw in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>, the producer chooses which partition to use. If you specify the <span id="ITerm37">partition parameter</span>, it will be used, and the key will be “ignored” even though the key will still be written into the topic. Routing of messages to partitions doesn’t have to be key-based. You can explicitly specify a partition when creating a <span class="EmphasisFontCategoryNonProportional ">ProducerRecord</span> too. When <span class="EmphasisFontCategoryNonProportional ">pinnedToPartition</span> is configured with <span class="EmphasisFontCategoryNonProportional ">true</span>, the underlying utility library uses the overloaded version of <span class="EmphasisFontCategoryNonProportional ">requestReply(String topic, K key, V value)</span> so that a value for the key can be specified, as shown in Listing <span class="InternalRef"><a href="#PC12">5-8</a></span>.<div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">package se.callista.blog.synch_kafka.request_reply_util;</div></div><div class="LineGroup"><div class="FixedLine">public class CompletableFutureReplyingKafkaTemplate&lt;K, V, R&gt;</div><div class="FixedLine">    extends PartitionAwareReplyingKafkaTemplate&lt;K, V, R&gt;</div><div class="FixedLine">    implements CompletableFutureReplyingKafkaOperations&lt;</div><div class="FixedLine">    K, V, R&gt; {</div></div><div class="LineGroup"><div class="FixedLine">    @Override</div><div class="FixedLine">    public CompletableFuture&lt;R&gt; requestReply(String topic,</div><div class="FixedLine">            V value) {</div><div class="FixedLine">        return adapt(sendAndReceive(topic, value));</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Override</div><div class="FixedLine">    public CompletableFuture&lt;R&gt; requestReply(String topic,</div><div class="FixedLine">            K key, V value) {</div><div class="FixedLine">        return adapt(sendAndReceive(topic, key, value));</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Override</div><div class="FixedLine">    public CompletableFuture&lt;R&gt; requestReply(String topic,</div><div class="FixedLine">            Integer partition, K key, V value) {</div><div class="FixedLine">        return adapt(sendAndReceive(topic, partition,</div><div class="FixedLine">            key, value));</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-8</span><p class="SimplePara">CompletableFutureReplyingKafkaTemplate Utility (ch05\ch05-01\kafka-request-reply-util\src\main\java\se\callista\blog\synch_kafka\request_reply_util\CompletableFutureReplyingKafkaTemplate.java)</p></div></div></div></div>

          <div class="Para" id="Par61">You can configure the same values for the key by providing the same values for the <span class="EmphasisFontCategoryNonProportional ">appName</span> through the run scripts in the root folder of the Product Web microservice:<div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine">-Dspring.application.name=<strong class="EmphasisTypeBold ">product-web-1</strong></div><div class="FixedLine">-Dspring.application.name=<strong class="EmphasisTypeBold ">product-web-1</strong></div></div></div></div>

          <p class="Para" id="Par62">In Listing <span class="InternalRef"><a href="#PC9">5-7</a></span>, note the configuration <span class="EmphasisFontCategoryNonProportional ">numPartitions: 2</span>. The number 2 is arbitrary, but it should be more than the number of (instances of) requester microservices, because otherwise the system will throw errors. Moreover, shared partitions cannot guarantee that the requestor (instance of) microservice will receive the corresponding response.</p>

          <div class="Para" id="Par63">In the Product Server microservice, the main <span id="ITerm38">component</span> is <span class="EmphasisFontCategoryNonProportional ">ProductListener</span>, as shown in Listing <span class="InternalRef"><a href="#PC14">5-9</a></span>.<div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine">@Component</div><div class="FixedLine">public class ProductListener {</div></div><div class="LineGroup"><div class="FixedLine">    @KafkaListener(topics = "${kafka.topic.product.request}",</div><div class="FixedLine">        containerFactory =</div><div class="FixedLine">            "requestReplyListenerContainerFactory")</div><div class="FixedLine">    @SendTo</div><div class="FixedLine">    public Products listenWithHeaders(</div><div class="FixedLine">            @Payload String requestor,</div><div class="FixedLine">            @Header(KafkaHeaders.REPLY_TOPIC)</div><div class="FixedLine">                String replyTopic,</div><div class="FixedLine">            @Header(KafkaHeaders.REPLY_PARTITION)</div><div class="FixedLine">                int replyPartitionId,</div><div class="FixedLine">            @Header(KafkaHeaders.RECEIVED_TOPIC)</div><div class="FixedLine">                String receivedTopic,</div><div class="FixedLine">            @Header(KafkaHeaders.RECEIVED_PARTITION_ID)</div><div class="FixedLine">                int receivedPartitionId,</div><div class="FixedLine">            @Header(KafkaHeaders.CORRELATION_ID)</div><div class="FixedLine">                String correlationId,</div><div class="FixedLine">            @Header(KafkaHeaders.OFFSET) String offset){</div></div><div class="LineGroup"><div class="FixedLine">        LOGGER.info("Start");</div><div class="FixedLine">        LOGGER.debug("Listen; Request from : " + requestor);</div><div class="FixedLine">        LOGGER.debug("Listen; replyTopic : " + replyTopic);</div><div class="FixedLine">        LOGGER.debug("Listen; replyPartitionId : " +</div><div class="FixedLine">            replyPartitionId);</div><div class="FixedLine">        LOGGER.debug("Listen; receivedTopic : " +</div><div class="FixedLine">            receivedTopic);</div><div class="FixedLine">        LOGGER.debug("Listen; receivedPartitionId : " +</div><div class="FixedLine">            receivedPartitionId);</div><div class="FixedLine">        LOGGER.debug("Listen; correlationId : " +</div><div class="FixedLine">            correlationId);</div><div class="FixedLine">        LOGGER.debug("Listen; offset : " + offset);</div></div><div class="LineGroup"><div class="FixedLine">        List&lt;Product&gt; productList = getAllTheProducts();</div><div class="FixedLine">        Products products=new Products();</div><div class="FixedLine">        products.setProducts(productList);</div></div><div class="LineGroup"><div class="FixedLine">        LOGGER.info("Ending...");</div><div class="FixedLine">        return products;</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-9</span><p class="SimplePara">Product Server Message Listener (ch05\ch05-01\01-ProductServer\src\main\java\com\acme\ecom\product\kafka\client\ProductListener.java)</p></div></div></div></div>

          <p class="Para" id="Par64"><span class="EmphasisFontCategoryNonProportional ">ProductListener</span> contains logging information, which will help you debug the headers and other parameters. It also fetches a collection of <span class="EmphasisFontCategoryNonProportional ">Product</span> entities from an in-memory DB and returns it to the Reply channel.</p>

          <div class="Para" id="Par65">The rest of the code is very similar to Listing <span class="ExternalRef"><a href="Capítulo-06.html#PC11"><span class="RefSource">4-11</span></a></span> from Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>, so it’s not repeated here. Instead, Listing <span class="InternalRef"><a href="#PC15">5-10</a></span> shows a snippet of the <span id="ITerm39">configuration</span> for the Product Server microservice.<div class="ProgramCode" id="PC15"><div class="LineGroup"><div class="FixedLine">product:</div><div class="FixedLine">  topic:</div><div class="FixedLine">    request:</div><div class="FixedLine">      numPartitions: 3</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-10</span><p class="SimplePara">Configuration for Product Server Microservice (ch05\ch05-01\01-ProductServer\src\main\resources\application.yml)</p></div></div></div></div>

          <p class="Para" id="Par66">This example is demonstrated with three instances of the Product Server microservice.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec11">

          <h3 class="Heading">Build and Run the Microservice Sequential Processing</h3>

          <div class="Para" id="Par67">The <span class="EmphasisFontCategoryNonProportional ">ch05\ch05-01</span> folder contains the Maven scripts required to build the examples. As a first step, you need to bring up the Kafka broker. Refer to Appendix D to learn how to set up Kafka server and bring the server up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC16">5-11</a></span> to bring up Kafka from the Kafka installation location.<div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine">bin/zookeeper-server-start.sh config/zookeeper.properties</div><div class="FixedLine">bin/kafka-server-start.sh config/server.properties</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-11</span><p class="SimplePara">Commands to Bring Up Kafka Broker</p></div></div></div></div>

          <div class="Para" id="Par68">Next, build and <span id="ITerm40">install</span> the utility library from the Callista Enterprise, as shown in Listing <span class="InternalRef"><a href="#PC17">5-12</a></span>.<div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:kafka-request-reply-util binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-01/kafka-request-reply-util</div><div class="FixedLine">(base) binildass-MacBook-Pro:kafka-request-reply-util binil$ mvn clean install</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] -&lt; se.callista.blog.synch_kafka:kafka-req...-util &gt;-</div><div class="FixedLine">[INFO] Building Kafka Request Reply utility 0.0.1-SNAPSHOT</div><div class="FixedLine">[INFO] --------------------------------[ jar ]-------------</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO] ----------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] ----------------------------------------------------</div><div class="FixedLine">[INFO] Total time:  1.335 s</div><div class="FixedLine">[INFO] Finished at: 2024-02-27T12:35:54+05:30</div><div class="FixedLine">[INFO] ----------------------------------------------------</div><div class="FixedLine">binildass-MacBook-Pro:kafka-request-reply-util binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-12</span><p class="SimplePara">Commands to Build and Install the Utility Library from the Callista Enterprise</p></div></div></div></div>

          <p class="Para" id="Par69">Next, take five command terminals—three for the Product Server and two for the Product Web microservice—and change the directory to the top-level folder of both microservices.</p>

          <div class="Para" id="Par70">Build the Product Server microservice using the <span class="EmphasisFontCategoryNonProportional ">make.sh</span> scripts, as shown in Listing <span class="InternalRef"><a href="#PC18">5-13</a></span>.<div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-01/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-13</span><p class="SimplePara">Commands to Build the Product Server Microservice</p></div></div></div></div>

          <div class="Para" id="Par71">Next, build the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC19">5-14</a></span>.<div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-01/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-14</span><p class="SimplePara">Commands to Build the Product Web Microservice</p></div></div></div></div>

          <div class="Para" id="Par72">Now that the Product Server microservice is built, you can run it using the <span class="EmphasisFontCategoryNonProportional ">run1.sh</span>, <span class="EmphasisFontCategoryNonProportional ">run2.sh</span> and <span class="EmphasisFontCategoryNonProportional ">run3.sh</span> scripts in the root folder of the microservice, in three different terminals. See Listings <span class="InternalRef"><a href="#PC20">5-15</a></span> through <span class="InternalRef"><a href="#PC22">5-17</a></span>.<div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-01/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run1.sh</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 17:41:09 INFO  InitComponent.init:43 - Start</div><div class="FixedLine">2024-02-28 17:41:09 INFO  InitComponent.init:44 - Do Nothing</div><div class="FixedLine">2024-02-28 17:41:09 INFO  InitComponent.init:66 - End</div><div class="FixedLine">2024-02-28 17:41:11 INFO  Logger.log:56 - Started EcomProd...</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-15</span><p class="SimplePara">Commands to Run the Product Server Microservice: Instance 1</p></div></div></div><div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-01/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run2.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 17:41:11 INFO  Logger.log:56 - Started EcomProd...</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-16</span><p class="SimplePara">Commands to Run the Product Server Microservice: Instance 2</p></div></div></div><div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-01/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run3.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 17:41:19 INFO  InitComponent.init:43 - Start</div><div class="FixedLine">2024-02-28 17:41:19 INFO  InitComponent.init:44 - Do Nothing</div><div class="FixedLine">2024-02-28 17:41:19 INFO  InitComponent.init:66 - End</div><div class="FixedLine">2024-02-28 17:41:20 INFO  Logger.log:56 - Started EcomProd...</div><div class="FixedLine">2024-02-28 <strong class="EmphasisTypeBold ">17:52:23</strong> INFO  ProductListener.listenWithHeaders:57 - <strong class="EmphasisTypeBold ">Start</strong></div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductListener.listenWithHeaders:58 - Listen; Request from : All</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductListener.listenWithHeaders:59 - Listen; replyTopic : product-req-reply-topic</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductListener.listenWithHeaders:60 - Listen; replyPartitionId : 0</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductListener.listenWithHeaders:61 - Listen; receivedTopic : product-req-topic</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductListener.listenWithHeaders:62 - Listen; receivedPartitionId : 0</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 <strong class="EmphasisTypeBold ">17:52:29</strong> INFO  ProductListener.listenWithHeaders:80 - <strong class="EmphasisTypeBold ">Ending</strong>...</div><div class="FixedLine">2024-02-28 <strong class="EmphasisTypeBold ">17:52:29</strong> INFO  ProductListener.listenWithHeaders:57 - <strong class="EmphasisTypeBold ">Start</strong></div><div class="FixedLine">2024-02-28 17:52:29 DEBUG ProductListener.listenWithHeaders:58 - Listen; Request from : All</div><div class="FixedLine">2024-02-28 17:52:29 DEBUG ProductListener.listenWithHeaders:59 - Listen; replyTopic : product-req-reply-topic</div><div class="FixedLine">2024-02-28 17:52:29 DEBUG ProductListener.listenWithHeaders:60 - Listen; replyPartitionId : 1</div><div class="FixedLine">2024-02-28 17:52:29 DEBUG ProductListener.listenWithHeaders:61 - Listen; receivedTopic : product-req-topic</div><div class="FixedLine">2024-02-28 17:52:29 DEBUG ProductListener.listenWithHeaders:62 - Listen; receivedPartitionId : 0</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 <strong class="EmphasisTypeBold ">17:52:35</strong> INFO  ProductListener.listenWithHeaders:80 - <strong class="EmphasisTypeBold ">Ending</strong>...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-17</span><p class="SimplePara">Commands to Run the Product Server Microservice: Instance 3</p></div></div></div></div>

          <div class="Para" id="Par73">Once all three instances of the Product Server microservice are running, you can bring up the two Product Web microservice instances, as shown in Listings <span class="InternalRef"><a href="#PC23">5-18</a></span> and <span class="InternalRef"><a href="#PC24">5-19</a></span>.<div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-01/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh run1.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 17:48:02 INFO  Logger.log:56 - Started EcomProd...</div><div class="FixedLine">2024-02-28 17:52:23 INFO  ProductRestController.getAllProducts:69 - Start</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductRestController.getAllProducts:70 - Application Name : <strong class="EmphasisTypeBold ">product-web-1</strong></div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductRestController.getAllProducts:71 - PinnedToPartition? : true</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductRestController.getAllProducts:72 - Thread : Thread[http-nio-8080-exec-1,5,main]</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG LogAccessor.debug:191 - Using Request partition : null</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG LogAccessor.debug:191 - Using <strong class="EmphasisTypeBold ">Request key : product-web-1</strong></div><div class="FixedLine">2024-02-28 17:52:23 DEBUG LogAccessor.debug:191 - Using Reply partition : 0</div><div class="FixedLine">2024-02-28 <strong class="EmphasisTypeBold ">17:52:23</strong> DEBUG LogAccessor.debug:313 - <strong class="EmphasisTypeBold ">Sending</strong>: ProducerRecord(topic=product-req-topic...</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 17:52:27 INFO  ProductRestController.getAllProducts:98 - Ending</div><div class="FixedLine">2024-02-28 17:52:29 DEBUG LogAccessor.debug:313 - Received: product-req-reply-topic-0@0 with correlationId: ec3cceaa-d7e4-4544-add2-4b98ce5e3709</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-18</span><p class="SimplePara">Commands to Run the Product Web Microservice: Instance 1</p></div></div></div><div class="ProgramCode" id="PC24"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-01/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh run2.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 17:50:27 INFO  Logger.log:56 - Started EcomProd...</div><div class="FixedLine">2024-02-28 17:52:23 INFO  ProductRestController.getAllProducts:69 - Start</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductRestController.getAllProducts:70 - Application Name : <strong class="EmphasisTypeBold ">product-web-1</strong></div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductRestController.getAllProducts:71 - PinnedToPartition? : true</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG ProductRestController.getAllProducts:72 - Thread : Thread[http-nio-8081-exec-1,5,main]</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG LogAccessor.debug:191 - Using Request partition : null</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG LogAccessor.debug:191 - Using <strong class="EmphasisTypeBold ">Request key : product-web-1</strong></div><div class="FixedLine">2024-02-28 17:52:23 DEBUG LogAccessor.debug:191 - Using Reply partition : 1</div><div class="FixedLine">2024-02-28 <strong class="EmphasisTypeBold ">17:52:23</strong> DEBUG LogAccessor.debug:313 - <strong class="EmphasisTypeBold ">Sending</strong>: ProducerRecord(topic=product-req-topic...</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 17:52:27 INFO  ProductRestController.getAllProducts:98 - Ending</div><div class="FixedLine">2024-02-28 17:52:35 DEBUG LogAccessor.debug:313 - Received: product-req-reply-topic-1@0 with correlationId: 8403edb7-e702-4e05-8341-ed7a2b2bd3ba</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-19</span><p class="SimplePara">Commands to Run the Product Web Microservice: Instance 2</p></div></div></div></div>

          <p class="Para" id="Par74">Now that both microservices are up and running, you are ready to test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec12">

          <h3 class="Heading">Testing Sequential Request Processing</h3>

          <p class="Para" id="Par75"><span id="ITerm41">When</span> all is set, you can access the web application using cURL clients.</p>

          <p class="Para" id="Par76">To test the processing of requests in sequential order within a single partition, you need to configure the <span class="EmphasisFontCategoryNonProportional ">pinnedToPartition</span> with a <span class="EmphasisFontCategoryNonProportional ">true</span> value, which is shown in Listing <span class="InternalRef"><a href="#PC9">5-7</a></span>.</p>

          <p class="Para" id="Par77">For testing, the intention is to fire more than one request to the Product Web microservices instance concurrently. Since you have pinned requests from the Product Web microservices to the same partition, you know the request messages will be picked up by a single instance of the Product Server microservice.</p>

          <div class="Para" id="Par78">You can now use two separate terminals to run cURL client commands concurrently (more or less), as shown in Listings <span class="InternalRef"><a href="#PC25">5-20</a></span> and <span class="InternalRef"><a href="#PC26">5-21</a></span>.<div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-01/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh curlrun1.sh</div><div class="FixedLine">Firing http://127.0.0.1:8080/productsweb and waiting...</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Wed Feb 28 <strong class="EmphasisTypeBold ">17:52:23</strong> IST 2024</div><div class="FixedLine">==========================================</div><div class="FixedLine">{"products":[{"productId":"1","name":"Kamsung ...</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Wed Feb 28 17:52:29 IST 2024</div><div class="FixedLine">==========================================</div><div class="FixedLine">Response from http://127.0.0.1:8080/productsweb received.</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-20</span><p class="SimplePara">Commands to Test Using cURL: Client 1</p></div></div></div><div class="ProgramCode" id="PC26"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-01/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh curlrun2.sh</div><div class="FixedLine">Firing http://127.0.0.1:8081/productsweb and waiting...</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Wed Feb 28 <strong class="EmphasisTypeBold ">17:52:23</strong> IST 2024</div><div class="FixedLine">==========================================</div><div class="FixedLine">{"products":[{"productId":"1","name":"Kamsung ...</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Wed Feb 28 17:52:35 IST 2024</div><div class="FixedLine">==========================================</div><div class="FixedLine">Response from http://127.0.0.1:8081/productsweb received.</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-21</span><p class="SimplePara">Commands to Test Using cURL: Client 2</p></div></div></div></div>

          <div class="Para" id="Par79">Listings <span class="InternalRef"><a href="#PC25">5-20</a></span> and <span class="InternalRef"><a href="#PC26">5-21</a></span> show that you can send requests from clients more or less concurrently (at time <span class="EmphasisFontCategoryNonProportional ">17:52:23</span>). Listings <span class="InternalRef"><a href="#PC23">5-18</a></span> and <span class="InternalRef"><a href="#PC24">5-19</a></span> further show that the same instance of the Product Web microservice has also attempted to relay these requests to the Product Server microservice more or less concurrently:<div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine">2024-02-28 17:52:23 DEBUG LogAccessor.debug:313 - Sending: ProducerRecord(topic=product-req-topic...</div><div class="FixedLine">2024-02-28 17:52:23 DEBUG LogAccessor.debug:313 - Sending: ProducerRecord(topic=product-req-topic...</div></div></div></div>

          <div class="Para" id="Par80">However, careful observation of Listing <span class="InternalRef"><a href="#PC22">5-17</a></span> will reveal that the Product Server microservice performs computation against the messages received sequentially, which is the order in which messages arrive at the Product Server microservice:<div class="ProgramCode" id="PC28"><div class="LineGroup"><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 17:52:23 INFO  ProductListener.listenWithHeaders:57 – Start</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 <strong class="EmphasisTypeBold ">17:52:29</strong> INFO  ProductListener.listenWithHeaders:80 - <strong class="EmphasisTypeBold ">Ending</strong>...</div><div class="FixedLine">2024-02-28 <strong class="EmphasisTypeBold ">17:52:29</strong> INFO  ProductListener.listenWithHeaders:57 – <strong class="EmphasisTypeBold ">Start</strong></div><div class="FixedLine">...</div><div class="FixedLine">2024-02-28 17:52:35 INFO  ProductListener.listenWithHeaders:80 - Ending...</div></div></div></div>

          <div class="Para" id="Par81">When you bring up more instances of the Product Web microservice, if you want to make sure they are all pinned to the same Topic partition, you need to tweak the default values for the <span class="EmphasisFontCategoryNonProportional ">appName</span> configured through the run scripts in the root folder of the Product Web microservice. The default values are as follows:<div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine">-Dspring.application.name=<strong class="EmphasisTypeBold ">product-web-1</strong></div><div class="FixedLine">-Dspring.application.name=<strong class="EmphasisTypeBold ">product-web-1</strong></div></div></div><figure class="Figure" id="Fig11"><div class="MediaObject" id="MO11"><img alt="" aria-describedby="d64e2263" src="../images/619782_1_En_5_Chapter/Imagem-059.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2263"><p class="Para" id="Par135">A diagram presents an event-driven architecture for communication between product web microservice instances and product server microservice instances, utilizing an event queue with multiple partitions for scalability. Each partition includes an event queue.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-11</span><p class="SimplePara">Microservice instances pinned to the same message topic partition</p></div></figcaption></figure></div>

          <p class="Para" id="Par82">In doing so, as shown in Figure <span class="InternalRef"><a href="#Fig11">5-11</a></span>, messages from all the instances of the Product Web microservice can be pinned to be delivered to the same partition, say Partition 1 (shown with a tick mark). Consequently, messages from all the instances of the Product Web microservice can be served by a single instance of the Product Server microservice.</p>

          <div class="Para" id="Par83">The <span id="ITerm42">message processing schema</span> of the (Product Server) microservice instance processing messages in sequence, and hence in order, is shown in Figure <span class="InternalRef"><a href="#Fig12">5-12</a></span>.<figure class="Figure" id="Fig12"><div class="MediaObject" id="MO12"><img alt="" aria-describedby="d64e2301" src="../images/619782_1_En_5_Chapter/Imagem-060.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2301"><p class="Para" id="Par136">A diagram presents a request-to-reply communication model between a request topic and a reply topic, facilitated by a provider microservice instance that processes messages across partitions. The partitions from the request topic are transferred to the reply topic.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-12</span><p class="SimplePara">Microservice processing requests in sequence<span id="ITerm43"></span></p></div></figcaption></figure></div>

          <p class="Para" id="Par84">Before I conclude, the next section inspects the assignment of partitions that were configured in Listings <span class="InternalRef"><a href="#PC9">5-7</a></span> and <span class="InternalRef"><a href="#PC15">5-10</a></span>.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec13">

          <h3 class="Heading">Inspecting the Microservice Partition assignment</h3>

          <div class="Para" id="Par85">This section starts by looking at the <span id="ITerm44">different</span> topics created automatically when you bring the microservice instances up. See Listing <span class="InternalRef"><a href="#PC30">5-22</a></span>.<div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:kafka_2.13-2.5.0 binil$ sh bin/kafka-topics.sh --zookeeper localhost:2181 --list</div><div class="FixedLine">__consumer_offsets</div><div class="FixedLine">product-req-reply-topic</div><div class="FixedLine">product-req-topic</div><div class="FixedLine">binildass-MacBook-Pro:kafka_2.13-2.5.0 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-22</span><p class="SimplePara">Commands to List the Kafka Topics</p></div></div></div></div>

          <div class="Para" id="Par86">With reference to the number of partitions configured for the Product Web microservice in Listing <span class="InternalRef"><a href="#PC9">5-7</a></span>, the partition assignments are shown in Listing <span class="InternalRef"><a href="#PC31">5-23</a></span>.<div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:kafka_2.13-2.5.0 binil$ bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group product-web</div></div><div class="LineGroup"><div class="FixedLine">GROUP           TOPIC                   PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                                 HOST            CLIENT-ID</div><div class="FixedLine">product-web     product-req-reply-topic 1          0               0               0               consumer-product-web-1-c457cc3e-cf76-4788-9230-19c89f016333 /127.0.0.1      consumer-product-web-1</div><div class="FixedLine">product-web     product-req-reply-topic 0          0               0               0          consumer-product-web-1-347b84e6-d51a-4561-b5d1-3ec54378a47c /127.0.0.1      consumer-product-web-1</div><div class="FixedLine">binildass-MacBook-Pro:kafka_2.13-2.5.0 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-23</span><p class="SimplePara">Assignment of Kafka Topic Partitions for the Product Web Microservice</p></div></div></div></div>

          <div class="Para" id="Par87">With reference to the number of partitions configured for the Product Server microservice in Listing <span class="InternalRef"><a href="#PC15">5-10</a></span>, the partition assignments are shown in Listing <span class="InternalRef"><a href="#PC32">5-24</a></span>.<div class="ProgramCode" id="PC32"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:kafka_2.13-2.5.0 binil$ bin/kafka-consumer-groups.sh --bootstrap-server localhost:9092 --describe --group product-server</div></div><div class="LineGroup"><div class="FixedLine">GROUP           TOPIC             PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                HOST     CLIENT-ID</div><div class="FixedLine">product-server  product-req-topic 2          0               0        0               consumer-product-server-1-f2ae14f5-3964-4a6f-897e-954d3c447669 /127.0.0.1      consumer-product-server-1</div><div class="FixedLine">product-server  product-req-topic 1          0               0        0               consumer-product-server-1-865f46aa-a4fe-4031-830d-8c182f74cb42 /127.0.0.1      consumer-product-server-1</div><div class="FixedLine">product-server  product-req-topic 0          0               0        0               consumer-product-server-1-436a6f12-2073-4c43-a201-0981ed94f286 /127.0.0.1      consumer-product-server-1</div><div class="FixedLine">binildass-MacBook-Pro:kafka_2.13-2.5.0 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-24</span><p class="SimplePara">Assignment of Kafka Topic Partitions for the Product Server Microservice</p></div></div></div></div>

          <p class="Para" id="Par88">This extra partition assignment information can help you if you need to explore with the demonstration code further.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec14">

        <h2 class="Heading">Microservices Parallel Processing</h2>

        <p class="Para" id="Par89">This slightly altered example leverages the same set of microservices in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>, which are tweaked to demonstrate the sequential processing in the just previous sample. A consumer and a provider microservice communicate with each other using a messaging channel. The provider microservice stores the entity in an in-memory database, to keep the example simple. Moreover, when the browser sends requests to the first (consumer) microservice, the example uses async HTTP.</p>

        <p class="Para" id="Par90">The <span id="ITerm45">objective</span> here is to demonstrate that when the same kind of requests from different users or microservice consumers reaches a cluster of instances of a single type of provider microservice, the requests can also be serviced in parallel to improve system scalability.</p>

        <section class="Section2 RenderAsSection2" id="Sec15">

          <h3 class="Heading">Design Parallel Processing Microservices</h3>

          <div class="Para" id="Par91">Figure <span class="InternalRef"><a href="#Fig13">5-13</a></span> shows a modified version of the Hexagonal microservice view shown in Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span>. This allows both microservices to communicate through an async channel. Apache Kafka is again used as the <span id="ITerm46">messaging channel</span>, which is inherently asynchronous.<figure class="Figure" id="Fig13"><div class="MediaObject" id="MO13"><img alt="" aria-describedby="d64e2456" src="../images/619782_1_En_5_Chapter/Imagem-061.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2456"><p class="Para" id="Par137">A diagram illustrates an event-driven microservice architecture that involves product web microservice instances and product server microservice instances, connected via an event queue. The event queue is processed between many to many or any to any channels.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-13</span><p class="SimplePara">Microservice instances load balanced to many topic partitions</p></div></figcaption></figure></div>

          <p class="Para" id="Par92">The more partitions a topic has, the higher the concurrency you can achieve and therefore the higher the potential throughput. In Kafka, each partition must be allocated to only one consumer. So, you can have a maximum of one consumer per partition. This means that you can only have as many consumers (in a single consumer group) as there are partitions for a topic, but you may have fewer. If there are fewer consumers than partitions, consumers may process records from one or more partitions. To summarize, the maximum throughput will be achieved when you have one consumer per partition, or when you have as many consumers as there are partitions.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec16">

          <h3 class="Heading">Parallelism and Thread Safety</h3>

          <div class="Para" id="Par93">Figure <span class="InternalRef"><a href="#Fig14">5-14</a></span> portrays the discussions in the previous <span id="ITerm47">section</span>. You have seen that you can only have as many consumers (in a single consumer group) as there are partitions for a topic. If you have more consumers than the number of partitions, extra consumers may not be assigned with a partition.<figure class="Figure" id="Fig14"><div class="MediaObject" id="MO14"><img alt="" aria-describedby="d64e2491" src="../images/619782_1_En_5_Chapter/Imagem-062.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2491"><p class="Para" id="Par138">A diagram depicts two topologies, not a feasible and a feasible. On the left, the partitions are processed through the event queue with many consumers followed by message listeners. On the right, the partitions are processed through the event queue with the same consumer followed by listeners.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-14</span><p class="SimplePara">Microservice <span id="ITerm48">consumers vs. partition assignment</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par94">Kafka producers are thread-safe and can be shared among multiple threads. However, Kafka consumers are not thread-safe by design. Hence, you can’t share the same consumer instance among multiple threads. The default Kafka consumer is single-threaded, so it can only process records sequentially, as you saw in the example in the previous section. So, how can you increase parallelism?</p>

          <p class="Para" id="Par95">Because single-threaded consumers can’t concurrently process regardless of being assigned to multiple partitions, the straightforward solution is to increase the number of partitions and consumers simultaneously, which is what you will attempt in this section. However, this design has its own caveats, since for high-transactional systems it is not feasible to have too many consumers, requiring as many partitions to support as there are consumers, potentially millions. In such scenarios, you need to adopt a heterogenous strategy of decoupling the consumption and acknowledgment of messages from time-consuming message processing, which is not in the scope of this demonstration.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec17">

          <h3 class="Heading">Understanding the Code</h3>

          <p class="Para" id="Par96">The <span id="ITerm49">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch05\ch05-02</span> folder. This code is the same as the first example in this chapter, but it’s configured differently. This section looks at the changes in the consumer microservice—the Product Web microservice.</p>

          <div class="Para" id="Par97">The main parts of the Product Web microservice configuration are shown in Listing <span class="InternalRef"><a href="#PC33">5-25</a></span>.<div class="ProgramCode" id="PC33"><div class="LineGroup"><div class="FixedLine">server:</div><div class="FixedLine">    port: 8080</div><div class="FixedLine">spring:</div><div class="FixedLine">    ...</div><div class="FixedLine">    kafka:</div><div class="FixedLine">        bootstrap-servers: localhost:9092</div><div class="FixedLine">        consumer:</div><div class="FixedLine">            auto-offset-reset: earliest</div><div class="FixedLine">            group-id: product-web</div><div class="FixedLine">kafka:</div><div class="FixedLine">    topic:</div><div class="FixedLine">        product:</div><div class="FixedLine">            request: product-req-topic</div><div class="FixedLine">            pinnedToPartition: false</div><div class="FixedLine">            reply: product-req-reply-topic</div><div class="FixedLine">    request-reply:</div><div class="FixedLine">        timeout-ms: 60000</div><div class="FixedLine">product:</div><div class="FixedLine">    topic:</div><div class="FixedLine">        request:</div><div class="FixedLine">            numPartitions: 3</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-25</span><p class="SimplePara">Configuration for the Product Web Microservice (ch05\ch05-02\02-ProductWeb\src\main\resources\application.yml)</p></div></div></div></div>

          <p class="Para" id="Par98">The <span class="EmphasisFontCategoryNonProportional ">pinnedToPartition</span> is configured with <span class="EmphasisFontCategoryNonProportional ">false</span>, since you leave the assignment of Product Web microservice instances to the available partitions in the underlying library.</p>

          <div class="Para" id="Par99">You can configure values for the <span class="EmphasisFontCategoryNonProportional ">appName</span> through the <span class="EmphasisFontCategoryNonProportional ">run</span> scripts in the root folder of the Product Web microservice:<div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine">-Dspring.application.name=<strong class="EmphasisTypeBold ">product-web-1</strong></div><div class="FixedLine">-Dspring.application.name=<strong class="EmphasisTypeBold ">product-web-2</strong></div><div class="FixedLine">-Dspring.application.name=<strong class="EmphasisTypeBold ">product-web-3</strong></div></div></div></div>

          <p class="Para" id="Par100">Since the <span class="EmphasisFontCategoryNonProportional ">pinnedToPartition</span> is configured with <span class="EmphasisFontCategoryNonProportional ">false</span>, you are not leveraging the <span class="EmphasisFontCategoryNonProportional ">appName</span> for any partition stickiness, so it doesn’t matter whether you configure the same values or different values for the <span class="ExternalRef"><a href="http://spring.application.name"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">spring.application.name</span></span></a></span>.</p>

          <p class="Para" id="Par101">In Listing <span class="InternalRef"><a href="#PC33">5-25</a></span>, you may notice the configuration <span class="EmphasisFontCategoryNonProportional ">numPartitions: 3</span>. The number is arbitrary, but it should be more than the number of (instances of) requester microservices, since otherwise the system will throw errors. The number of instances for the Product Server microservices is also three.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec18">

          <h3 class="Heading">Build and Run the Microservice Parallel Processing</h3>

          <p class="Para" id="Par102">The <span class="EmphasisFontCategoryNonProportional ">ch05\ch05-02</span> folder contains the Maven scripts required to build the examples. As a first step, you need to bring up the Kafka broker. Refer to Appendix D to learn how to set up Kafka server and bring it up. Subsequently, you also need to build and install the utility library from Callista Enterprise, as mentioned in the previous example in this chapter.</p>

          <p class="Para" id="Par103">Next, take six command terminals—three for the Product Server and three for the Product Web microservice—and change the directory to the top-level folder of both microservices.</p>

          <div class="Para" id="Par104"><span id="ITerm50">Build</span> the Product Server microservice using the <span class="EmphasisFontCategoryNonProportional ">make.sh</span> scripts, as shown in Listing <span class="InternalRef"><a href="#PC35">5-26</a></span>.<div class="ProgramCode" id="PC35"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-02/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-26</span><p class="SimplePara">Commands to Build the Product Server Microservice</p></div></div></div></div>

          <div class="Para" id="Par105">Next, build the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC36">5-27</a></span>.<div class="ProgramCode" id="PC36"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-02/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-27</span><p class="SimplePara">Commands to build the Product Web Microservice</p></div></div></div></div>

          <div class="Para" id="Par106">In the first step, you bring up the three instances of the Product Server microservices one by one. You begin by running the Product Server microservices instance 1, as shown in Listing <span class="InternalRef"><a href="#PC37">5-28</a></span>.<div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-02/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run1.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 <strong class="EmphasisTypeBold ">19:52:16</strong> INFO  ProductListener.listenWithHeaders:57 - <strong class="EmphasisTypeBold ">Start</strong></div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 19:52:23 INFO  ProductListener.listenWithHeaders:80 - Ending...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-28</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 1</p></div></div></div></div>

          <div class="Para" id="Par107">Next, you run the Product Server microservices instance 2, as shown in Listing <span class="InternalRef"><a href="#PC38">5-29</a></span>.<div class="ProgramCode" id="PC38"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-02/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run2.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 <strong class="EmphasisTypeBold ">19:52:17</strong> INFO  ProductListener.listenWithHeaders:57 - <strong class="EmphasisTypeBold ">Start</strong></div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 19:52:23 INFO  ProductListener.listenWithHeaders:80 - Ending...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-29</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 2</p></div></div></div></div>

          <div class="Para" id="Par108">Lastly, you run the Product Server microservices instance 3, as shown in Listing <span class="InternalRef"><a href="#PC39">5-30</a></span>.<div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-02/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run3.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 <strong class="EmphasisTypeBold ">19:52:16</strong> INFO  ProductListener.listenWithHeaders:57 - <strong class="EmphasisTypeBold ">Start</strong></div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 19:52:22 INFO  ProductListener.listenWithHeaders:80 - Ending...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-30</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 3</p></div></div></div></div>

          <div class="Para" id="Par109">In the second step, you bring up the three instances of the Product Web microservice one by one. First, run the Product Web microservice instance 1, as shown in Listing <span class="InternalRef"><a href="#PC40">5-31</a></span>.<div class="ProgramCode" id="PC40"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-02/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh run1.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 19:52:16 INFO  ProductRestController.getAllProducts:69 – Start</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 <strong class="EmphasisTypeBold ">19:52:16</strong> DEBUG LogAccessor.debug:313 - <strong class="EmphasisTypeBold ">Sending</strong>: ProducerRecord(topic=product-req-topic,...</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 19:52:22 DEBUG LogAccessor.debug:313 - Received: product-req-reply-topic-2@0 with correlationId: c67dd6d1-83ed-479c-99b4-708f603b48dc</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-31</span><p class="SimplePara">Commands to Run the Product Web Microservice Instance 1</p></div></div></div></div>

          <div class="Para" id="Par110">Listing <span class="InternalRef"><a href="#PC41">5-32</a></span> shows the Product Web microservice instance 2.<div class="ProgramCode" id="PC41"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-02/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh run2.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 19:52:16 INFO  ProductRestController.getAllProducts:69 - Start</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 <strong class="EmphasisTypeBold ">19:52:16</strong> DEBUG LogAccessor.debug:313 - <strong class="EmphasisTypeBold ">Sending</strong>: ProducerRecord(topic=product-req-topic,...</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 19:52:23 DEBUG LogAccessor.debug:313 - Received: product-req-reply-topic-0@0 with correlationId: 2045c904-b6c8-4608-a21b-684943f4ab30</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-32</span><p class="SimplePara">Commands to Run the Product Web Microservice Instance 2</p></div></div></div></div>

          <div class="Para" id="Par111">As a last step, run the Product Web microservices instance 3, as shown in Listing <span class="InternalRef"><a href="#PC42">5-33</a></span>.<div class="ProgramCode" id="PC42"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-02/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh run3.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 19:52:17 INFO  ProductRestController.getAllProducts:69 - Start</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 <strong class="EmphasisTypeBold ">19:52:17</strong> DEBUG LogAccessor.debug:313 - <strong class="EmphasisTypeBold ">Sending</strong>: ProducerRecord(topic=product-req-topic,...</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-29 19:52:23 DEBUG LogAccessor.debug:313 - Received: product-req-reply-topic-1@0 with correlationId: 3bdb5077-8f14-46a0-ae7c-3585dc8a9fce</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-33</span><p class="SimplePara">Commands to Run the Product Web Microservice Instance 3</p></div></div></div></div>

          <p class="Para" id="Par112">Now that both microservices are up and running, you can test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec19">

          <h3 class="Heading">Testing Parallel Request Processing</h3>

          <p class="Para" id="Par113"><span id="ITerm51">When</span> all is set, you can access the web application using cURL clients.</p>

          <p class="Para" id="Par114">To test the processing of requests in parallel, you need to configure the <span class="EmphasisFontCategoryNonProportional ">pinnedToPartition</span> with a <span class="EmphasisFontCategoryNonProportional ">false</span> value, which is done in Listing <span class="InternalRef"><a href="#PC33">5-25</a></span>.</p>

          <div class="Para" id="Par115">For testing, the intention is to fire more than one request to the Product Web microservices concurrently. You can now use three separate terminals to run cURL client commands concurrently (more or less), as shown in Listings <span class="InternalRef"><a href="#PC43">5-34</a></span> through <span class="InternalRef"><a href="#PC45">5-36</a></span>.<div class="ProgramCode" id="PC43"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch05/ch05-02/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh curlrun1.sh</div><div class="FixedLine">Firing http://127.0.0.1:8080/productsweb and waiting...</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Thu Feb 29 19:52:16 IST 2024</div><div class="FixedLine">==========================================</div><div class="FixedLine">{"products":[{"productId":"1","name":"Kamsung ...</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Thu Feb 29 19:52:22 IST 2024</div><div class="FixedLine">==========================================</div><div class="FixedLine">Response from http://127.0.0.1:8080/productsweb received.</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-34</span><p class="SimplePara">Commands to Test Using cURL: Client 1</p></div></div></div><div class="ProgramCode" id="PC44"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh curlrun2.sh</div><div class="FixedLine">Firing http://127.0.0.1:8081/productsweb and waiting...</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Thu Feb 29 19:52:16 IST 2024</div><div class="FixedLine">==========================================</div><div class="FixedLine">{"products":[{"productId":"1","name":"Kamsung...</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Thu Feb 29 19:52:23 IST 2024</div><div class="FixedLine">==========================================</div><div class="FixedLine">Response from http://127.0.0.1:8081/productsweb received.</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-35</span><p class="SimplePara">Commands to Test Using cURL: Client 2</p></div></div></div><div class="ProgramCode" id="PC45"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh curlrun3.sh</div><div class="FixedLine">Firing http://127.0.0.1:8082/productsweb and waiting...</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Thu Feb 29 19:52:17 IST 2024</div><div class="FixedLine">==========================================</div><div class="FixedLine">{"products":[{"productId":"1","name":"Kamsung...</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Thu Feb 29 19:52:23 IST 2024</div><div class="FixedLine">==========================================</div><div class="FixedLine">Response from http://127.0.0.1:8082/productsweb received.</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-36</span><p class="SimplePara">Commands to Test Using cURL: Client 3</p></div></div></div></div>

          <div class="Para" id="Par116">Careful observation of Listings <span class="InternalRef"><a href="#PC43">5-34</a></span> through <span class="InternalRef"><a href="#PC45">5-36</a></span> will show that the program can fire cURL clients more or less concurrently with the Product Web microservice instances. Subsequently, from Listings <span class="InternalRef"><a href="#PC40">5-31</a></span> through <span class="InternalRef"><a href="#PC42">5-33</a></span>, it’s clear that the different Product Web microservice instances can also relay these requests more or less at the same time to different Product Server microservice instances in a load balanced manner.<div class="ProgramCode" id="PC46"><div class="LineGroup"><div class="FixedLine">2024-02-29 19:52:16 INFO  ProductRestController.getAllProducts:69 – Start</div><div class="FixedLine">2024-02-29 19:52:16 INFO  ProductRestController.getAllProducts:69 - Start</div><div class="FixedLine">2024-02-29 19:52:17 INFO  ProductRestController.getAllProducts:69 - Start</div></div></div></div>

          <div class="Para" id="Par117">Next, observe the processing of requests in different instances of the Product Server microservice in Listings <span class="InternalRef"><a href="#PC37">5-28</a></span> through <span class="InternalRef"><a href="#PC39">5-30</a></span>. They show that message processing happens more or less concurrently in a load balanced manner:<div class="ProgramCode" id="PC47"><div class="LineGroup"><div class="FixedLine">2024-02-29 19:52:16 INFO  ProductListener.listenWithHeaders:57 - Start</div><div class="FixedLine">2024-02-29 19:52:17 INFO  ProductListener.listenWithHeaders:57 - Start</div><div class="FixedLine">2024-02-29 19:52:16 INFO  ProductListener.listenWithHeaders:57 - Start</div></div></div></div>

          <div class="Para" id="Par118">The message processing schema of the microservice instance is processing messages concurrently, and could be processing out of order, as shown in Figure <span class="InternalRef"><a href="#Fig15">5-15</a></span>.<figure class="Figure" id="Fig15"><div class="MediaObject" id="MO15"><img alt="" aria-describedby="d64e3092" src="../images/619782_1_En_5_Chapter/Imagem-063.jpg" style="width:35.15em"/><div class="TextObject" id="d64e3092"><p class="Para" id="Par139">A diagram illustrates a request-reply model using a kafka-like system with request topics and replies topics across provider microservice instances. The request topic has multiple partitions, where requests are placed into specific partitions.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 5-15</span><p class="SimplePara">Microservice <span id="ITerm52">consumer vs. partition assignments</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par119">When the microservices are up and running, you can also access the web application using your browser and pointing to the URL:</p>

          <p class="Para ParaOneEmphasisChild" id="Par120"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/product.html</span></p>

          <p class="Para ParaOneEmphasisChild" id="Par121"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8081/product.html</span></p>

          <p class="Para ParaOneEmphasisChild" id="Par122"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8082/product.html</span></p>

          <p class="Para" id="Par123">You might have to wait at the browser console a bit, since the browser is rendered with the data only eventually, due to the sleep delays provisioned in the microservices.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec20">

        <h2 class="Heading">Summary</h2>

        <p class="Para" id="Par124">One major benefit of an event-driven architecture using a message-oriented microservice is decoupling the event producer microservice from the event consumer microservice, allowing for more flexible and evolvable systems. Relying on a synchronous Request-Reply semantics is the exact opposite, where the producer and consumer microservices are tightly coupled. This should only be used when needed. If synchronous Request-Reply is required, an HTTP-based protocol is much simpler, more straightforward, and more efficient than using an asynchronous channel like Apache Kafka. Having said this, there may be scenarios when using synchronous styled Request-Reply makes sense. You might need to wisely choose from the combination of available choices for the job at hand. The examples in this chapter have demonstrated the retrieval of a collection of Product entities over a messaging channel. You might now naturally think about whether the style of inter-microservice interactions explained in this chapter could be used in real life to cover full-fledged business use cases, and this is what Chapter <span class="ExternalRef"><a href="Capítulo-08.html"><span class="RefSource">6</span></a></span> covers.</p>

      </section>

    </div>

  </div>

</body>

</html>