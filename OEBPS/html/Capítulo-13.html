<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en">

<head>
  <title>Message Oriented Microservices in Kubernetes</title>
  <link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>

<body>

  <div epub:type="chapter" role="doc-chapter">

    <div class="ChapterContextInformation">

      <div class="ContextInformation" id="b979-8-8688-0555-4_11"><div class="ChapterCopyright">© The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature 2024</div><span class="ContextInformationAuthorEditorNames">B. A. Christudas</span><span class="ContextInformationBookTitles"><span class="BookTitle">Java Microservices and Containers in the Cloud</span></span><span class="ChapterDOI"><a href="https://doi.org/10.1007/979-8-8688-0555-4_11">https://doi.org/10.1007/979-8-8688-0555-4_11</a></span></div>

    </div>

    <!--Begin Abstract-->

    <div class="MainTitleSection">

      <h1 class="ChapterTitle" lang="en">11. Message Oriented Microservices in Kubernetes</h1>

    </div>

    <div class="AuthorGroup">

      <div class="AuthorNames"><span class="Author"><span class="AuthorName">Binildas A. Christudas</span><sup><a href="#Aff2">1</a> <span class="ContactIcon"> </span></sup></span></div>

      <div class="Affiliations">

        <div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">NBCRA 45, Christbin, Thiruvananthapuram, Kerala, India</div></div>

        <div class="ClearBoth"> </div>

      </div>

    </div>

    <!--End Abstract-->

    <div class="Fulltext">

      <p class="Para" id="Par2">In Chapter <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span>, you learned how <span id="ITerm1">Kubernetes</span><span id="ITerm2"></span> does container orchestration, which greatly improves the manageability of operating microservices. This is even more important as the number of microservices goes up. You also saw some resiliency aspects of Kubernetes and through the examples you saw how a pod is re-created when you delete an existing pod. You also saw how a state is restored after re-creating a pod.</p>

      <p class="Para" id="Par3"><span id="ITerm3">Scalability and resiliency</span> are two desirable qualities for every production-grade application. When you attempt to improve these two qualities, you make the operating environment more chaotic. This is true for a microservices architecture, since you need to manage more types of services and a greater number of each type of service.</p>

      <p class="Para" id="Par4">In Chapter <span class="ExternalRef"><a href="Capítulo-08.html"><span class="RefSource">6</span></a></span>, you learned about a consumer and provider microservice communicating with each other using Kafka as the messaging channel. The provider microservice stores the entity in a <span id="ITerm4">database</span>. In Chapter <span class="ExternalRef"><a href="Capítulo-11.html"><span class="RefSource">9</span></a></span>, you modified those same examples, leveraging containerization as a runtime option. In this chapter, you will revisit them and use Kubernetes for deployment.</p>

      <div class="Para" id="Par5">This chapter is a continuation of Chapter <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span>, so it’s fully hands on and covers the following three scenarios:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par6">Microservices communicating over Kafka and interacting with PostgreSQL</p></li><li><p class="Para" id="Par7">Microservices communicating over Kafka and interacting with MongoDB</p></li><li><p class="Para" id="Par8">Using Ingress to access coordinating microservices</p></li></ul></div></div>

      <p class="Para" id="Par9">The following section gets straight into those examples.</p>

      <section class="Section1 RenderAsSection1" id="Sec1">

        <h2 class="Heading">Microservices Over Kafka with PostgreSQL in k8s</h2>

        <p class="Para" id="Par10">This example tweaks the same set of microservices from Chapter <span class="ExternalRef"><a href="Capítulo-08.html"><span class="RefSource">6</span></a></span> in the section titled “CRUD Microservices over Kafka on PostgreSQL” and from Chapter <span class="ExternalRef"><a href="Capítulo-11.html"><span class="RefSource">9</span></a></span> in the section titled “Composing Microservice with PostgreSQL Containers.” A consumer and provider microservice communicate with each other using Kafka as the messaging channel. The provider microservice stores the entity in a <span id="ITerm5">PostgreSQL database</span>. When the browser sends a request to the first (consumer) microservice, it uses async HTTP. Even though it uses async HTTP, the example emulates a sync-style user experience at the client device level, a browser in this case.</p>

        <p class="Para" id="Par11">The example also contains multiple instances of the consumer and provider microservices and uses <span id="ITerm6">multiple clients</span> while testing the service.</p>

        <section class="Section2 RenderAsSection2" id="Sec2">

          <h3 class="Heading">Design the Microservices Orchestration Topology</h3>

          <div class="Para" id="Par12">This example uses a modified version of the <span id="ITerm7">hexagonal</span> microservice view shown in Figure <span class="ExternalRef"><a href="Capítulo-11.html#Fig3"><span class="RefSource">9-3</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-11.html"><span class="RefSource">9</span></a></span>. Both microservices communicate through an <span id="ITerm8">async channel</span>. Apache Kafka is the messaging channel, which is inherently asynchronous. This modified design is shown in Figure <span class="InternalRef"><a href="#Fig1">11-1</a></span>.<figure class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img alt="" aria-describedby="d64e285" src="../images/619782_1_En_11_Chapter/Imagem-118.jpg" style="width:35.15em"/><div class="TextObject" id="d64e285"><p class="Para" id="Par105">A 3 D model diagram of the user connected to the browser, product web mu S, Kafka infrastructure service with event queue and partitions 1 and 2, product server mu S, container engine with functions, host O S, and hardware with C P U, disk, and others. Product web includes 3 business services, and product server includes 3 business services and 1 application service.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-1</span><p class="SimplePara">Kubernetes orchestration topology for microservices</p></div></figcaption></figure></div>

          <p class="Para" id="Par13">Here, the Product Web and <span id="ITerm9">Product Server</span> containers provide business services, whereas the Mongo container provides application services to persist the state. The Kafka container provides infrastructure services, so it’s not shown as a part of any specific (business) microservice.</p>

          <p class="Para" id="Par14">Another aspect you need to note in Figure <span class="InternalRef"><a href="#Fig1">11-1</a></span> is that you have multiple instances of the Product Web and Product Server microservices. This will help you experiment with sticky and <span id="ITerm10">load-balanced scenarios</span>, like you did in Chapter <span class="ExternalRef"><a href="Capítulo-08.html"><span class="RefSource">6</span></a></span>.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec3">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par15">The <span id="ITerm11">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch11\ch11-01</span> folder. Much of the source code in this example is like <span class="EmphasisFontCategoryNonProportional ">ch09\ch09-03</span>, which I explained in detail in Chapter <span class="ExternalRef"><a href="Capítulo-11.html"><span class="RefSource">9</span></a></span>. In the example in Chapter <span class="ExternalRef"><a href="Capítulo-11.html"><span class="RefSource">9</span></a></span>, the deployment architecture is similar, but it used Docker Compose instead of Kubernetes. In the second example—<span class="EmphasisFontCategoryNonProportional ">ch10\ch10-02</span>—in Chapter <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span>, you also looked at the Kubernetes-based deployment of the two microservices and PostgreSQL. What’s left is the Kubernetes deployment of Kafka alone.</p>

          <div class="Para" id="Par16">A summarized representation of the source code organization for the example inside the <span class="EmphasisFontCategoryNonProportional ">ch11-01</span> folder is shown in Listing <span class="InternalRef"><a href="#PC1">11-1</a></span>.<div class="ProgramCode" id="PC1"><div class="LineGroup"><div class="FixedLine">./ch11-01/</div><div class="FixedLine">├── 01-ProductServer</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── 02-ProductWeb</div><div class="FixedLine">│   ├── pingrun1.sh</div><div class="FixedLine">│   ├── pingrun2.sh</div><div class="FixedLine">│   ├── pingrun3.sh</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── Dockerfile</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── kafka-deployment.yml</div><div class="FixedLine">├── kafka-request-reply-util</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── kafka-svc.yml</div><div class="FixedLine">├── makeandrun.sh</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">├── postgres-config.yml</div><div class="FixedLine">├── postgres-deployment.yml</div><div class="FixedLine">├── postgres-pvc.yml</div><div class="FixedLine">├── postgres-svc.yml</div><div class="FixedLine">├── product-server-deployment.yml</div><div class="FixedLine">├── product-server-service.yml</div><div class="FixedLine">├── product-web-deployment.yml</div><div class="FixedLine">└── product-web-service.yml</div></div><div class="LineGroup"><div class="FixedLine">42 directories, 53 files</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-1</span><p class="SimplePara">Example 11-01 <span id="ITerm12">Source Code Organization</span></p></div></div></div></div>

          <div class="Para" id="Par17">As you can verify from Listing <span class="InternalRef"><a href="#PC1">11-1</a></span>, all the descriptors are familiar except for <span class="EmphasisFontCategoryNonProportional ">kafka*.yml</span>. Listing <span class="InternalRef"><a href="#PC2">11-2</a></span> shows these new descriptors.<div class="ProgramCode" id="PC2"><div class="LineGroup"><div class="FixedLine">---</div><div class="FixedLine">apiVersion: apps/v1</div><div class="FixedLine">kind: Deployment</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: zookeeper-deployment</div><div class="FixedLine">spec:</div><div class="FixedLine">  replicas: 1</div><div class="FixedLine">  selector:</div><div class="FixedLine">    matchLabels:</div><div class="FixedLine">      component: zookeeper</div><div class="FixedLine">  template:</div><div class="FixedLine">    metadata:</div><div class="FixedLine">      labels:</div><div class="FixedLine">        component: zookeeper</div><div class="FixedLine">    spec:</div><div class="FixedLine">      containers:</div><div class="FixedLine">      - name: zookeeper</div><div class="FixedLine">        image: digitalwonderland/zookeeper</div><div class="FixedLine">        ports:</div><div class="FixedLine">          - containerPort: 2181</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-2</span><p class="SimplePara">The <span id="ITerm13">Zookeeper Deployment YAML File</span> (ch11\ch11-01\kafka-deployment.yml)</p></div></div></div></div>

          <div class="Para" id="Par18">Listing <span class="InternalRef"><a href="#PC2">11-2</a></span> uses <span class="EmphasisFontCategoryNonProportional ">digitalwonderland/zookeeper</span> as the zookeeper image. The rest of the lines are self-explanatory. Listing <span class="InternalRef"><a href="#PC3">11-3</a></span> investigates the Kafka descriptors.<div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine">---</div><div class="FixedLine">apiVersion: apps/v1</div><div class="FixedLine">kind: Deployment</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: kafka-1-deployment</div><div class="FixedLine">spec:</div><div class="FixedLine">  replicas: 1</div><div class="FixedLine">  selector:</div><div class="FixedLine">    matchLabels:</div><div class="FixedLine">      component: kafka-1</div><div class="FixedLine">  template:</div><div class="FixedLine">    metadata:</div><div class="FixedLine">      labels:</div><div class="FixedLine">        component: kafka-1</div><div class="FixedLine">    spec:</div><div class="FixedLine">      containers:</div><div class="FixedLine">      - name: kafka-1</div><div class="FixedLine">        image: pharosproduction/kafka_k8s:v1</div><div class="FixedLine">        resources:</div><div class="FixedLine">          requests:</div><div class="FixedLine">            memory: "256Mi"</div><div class="FixedLine">            cpu: "250m"</div><div class="FixedLine">          limits:</div><div class="FixedLine">            memory: "512Mi"</div><div class="FixedLine">            cpu: "500m"</div><div class="FixedLine">        ports:</div><div class="FixedLine">          - containerPort: 9092</div><div class="FixedLine">        env:</div><div class="FixedLine">          - name: MY_POD_IP</div><div class="FixedLine">            valueFrom:</div><div class="FixedLine">              fieldRef:</div><div class="FixedLine">                fieldPath: status.podIP</div><div class="FixedLine">          - name: KAFKA_ADVERTISED_PORT</div><div class="FixedLine">            value: "9092"</div><div class="FixedLine">          - name: KAFKA_ZOOKEEPER_CONNECT</div><div class="FixedLine">            value: zookeeper-ip-service:2181</div><div class="FixedLine">          - name: KAFKA_ADVERTISED_HOST_NAME</div><div class="FixedLine">            value: $(MY_POD_IP)</div><div class="FixedLine">          - name: KAFKA_BROKER_ID</div><div class="FixedLine">            value: "1"</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-3</span><p class="SimplePara">The <span id="ITerm14">Kafka Deployment YAML File</span> (ch11\ch11-01\kafka-deployment.yml)</p></div></div></div></div>

          <div class="Para" id="Par19">The <span class="EmphasisFontCategoryNonProportional ">pharosproduction/kafka_k8s:v1</span> image is used for the Kafka server. You can see that the <span class="EmphasisFontCategoryNonProportional ">kafka</span> deployment refers to the <span class="EmphasisFontCategoryNonProportional ">zookeeper-ip-service</span>, the service name for the <span id="ITerm15">zookeeper service</span> that’s configured in Listing <span class="InternalRef"><a href="#PC4">11-4</a></span>.<div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine">---</div><div class="FixedLine">apiVersion: v1</div><div class="FixedLine">kind: Service</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: zookeeper-ip-service</div><div class="FixedLine">spec:</div><div class="FixedLine">  type: ClusterIP</div><div class="FixedLine">  selector:</div><div class="FixedLine">    component: zookeeper</div><div class="FixedLine">  ports:</div><div class="FixedLine">  - name: zookeeper</div><div class="FixedLine">    port: 2181</div><div class="FixedLine">    targetPort: 2181</div><div class="FixedLine">  type: NodePort</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-4</span><p class="SimplePara">The Zookeeper Service YAML File (ch11\ch11-01\kafka-svct.yml)</p></div></div></div></div>

          <p class="Para" id="Par20">The <span id="ITerm16"><span class="EmphasisFontCategoryNonProportional ">zookeeper-ip-service</span></span> is also configured to have a <span class="EmphasisFontCategoryNonProportional ">NodePort</span>. This will help you to interact with the message broker from outside the Kubernetes cluster to do some kind of basic queue management, which is demonstrated later, in Listings <span class="InternalRef"><a href="#PC17">11-17</a></span> and <span class="InternalRef"><a href="#PC18">11-18</a></span>.</p>

          <div class="Para" id="Par21">Last but not the least, Listing <span class="InternalRef"><a href="#PC5">11-5</a></span> looks at the definition for the Kafka service.<div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">---</div><div class="FixedLine">apiVersion: v1</div><div class="FixedLine">kind: Service</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: kafka-1-ip-service</div><div class="FixedLine">spec:</div><div class="FixedLine">  type: ClusterIP</div><div class="FixedLine">  selector:</div><div class="FixedLine">    component: kafka-1</div><div class="FixedLine">  ports:</div><div class="FixedLine">  - name: kafka</div><div class="FixedLine">    port: 9092</div><div class="FixedLine">    targetPort: 9092</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-5</span><p class="SimplePara">The <span id="ITerm17">Kafka Service YAML File</span> (ch11\ch11-01\kafka-svct.yml)</p></div></div></div></div>

          <div class="Para" id="Par22">The <span id="ITerm18">Product Server microservice</span> pod refers to the <span class="EmphasisFontCategoryNonProportional ">kafka</span> service as the message broker to receive messages from the Product Web microservice. See Listing <span class="InternalRef"><a href="#PC6">11-6</a></span>.<div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">apiVersion: apps/v1</div><div class="FixedLine">kind: Deployment</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: product-server</div><div class="FixedLine">  ...</div><div class="FixedLine">spec:</div><div class="FixedLine">  replicas: 3</div><div class="FixedLine">  ...</div><div class="FixedLine">  template:</div><div class="FixedLine">    ...</div><div class="FixedLine">    spec:</div><div class="FixedLine">      containers:</div><div class="FixedLine">      - name: product-server</div><div class="FixedLine">        ...</div><div class="FixedLine">        env:</div><div class="FixedLine">          - name: DB_SERVER</div><div class="FixedLine">            value: postgres</div><div class="FixedLine">          - name: spring.kafka.bootstrap-servers</div><div class="FixedLine">            value: kafka-1-ip-service:9092</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-6</span><p class="SimplePara">The Product Server Pod YAML File (ch11\ch11-01\product-server-deployment.yml)</p></div></div></div></div>

          <div class="Para" id="Par23">The <span id="ITerm19">Product Web microservice pod</span> also refers to the same <span class="EmphasisFontCategoryNonProportional ">kafka</span> service as the message broker to send messages to the Product Server microservice. See Listing <span class="InternalRef"><a href="#PC7">11-7</a></span>.<div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine">apiVersion: apps/v1</div><div class="FixedLine">kind: Deployment</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: product-web</div><div class="FixedLine">  ...</div><div class="FixedLine">spec:</div><div class="FixedLine">  replicas: 3</div><div class="FixedLine">  ...</div><div class="FixedLine">  template:</div><div class="FixedLine">    ...</div><div class="FixedLine">    spec:</div><div class="FixedLine">      containers:</div><div class="FixedLine">      ...</div><div class="FixedLine">        env:</div><div class="FixedLine">          - name: spring.kafka.bootstrap-servers</div><div class="FixedLine">            value: kafka-1-ip-service:9092</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-7</span><p class="SimplePara">The <span id="ITerm20">Product Web Pod YAML File</span> (ch11\ch11-01\product-web-deployment.yml)</p></div></div></div></div>

          <p class="Para" id="Par24">Note that three replicas have been configured for the Product Web microservice and three for the <span id="ITerm21">Product Server microservice</span>.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec4">

          <h3 class="Heading">Run Microservices in Kubernetes</h3>

          <div class="Para" id="Par25">The <span class="EmphasisFontCategoryNonProportional ">ch11\ch11-01</span> folder contains the scripts required to build and run the examples. The first step is to start a Minikube <span id="ITerm22">single-node</span> Kubernetes cluster (see Listing <span class="InternalRef"><a href="#PC8">11-8</a></span>). Refer to Appendix E for a quick reference to Kubernetes setup and commands.<div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ minikube start</div><div class="FixedLine">  minikube v1.25.2 on Darwin 12.4</div><div class="FixedLine">...</div><div class="FixedLine">  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-8</span><p class="SimplePara">Starting Minikube</p></div></div></div></div>

          <p class="Para" id="Par26">Set the Minikube environment variables in your work terminal.</p>

          <div class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant" id="FPar1">

            <div class="Heading">Note</div>

            <p class="Para FirstParaInFormalPara" id="Par27">The examples in this chapter assume that the previous two steps connected to the Docker daemon have been executed if you are using the Minikube single-node Kubernetes cluster.</p>

          </div>

          <div class="Para" id="Par28">Assuming that your single-node Kubernetes cluster, <span id="ITerm23">Minikube</span> is up and running, a simple script, containing a single command, can build and run the complete application with all the <span id="ITerm24">deployment descriptors</span> (it’s called <span class="EmphasisFontCategoryNonProportional ">makeandrun.sh</span>). Listing <span class="InternalRef"><a href="#PC9">11-9</a></span> executes that script.<div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-01 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch11/ch11-01</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-01 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-01 binil$ sh makeandrun.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] -&lt; se.callista.blog.synch_kafka:kafka-request-reply-util &gt;-</div><div class="FixedLine">[INFO] Building Kafka Request Reply utility 0.0.1-SNAPSHOT</div><div class="FixedLine">[INFO] --------------------------------[ jar ]--------------</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Kafka Request Reply utility ...... SUCCESS [  1.119 s]</div><div class="FixedLine">[INFO] Ecom-Product-Server-Microservice . SUCCESS [  2.534 s]</div><div class="FixedLine">[INFO] Ecom-Product-Web-Microservice .... SUCCESS [  0.499 s]</div><div class="FixedLine">[INFO] Ecom ............................. SUCCESS [  0.002 s]</div><div class="FixedLine">[INFO] ------------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] ------------------------------------------------------</div><div class="FixedLine">...</div><div class="FixedLine">http://192.168.64.6:32535</div><div class="FixedLine">NAME                                 READY STATUS  RESTART AGE</div><div class="FixedLine">kafka-1-deployment-7bcc6dd87f-rxhkd  1/1   Running 0        8s</div><div class="FixedLine">postgres-89dbf9fd9-g9jx8             1/1   Running 0        7s</div><div class="FixedLine">product-server-5bb6569674-9dflb      1/1   Running 0        5s</div><div class="FixedLine">product-server-5bb6569674-g2488      1/1   Running 0        5s</div><div class="FixedLine">product-server-5bb6569674-nzlv2      1/1   Running 0        5s</div><div class="FixedLine">product-web-787d9ddf75-9m5c6         1/1   Running 0        4s</div><div class="FixedLine">product-web-787d9ddf75-g82vm         1/1   Running 0        4s</div><div class="FixedLine">product-web-787d9ddf75-tn8lk         1/1   Running 0        4s</div><div class="FixedLine">zookeeper-deployment-886ff5f87-qmnl6 1/1   Running 0        8s</div><div class="FixedLine">NAME                 TYPE      CLUSTER-IP     PORT(S)</div><div class="FixedLine">kafka-1-ip-service   ClusterIP 10.98.44.163   9092/TCP</div><div class="FixedLine">kubernetes           ClusterIP 10.96.0.1      443/TCP</div><div class="FixedLine">postgres             ClusterIP 10.97.76.252   5432/TCP</div><div class="FixedLine">product-server       ClusterIP 10.106.100.232 8081/TCP</div><div class="FixedLine">product-web          LoadBalan 10.110.112.90  8080:32535/TCP</div><div class="FixedLine">zookeeper-ip-service NodePort  10.111.204.18  2181:30059/TCP</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-01 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-9</span><p class="SimplePara">Executing the Script to Build and Run Microservices in Kubernetes (ch11\ch11-01\makeandrun.sh)</p></div></div></div></div>

          <p class="Para" id="Par29">Make sure all the pods are in “<span class="EmphasisFontCategoryNonProportional ">Running</span>” <span class="EmphasisFontCategoryNonProportional ">STATUS</span>. You are now ready to test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec5">

          <h3 class="Heading">Testing the Microservice Pods</h3>

          <p class="Para" id="Par30">Open the <span id="ITerm25">terminal windows</span> of all instances of the Product Server microservice and the Product Web microservice. Remember, you configured three replicas for each microservice, as is evident in Listing <span class="InternalRef"><a href="#PC10">11-10</a></span>.</p>

          <div class="Para" id="Par31">Link your console to the Product Server microservice pod 1 terminal.<div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl --tail 30 logs -f product-server-5bb6569674-9dflb</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-10</span><p class="SimplePara">Product Server Pod 1 Terminal</p></div></div></div></div>

          <div class="Para" id="Par32">Next, link your console to the Product Server microservice pod 2 terminal. See Listing <span class="InternalRef"><a href="#PC11">11-11</a></span>.<div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl --tail 30 logs -f product-server-5bb6569674-g2488</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-11</span><p class="SimplePara">Product Server Pod 2 Terminal</p></div></div></div></div>

          <div class="Para" id="Par33">As the last step, link your console to the Product Server microservice pod 3 terminal. See Listing <span class="InternalRef"><a href="#PC12">11-12</a></span>.<div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl --tail 30 logs -f product-server-5bb6569674-nzlv2</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2023-05-19 13:49:12 INFO  StartupInfoLogger.logStarting:51 - Starting EcomProductServerMicroservice...</div><div class="FixedLine">...</div><div class="FixedLine">Running Changeset: db/changelog/initial-schema_inventory.xml::product::Binildas</div><div class="FixedLine">Running Changeset: db/changelog/initial-schema_inventory.xml::addAutoIncrement-product::Binildas</div><div class="FixedLine">Running Changeset: db/changelog/initial-schema_inventory.xml::insert-product-01::Binildas</div><div class="FixedLine">Running Changeset: db/changelog/initial-schema_inventory.xml::insert-product-02::Binildas</div><div class="FixedLine">...</div><div class="FixedLine">Liquibase: Update has been successful.</div><div class="FixedLine">2023-05-19 13:49:53 INFO  InitializationComponent.init:42 - Start</div><div class="FixedLine">2023-05-19 13:49:53 INFO  InitializationComponent.init:67 - End</div><div class="FixedLine">2023-05-19 13:50:04 INFO  StartupInfoLogger.logStarted:57 - Started EcomProductServerMicroserviceApplication in 57.979 seconds (process running for 69.734)</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-12</span><p class="SimplePara">Product Server Pod 3 Terminal</p></div></div></div></div>

          <div class="Para" id="Par34">Next, you will get the Product Web Microservice <span id="ITerm26">consoles</span>. First link your host console to the Product Web microservice pod 1 terminal. See Listing <span class="InternalRef"><a href="#PC13">11-13</a></span>.<div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl --tail 30 logs -f product-web-787d9ddf75-9m5c6</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-13</span><p class="SimplePara">Product Web pod 1 Terminal</p></div></div></div></div>

          <div class="Para" id="Par35">Link your console to the Product Web microservice pod 2 <span id="ITerm27">terminal</span>. See Listing <span class="InternalRef"><a href="#PC14">11-14</a></span>.<div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl --tail 30 logs -f product-web-787d9ddf75-g82vm</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-14</span><p class="SimplePara">Product Web Pod 2 Terminal</p></div></div></div></div>

          <div class="Para" id="Par36">As the final step, link your console to the Product Web microservice pod 3 <span id="ITerm28">terminal</span>. See Listing <span class="InternalRef"><a href="#PC15">11-15</a></span>.<div class="ProgramCode" id="PC15"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl --tail 30 logs -f product-web-787d9ddf75-tn8lk</div><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2023-05-19 13:49:11 INFO  StartupInfoLogger.logStarting:51 - Starting EcomProductWebMicroservice...</div><div class="FixedLine">2023-05-19 13:49:43 INFO  StartupInfoLogger.logStarted:57 - Started EcomProductWebMicroservice...</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-15</span><p class="SimplePara">Product Web Pod 3 Terminal</p></div></div></div></div>

          <p class="Para" id="Par37">You can now access some statistics from Kafka. Remember that you defined a <span class="EmphasisFontCategoryNonProportional ">NodePort</span> for the zookeeper pod. You will now connect to the zookeeper from the host machine.</p>

          <div class="Para" id="Par38">To access the <span id="ITerm29">Kafka container</span>, as mentioned in Appendix E, you must get the Minikube IP first. See Listing <span class="InternalRef"><a href="#PC16">11-16</a></span>.<div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch07-02 binil$ minikube ip</div><div class="FixedLine">192.168.64.6</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch07-02 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-16</span><p class="SimplePara">Finding Minikube IP</p></div></div></div></div>

          <div class="Para" id="Par39">Now to connect to <span id="ITerm30">Kafka</span>. One way to do so is to use the <span class="EmphasisFontCategoryNonProportional ">kafka-topics.sh</span> script in any standard Apache Kafka extracted folder. See Listing <span class="InternalRef"><a href="#PC17">11-17</a></span>.<div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:bin binil$ pwd</div><div class="FixedLine">/Users/binil/Applns/apache/kafka/kafka_2.13-2.5.0/bin</div><div class="FixedLine">(base) binildass-MacBook-Pro:bin binil$ sh ./kafka-topics.sh --zookeeper 192.168.64.6:30059 --list</div><div class="FixedLine">(base) binildass-MacBook-Pro:bin binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-17</span><p class="SimplePara">Listing the Kafka Topics</p></div></div></div></div>

          <p class="Para" id="Par40">Note that the IP address in Listing <span class="InternalRef"><a href="#PC17">11-17</a></span> is the Minikube IP address and the port is the <span class="EmphasisFontCategoryNonProportional ">NodePort</span> of <span class="EmphasisFontCategoryNonProportional ">zookeeper-ip-service</span> in Listing <span class="InternalRef"><a href="#PC9">11-9</a></span>.</p>

          <p class="Para" id="Par41">You may now access the Product Web microservice using a browser with the URL formed with the Minikube IP:</p>

          <p class="Para ParaOneEmphasisChild" id="Par42"><span class="EmphasisFontCategoryNonProportional ">http://192.168.64.5:8080/product.html</span></p>

          <p class="Para" id="Par43">Refer to the section titled “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the Product Web microservice container.</p>

          <p class="Para" id="Par44">While you test the microservices, you can keep watching the log windows in Listings <span class="InternalRef"><a href="#PC10">11-10</a></span> through <span class="InternalRef"><a href="#PC15">11-15</a></span>.</p>

          <div class="Para" id="Par45">Let’s now revisit the <span id="ITerm31">Kafka topics</span>, as shown in Listing <span class="InternalRef"><a href="#PC18">11-18</a></span>.<div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:bin binil$ sh ./kafka-topics.sh --zookeeper 192.168.64.6:30059 --list</div><div class="FixedLine">__consumer_offsets</div><div class="FixedLine">product-req-reply-topic</div><div class="FixedLine">product-req-topic</div><div class="FixedLine">(base) binildass-MacBook-Pro:bin binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-18</span><p class="SimplePara">Listing the Kafka Topics</p></div></div></div></div>

          <p class="Para" id="Par46">You can see the different topics created on the fly when you test the microservices. This is in line with the description provided in Listing 4-9 in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec6">

          <h3 class="Heading">Load Testing the Microservice Pods</h3>

          <div class="Para" id="Par47">I have provided a few scripts to help you load test the microservices and see how the load is evenly distributed from the Product Web to the Product Server through the <span id="ITerm32">Kafka messaging channel</span><span id="ITerm33"></span>. See Listing <span class="InternalRef"><a href="#PC19">11-19</a></span>.<div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine">./02-ProductWeb/</div><div class="FixedLine">├── pingrun1.sh</div><div class="FixedLine">├── pingrun2.sh</div><div class="FixedLine">├── pingrun3.sh</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">└── src</div><div class="FixedLine">    └── ...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-19</span><p class="SimplePara">Load Testing Scripts</p></div></div></div></div>

          <div class="Para" id="Par48">To load test, first open each of these <span id="ITerm34">scripts</span> and tweak the URL to point to the Product Web microservice. Subsequently, you can open three different terminals and execute these scripts concurrently to fire cURL requests. See Listings <span class="InternalRef"><a href="#PC20">11-20</a></span> through <span class="InternalRef"><a href="#PC22">11-22</a></span>.<div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/ch11/ch11-01/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh pingrun1.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-20</span><p class="SimplePara">Firing Requests to Product Web Microservice from Terminal 1</p></div></div></div><div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh pingrun2.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-21</span><p class="SimplePara">Firing Requests to Product Web Microservice from Terminal 2</p></div></div></div><div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh pingrun3.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-22</span><p class="SimplePara">Firing Requests to Product Web Microservice from Terminal 3</p></div></div></div></div>

          <p class="Para" id="Par49">The contents of all three <span id="ITerm35">scripts</span> are the same, so you can alternatively execute the same script in three different terminals!</p>

          <div class="Para" id="Par50">Once you complete testing the microservices in this example, you can stop and remove the microservice containers and clean the <span id="ITerm36">environment</span>. See Listing <span class="InternalRef"><a href="#PC23">11-23</a></span>.<div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch10-03 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch11/ch11-01</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch10-03 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch10-03 binil$ sh clean.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO] --------------------------------------</div><div class="FixedLine">[INFO] Reactor Build Order:</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Kafka Request Reply utility        [jar]</div><div class="FixedLine">[INFO] Ecom-Product-Server-Microservice   [jar]</div><div class="FixedLine">[INFO] Ecom-Product-Web-Microservice      [jar]</div><div class="FixedLine">[INFO] Ecom                               [pom]</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">service "product-web" deleted</div><div class="FixedLine">deployment.apps "product-web" deleted</div><div class="FixedLine">service "product-server" deleted</div><div class="FixedLine">service "product-server-nodeport" deleted</div><div class="FixedLine">deployment.apps "product-server" deleted</div><div class="FixedLine">service "postgres" deleted</div><div class="FixedLine">deployment.apps "postgres" deleted</div><div class="FixedLine">persistentvolumeclaim "postgres-persistent-volume-claim" deleted</div><div class="FixedLine">configmap "postgres-config" deleted</div><div class="FixedLine">service "zookeeper-ip-service" deleted</div><div class="FixedLine">service "kafka-1-ip-service" deleted</div><div class="FixedLine">deployment.apps "zookeeper-deployment" deleted</div><div class="FixedLine">deployment.apps "kafka-1-deployment" deleted</div><div class="FixedLine">Untagged: ecom/product-web:latest</div><div class="FixedLine">Untagged: ecom/product-server:latest</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-01 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-23</span><p class="SimplePara">Cleaning the Project and the Environment</p></div></div></div></div>

          <p class="Para" id="Par51">This completes the first example.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec7">

        <h2 class="Heading">Microservices Over Kafka with MongoDB in k8s</h2>

        <p class="Para" id="Par52">In this example, you will tweak the same set of microservices from Chapter <span class="ExternalRef"><a href="Capítulo-08.html"><span class="RefSource">6</span></a></span> in the section titled “<span id="ITerm37">CRUD</span> Microservices over Kafka on MongoDB” and in Chapter <span class="ExternalRef"><a href="Capítulo-11.html"><span class="RefSource">9</span></a></span> in the section titled “Composing Microservice with MongoDB Containers.” A consumer and a provider microservice communicate with each other using Kafka as the messaging channel. The provider microservice stores the entity in a MongoDB database. When the browser sends a request to the first (consumer) microservice, it uses async <span id="ITerm38">HTTP</span>. Even though it uses async HTTP, the example emulates a sync-style user experience at the browser level.</p>

        <p class="Para" id="Par53">This section demonstrates this example with multiple instances of the consumer and provider microservices, and you will also use multiple clients while testing the service.</p>

        <section class="Section2 RenderAsSection2" id="Sec8">

          <h3 class="Heading">Design the Microservices Orchestration Topology</h3>

          <div class="Para" id="Par54">This example uses a modified version of the <span id="ITerm39">hexagonal microservice</span> view shown in Figure <span class="ExternalRef"><a href="Capítulo-11.html#Fig4"><span class="RefSource">9-4</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-11.html"><span class="RefSource">9</span></a></span>. The microservices communicate through an async channel. <span id="ITerm40">Apache Kafka</span>, which is inherently asynchronous, is used as the messaging channel. See Figure <span class="InternalRef"><a href="#Fig2">11-2</a></span>.<figure class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img alt="" aria-describedby="d64e1631" src="../images/619782_1_En_11_Chapter/Imagem-119.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1631"><p class="Para" id="Par106">A 3 D model diagram of the user connected to the browser, product web mu S, Kafka infrastructure service with event queue and partitions 1 and 2, product server mu S, container engine, host O S, and hardware. Product web includes 3 business services, and product server includes 3 business services and 1 application service.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-2</span><p class="SimplePara">Kubernetes orchestration topology for microservice</p></div></figcaption></figure></div>

          <p class="Para" id="Par55">The deployment <span id="ITerm41">architecture</span> is very similar to the previous example in this chapter. The only difference is that this example deploys a MongoDB container in Kubernetes.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec9">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par56">The <span id="ITerm42">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch11\ch11-02</span> folder.</p>

          <div class="Para" id="Par57">A summarized representation of the <span id="ITerm43">source code organization</span> for the example inside the <span class="EmphasisFontCategoryNonProportional ">ch11-02</span> folder is shown in Listing <span class="InternalRef"><a href="#PC24">11-24</a></span>.<div class="ProgramCode" id="PC24"><div class="LineGroup"><div class="FixedLine">ch11-02/</div><div class="FixedLine">├── 01-ProductServer</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── 02-ProductWeb</div><div class="FixedLine">│   ├── pingrun1.sh</div><div class="FixedLine">│   ├── pingrun2.sh</div><div class="FixedLine">│   ├── pingrun3.sh</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── Dockerfile</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── kafka-deployment.yml</div><div class="FixedLine">├── kafka-request-reply-util</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── kafka-svc.yml</div><div class="FixedLine">├── makeandrun.sh</div><div class="FixedLine">├── mongo-deployment.yml</div><div class="FixedLine">├── mongo-service.yml</div><div class="FixedLine">├── mongo-volume-claim.yml</div><div class="FixedLine">├── mongo-volume.yml</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">├── product-server-deployment.yml</div><div class="FixedLine">├── product-server-service.yml</div><div class="FixedLine">├── product-web-deployment.yml</div><div class="FixedLine">└── product-web-service.yml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-24</span><p class="SimplePara">Example 11-02 <span id="ITerm44">Source Code Organization</span></p></div></div></div></div>

          <p class="Para" id="Par58">The <span id="ITerm45">source code</span> in this example is similar to <span class="EmphasisFontCategoryNonProportional ">ch09\ch09-04</span>, which I explained in detail in Chapter <span class="ExternalRef"><a href="Capítulo-11.html"><span class="RefSource">9</span></a></span>. In this example from Chapter <span class="ExternalRef"><a href="Capítulo-11.html"><span class="RefSource">9</span></a></span>, the deployment architecture is similar, but it used Docker Compose instead of Kubernetes. In the first example in Chapter <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span> (<span class="EmphasisFontCategoryNonProportional ">ch10\ch10-01</span>), you also looked at the Kubernetes-based deployment of the two microservices and <span id="ITerm46">PostgreSQL</span>, and in the previous example in this chapter, you also saw the Kubernetes deployment of Kafka. You should therefore be familiar with all the deployment descriptors in Listing <span class="InternalRef"><a href="#PC24">11-24</a></span>, so I move to the next steps in executing the example.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec10">

          <h3 class="Heading">Run Microservices in Kubernetes</h3>

          <p class="Para" id="Par59">The <span class="EmphasisFontCategoryNonProportional ">ch11\ch11-02</span> folder contains the scripts required to build and run the examples. The first step is to start a Minikube, single-node Kubernetes cluster. Refer to Appendix E for a quick reference to the Kubernetes setup and commands. As a next step, you need to create a new folder for Mongo data inside the <span id="ITerm47">Minikube VM</span>, which you have configured in <span class="EmphasisFontCategoryNonProportional ">mongo-volume.yml</span>.</p>

          <div class="Para" id="Par60">Finally, a simple script, containing all the commands to build and run the complete application with all the defined deployments, is executed in Listing <span class="InternalRef"><a href="#PC25">11-25</a></span>.<div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-02 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch11/ch11-02</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-02 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-02 binil$ sh makeandrun.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Kafka Request Reply utility ...... SUCCESS [  1.129 s]</div><div class="FixedLine">[INFO] Ecom-Product-Server-Microservice . SUCCESS [  1.242 s]</div><div class="FixedLine">[INFO] Ecom-Product-Web-Microservice .... SUCCESS [  0.481 s]</div><div class="FixedLine">[INFO] Ecom ............................. SUCCESS [  0.002 s]</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] Total time:  3.023 s</div><div class="FixedLine">[INFO] Finished at: 2023-05-19T20:17:30+05:30</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">...</div><div class="FixedLine">http://192.168.64.6:32627</div><div class="FixedLine">NAME                                 READY STATUS  RESTART AGE</div><div class="FixedLine">kafka-1-deployment-7bcc6dd87f-jrdjx  1/1   Running 0       9s</div><div class="FixedLine">mongo-cluster-0                      1/1   Running 0       8s</div><div class="FixedLine">product-server-5cc8967574-6p249      1/1   Running 0       6s</div><div class="FixedLine">product-server-5cc8967574-7gnz9      1/1   Running 0       6s</div><div class="FixedLine">product-server-5cc8967574-jr2lv      1/1   Running 0       6s</div><div class="FixedLine">product-web-ff4f65986-9plf7          1/1   Running 0       5s</div><div class="FixedLine">product-web-ff4f65986-qd9bs          1/1   Running 0       5s</div><div class="FixedLine">product-web-ff4f65986-s8hm4          1/1   Running 0       5s</div><div class="FixedLine">zookeeper-deployment-886ff5f87-nv5xn 1/1   Running 0       9s</div><div class="FixedLine">NAME                 TYPE      CLUSTER-IP    PORT(S)</div><div class="FixedLine">kafka-1-ip-service   ClusterIP 10.108.5.80   9092/TCP</div><div class="FixedLine">kubernetes           ClusterIP 10.96.0.1     443/TCP</div><div class="FixedLine">mongo                ClusterIP 10.103.88.174 27017/TCP</div><div class="FixedLine">mongo-nodeport       NodePort  10.108.6.234  27017:30001/TCP</div><div class="FixedLine">product-server       ClusterIP 10.103.49.104 8081/TCP</div><div class="FixedLine">product-server-np    NodePort  10.109.23.86  8081:30002/TCP</div><div class="FixedLine">product-web          LoadBalan 10.99.185.187 8080:32627/TCP</div><div class="FixedLine">zookeeper-ip-service ClusterIP 10.107.235.56 2181/TCP</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-02 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-25</span><p class="SimplePara">Executing the <span id="ITerm48">Script</span> to Build and Run Microservices in Kubernetes (ch11\ch11-02\makeandrun.sh)</p></div></div></div></div>

          <div class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant" id="FPar2">

            <div class="Heading">Note</div>

            <p class="Para FirstParaInFormalPara" id="Par61">I abbreviated <span class="EmphasisFontCategoryNonProportional ">product-server-nodeport</span> to <span class="EmphasisFontCategoryNonProportional ">product-server-np</span> in Listing <span class="InternalRef"><a href="#PC25">11-25</a></span> for formatting convenience.</p>

          </div>

          <p class="Para" id="Par62">You are now ready to test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec11">

          <h3 class="Heading">Testing the Microservice Pods</h3>

          <p class="Para" id="Par63">You can now access the <span id="ITerm49">Product Web microservice</span> using a browser with this URL formed with the Minikube IP:</p>

          <p class="Para ParaOneEmphasisChild" id="Par64"><span class="EmphasisFontCategoryNonProportional ">http://192.168.64.6:32627/product.html</span></p>

          <p class="Para" id="Par65">Refer to the section titled “Test the Microservice using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the Product Web microservice container.</p>

          <p class="Para" id="Par66">You can inspect the data folder, as explained in the first example in Chapter <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span>. You can also repeat the related tests, as explained in the first example in Chapter <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span>.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec12">

          <h3 class="Heading">Load Testing the Microservice Pods</h3>

          <div class="Para" id="Par67">This example provides a few scripts to help you load test the microservices and see how the load is evenly distributed from the Product Web to the Product Server through the Kafka messaging channel. See Listing <span class="InternalRef"><a href="#PC26">11-26</a></span>.<div class="ProgramCode" id="PC26"><div class="LineGroup"><div class="FixedLine">./02-ProductWeb/</div><div class="FixedLine">├── pingrun1.sh</div><div class="FixedLine">├── pingrun2.sh</div><div class="FixedLine">├── pingrun3.sh</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">└── src</div><div class="FixedLine">    └── ...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-26</span><p class="SimplePara"><span id="ITerm50">Load Testing</span> Scripts</p></div></div></div></div>

          <p class="Para" id="Par68">Refer to the previous example for step-by-step instructions to load test the example.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec13">

          <h3 class="Heading">Connect to the MongoDB Pod Using kubectl</h3>

          <div class="Para" id="Par69">This section investigates how to interact with <span id="ITerm51">MongoDB</span> using the <span class="EmphasisFontCategoryNonProportional ">kubectl</span> command. As you saw earlier, the <span class="EmphasisFontCategoryNonProportional ">kubectl exec</span> command allows you to remotely run arbitrary commands inside an existing container of a pod. Based on that, you connect to the <span id="ITerm52">MongoDB pod</span>. See Listing <span class="InternalRef"><a href="#PC27">11-27</a></span>.<div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:bin binil$ kubectl exec -it mongo-cluster-0 -- sh</div><div class="FixedLine">#</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-27</span><p class="SimplePara">Connecting to MongoDB Pod Using kubectl</p></div></div></div></div>

          <div class="Para" id="Par70">Next, load the Mongo shell, as shown in Listing <span class="InternalRef"><a href="#PC28">11-28</a></span>.<div class="ProgramCode" id="PC28"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:bin binil$ kubectl exec -it mongo-cluster-0 -- sh</div><div class="FixedLine"># mongo</div><div class="FixedLine">MongoDB shell version v4.2.24</div><div class="FixedLine">connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb</div><div class="FixedLine">...</div><div class="FixedLine">---</div></div><div class="LineGroup"><div class="FixedLine">&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-28</span><p class="SimplePara">Connecting to MongoDB Shell Using kubectl</p></div></div></div></div>

          <div class="Para" id="Par71">Refer to Appendix B and execute any MongoDB commands. See Listing <span class="InternalRef"><a href="#PC29">11-29</a></span>.<div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:bin binil$ kubectl exec -it mongo-cluster-0 -- sh</div><div class="FixedLine"># mongo</div><div class="FixedLine">...</div><div class="FixedLine">---</div></div><div class="LineGroup"><div class="FixedLine">&gt; show dbs</div><div class="FixedLine">admin   0.000GB</div><div class="FixedLine">config  0.000GB</div><div class="FixedLine">local   0.000GB</div><div class="FixedLine">test    0.000GB</div><div class="FixedLine">&gt; db.getName()</div><div class="FixedLine">test</div><div class="FixedLine">&gt; show collections</div><div class="FixedLine">product</div><div class="FixedLine">&gt; db.product.find()</div><div class="FixedLine">{ "_id" : ObjectId("64733f182a010c0eaeda6e30"), ...</div><div class="FixedLine">{ "_id" : ObjectId("64733f182a010c0eaeda6e31"), ...</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-29</span><p class="SimplePara">Executing <span id="ITerm53">MongoDB Shell Commands</span></p></div></div></div></div>

          <div class="Para" id="Par72">Once you test the <span id="ITerm54">microservices</span> in this example, you can stop and remove the microservice containers and clean the environment, as shown in Listing <span class="InternalRef"><a href="#PC30">11-30</a></span>.<div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-02 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch11/ch11-02</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-02 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-02 binil$ sh clean.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO] ---------------------------------------------------</div><div class="FixedLine">[INFO] Reactor Build Order:</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Kafka Request Reply utility                     [jar]</div><div class="FixedLine">[INFO] Ecom-Product-Server-Microservice                [jar]</div><div class="FixedLine">[INFO] Ecom-Product-Web-Microservice                   [jar]</div><div class="FixedLine">[INFO] Ecom                                            [pom]</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Kafka Request Reply utility ...... SUCCESS [  0.087 s]</div><div class="FixedLine">[INFO] Ecom-Product-Server-Microservice . SUCCESS [  0.075 s]</div><div class="FixedLine">[INFO] Ecom-Product-Web-Microservice .... SUCCESS [  0.013 s]</div><div class="FixedLine">[INFO] Ecom ............................. SUCCESS [  0.003 s]</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] Total time:  0.415 s</div><div class="FixedLine">[INFO] Finished at: 2023-05-19T20:41:43+05:30</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">service "product-web" deleted</div><div class="FixedLine">deployment.apps "product-web" deleted</div><div class="FixedLine">service "product-server" deleted</div><div class="FixedLine">service "product-server-nodeport" deleted</div><div class="FixedLine">deployment.apps "product-server" deleted</div><div class="FixedLine">service "mongo" deleted</div><div class="FixedLine">service "mongo-nodeport" deleted</div><div class="FixedLine">statefulset.apps "mongo-cluster" deleted</div><div class="FixedLine">persistentvolumeclaim "mongo-data-db" deleted</div><div class="FixedLine">persistentvolume "mongo-data-db" deleted</div><div class="FixedLine">service "zookeeper-ip-service" deleted</div><div class="FixedLine">service "kafka-1-ip-service" deleted</div><div class="FixedLine">deployment.apps "zookeeper-deployment" deleted</div><div class="FixedLine">deployment.apps "kafka-1-deployment" deleted</div><div class="FixedLine">Untagged: ecom/product-web:latest</div><div class="FixedLine">Untagged: ecom/product-server:latest</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-02 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-30</span><p class="SimplePara">Cleaning the Project and the Environment</p></div></div></div></div>

          <p class="Para" id="Par73">This completes the second example.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec14">

        <h2 class="Heading">Ingress Routing of Microservices</h2>

        <p class="Para" id="Par74">Through the previous chapters and the previous examples in this chapter, you have seen how a typical deployment can be done in Kubernetes with multiple business, application, and infrastructure services. This section shows you how to tweak the same set of microservices in the second example in Chapter <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span> to plug in an <span id="ITerm55">Ingress</span> in the front to route external requests. A consumer and provider microservice communicate with each other. The provider microservice stores the entity in a <span id="ITerm56">PostgreSQL database</span>. The request from the browser is intercepted by the Ingress. As seen in Chapter <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span>, an Ingress can expose multiple services through a single IP address.</p>

        <p class="Para" id="Par75">Even though this example is included in this chapter and is titled Message Oriented Microservices as a final example, I have purposefully eliminated the messaging bridge between the microservices. This is to make the example lighter so that I can introduce a few other new components and keep the overall complexity of the example well within limits.</p>

        <section class="Section2 RenderAsSection2" id="Sec15">

          <h3 class="Heading">Design Ingress Routing Topology</h3>

          <div class="Para" id="Par76">The <span id="ITerm57">Product Web and Product Server</span> microservices are both containerized, and the Product Server microservice will connect to a PostgreSQL database deployed within a container. All these containers will reside in Kubernetes. Ingress becomes an additional component for routing and the Adminer UI component manages the <span id="ITerm58">PostgreSQL database</span>. See Figure <span class="InternalRef"><a href="#Fig3">11-3</a></span>.<figure class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img alt="" aria-describedby="d64e2291" src="../images/619782_1_En_11_Chapter/Imagem-120.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2291"><p class="Para" id="Par107">A 3 D model diagram of the user connected to the browser, ingress infrastructure service, product web mu S, product server mu S, container engine with functions, host O S, and hardware. Product web includes a business service, and product server includes a business service and 2 application services.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-3</span><p class="SimplePara">Ingress routing <span id="ITerm59">topology</span> for microservices</p></div></figcaption></figure></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec16">

          <h3 class="Heading">Environment Configurations</h3>

          <p class="Para" id="Par77">To make the URLs (<span class="ExternalRef"><a href="http://products.acme.test"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://products.acme.test</span></span></a></span> and <span class="ExternalRef"><a href="http://adminer.acme.test"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://adminer.acme.test</span></span></a></span>) work, you need to edit the host files in your host machine.</p>

          <p class="Para" id="Par78">Every website connected to the Internet has a unique numeric address that tells all the other devices where it is—its TCP/IP address. The <span id="ITerm60">Domain Name System (DNS)</span> translates those numeric addresses into something more recognizable and memorable to humans, such as <span class="ExternalRef"><a href="http://www.acme.com"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.acme.com</span></span></a></span>. The first time you type a web address like <span class="ExternalRef"><a href="http://www.acme.com"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.acme.com</span></span></a></span>, your machine pings a DNS server—typically one automatically configured for you by your ISP (Internet Service Provider). This will resolve the TCP/IP address of the server you’re trying to connect to. Your browser builds up a hidden cache file to remember those details when you visit the site again.</p>

          <div class="Para" id="Par79">As specified, this example adds the names to the host files, as shown in Listing <span class="InternalRef"><a href="#PC31">11-31</a></span>.<div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-03 binil$ minikube ip</div><div class="FixedLine">192.168.64.5</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ sudo nano /etc/hosts</div></div><div class="LineGroup"><div class="FixedLine">192.168.64.5  adminer.acme.com</div><div class="FixedLine">192.168.64.5  products.acme.com</div></div><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ ^O (To Save)</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ ^X (To Exit)</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ sudo killall -HUP mDNSResponder</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-31</span><p class="SimplePara">Adding Hostnames to the etc Hosts File</p></div></div></div></div>

          <p class="Para" id="Par80">Listing <span class="InternalRef"><a href="#PC31">11-31</a></span> shows how I add the two new lines to add two new hostnames to my machine. This will map your localhost (Minikube) IP address to both hostnames and make them accessible.</p>

          <div class="Para" id="Par81">Figure <span class="InternalRef"><a href="#Fig4">11-4</a></span> shows how I edited this file.<figure class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img alt="" aria-describedby="d64e2384" src="../images/619782_1_En_11_Chapter/Imagem-121.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2384"><p class="Para" id="Par108">A cropped screenshot of the binil sudo 80 x 5 window. It has 2 commands that read base within parentheses binil d a s s-MacBook-Pro colon tilde binil dollar sign sudo nano slash e t c slash hosts and password.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-4</span><p class="SimplePara">Editing the <span id="ITerm61">host files</span></p></div></figcaption></figure></div>

          <div class="Para" id="Par82">Figure <span class="InternalRef"><a href="#Fig5">11-5</a></span> shows how I added the two hostnames in my machine.<figure class="Figure" id="Fig5"><div class="MediaObject" id="MO5"><img alt="" aria-describedby="d64e2401" src="../images/619782_1_En_11_Chapter/Imagem-122.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2401"><p class="Para" id="Par109">A screenshot of the binil pico sudo 80 x 20 window. It has the U W pico 5.09 file colon slash e t c slash hosts data that read host database, localhost is used to configure the loopback interface, when the system is booting do not change this entry, added by docker desktop, and others with localhost, broadcasthost, and other addresses.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-5</span><p class="SimplePara">Adding hostnames</p></div></figcaption></figure></div>

          <p class="Para" id="Par83">Once you’re done, hold down the Control and O keys to save the file, and then Control and X to exit. Subsequently in a command line, type <span class="EmphasisFontCategoryNonProportional ">sudo killall -HUP mDNSResponder</span> and then press Return. That will flush your DNS cache, so it isn’t confused by any changes you made to the Hosts file.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec17">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par84">The <span id="ITerm62">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch11\ch11-03</span> folder. The source code in this example is similar to <span class="EmphasisFontCategoryNonProportional ">ch10\ch10-01</span>, which I explained in detail in Chapter <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span>. However, two new components were introduced—the Ingress and the Adminer.</p>

          <div class="Para" id="Par85">A summarized representation of the source code organization for the example inside the <span class="EmphasisFontCategoryNonProportional ">ch11-03</span> folder is shown in Listing <span class="InternalRef"><a href="#PC32">11-32</a></span>.<div class="ProgramCode" id="PC32"><div class="LineGroup"><div class="FixedLine">./ch11-03/</div><div class="FixedLine">├── 01-ProductServer</div><div class="FixedLine">│   ├── make.sh</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── main</div><div class="FixedLine">├── 02-ProductWeb</div><div class="FixedLine">│   ├── make.sh</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── main</div><div class="FixedLine">├── Dockerfile</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── adminer-deployment.yaml</div><div class="FixedLine">├── adminer-svc.yaml</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── ingress-controller.yaml</div><div class="FixedLine">├── makeandrun.sh</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">├── postgres-config.yml</div><div class="FixedLine">├── postgres-deployment.yml</div><div class="FixedLine">├── postgres-pvc.yml</div><div class="FixedLine">├── postgres-svc.yml</div><div class="FixedLine">├── product-server-deployment.yml</div><div class="FixedLine">├── product-server-service.yml</div><div class="FixedLine">├── product-web-deployment.yml</div><div class="FixedLine">└── product-web-service.yml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-32</span><p class="SimplePara">Example 11-03 <span id="ITerm63">Source Code Organization</span></p></div></div></div></div>

          <div class="Para" id="Par86">There are two presentation services or UI services in this project:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par87"><span class="ExternalRef"><a href="http://products.acme.test"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://products.acme.test</span></span></a></span>: The user can interact with the Product Web microservice</p></li><li><p class="Para" id="Par88"><span class="ExternalRef"><a href="http://adminer.acme.test"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://adminer.acme.test</span></span></a></span>: The user can interact with the PostgreSQL database</p></li></ul></div></div>

          <div class="Para" id="Par89">Ingress and the Adminer are the two new deployments in Listing <span class="InternalRef"><a href="#PC32">11-32</a></span>, compared to those in Listing 10-41 in Chapter <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span>. Let’s investigate these new deployments one by one. See Listing <span class="InternalRef"><a href="#PC33">11-33</a></span>.<div class="ProgramCode" id="PC33"><div class="LineGroup"><div class="FixedLine">apiVersion: networking.k8s.io/v1</div><div class="FixedLine">kind: Ingress</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: ingress-service</div><div class="FixedLine">  annotations:</div><div class="FixedLine">    kubernetes.io/ingress.class: nginx</div><div class="FixedLine">spec:</div><div class="FixedLine">  rules:</div><div class="FixedLine">    - host: "adminer.acme.test"</div><div class="FixedLine">      http:</div><div class="FixedLine">        paths:</div><div class="FixedLine">          - path: /</div><div class="FixedLine">            pathType: Prefix</div><div class="FixedLine">            backend:</div><div class="FixedLine">              service:</div><div class="FixedLine">                name: adminer</div><div class="FixedLine">                port:</div><div class="FixedLine">                  number: 8080</div><div class="FixedLine">    - host: "products.acme.test"</div><div class="FixedLine">      http:</div><div class="FixedLine">        paths:</div><div class="FixedLine">          - path: /</div><div class="FixedLine">            pathType: Prefix</div><div class="FixedLine">            backend:</div><div class="FixedLine">              service:</div><div class="FixedLine">                name: product-web</div><div class="FixedLine">                port:</div><div class="FixedLine">                  number: 8080</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-33</span><p class="SimplePara">The <span id="ITerm64">Pod Definition YAML File</span> for Ingress (ch11\ch11-03\ingress-controller.yml)</p></div></div></div></div>

          <p class="Para" id="Par90">First, you specify the kind of the <span id="ITerm65">Kubernetes object</span> you want to create, which is Ingress. It’s followed by metadata with the name of the object as usual and a new section, called <span class="EmphasisFontCategoryNonProportional ">annotations</span>. You can configure the behavior of the Ingress. This example uses the simplest one, but there are many more possibilities. The <span class="EmphasisFontCategoryNonProportional ">spec</span> section includes the first rule—that all requests from the <span class="EmphasisFontCategoryNonProportional ">adminer.acme.test</span> host be routed to the <span class="EmphasisFontCategoryNonProportional ">ClusterIP</span> with a name (<span class="EmphasisFontCategoryNonProportional ">adminer</span>) and the requests from the <span class="EmphasisFontCategoryNonProportional ">products.acme.test</span> host be routed to the <span class="EmphasisFontCategoryNonProportional ">ClusterIP</span> with a name (<span class="EmphasisFontCategoryNonProportional ">product-web</span>).</p>

          <div class="Para" id="Par91">The next component is the Adminer UI, which is a UI to the PostgreSQL database. See Listing <span class="InternalRef"><a href="#PC34">11-34</a></span>.<div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine">apiVersion: apps/v1</div><div class="FixedLine">kind: Deployment</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: adminer</div><div class="FixedLine">  labels:</div><div class="FixedLine">    app: adminer</div><div class="FixedLine">    group: db</div><div class="FixedLine">spec:</div><div class="FixedLine">  replicas: 1</div><div class="FixedLine">  selector:</div><div class="FixedLine">    matchLabels:</div><div class="FixedLine">      app: adminer</div><div class="FixedLine">  template:</div><div class="FixedLine">    metadata:</div><div class="FixedLine">      labels:</div><div class="FixedLine">        app: adminer</div><div class="FixedLine">        group: db</div><div class="FixedLine">    spec:</div><div class="FixedLine">      containers:</div><div class="FixedLine">        - name: adminer</div><div class="FixedLine">          image: adminer:4.8.1-standalone</div><div class="FixedLine">          ports:</div><div class="FixedLine">          - containerPort: 8080</div><div class="FixedLine">          imagePullPolicy: IfNotPresent</div><div class="FixedLine">          env:</div><div class="FixedLine">            - name: ADMINER_DESIGN</div><div class="FixedLine">              value: pepa-linha</div><div class="FixedLine">            - name: ADMINER_DEFAULT_SERVER</div><div class="FixedLine">              value: postgres</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-34</span><p class="SimplePara">The <span id="ITerm66">Pod Definition YAML File</span> for Adminer (ch11\ch11-03\adminer-deployment.yml)</p></div></div></div></div>

          <div class="Para" id="Par92">The initial section is responsible for defining what kind of object you’re creating (<span class="EmphasisFontCategoryNonProportional ">apiVersion, kind</span>) followed by some metadata, including <span class="EmphasisFontCategoryNonProportional ">name</span>, <span class="EmphasisFontCategoryNonProportional ">labels</span>, and <span class="EmphasisFontCategoryNonProportional ">app group</span> (<span class="EmphasisFontCategoryNonProportional ">metadata</span>). It then mentions the <span class="EmphasisFontCategoryNonProportional ">image</span> to use for the container and a few other environment variables. It also defines an Adminer service. See Listing <span class="InternalRef"><a href="#PC35">11-35</a></span>.<div class="ProgramCode" id="PC35"><div class="LineGroup"><div class="FixedLine">apiVersion: v1</div><div class="FixedLine">kind: Service</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: adminer</div><div class="FixedLine">  labels:</div><div class="FixedLine">    group: db</div><div class="FixedLine">spec:</div><div class="FixedLine">  type: ClusterIP</div><div class="FixedLine">  selector:</div><div class="FixedLine">    app: adminer</div><div class="FixedLine">  ports:</div><div class="FixedLine">    - port: 8080</div><div class="FixedLine">      targetPort: 8080</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-35</span><p class="SimplePara">The <span id="ITerm67">Service Definition YAML File</span> for Adminer (ch11\ch11-03\adminer-svc.yml)</p></div></div></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec18">

          <h3 class="Heading">Run Ingress and Microservices in Kubernetes</h3>

          <div class="Para" id="Par93">This example assumes that your <span id="ITerm68">single-node Kubernetes</span> cluster, <span id="ITerm69">Minikube</span>, is up and running, and that you have already enabled the Ingress add-on in Minikube, as specified in Appendix E. You now have a simple script, containing a single command, to build and run the complete application with all the deployment descriptors, as shown in Listing <span class="InternalRef"><a href="#PC36">11-36</a></span>.<div class="ProgramCode" id="PC36"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-03 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-03 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch11/ch11-03</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-03 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-03 binil$ sh makeandrun.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] Reactor Build Order:</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Ecom-Product-Server-Microservice                 [jar]</div><div class="FixedLine">[INFO] Ecom-Product-Web-Microservice                    [jar]</div><div class="FixedLine">[INFO] Ecom                                             [pom]</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] -&lt;com...product:Ecom-Product-Server-Microservice&gt;-</div><div class="FixedLine">[INFO] Building Ecom-Product-Server-Microservice 0.0.1-SNAPSHOT</div><div class="FixedLine">[INFO] --------------------------------[ jar ]--------------</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Ecom-Product-Server-Microservice . SUCCESS [  2.975 s]</div><div class="FixedLine">[INFO] Ecom-Product-Web-Microservice .... SUCCESS [  0.660 s]</div><div class="FixedLine">[INFO] Ecom ............................. SUCCESS [  0.020 s]</div><div class="FixedLine">[INFO] ------------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] ------------------------------------------------------</div><div class="FixedLine">[INFO] Total time:  3.850 s</div><div class="FixedLine">[INFO] Finished at: 2023-05-28T22:17:15+05:30</div><div class="FixedLine">[INFO] ------------------------------------------------------</div><div class="FixedLine">...</div><div class="FixedLine">Successfully tagged ecom/product-web:latest</div><div class="FixedLine">Successfully tagged ecom/product-server:latest</div><div class="FixedLine">configmap/postgres-config created</div><div class="FixedLine">persistentvolumeclaim/postgres-persistent-volume-claim created</div><div class="FixedLine">deployment.apps/postgres created</div><div class="FixedLine">service/postgres created</div><div class="FixedLine">deployment.apps/adminer created</div><div class="FixedLine">service/adminer created</div><div class="FixedLine">deployment.apps/product-server created</div><div class="FixedLine">service/product-server created</div><div class="FixedLine">deployment.apps/product-web created</div><div class="FixedLine">service/product-web created</div><div class="FixedLine">ingress.networking.k8s.io/ingress-service created</div><div class="FixedLine">http://192.168.64.6:31858</div><div class="FixedLine">NAME                              READY   STATUS    RESTART</div><div class="FixedLine">adminer-847f44cbd4-hg4gf          1/1     Running   0</div><div class="FixedLine">postgres-89dbf9fd9-vr8k2          0/1     Pending   0</div><div class="FixedLine">product-server-5bf9db77dc-v9jl7   1/1     Running   0</div><div class="FixedLine">product-web-7496dc46f9-fqfkq      1/1     Running   0</div><div class="FixedLine">NAME           TYPE      CLUSTER-IP     PORT(S)        AGE</div><div class="FixedLine">adminer        ClusterIP 10.104.83.51   8080/TCP       4s</div><div class="FixedLine">kubernetes     ClusterIP 10.96.0.1      443/TCP        11d</div><div class="FixedLine">postgres       ClusterIP 10.104.112.235 5432/TCP       5s</div><div class="FixedLine">product-server ClusterIP 10.104.42.20   8081/TCP       4s</div><div class="FixedLine">product-web    NodePort  10.106.179.41  8080:31858/TCP 4s</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-03 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-36</span><p class="SimplePara">Executing the Script to Build and Run Microservices in Kubernetes (ch11\ch11-03\makeandrun.sh)</p></div></div></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec19">

          <h3 class="Heading">Describing Ingress</h3>

          <div class="Para" id="Par94">Once the pods are up and running, you can <span id="ITerm70">describe</span> the Ingress object you have created. See Listing <span class="InternalRef"><a href="#PC37">11-37</a></span>.<div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl describe ingress</div><div class="FixedLine">Name:             ingress-service</div><div class="FixedLine">Labels:           &lt;none&gt;</div><div class="FixedLine">Namespace:        default</div><div class="FixedLine">Address:          192.168.64.6</div><div class="FixedLine">Ingress Class:    &lt;none&gt;</div><div class="FixedLine">Default backend:  &lt;default&gt;</div><div class="FixedLine">Rules:</div><div class="FixedLine">  Host                Path  Backends</div><div class="FixedLine">  ----                ----  --------</div><div class="FixedLine">  adminer.acme.test</div><div class="FixedLine">                      /   adminer:8080 (10.244.1.234:8080)</div><div class="FixedLine">  products.acme.test</div><div class="FixedLine">                      /   product-web:8080 (10.244.1.233:8080)</div><div class="FixedLine">Annotations:          kubernetes.io/ingress.class: nginx</div><div class="FixedLine">Events:</div><div class="FixedLine">  Type    Reason  Age                    From                      Message</div><div class="FixedLine">  ----    ------  ---------------------  ------------------------  --------</div><div class="FixedLine">  Normal  Sync    7m15s (x2 over 7m44s)  nginx-ingress-controller  Scheduled for sync</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-37</span><p class="SimplePara">Describing the Ingress Kubernetes Object</p></div></div></div></div>

          <p class="Para" id="Par95">As you can see, the routes you specified while <span id="ITerm71">creating</span> the Ingress Kubernetes objects are configured successfully. Let’s now attempt to access those routes.</p>

          <p class="Para" id="Par96">You are now ready to test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec20">

          <h3 class="Heading">Testing the Microservice Pods</h3>

          <p class="Para" id="Par97">You can access the Product Web microservice using the <span id="ITerm72">hostname</span> you configured (see Figure <span class="InternalRef"><a href="#Fig6">11-6</a></span>).</p>

          <div class="Para" id="Par98"><span class="ExternalRef"><a href="http://products.acme.test/product.html"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://products.acme.test/product.html</span></span></a></span><figure class="Figure" id="Fig6"><div class="MediaObject" id="MO6"><img alt="" aria-describedby="d64e3036" src="../images/619782_1_En_11_Chapter/Imagem-123.jpg" style="width:35.15em"/><div class="TextObject" id="d64e3036"><p class="Para" id="Par110">A screenshot of the bootstrap C R U D data table browser tab. It has a table of manage products with the add new product button at the top. The table has columns of i d, name, code, title, price, and actions with 2 rows of data.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-6</span><p class="SimplePara">Accessing the Product Web microservice using the hostname</p></div></figcaption></figure></div>

          <p class="Para" id="Par99">Note the <span id="ITerm73">URL address</span> in Figure <span class="InternalRef"><a href="#Fig6">11-6</a></span>. Refer to the section titled “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the <span id="ITerm74">Product Web microservice</span> container. While you test the microservices, you can keep watching the log windows of the Product Web and Product Server microservices.</p>

          <div class="Para" id="Par100">Recall that you also configured the Adminer UI. You can now attempt to access the <span id="ITerm75">PostgreSQL database</span> through the Adminer UI. Use the second URL for that: <span class="ExternalRef"><a href="http://adminer.acme.test"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://adminer.acme.test</span></span></a></span>.<figure class="Figure" id="Fig7"><div class="MediaObject" id="MO7"><img alt="" aria-describedby="d64e3083" src="../images/619782_1_En_11_Chapter/Imagem-124.jpg" style="width:35.15em"/><div class="TextObject" id="d64e3083"><p class="Para" id="Par111">A screenshot of the login admirer browser tab. It has the login section on the right with the admirer version and language on the left. The login section has the system dropdown menu, server, username, password, and database input boxes, and the login button with a permanent login checkbox.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-7</span><p class="SimplePara">Accessing the PostgreSQL database using the Adminer UI</p></div></figcaption></figure></div>

          <div class="Para" id="Par101">Note the <span id="ITerm76">URL address</span> in Figure <span class="InternalRef"><a href="#Fig7">11-7</a></span>. It provides the credentials configured in <span class="EmphasisFontCategoryNonProportional ">postgres-config.yml</span>. If you can successfully log in, you can view the tables that the Product Server microservice initialized. See Figure <span class="InternalRef"><a href="#Fig8">11-8</a></span>.<figure class="Figure" id="Fig8"><div class="MediaObject" id="MO8"><img alt="" aria-describedby="d64e3120" src="../images/619782_1_En_11_Chapter/Imagem-125.jpg" style="width:35.15em"/><div class="TextObject" id="d64e3120"><p class="Para" id="Par112">A screenshot of the schema public browser tab. It has the schema public section on the right with the admirer version, language, and 2 dropdown menus with various options on the left. The schema section has the tables and views section with a search bar and a table with 8 columns and 3 rows with checkboxes and others.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 11-8</span><p class="SimplePara">Adminer <span id="ITerm77">UI displaying</span> the new tables</p></div></figcaption></figure></div>

          <div class="Para" id="Par102">Once you test all the microservices from this example, you can stop and remove the microservice containers and clean the environment, as shown in Listing <span class="InternalRef"><a href="#PC38">11-38</a></span>.<div class="ProgramCode" id="PC38"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-03 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch11/ch11-03</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-03 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-03 binil$ sh clean.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] Reactor Build Order:</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Ecom-Product-Server-Microservice                 [jar]</div><div class="FixedLine">[INFO] Ecom-Product-Web-Microservice                    [jar]</div><div class="FixedLine">[INFO] Ecom                                             [pom]</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Ecom-Product-Server-Microservice . SUCCESS [  0.114 s]</div><div class="FixedLine">[INFO] Ecom-Product-Web-Microservice .... SUCCESS [  0.009 s]</div><div class="FixedLine">[INFO] Ecom ............................. SUCCESS [  0.036 s]</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] Total time:  0.384 s</div><div class="FixedLine">[INFO] Finished at: 2023-05-28T22:46:54+05:30</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">service "product-web" deleted</div><div class="FixedLine">deployment.apps "product-web" deleted</div><div class="FixedLine">service "product-server" deleted</div><div class="FixedLine">deployment.apps "product-server" deleted</div><div class="FixedLine">service "adminer" deleted</div><div class="FixedLine">deployment.apps "adminer" deleted</div><div class="FixedLine">service "postgres" deleted</div><div class="FixedLine">deployment.apps "postgres" deleted</div><div class="FixedLine">persistentvolumeclaim "postgres-persistent-volume-claim" deleted</div><div class="FixedLine">configmap "postgres-config" deleted</div><div class="FixedLine">ingress.networking.k8s.io "ingress-service" deleted</div><div class="FixedLine">Untagged: ecom/product-web:latest</div><div class="FixedLine">Untagged: ecom/product-server:latest</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch11-03 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-38</span><p class="SimplePara">Cleaning the Project and the Environment</p></div></div></div></div>

          <p class="Para" id="Par103">This completes the last example in this chapter.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec21">

        <h2 class="Heading">Summary</h2>

        <p class="Para" id="Par104">The last chapter introduced <span id="ITerm78">Kubernetes</span> and the familiar microservices example interacting with an SQL and a NoSQL database. The current chapter is an extension of that, where you looked at Kafka in Kubernetes. You also learned that all the design primitives—including the correlation between multiple instances of the consumer and provider microservices—all work in the <span id="ITerm79">Kubernetes</span> toolset as expected. Finally, you learned about Ingress, which can expose multiple services through a single IP address, giving you a practical and economic means of exposing multiple services to the external world. The next step is to look at a few more tools that can help you further reduce and manage complexity in a production scenario of microservices, where you have more than a dozen of them. This is the topic of the next chapter.</p>

      </section>

    </div>

  </div>

</body>

</html>