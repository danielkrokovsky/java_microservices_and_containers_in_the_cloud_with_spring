<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en">

<head>
  <title>Composing Multi-Service Containers</title>
  <link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>

<body>

  <div epub:type="chapter" role="doc-chapter">

    <div class="ChapterContextInformation">

      <div class="ContextInformation" id="b979-8-8688-0555-4_9"><div class="ChapterCopyright">© The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature 2024</div><span class="ContextInformationAuthorEditorNames">B. A. Christudas</span><span class="ContextInformationBookTitles"><span class="BookTitle">Java Microservices and Containers in the Cloud</span></span><span class="ChapterDOI"><a href="https://doi.org/10.1007/979-8-8688-0555-4_9">https://doi.org/10.1007/979-8-8688-0555-4_9</a></span></div>

    </div>

    <!--Begin Abstract-->

    <div class="MainTitleSection">

      <h1 class="ChapterTitle" lang="en">9. Composing Multi-Service Containers</h1>

    </div>

    <div class="AuthorGroup">

      <div class="AuthorNames"><span class="Author"><span class="AuthorName">Binildas A. Christudas</span><sup><a href="#Aff2">1</a> <span class="ContactIcon"> </span></sup></span></div>

      <div class="Affiliations">

        <div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">NBCRA 45, Christbin, Thiruvananthapuram, Kerala, India</div></div>

        <div class="ClearBoth"> </div>

      </div>

    </div>

    <!--End Abstract-->

    <div class="Fulltext">

      <p class="Para" id="Par2">As <span id="ITerm1">microservices applications</span> grow beyond a handful of services, we often need some way to define inter-dependency and inter-connectivity options between these services. We also need an elegant way to manage these services. Tools like Docker Compose and Kubernetes have quickly become commonplace for these types of requirements. This chapter looks at Docker Compose, followed by Kubernetes in the next chapter.</p>

      <div class="Para" id="Par3"><span id="ITerm2">Docker Compose</span> is used for easily defining and running multi-container Docker applications or microservices. In the previous two chapters, you learned how to effectively utilize Docker to containerize applications. When it comes to microservices, any trivial application will have more than a dozen microservices, which is many more compared to the classical single <span class="EmphasisFontCategoryNonProportional ">.ear</span> or single <span class="EmphasisFontCategoryNonProportional ">.jar</span> kind of monolith deployments. With <span id="ITerm3">Docker Compose</span>, you can use a single YAML file to configure your microservice application’s services. Then, with a single command, you create and start all the services from your YAML configuration. The following concepts are covered in this chapter.<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par4">A quick introduction to Docker Compose</p></li><li><p class="Para" id="Par5">Composing microservices and database containers together</p></li><li><p class="Para" id="Par6">Adding message broker containers to the composition</p></li><li><p class="Para" id="Par7">Demonstrating Full CRUD functionality across composed containers</p></li></ul></div></div>

      <p class="Para" id="Par8">As has been mentioned, the objective is to explain and demonstrate aspects in gradually increasing levels of complexity. So, the code examples start from where the last chapter stopped. It’s best to read Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span> before you read this chapter, so that you are acquitted with the basics of running container infrastructure. This chapter provides step-by-step instructions if you want to start straight into this chapter.</p>

      <section class="Section1 RenderAsSection1" id="Sec1">

        <h2 class="Heading">Introducing Docker Compose</h2>

        <p class="Para" id="Par9">As explained, when using Docker for containerization, managing many different containers can quickly become cumbersome. <span id="ITerm4">Docker Compose</span> is a tool that helps you overcome this problem and handle multiple containers at once.</p>

        <div class="Para" id="Par10">Using Docker Compose <span id="ITerm5">for packaging and deployment management</span> is basically a three-step process:<div class="OrderedList"><ol><li class="ListItem"><div class="ItemNumber">1.</div><div class="ItemContent"><p class="Para" id="Par11">You define your application’s environment with a Dockerfile so that it can be reproduced anywhere.</p></div><div class="ClearBoth"> </div></li><li class="ListItem"><div class="ItemNumber">2.</div><div class="ItemContent"><p class="Para" id="Par12">You define the services that make up your application in <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span> so that they can be run together in an isolated environment.</p></div><div class="ClearBoth"> </div></li><li class="ListItem"><div class="ItemNumber">3.</div><div class="ItemContent"><p class="Para" id="Par13">As the final step, you run <span class="EmphasisFontCategoryNonProportional ">docker compose up</span>, and this command starts and runs your entire app.</p></div><div class="ClearBoth"> </div></li></ol></div></div>

        <p class="Para" id="Par14">The next section delves into how this compose file looks.</p>

        <section class="Section2 RenderAsSection2" id="Sec2">

          <h3 class="Heading">Docker Compose YAML</h3>

          <p class="Para" id="Par15">In <span id="ITerm6">Docker Compose</span>, you declare rules declared within a single <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span> configuration file. These YAML rules are both human-readable and machine-optimized, and hence verbal enough for you to declare the interdependencies of multiple containers. This helps you manage multiple microservices in a single application’s deployment landscape.</p>

          <div class="Para" id="Par16">In a Docker Compose <span id="ITerm7">YAML file</span>, you need to specify the version of the Compose file format, at least one service, and optionally <span id="ITerm8">volumes and networks</span>. The general format is shown in Listing <span class="InternalRef"><a href="#PC1">9-1</a></span>.<div class="ProgramCode" id="PC1"><div class="LineGroup"><div class="FixedLine">version: "3"</div><div class="FixedLine">services:</div><div class="FixedLine">  ...</div><div class="FixedLine">  ...</div><div class="FixedLine">volumes:</div><div class="FixedLine">  ...</div><div class="FixedLine">networks:</div><div class="FixedLine">  ...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-1</span><p class="SimplePara">Docker Compose YAML Format</p></div></div></div></div>

          <p class="Para" id="Par17">Volumes, as explained in the previous chapters, are physical areas of disk space in the host computer shared between the host and a container, or even between containers. In other words, a volume is a shared directory in the host, visible from containers that have access.</p>

          <p class="Para" id="Par18"><span id="ITerm9">Networks</span> define the communication path and rules between containers, and between a container and the host. Shared or common network zones will make containers’ services discoverable by each other, while private zones will segregate them into virtual sandboxes.</p>

          <div class="Para" id="Par19">Services are typically logical groupings of related container services. As an example, a web application with different tiers could be declared, as shown in Listing <span class="InternalRef"><a href="#PC2">9-2</a></span>.<div class="ProgramCode" id="PC2"><div class="LineGroup"><div class="FixedLine">services:</div><div class="FixedLine">    app:</div><div class="FixedLine">        image: my-js-app</div><div class="FixedLine">        ...</div><div class="FixedLine">    backend:</div><div class="FixedLine">        image: my-boot-app</div><div class="FixedLine">        ...</div><div class="FixedLine">    db:</div><div class="FixedLine">        image: mongo</div><div class="FixedLine">        ...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-2</span><p class="SimplePara">Docker Composing Typical 3 <span id="ITerm10">Tier Service</span></p></div></div></div></div>

          <p class="Para" id="Par20">There are many more constructs available in <span id="ITerm11">Docker Compose</span>, and in line with the theme of this book, you will learn by doing things.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec3">

          <h3 class="Heading">Docker Compose Use Cases</h3>

          <div class="Para" id="Par21">Even though there are more <span id="ITerm12">tools</span> available for managing containerized applications, Docker Compose has its use in a few scenarios, such as:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par22">Developer environment: One of the best use cases for Docker Compose is in enabling developers to “getting started,” which is highly useful for new entrants to a project. Docker Compose can reduce a multi-page “developer getting started guide” into a single machine-readable Compose file and a few commands that anyone can bring up using a single button. The Docker Compose file provides a way to document and configure all the application’s service dependencies (databases, message queues, caches, web service APIs, presentation apps, etc.). Using the Compose command-line tool, you can create and start one or more containers for each dependency with a single <span class="EmphasisFontCategoryNonProportional ">docker-compose up</span> command.</p></li><li><p class="Para" id="Par23">Automating test environments: Test automation is an essential part of any Continuous Deployment or Continuous Integration process and Docker Compose provides a convenient way to create and destroy testing environments custom defined for your test suite.</p></li></ul></div></div>

          <div class="Para" id="Par24">You can create and destroy these <span id="ITerm13">environments</span> in a few commands within a Compose file:<div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine">docker-compose up</div><div class="FixedLine">./run_your tests</div><div class="FixedLine">docker-compose down</div></div></div></div>

          <p class="Para" id="Par25">As mentioned, you will learn best by doing things, so let’s jump straight to concrete coding examples.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec4">

        <h2 class="Heading">Composing Microservice with PostgreSQL Containers</h2>

        <p class="Para" id="Par26">Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span> explained why it’s better to deploy state-handling applications including databases outside <span id="ITerm14">Docker container</span>, since containers are designed to be more efficient in stateless kinds of operations. There can still be use cases where you’d want your database within a container, such as in cases of rapid testing. In Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span>, you saw a full-fledged microservice interaction with a <span id="ITerm15">PostgreSQL database</span>, all in <span id="ITerm16">Docker containers</span>. Refer to Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span> for the overall design of it. In this section, you will modify that example to be fully deployed within a container infrastructure using Docker Compose.</p>

        <section class="Section2 RenderAsSection2" id="Sec5">

          <h3 class="Heading">Composing the Container Topology</h3>

          <div class="Para" id="Par27">For this <span id="ITerm17">composition</span>, you need a complete <span id="ITerm18">container-based deployment topology</span>, as shown in Figure <span class="InternalRef"><a href="#Fig1">9-1</a></span>. The Product Web and Product Server microservices are both containerized, and the Product Server microservice will connect to a <span id="ITerm19">PostgreSQL database</span>, again deployed within a container.<figure class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img alt="" aria-describedby="d64e464" src="../images/619782_1_En_9_Chapter/Imagem-102.jpg" style="width:35.15em"/><div class="TextObject" id="d64e464"><p class="Para" id="Par137">A diagram illustrates the complete container-based deployment. It starts with user, followed by browser, command line, docker C L I, docker daemon, container engine, host O S, and hardware.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 9-1</span><p class="SimplePara">Composing microservice containers</p></div></figcaption></figure></div>

          <p class="Para" id="Par28">Here, the <span id="ITerm20">Product Web and Product Server</span> containers provide business services, whereas the <span id="ITerm21">PostgreSQL container</span> provides application services for persisting state.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec6">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par29">The <span id="ITerm22">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch09\ch09-01</span> folder. Much of the source code in this example is similar to <span class="EmphasisFontCategoryNonProportional ">ch03\ch03-01</span>, which was explained in detail in Chapter <span class="ExternalRef"><a href="Capítulo-05.html"><span class="RefSource">3</span></a></span> in the section titled “Microservices Using PostgreSQL and RestTemplate” and in Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span> in the section titled “<span id="ITerm23">Microservice</span> and PostgreSQL in Container.” You saw the deployment schema of these multiple interacting microservices using a PostgreSQL database in the previous chapter, so this section looks specifically into composing them using Docker Compose.</p>

          <p class="Para" id="Par30">Connecting from a containerized microservice to a containerized <span id="ITerm24">PostgreSQL server</span> is rather straightforward, so there are very few changes to be made when running the containers alone. The next section investigates those changes.</p>

          <div class="Para" id="Par31">Listing <span class="InternalRef"><a href="#PC4">9-3</a></span> shows the source code <span id="ITerm25">organization</span> for this example.<div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine">ch09-01</div><div class="FixedLine">├── 01-ProductServer</div><div class="FixedLine">│   ├── Dockerfile</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── 02-ProductWeb</div><div class="FixedLine">│   ├── Dockerfile</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── docker-compose.yml</div><div class="FixedLine">├── makeandrun.sh</div><div class="FixedLine">└── pom.xml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-3</span><p class="SimplePara">Example 09-01 Source Code Organization</p></div></div></div></div>

          <div class="Para" id="Par32">A concise representation of the source code <span id="ITerm26">organization</span> for the example inside the <span class="EmphasisFontCategoryNonProportional ">ch09-01</span> folder is shown in Listing <span class="InternalRef"><a href="#PC4">9-3</a></span>. Of interest here are <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span> and the Dockerfile placed inside the two project folders.<div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">version: "3"</div></div><div class="LineGroup"><div class="FixedLine">services:</div></div><div class="LineGroup"><div class="FixedLine">    db:</div><div class="FixedLine">        image: "postgres:9.6-alpine"</div><div class="FixedLine">        container_name: postgres-docker</div><div class="FixedLine">        volumes:</div><div class="FixedLine">            - product-data:/var/lib/postgresql/data</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - 5432:5432</div><div class="FixedLine">        environment:</div><div class="FixedLine">            - POSTGRES_DB=productdb</div><div class="FixedLine">            - POSTGRES_USER=postgres</div><div class="FixedLine">            - POSTGRES_PASSWORD=postgre</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div></div><div class="LineGroup"><div class="FixedLine">    server:</div><div class="FixedLine">        build: ./01-ProductServer</div><div class="FixedLine">        image: ecom/product-server</div><div class="FixedLine">        container_name: product-server</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - "8081:8081"</div><div class="FixedLine">        depends_on:</div><div class="FixedLine">            - "db"</div><div class="FixedLine">        environment:</div><div class="FixedLine">            - DB_SERVER=postgres-docker:5432</div><div class="FixedLine">            - POSTGRES_DB=productdb</div><div class="FixedLine">            - POSTGRES_USER=postgres</div><div class="FixedLine">            - POSTGRES_PASSWORD=postgre</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div></div><div class="LineGroup"><div class="FixedLine">    web:</div><div class="FixedLine">        build: ./02-ProductWeb</div><div class="FixedLine">        image: ecom/product-web</div><div class="FixedLine">        container_name: product-web</div><div class="FixedLine">        depends_on:</div><div class="FixedLine">            - "server"</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - "8080:8080"</div><div class="FixedLine">        environment:</div><div class="FixedLine">            - acme.PRODUCT_SERVICE_URL=http://product-server:8081/products</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div></div><div class="LineGroup"><div class="FixedLine">volumes:</div><div class="FixedLine">    product-data:</div></div><div class="LineGroup"><div class="FixedLine">networks:</div><div class="FixedLine">    ecom-network:</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-4</span><p class="SimplePara">The <span id="ITerm27">Docker Compose</span> YAML File (ch09\ch09-01\docker-compose.yml)</p></div></div></div></div>

          <p class="Para" id="Par33">There are three services defined here, each one an abstract definition of a computing resource within an application that can be scaled/replaced independent of other components. Each service is backed by a container and run by the platform according to the replication requirements and placement constraints. Each of these services backed by containers are defined by a Docker image and a set of runtime arguments. All containers within a service are identically created with these arguments.</p>

          <p class="Para" id="Par34">You need to build an image of the server and the web from the source code by reading its Dockerfile. You can use the <span class="EmphasisFontCategoryNonProportional ">build</span> keyword, passing the path to the <span id="ITerm28">Dockerfile</span> as the value. When you specify <span class="EmphasisFontCategoryNonProportional ">./01-ProductServer</span> and <span class="EmphasisFontCategoryNonProportional ">./02-ProductWeb</span>, you mention that relative to the current directory (where you have the <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span>), go in one more folder into each of these mentioned folders to find the corresponding Dockerfile.</p>

          <p class="Para" id="Par35">When the image you need for the service (as in the case of <span class="EmphasisFontCategoryNonProportional ">db</span>) has already been published (by you or by others) in <span id="ITerm29">Docker Hub</span> or another Docker Registry, it’s called using the <span class="EmphasisFontCategoryNonProportional ">image</span> attribute, by specifying the image name and tag. But when you can specify the image name in conjunction with the <span class="EmphasisFontCategoryNonProportional ">build</span> attribute, as in the case of server and web, you name the image, making it available to other services.</p>

          <p class="Para" id="Par36">To reach a container from the host, the ports of the services must be exposed declaratively through the <span class="EmphasisFontCategoryNonProportional ">ports</span> keyword, as if you were using <span class="EmphasisFontCategoryNonProportional ">8080</span> for <span class="EmphasisFontCategoryNonProportional ">web</span>, <span class="EmphasisFontCategoryNonProportional ">8081</span> for <span class="EmphasisFontCategoryNonProportional ">server</span> and <span class="EmphasisFontCategoryNonProportional ">5432</span> for <span class="EmphasisFontCategoryNonProportional ">db</span>. This also allows you to choose to expose the port differently in the host, if required.</p>

          <p class="Para" id="Par37">The three containers—<span class="EmphasisFontCategoryNonProportional ">web</span>, <span class="EmphasisFontCategoryNonProportional ">server</span>, and <span class="EmphasisFontCategoryNonProportional ">db</span>—communicate between themselves in networks created implicitly or through configurations by <span id="ITerm30">Docker Compose</span>, as you do in the example. A service can communicate with another service on the same network by simply referencing it by container name and port (for example, <span class="EmphasisFontCategoryNonProportional ">product-server:8081</span>), if you’ve made the port accessible through the <span class="EmphasisFontCategoryNonProportional ">expose</span> keyword.</p>

          <p class="Para" id="Par38">Docker manages both anonymous and named volumes, automatically mounting them in self-generated directories in the host. <span class="EmphasisFontCategoryNonProportional ">product-data</span> is a named volume accessible to the <span class="EmphasisFontCategoryNonProportional ">db</span> service. <span class="EmphasisFontCategoryNonProportional ">/var/lib/postgresql/data</span> is the path it’s mapped to, which will be used by the <span class="EmphasisFontCategoryNonProportional ">postgres-docker</span> container.</p>

          <p class="Para" id="Par39">You might also need to create a dependency chain between these services, so that some services are loaded before (and unloaded after) the other ones. You can achieve this result through the <span class="EmphasisFontCategoryNonProportional ">depends_on</span> keyword. You want the <span class="EmphasisFontCategoryNonProportional ">db</span> to be loaded before you load the <span class="EmphasisFontCategoryNonProportional ">server</span> because you have the initialization script in <span class="EmphasisFontCategoryNonProportional ">server</span>, inserting the initial load data to the <span class="EmphasisFontCategoryNonProportional ">db</span>.</p>

          <p class="Para" id="Par40">Providing the required environment variables is easy in Compose. You can define static and dynamic environment variables, the latter with the <span class="EmphasisFontCategoryNonProportional ">${}</span> notation. For example: <span class="EmphasisFontCategoryNonProportional ">DB_SERVER=postgres-docker:5432</span>.</p>

          <div class="Para" id="Par41">As explained, relative to the current directory (where the <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span> is located), the <span id="ITerm31">Dockerfile</span> is found here:<div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">build: ./01-ProductServer</div></div></div></div>

          <div class="Para" id="Par42">Listing <span class="InternalRef"><a href="#PC7">9-5</a></span> shows this file.<div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine">FROM maven:3.6.1-jdk-8-slim AS build</div><div class="FixedLine">RUN mkdir -p /workspace</div><div class="FixedLine">WORKDIR /workspace</div><div class="FixedLine">COPY pom.xml /workspace</div><div class="FixedLine">COPY src /workspace/src</div><div class="FixedLine">RUN mvn -f pom.xml clean package</div></div><div class="LineGroup"><div class="FixedLine">FROM openjdk:8-alpine</div><div class="FixedLine">COPY --from=build /workspace/target/*.jar app.jar</div><div class="FixedLine">EXPOSE 8081</div><div class="FixedLine">ENTRYPOINT ["java","-jar","app.jar"]</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-5</span><p class="SimplePara">The <span id="ITerm32">Dockerfile</span> (ch09\ch09-01\01-ProductServer\Dockerfile)</p></div></div></div></div>

          <p class="Para" id="Par43">A multi-stage build file is used here. With multi-stage builds, you can use multiple <span class="EmphasisFontCategoryNonProportional ">FROM</span> statements in your Dockerfile. Each <span class="EmphasisFontCategoryNonProportional ">FROM</span> instruction can use a different base, and each begins a new stage of the build. You can selectively copy artifacts from one stage to another.</p>

          <p class="Para" id="Par44">You can name your stages by adding an <span class="EmphasisFontCategoryNonProportional ">AS &lt;NAME&gt;</span> to the <span class="EmphasisFontCategoryNonProportional ">FROM</span> instruction. The name <span class="EmphasisFontCategoryNonProportional ">build</span> is used in this example. This name can be used in the second stage in the <span class="EmphasisFontCategoryNonProportional ">COPY</span> instruction. This means that even if the instructions in your <span id="ITerm33">Dockerfile</span> are reordered later, the <span class="EmphasisFontCategoryNonProportional ">COPY</span> doesn’t break.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec7">

          <h3 class="Heading">Run Containers Using Docker Compose</h3>

          <div class="Para" id="Par45">The <span class="EmphasisFontCategoryNonProportional ">ch09\ch09-04</span> folder contains the scripts required to build and run these examples. The first step is to start a Minikube single-node Kubernetes cluster so that you have a Docker Daemon up. Refer to Appendix E for a quick reference to the container commands. See Listing <span class="InternalRef"><a href="#PC8">9-6</a></span>.<div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ pwd</div><div class="FixedLine">/Users/binil</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ minikube start</div><div class="FixedLine">  minikube v1.25.2 on Darwin 12.4</div><div class="FixedLine">...</div><div class="FixedLine">  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-6</span><p class="SimplePara">Starting Minikube</p></div></div></div></div>

          <p class="Para" id="Par46">You also need to set the <span id="ITerm34">Minikube environment</span> variables in your work terminal.</p>

          <div class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant" id="FPar1">

            <div class="Heading">Note</div>

            <p class="Para FirstParaInFormalPara" id="Par47">For all the examples in this chapter, I assume the previous two steps connected to the Docker Daemon have been executed if you are using the Minikube single-node Kubernetes cluster.</p>

          </div>

          <div class="Para" id="Par48">Listing <span class="InternalRef"><a href="#PC9">9-7</a></span> shows a simple script containing a single command that builds and runs the complete application with all the defined containers.<div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine">docker-compose up</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-7</span><p class="SimplePara">The Script to Build and Run Microservices Docker Containers (ch09\ch09-01\makeandrun.sh)</p></div></div></div></div>

          <div class="Para" id="Par49">You can build the microservices and the <span id="ITerm35">Docker images</span> and then run the containers, as shown in Listing <span class="InternalRef"><a href="#PC10">9-8</a></span>.<div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-01 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch09/ch09-01</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-01 binil$ sh makeandrun.sh</div><div class="FixedLine">[+] Running 0/2</div><div class="FixedLine"> ⠿ web Error</div><div class="FixedLine"> ⠿ server Error</div><div class="FixedLine">[+] Building 58.4s (16/20)</div><div class="FixedLine"> =&gt; [ecom/product-server internal] load build context</div><div class="FixedLine"> =&gt; =&gt; transferring context: 5.06kB</div><div class="FixedLine"> =&gt; [ecom/product-web internal] load build context</div><div class="FixedLine"> =&gt; =&gt; transferring context: 4.92kB</div><div class="FixedLine"> =&gt; CACHED [ecom/product-web build 2/6] RUN mkdir -p /workspace</div><div class="FixedLine"> =&gt; CACHED [ecom/product-web build 3/6] WORKDIR /workspace</div><div class="FixedLine"> =&gt; CACHED [ecom/product-server build 4/6] COPY pom.xml /workspace</div><div class="FixedLine"> =&gt; [ecom/product-server build 5/6] COPY src /workspace/src</div><div class="FixedLine"> =&gt; CACHED [ecom/product-web build 4/6] COPY pom.xml /workspace</div><div class="FixedLine"> =&gt; [ecom/product-web build 5/6] COPY src /workspace/src</div><div class="FixedLine"> =&gt; [ecom/product-server build 6/6] RUN mvn -f pom.xml clean package</div><div class="FixedLine"> =&gt; =&gt; # erxml/jackson/core/jackson-core/2.11.4/jackson-core-2.11.4.pom (4.9 kB</div><div class="FixedLine"> =&gt; =&gt; #  at 6.2 kB/s)</div><div class="FixedLine"> =&gt; =&gt; # Downloading from central: https://repo.maven.apache.org/maven2/com/fas</div><div class="FixedLine"> =&gt; =&gt; # terxml/jackson/datatype/jackson-datatype-jdk8/2.11.4/jackson-datatype-</div><div class="FixedLine"> =&gt; =&gt; # jdk8-2.11.4.pom</div><div class="FixedLine"> =&gt; =&gt; # Progress (1): 2.2 kB</div><div class="FixedLine"> =&gt; [ecom/product-web build 6/6] RUN mvn -f pom.xml clean package         56.6s</div><div class="FixedLine"> =&gt; =&gt; # Downloaded from central: https://repo.maven.apache.org/maven2/com/fast</div><div class="FixedLine"> =&gt; =&gt; # erxml/jackson/datatype/jackson-datatype-jsr310/2.11.4/jackson-datatype</div><div class="FixedLine"> =&gt; =&gt; # -jsr310-2.11.4.pom (4.5 kB at 6.0 kB/s)</div><div class="FixedLine"> =&gt; =&gt; # Downloading from central: https://repo.maven.apache.org/maven2/com/fas</div><div class="FixedLine"> =&gt; =&gt; # terxml/jackson/module/jackson-module-parameter-names/2.11.4/jackson-mo</div><div class="FixedLine"> =&gt; =&gt; # dule-parameter-names-2.11.4.pom</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-8</span><p class="SimplePara">Executing the <span id="ITerm36">Docker Compose</span> Up Command</p></div></div></div></div>

          <div class="Para" id="Par50">If this is the first time you are running this command, the <span id="ITerm37">microservices</span> will be built first using Maven. This is shown in Listing <span class="InternalRef"><a href="#PC10">9-8</a></span>. The completion of the <span class="EmphasisFontCategoryNonProportional ">docker-compose up</span> command is shown in Listing <span class="InternalRef"><a href="#PC11">9-9</a></span>.<div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-01 binil$ docker-compose up</div><div class="FixedLine">[+] Running 0/2</div><div class="FixedLine"> ⠿ web Error</div><div class="FixedLine"> ⠿ server Error</div><div class="FixedLine">[+] Building 381.2s (21/21) FINISHED</div><div class="FixedLine">...</div><div class="FixedLine"> =&gt; [ecom/product-web stage-1 2/2] COPY --from=build /workspace/target/*.</div><div class="FixedLine"> =&gt; [ecom/product-server] exporting to image</div><div class="FixedLine"> =&gt; =&gt; exporting layers</div><div class="FixedLine"> =&gt; =&gt; writing image sha256:76407061fc0df84b795e7aa818e4eca8189ba2d4e76f6</div><div class="FixedLine"> =&gt; =&gt; naming to docker.io/ecom/product-web</div><div class="FixedLine"> =&gt; =&gt; writing image sha256:05dc3a6cbb0248e6353beac61240a7f81155c47264644</div><div class="FixedLine"> =&gt; =&gt; naming to docker.io/ecom/product-server</div><div class="FixedLine"> =&gt; [ecom/product-server stage-1 2/2] COPY --from=build /workspace/target</div><div class="FixedLine">[+] Running 4/2</div><div class="FixedLine"> ⠿ Network ch09-01_ecom-network  Created</div><div class="FixedLine"> ⠿ Container postgres-docker     Created</div><div class="FixedLine"> ⠿ Container product-server      Created</div><div class="FixedLine"> ⠿ Container product-web         Created</div><div class="FixedLine">Attaching to postgres-docker, product-server, product-web</div><div class="FixedLine">postgres-docker  |</div><div class="FixedLine">postgres-docker  | PostgreSQL Database directory appears to contain a database; Skipping initialization</div><div class="FixedLine">...</div><div class="FixedLine">product-server   |   .   ____          _            __ _ _</div><div class="FixedLine">product-server   |  /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">product-server   | ( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine">product-server   |  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">product-server   |   '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine">product-server   |  =========|_|==============|___/=/_/_/_/</div><div class="FixedLine">product-server   |  :: Spring Boot ::                (v3.2.0)</div><div class="FixedLine">product-server   |</div><div class="FixedLine">product-server   | 2022-06-04 13:15:31 INFO  StartupInfoLogger.logStarting:55 - Starting EcomProductMicroserviceApplication v0.0.1-SNAPSHOT using Java 1.8.0_212 on 67bec9c678c1 with PID 1 (/app.jar started by root in /)</div><div class="FixedLine">...</div><div class="FixedLine">product-web      |</div><div class="FixedLine">product-web      |   .   ____          _            __ _ _</div><div class="FixedLine">product-web      |  /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">product-web      | ( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine">product-web      |  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">product-web      |   '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine">product-web      |  =========|_|==============|___/=/_/_/_/</div><div class="FixedLine">product-web      |  :: Spring Boot ::                (v3.2.0)</div><div class="FixedLine">product-web      |</div><div class="FixedLine">...</div><div class="FixedLine">product-web      | 2022-06-04 13:15:50 INFO  StartupInfoLogger.logStarted:61 - Started EcomProductMicroserviceApplication in 20.779 seconds (JVM running for 24.665)</div><div class="FixedLine">product-server   | 2022-06-04 13:15:52 INFO  InitializationComponent.init:45 - Start</div><div class="FixedLine">...</div><div class="FixedLine">product-server   | Hibernate: insert into product (code, prodname, price, title) values (?, ?, ?, ?)</div><div class="FixedLine">product-server   | Hibernate: insert into product (code, prodname, price, title) values (?, ?, ?, ?)</div><div class="FixedLine">product-server   | 2022-06-04 13:15:53 INFO  InitializationComponent.init:74 - End</div><div class="FixedLine">product-server   | 2022-06-04 13:15:59 INFO  StartupInfoLogger.logStarted:61 - Started EcomProductMicroserviceApplication in 30.06 seconds (JVM running for 33.926)</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-9</span><p class="SimplePara">Execution of the Docker Compose Up Command: Completed</p></div></div></div></div>

          <p class="Para" id="Par51">Listing <span class="InternalRef"><a href="#PC11">9-9</a></span> shows that the <span class="EmphasisFontCategoryNonProportional ">.jar</span> files generated as a result of <span class="EmphasisFontCategoryNonProportional ">maven build</span> are used to generate <span id="ITerm38">Docker images</span>, and subsequently all three containers (<span class="EmphasisFontCategoryNonProportional ">postgres-docker</span>, <span class="EmphasisFontCategoryNonProportional ">product-server</span>, and <span class="EmphasisFontCategoryNonProportional ">product-web</span>) are started.</p>

          <div class="Para" id="Par52">In my <span id="ITerm39">Minikube-based Docker environment</span> on the Mac, I received the following error when I tried to build the example the first time:<div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">"exec: "docker-credential-desktop.exe": executable file not found in $PATH, out:"</div></div></div></div>

          <div class="Para" id="Par53">I changed <span class="EmphasisFontCategoryNonProportional ">credsStore</span> to <span class="EmphasisFontCategoryNonProportional ">credStore</span> in <span class="EmphasisFontCategoryNonProportional ">~/.docker/config.json</span>:<div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ sudo nano ~/.docker/config.json</div></div></div></div>

          <p class="Para" id="Par54">Make this change, then press Control+X to quit. Enter <span class="EmphasisFontCategoryNonProportional ">Y</span> to save the modified buffer. You also need to open a new terminal after making these changes (and of course set the <span class="EmphasisFontCategoryNonProportional ">minikube env</span>).</p>

          <p class="Para" id="Par55">Once the containers are up and running, you can test the application.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec8">

          <h3 class="Heading">Testing the Microservice Containers</h3>

          <div class="Para" id="Par56">Since the microservices <span id="ITerm40">and database containers</span> are up and running now, you can access the Product Web microservice. However, as mentioned in Appendix E, you have to get the Minikube IP first. See Listing <span class="InternalRef"><a href="#PC14">9-10</a></span>.<div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch07-02 binil$ minikube ip</div><div class="FixedLine">192.168.64.5</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch07-02 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-10</span><p class="SimplePara">Finding Minikube IP</p></div></div></div></div>

          <p class="Para" id="Par57">You can now access the Product Web microservice using a browser with the URL formed with the <span id="ITerm41">Minikube IP</span>.</p>

          <p class="Para ParaOneEmphasisChild" id="Par58"><span class="EmphasisFontCategoryNonProportional ">http://192.168.64.5:8080/product.html</span></p>

          <p class="Para" id="Par59">Refer to the section titled “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the Product Web <span id="ITerm42">microservice container</span>.</p>

          <p class="Para" id="Par60">While you test the microservices, keep watching the log windows. To determine the container IDs and keep watching the log windows, refer to Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span>.</p>

          <div class="Para" id="Par61">Once you complete testing the <span id="ITerm43">microservices</span>, you can then stop and remove the microservice containers and clean the environment. To stop the containers, use this command:<div class="ProgramCode" id="PC15"><div class="LineGroup"><div class="FixedLine">docker-compose down</div></div></div></div>

          <div class="Para" id="Par62">This command is included in Listing <span class="InternalRef"><a href="#PC16">9-11</a></span>.<div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine">docker-compose down</div><div class="FixedLine">docker rmi -f ecom/product-web</div><div class="FixedLine">docker rmi -f ecom/product-server</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-11</span><p class="SimplePara">The Script to Bring Down Microservices Docker Containers (ch09\ch09-01\clean.sh)</p></div></div></div></div>

          <div class="Para" id="Par63">You can execute this script to stop and remove the <span id="ITerm44">microservice</span> containers and clean the environment, as shown in Listing <span class="InternalRef"><a href="#PC17">9-12</a></span>.<div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-01 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch09/ch09-01</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-01 binil$ sh clean.sh</div><div class="FixedLine">[+] Running 4/4</div><div class="FixedLine"> ⠿ Container product-web         Removed 0.3s</div><div class="FixedLine"> ⠿ Container product-server      Removed 0.3s</div><div class="FixedLine"> ⠿ Container postgres-docker     Removed 0.2s</div><div class="FixedLine"> ⠿ Network ch09-01_ecom-network  Removed 0.0s</div><div class="FixedLine">Untagged: ecom/product-web:latest</div><div class="FixedLine">Deleted: sha256:76407061fc0df84b795e7aa818e4eca8189ba2d4e76f6cc9adbb1d34aa14a1c3</div><div class="FixedLine">Untagged: ecom/product-server:latest</div><div class="FixedLine">Deleted: sha256:05dc3a6cbb0248e6353beac61240a7f81155c4726464457eec808fa06f08bebd</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-01 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-12</span><p class="SimplePara">Stopping Microservice Containers and Cleaning the Environment</p></div></div></div></div>

          <div class="Para" id="Par64">You can also watch the logs in the server side console while executing the <span class="EmphasisFontCategoryNonProportional ">clean.sh</span> script, as shown in Listing <span class="InternalRef"><a href="#PC18">9-13</a></span>.<div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine">...</div><div class="FixedLine">product-web exited with code 143</div><div class="FixedLine">product-web exited with code 0</div><div class="FixedLine">product-server exited with code 143</div><div class="FixedLine">product-server exited with code 0</div><div class="FixedLine">...</div><div class="FixedLine">postgres-docker  | LOG:  database system is shut down</div><div class="FixedLine">postgres-docker exited with code 0</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-01 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-13</span><p class="SimplePara"><span id="ITerm45">Server-side Logs</span> While Cleaning the Environment</p></div></div></div></div>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec9">

        <h2 class="Heading">Composing Microservice with MongoDB Containers</h2>

        <p class="Para" id="Par65">This example again reuses the <span id="ITerm46">microservices</span> from the section titled “Microservices Using MongoDB with CrudRepository” in Chapter <span class="ExternalRef"><a href="Capítulo-05.html"><span class="RefSource">3</span></a></span>. It uses the same two microservices—a consumer and a provider microservice communicating with each other using the REST protocol. The provider microservice also interacts with a MongoDB. Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span> showed a full-fledged microservice example interacting with a <span id="ITerm47">MongoDB database</span>, all in Docker containers. Refer to Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span> for the overall design. In this section, you modify that example to be fully deployed within a container infrastructure using Docker Compose.</p>

        <section class="Section2 RenderAsSection2" id="Sec10">

          <h3 class="Heading">Composing the Container Topology</h3>

          <div class="Para" id="Par66">For this composition, you need a complete <span id="ITerm48">container-based deployment topology</span>, as shown in Figure <span class="InternalRef"><a href="#Fig2">9-2</a></span>. The Product Web and Product Server microservices are containerized, and the Product Server microservice will connect to a <span id="ITerm49">MongoDB database</span>, again deployed within a container.<figure class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img alt="" aria-describedby="d64e1497" src="../images/619782_1_En_9_Chapter/Imagem-103.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1497"><p class="Para" id="Par138">A diagram illustrates the microservice containers. It includes products web mu S, product server mu S, container engine, host O S, and hardware.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 9-2</span><p class="SimplePara">Composing <span id="ITerm50">microservice containers</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par67">Here also, the Product Web and Product Server containers provide business services, whereas the <span id="ITerm51">PostgreSQL container</span> provides application services for persisting state.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec11">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par68">The <span id="ITerm52">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch09\ch09-02</span> folder. Much of the source code in this example is similar to <span class="EmphasisFontCategoryNonProportional ">ch03\ch03-02</span>, which was explained in detail in Chapter <span class="ExternalRef"><a href="Capítulo-05.html"><span class="RefSource">3</span></a></span>, in the section titled “Microservices Using MongoDB and CrudRepository,” and in Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span>, in the section titled “Microservice <span id="ITerm53">and MongoDB Containers</span> Using File Mount.” You saw the container-based deployment schema of these multiple interacting microservices in the previous chapter, so this section looks specifically into composing them using Docker Compose.</p>

          <div class="Para" id="Par69">Let’s start by looking at the <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span> file. The section describing the <span class="EmphasisFontCategoryNonProportional ">web</span> service is the same as the one in Listing <span class="InternalRef"><a href="#PC5">9-4</a></span>, so it’s not repeated here. The rest of the configuration is shown in Listing <span class="InternalRef"><a href="#PC19">9-14</a></span>.<div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine">version: "3"</div></div><div class="LineGroup"><div class="FixedLine">services:</div></div><div class="LineGroup"><div class="FixedLine">    db:</div><div class="FixedLine">        image: mongo:3.6</div><div class="FixedLine">        container_name: mongo</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - "27017:27017"</div><div class="FixedLine">        volumes:</div><div class="FixedLine">            - "db-data:/data/db"</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div></div><div class="LineGroup"><div class="FixedLine">    server:</div><div class="FixedLine">        build: ./01-ProductServer</div><div class="FixedLine">        image: ecom/product-server</div><div class="FixedLine">        container_name: product-server</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - "8081:8081"</div><div class="FixedLine">        depends_on:</div><div class="FixedLine">            - "db"</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div><div class="FixedLine">        environment:</div><div class="FixedLine">            - spring.data.mongodb.uri=mongodb://192.168.64.5:27017/test</div></div><div class="LineGroup"><div class="FixedLine">    web:</div><div class="FixedLine">        ...</div></div><div class="LineGroup"><div class="FixedLine">volumes:</div><div class="FixedLine">    db-data:</div><div class="FixedLine">        driver: local</div><div class="FixedLine">        driver_opts:</div><div class="FixedLine">            o: bind</div><div class="FixedLine">            type: none</div><div class="FixedLine">            device: /home/docker/binil/mongodata</div></div><div class="LineGroup"><div class="FixedLine">networks:</div><div class="FixedLine">    ecom-network:</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-14</span><p class="SimplePara">The Docker Compose YAML File (ch09\ch09-02\docker-compose.yml)</p></div></div></div></div>

          <p class="Para" id="Par70">All the sections here are shown in the previous example and have been explained. Note that this example uses a named volume <span class="EmphasisFontCategoryNonProportional ">db-data</span>, which uses a mounted folder from the host. You can reuse the folder created for the example in Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span>. The folder is auto-created in the Minikube VM, since I use Docker in Minikube in the example in Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span>. If you have difficulty in creating this folder, one easy hack is to execute the example in Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span> and, without restarting the <span id="ITerm54">Minikube</span>, try building this example. Remember, all of this will be lost when you stop the Minikube. Optionally, you can create a new folder, which is explained as the first step in next section. If you are using Docker in a host machine, you can manually create this folder too, but in the host machine.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec12">

          <h3 class="Heading">Run Containers Using Docker Compose</h3>

          <p class="Para" id="Par71">The <span class="EmphasisFontCategoryNonProportional ">ch09\ch09-02</span> folder contains the scripts required to build and run the examples. The first step is to start a Minikube single-node Kubernetes cluster so that you have a Docker Daemon up. Refer to Appendix E for a quick reference to the container commands.</p>

          <div class="Para" id="Par72">Assuming the Minikube single-node Kubernetes cluster is up and running, as a next step, you need to create this new folder for the Mongo data you configured in <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span> in Listing <span class="InternalRef"><a href="#PC19">9-14</a></span>. This is done in Listing <span class="InternalRef"><a href="#PC20">9-15</a></span>.<div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:mongodata binil$ minikube ssh</div><div class="FixedLine">                         _             _</div><div class="FixedLine">            _         _ ( )           ( )</div><div class="FixedLine">  ___ ___  (_)  ___  (_)| |/')  _   _ | |_      __</div><div class="FixedLine">/' _ ` _ `\| |/' _ `\| || , &lt;  ( ) ( )| '_`\  /'__`\</div><div class="FixedLine">| ( ) ( ) || || ( ) || || |\`\ | (_) || |_) )(  ___/</div><div class="FixedLine">(_) (_) (_)(_)(_) (_)(_)(_) (_)`\___/'(_,__/'`\____)</div></div><div class="LineGroup"><div class="FixedLine">$ pwd</div><div class="FixedLine">/home/docker</div><div class="FixedLine">$ cd /home/docker</div><div class="FixedLine">$ mkdir -p binil/mongodata</div><div class="FixedLine">$ ls</div><div class="FixedLine">binil</div><div class="FixedLine">$ cd binil/mongodata/</div><div class="FixedLine">$ ls</div><div class="FixedLine">$ pwd</div><div class="FixedLine">/home/docker/binil/mongodata</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-15</span><p class="SimplePara">Creating a Local Folder Acting as Volume Mount for Mongo Data</p></div></div></div></div>

          <div class="Para" id="Par73">Listing <span class="InternalRef"><a href="#PC21">9-16</a></span> shows you how to build the <span id="ITerm55">microservices</span> and the Docker images and then run the containers.<div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-02 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch09/ch09-02</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-02 binil$ sh makeandrun.sh</div><div class="FixedLine">[+] Running 0/2</div><div class="FixedLine"> ⠿ server Error</div><div class="FixedLine"> ⠿ web Error</div><div class="FixedLine">[+] Building 324.8s (21/21) FINISHED</div><div class="FixedLine">...</div><div class="FixedLine"> =&gt; [ecom/product-server build 6/6] RUN mvn -f pom.xml clean package</div><div class="FixedLine"> =&gt; [ecom/product-web build 6/6] RUN mvn -f pom.xml clean package</div><div class="FixedLine"> =&gt; [ecom/product-web stage-1 2/2] COPY --from=build /workspace/target/*.</div><div class="FixedLine"> =&gt; [ecom/product-server] exporting to image</div><div class="FixedLine"> =&gt; =&gt; exporting layers</div><div class="FixedLine"> =&gt; =&gt; writing image sha256:dc88e223b86907868d6e9ed2bd9837295b26afed551f3</div><div class="FixedLine"> =&gt; =&gt; naming to docker.io/ecom/product-web</div><div class="FixedLine"> =&gt; =&gt; writing image sha256:d1ec2ce63b03cb6df7eaeee522fe271c0ac24d76b8f47</div><div class="FixedLine"> =&gt; =&gt; naming to docker.io/ecom/product-server</div><div class="FixedLine"> =&gt; [ecom/product-server stage-1 2/2] COPY --from=build /workspace/target</div><div class="FixedLine">[+] Running 4/2</div><div class="FixedLine"> ⠿ Network ch09-02_ecom-network  Created</div><div class="FixedLine"> ⠿ Container mongo               Created</div><div class="FixedLine"> ⠿ Container product-server      Created</div><div class="FixedLine"> ⠿ Container product-web         Created</div><div class="FixedLine">Attaching to mongo, product-server, product-web</div><div class="FixedLine">mongo           | 2022-06-04T14:57:12.181+0000 I CONTROL  [initandlisten] MongoDB starting : pid=1 port=27017 dbpath=/data/db 64-bit host=872d52dbcb22</div><div class="FixedLine">...</div><div class="FixedLine">product-web     | 2022-06-04 14:57:24 INFO  StartupInfoLogger.logStarted:61 - Started EcomProductMicroserviceApplication in 9.386 seconds (JVM running for 11.156)</div><div class="FixedLine">product-server  | 2022-06-04 14:57:25 INFO  StartupInfoLogger.logStarted:61 - Started EcomProductMicroserviceApplication in 10.909 seconds (JVM running for 12.848)</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-16</span><p class="SimplePara">Executing the Docker Compose Up Command</p></div></div></div></div>

          <p class="Para" id="Par74">Once the containers are up and running, you can test the application.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec13">

          <h3 class="Heading">Testing the Microservice Containers</h3>

          <div class="Para" id="Par75">Since the microservices <span id="ITerm56">and database containers</span> are up and running now, you can access the Product Web microservice. However, as mentioned in Appendix E, you must get the <span id="ITerm57">Minikube IP</span> first. See Listing <span class="InternalRef"><a href="#PC22">9-17</a></span>.<div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch07-02 binil$ minikube ip</div><div class="FixedLine">192.168.64.5</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch07-02 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-17</span><p class="SimplePara">Finding <span id="ITerm58">Minikube IP</span></p></div></div></div></div>

          <p class="Para" id="Par76">You can now access the <span id="ITerm59">Product Web microservice</span> using a browser with the URL formed with the Minikube IP.</p>

          <p class="Para ParaOneEmphasisChild" id="Par77"><span class="EmphasisFontCategoryNonProportional ">http://192.168.64.5:8080/product.html</span></p>

          <p class="Para" id="Par78">Refer to the section titled “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the <span id="ITerm60">Product Web microservice</span> container.</p>

          <p class="Para" id="Par79">While you test the microservices, keep watching the log windows. To determine the container IDs and keep watching the log windows, refer to Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span>.</p>

          <div class="Para" id="Par80">Once you complete testing the microservices, you can then stop and remove the microservice containers and clean the environment. To stop the containers you need to use this command:<div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine">docker-compose down</div></div></div></div>

          <div class="Para" id="Par81">It’s included in the script in Listing <span class="InternalRef"><a href="#PC24">9-18</a></span>.<div class="ProgramCode" id="PC24"><div class="LineGroup"><div class="FixedLine">docker-compose down</div><div class="FixedLine">docker rmi -f ecom/product-web</div><div class="FixedLine">docker rmi -f ecom/product-server</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-18</span><p class="SimplePara">The Script to Bring Down Microservices Docker Containers (ch09\ch09-02\clean.sh)</p></div></div></div></div>

          <div class="Para" id="Par82">You can execute this script to stop and remove the microservice containers and clean the environment, as shown in Listing <span class="InternalRef"><a href="#PC25">9-19</a></span>.<div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-02 binil$ sh clean.sh</div><div class="FixedLine">[+] Running 3/3</div><div class="FixedLine">[+] Running 4/4oduct-web         Removed</div><div class="FixedLine"> ⠿ Container product-web         Removed</div><div class="FixedLine"> ⠿ Container product-server      Removed</div><div class="FixedLine"> ⠿ Container mongo               Removed</div><div class="FixedLine"> ⠿ Network ch09-02_ecom-network  Removed</div><div class="FixedLine">Untagged: ecom/product-web:latest</div><div class="FixedLine">Deleted: sha256:dc88e223b86907868d6e9ed2bd9837295b26afed551f37f...</div><div class="FixedLine">Untagged: ecom/product-server:latest</div><div class="FixedLine">Deleted: sha256:d1ec2ce63b03cb6df7eaeee522fe271c0ac24d76b8f47be...</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-02 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-19</span><p class="SimplePara">Stopping Microservice Containers and Cleaning the Environment</p></div></div></div></div>

          <p class="Para" id="Par83">This completes the example.</p>

          <p class="Para" id="Par84">At this point, you have seen two examples using <span id="ITerm61">Docker Compose</span>. These are real improvements over similar examples in Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span> in terms of management of containers.</p>

          <p class="Para" id="Par85">Having added this improvisation into your toolkit, it’s time now to investigate more complex scenarios including more containers. In the next section, you add the Kafka broker to the container composition.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec14">

        <h2 class="Heading">Composing Microservice with PostgreSQL and Kafka</h2>

        <p class="Para" id="Par86">In Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span>, in the section titled “Microservice <span id="ITerm62">and PostgreSQL</span> in Container,” you saw a full-fledged microservice example interaction with a <span id="ITerm63">PostgreSQL database</span>, all in Docker containers. This section shows you how to modify that example so those containers can talk to each other using a messaging middleware, Kafka. You will also make the changes required to fully deploy all services within a container infrastructure using Docker Compose.</p>

        <section class="Section2 RenderAsSection2" id="Sec15">

          <h3 class="Heading">Composing the Container Topology</h3>

          <div class="Para" id="Par87">For the current design, you need a complete <span id="ITerm64">container-based deployment topology</span>, as shown in Figure <span class="InternalRef"><a href="#Fig3">9-3</a></span>. The Product Web and Product Server microservices are containerized, and the Product Server microservice will connect to a PostgreSQL database, again deployed within a container. All <span id="ITerm65">communications</span> between the Product Web microservice and the Product Server microservice are through Kafka.<figure class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img alt="" aria-describedby="d64e2009" src="../images/619782_1_En_9_Chapter/Imagem-104.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2009"><p class="Para" id="Par139">A diagram illustrates the microservice containers. It includes products web mu S, product server mu S, container engine, host O S, and hardware.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 9-3</span><p class="SimplePara">Composing microservice containers</p></div></figcaption></figure></div>

          <p class="Para" id="Par88">Here, the <span id="ITerm66">Product Web and Product Server containers</span> provide business services, whereas the Mongo container provides application services for persisting state. Kafka containers provide infrastructure services, so they are not shown as part of any specific (business) microservice.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec16">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par89">The <span id="ITerm67">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch09\ch09-03</span> folder, as shown in Listing <span class="InternalRef"><a href="#PC26">9-20</a></span>. Much of the source code in this example is similar to <span class="EmphasisFontCategoryNonProportional ">ch03\ch03-01</span>, which was explained in detail in Chapter <span class="ExternalRef"><a href="Capítulo-05.html"><span class="RefSource">3</span></a></span>, in the section titled “<span id="ITerm68">Microservices</span> Using PostgreSQL and RestTemplate.” In the section titled “CRUD Microservices over Kafka on PostgreSQL” in Chapter <span class="ExternalRef"><a href="Capítulo-08.html"><span class="RefSource">6</span></a></span>, you saw the code required for the Product Web microservice and the Product Server microservice to communicate with each other over the <span id="ITerm69">Kafka messaging channel</span>, so those details are not covered again here. Further, you also saw the Docker Compose-based deployment of the topology of a major portion of Figure <span class="InternalRef"><a href="#Fig3">9-3</a></span> in the section titled “Composing Microservice with PostgreSQL Containers.” This section explores the Kafka container and its deployment with the other microservices using the <span id="ITerm70">Docker Compose tool</span>.</p>

          <div class="Para" id="Par90">Listing <span class="InternalRef"><a href="#PC26">9-20</a></span> shows the source code organization for this example.<div class="ProgramCode" id="PC26"><div class="LineGroup"><div class="FixedLine">ch09-03</div><div class="FixedLine">├── 01-ProductServer</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── 02-ProductWeb</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── kafka-request-reply-util</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── docker-compose.yml</div><div class="FixedLine">├── makeandrun.sh</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">├── server.Dockerfile</div><div class="FixedLine">└── web.Dockerfile</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-20</span><p class="SimplePara">Example 09-03 Source Code <span id="ITerm71">Organization</span></p></div></div></div></div>

          <div class="Para" id="Par91">A concise representation of the source code <span id="ITerm72">organization</span> for the example inside the <span class="EmphasisFontCategoryNonProportional ">ch09-03</span> folder is shown in Listing <span class="InternalRef"><a href="#PC26">9-20</a></span>. <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span>, <span class="EmphasisFontCategoryNonProportional ">server.Dockerfile</span>, and <span class="EmphasisFontCategoryNonProportional ">web.Dockerfile</span> are all placed in the parent folder, and they are referred appropriately from the <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span> file in Listing <span class="InternalRef"><a href="#PC27">9-21</a></span>.<div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine">version: "3"</div></div><div class="LineGroup"><div class="FixedLine">services:</div></div><div class="LineGroup"><div class="FixedLine">    zookeeper:</div><div class="FixedLine">        image: bitnami/zookeeper:latest</div><div class="FixedLine">        container_name: zookeeper</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - '2181:2181'</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div><div class="FixedLine">        environment:</div><div class="FixedLine">            - ALLOW_ANONYMOUS_LOGIN=yes</div></div><div class="LineGroup"><div class="FixedLine">    kafka:</div><div class="FixedLine">        image: bitnami/kafka:latest</div><div class="FixedLine">        container_name: kafka</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - '9092:9092'</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div><div class="FixedLine">        environment:</div><div class="FixedLine">            - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181</div><div class="FixedLine">            - ALLOW_PLAINTEXT_LISTENER=yes</div><div class="FixedLine">        depends_on:</div><div class="FixedLine">            - zookeeper</div></div><div class="LineGroup"><div class="FixedLine">    db:</div><div class="FixedLine">        image: "postgres:9.6-alpine"</div><div class="FixedLine">        container_name: postgres-docker</div><div class="FixedLine">        volumes:</div><div class="FixedLine">            - product-data:/var/lib/postgresql/data</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - 5432:5432</div><div class="FixedLine">        environment:</div><div class="FixedLine">            - POSTGRES_DB=productdb</div><div class="FixedLine">            - POSTGRES_USER=postgres</div><div class="FixedLine">            - POSTGRES_PASSWORD=postgre</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div></div><div class="LineGroup"><div class="FixedLine">    server:</div><div class="FixedLine">        build:</div><div class="FixedLine">            context: .</div><div class="FixedLine">            dockerfile: server.Dockerfile</div><div class="FixedLine">        image: ecom/product-server</div><div class="FixedLine">        container_name: product-server</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - "8081:8081"</div><div class="FixedLine">        depends_on:</div><div class="FixedLine">            - "db"</div><div class="FixedLine">        environment:</div><div class="FixedLine">            - DB_SERVER=postgres-docker:5432</div><div class="FixedLine">            - POSTGRES_DB=productdb</div><div class="FixedLine">            - POSTGRES_USER=postgres</div><div class="FixedLine">            - POSTGRES_PASSWORD=postgre</div><div class="FixedLine">            - spring.kafka.bootstrap-servers=kafka:9092</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div></div><div class="LineGroup"><div class="FixedLine">    web:</div><div class="FixedLine">        build:</div><div class="FixedLine">            context: .</div><div class="FixedLine">            dockerfile: web.Dockerfile</div><div class="FixedLine">        image: ecom/product-web</div><div class="FixedLine">        container_name: product-web</div><div class="FixedLine">        depends_on:</div><div class="FixedLine">            - "server"</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - "8080:8080"</div><div class="FixedLine">        environment:</div><div class="FixedLine">            - spring.kafka.bootstrap-servers=kafka:9092</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div></div><div class="LineGroup"><div class="FixedLine">volumes:</div><div class="FixedLine">    product-data:</div></div><div class="LineGroup"><div class="FixedLine">networks:</div><div class="FixedLine">    ecom-network:</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-21</span><p class="SimplePara">The <span id="ITerm73">Docker Compose</span> YAML File (ch09\ch09-03\docker-compose.yml)</p></div></div></div></div>

          <p class="Para" id="Par92">For the server and the web service, the build scripts <span class="EmphasisFontCategoryNonProportional ">server.Dockerfile</span> and <span class="EmphasisFontCategoryNonProportional ">web.Dockerfile</span> are referred from the current context of the <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span>, including the relative file paths, so Docker Compose will find these files appropriately during the build. The rest of the aspects of <span class="EmphasisFontCategoryNonProportional ">db</span>, <span class="EmphasisFontCategoryNonProportional ">web</span>, and <span class="EmphasisFontCategoryNonProportional ">server</span> were explained in the first example in this chapter. <span class="EmphasisFontCategoryNonProportional ">zookeeper</span> and <span class="EmphasisFontCategoryNonProportional ">kafka</span> are the two new containers being configured here, and those configurations are self-explanatory.</p>

          <div class="Para" id="Par93">As explained earlier, relative to the current directory (where the <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span> is located), the Dockerfile called <span id="ITerm74"><span class="EmphasisFontCategoryNonProportional ">server.Dockerfile</span></span> is found here:<div class="ProgramCode" id="PC28"><div class="LineGroup"><div class="FixedLine">build:</div><div class="FixedLine">    context: .</div><div class="FixedLine">    dockerfile: server.Dockerfile</div></div></div></div>

          <div class="Para" id="Par94">You can now investigate this file, as shown in Listing <span class="InternalRef"><a href="#PC29">9-22</a></span>.<div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine">FROM maven:3.6.1-jdk-8-slim AS prebuild</div><div class="FixedLine">RUN mkdir -p /workspace</div><div class="FixedLine">WORKDIR /workspace</div><div class="FixedLine">COPY ./kafka-request-reply-util .</div><div class="FixedLine">RUN mvn clean install</div></div><div class="LineGroup"><div class="FixedLine">FROM maven:3.6.1-jdk-8-slim AS build</div><div class="FixedLine">COPY --from=prebuild /root/.m2 /root/.m2</div><div class="FixedLine">COPY ./01-ProductServer .</div><div class="FixedLine">RUN mvn clean package</div></div><div class="LineGroup"><div class="FixedLine">FROM openjdk:8-alpine</div><div class="FixedLine">COPY --from=build ./target/*.jar app.jar</div><div class="FixedLine">EXPOSE 8081</div><div class="FixedLine">ENTRYPOINT ["java","-jar","app.jar"]</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-22</span><p class="SimplePara">The Dockerfile (ch09\ch09-03 \server.Dockerfile)</p></div></div></div></div>

          <p class="Para" id="Par95">This is a three-stage build. In the first stage, you build the <span class="EmphasisFontCategoryNonProportional ">kafka-request-reply-util</span>, and in the second stage, you use that <span class="EmphasisFontCategoryNonProportional ">.jar</span> dependency for the Maven build for the <span id="ITerm75">Product Server microservice</span>. In the third stage, you use the <span class="EmphasisFontCategoryNonProportional ">.jar</span> of the Product Server microservice to build the Docker image. This image is named based on the <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span> file in Listing <span class="InternalRef"><a href="#PC27">9-21</a></span>, under the <span class="EmphasisFontCategoryNonProportional ">server</span> service, and the respective container is run.</p>

          <p class="Para" id="Par96">A similar explanation holds true for the <span class="EmphasisFontCategoryNonProportional ">web.Dockerfile</span> <span id="ITerm76">file</span> of the Product Web microservice, so it’s not repeated here.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec17">

          <h3 class="Heading">Run Containers Using Docker Compose</h3>

          <p class="Para" id="Par97">The <span class="EmphasisFontCategoryNonProportional ">ch09\ch09-03</span> folder contains the scripts required to build and run the examples. The first step is to start a Minikube single-node Kubernetes cluster so that you have a Docker Daemon up. Refer to Appendix E for a quick reference to the container commands.</p>

          <div class="Para" id="Par98">Assuming the Minikube single-node Kubernetes cluster is up and running, the simple script in Listing <span class="InternalRef"><a href="#PC30">9-23</a></span> contains a single command to build and run the complete application with all the defined containers.<div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine">docker-compose up</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-23</span><p class="SimplePara">The Script to Build and Run Microservices Docker Containers (ch09\ch09-03\makeandrun.sh)</p></div></div></div></div>

          <div class="Para" id="Par99">Listings <span class="InternalRef"><a href="#PC31">9-24</a></span> through <span class="InternalRef"><a href="#PC34">9-27</a></span> build the <span id="ITerm77">microservices</span> and the <span id="ITerm78">Docker images</span> and then run the containers.<div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch09/ch09-03</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$ sh makeandrun.sh</div><div class="FixedLine">[+] Running 0/2</div><div class="FixedLine"> ⠿ web Error</div><div class="FixedLine"> ⠿ server Error</div><div class="FixedLine">[+] Building 145.4s (12/24)</div><div class="FixedLine">...</div><div class="FixedLine"> =&gt; CACHED [ecom/product-web prebuild 2/5] RUN mkdir -p /workspace</div><div class="FixedLine"> =&gt; CACHED [ecom/product-web prebuild 3/5] WORKDIR /workspace</div><div class="FixedLine"> =&gt; [ecom/product-web prebuild 4/5] COPY ./kafka-request-reply-util .</div><div class="FixedLine"> =&gt; [ecom/product-web prebuild 5/5] RUN mvn clean install</div><div class="FixedLine"> =&gt; =&gt; # Downloaded from central: https://repo.maven.apache.org/maven2/org/apac</div><div class="FixedLine"> =&gt; =&gt; # he/maven/maven-toolchain/2.0.9/maven-toolchain-2.0.9.pom (3.5 kB at 5.</div><div class="FixedLine"> =&gt; =&gt; # 7 kB/s)</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-24</span><p class="SimplePara">The Docker Compose Up Command – Prebuild Stage</p></div></div></div></div>

          <div class="Para" id="Par100">Listing <span class="InternalRef"><a href="#PC31">9-24</a></span> shows the start of the build, where the <span class="EmphasisFontCategoryNonProportional ">kafka-request-reply-util</span> library is getting Maven built. The build continues in Listing <span class="InternalRef"><a href="#PC32">9-25</a></span>.<div class="ProgramCode" id="PC32"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch09/ch09-03</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$ sh makeandrun.sh</div><div class="FixedLine">...</div><div class="FixedLine"> =&gt; CACHED [ecom/product-server build 2/4] COPY --from=prebuild /root/.m2</div><div class="FixedLine"> =&gt; [ecom/product-server build 3/4] COPY ./01-ProductServer</div><div class="FixedLine"> =&gt; [ecom/product-server build 4/4] RUN mvn clean package</div><div class="FixedLine"> =&gt; =&gt; # -build-configuration-parent-11.0.10.Final.pom</div><div class="FixedLine"> =&gt; =&gt; # Downloaded from central: https://repo.maven.apache.org/maven2/org/infi</div><div class="FixedLine"> =&gt; =&gt; # nispan/infinispan-build-configuration-parent/11.0.10.Final/infinispan-</div><div class="FixedLine"> =&gt; =&gt; # build-configuration-parent-11.0.10.Final.pom (13 kB at 23 kB/s)</div><div class="FixedLine"> =&gt; =&gt; # Downloading from central: https://repo.maven.apache.org/maven2/org/jbo</div><div class="FixedLine"> =&gt; =&gt; # ss/jboss-parent/36/jboss-parent-36.pom</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-25</span><p class="SimplePara">The Docker Compose Up Command – Build Start Stage</p></div></div></div></div>

          <div class="Para" id="Par101">In Listing <span class="InternalRef"><a href="#PC32">9-25</a></span>, you can see that the .<span class="EmphasisFontCategoryNonProportional ">jar</span> generated from building the <span class="EmphasisFontCategoryNonProportional ">kafka-request-reply-util</span> library is copied into the build context of the <span class="EmphasisFontCategoryNonProportional ">product-server</span> and <span class="EmphasisFontCategoryNonProportional ">product-web</span> <span id="ITerm79">microservices</span>, and the <span class="EmphasisFontCategoryNonProportional ">product-server</span> and <span class="EmphasisFontCategoryNonProportional ">product-web</span> microservices are both getting built. The build continues in Listing <span class="InternalRef"><a href="#PC33">9-26</a></span>.<div class="ProgramCode" id="PC33"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch09/ch09-03</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$ sh makeandrun.sh</div><div class="FixedLine">...</div><div class="FixedLine"> =&gt; [ecom/product-web build 4/4] RUN mvn clean package</div><div class="FixedLine"> =&gt; [ecom/product-web stage-2 2/2] COPY --from=build ./target/*.jar app.j</div><div class="FixedLine"> =&gt; [ecom/product-web] exporting to image</div><div class="FixedLine"> =&gt; =&gt; exporting layers</div><div class="FixedLine"> =&gt; =&gt; writing image sha256:7c979090f142559b149b6b7f1518189fb33a85af0eadd</div><div class="FixedLine"> =&gt; =&gt; naming to docker.io/ecom/product-web</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-26</span><p class="SimplePara">The Docker Compose Up Command – Build Precompletion Stage</p></div></div></div></div>

          <div class="Para" id="Par102">Listing <span class="InternalRef"><a href="#PC33">9-26</a></span> has almost completed the packaging of the <span class="EmphasisFontCategoryNonProportional ">kafka-request-reply-util</span> <span id="ITerm80">library</span> and the <span class="EmphasisFontCategoryNonProportional ">product-server</span> and <span class="EmphasisFontCategoryNonProportional ">product-web</span> microservices and is heading toward the next stage of creating Docker images, which is shown in Listing <span class="InternalRef"><a href="#PC34">9-27</a></span>.<div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch09/ch09-03</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$ sh makeandrun.sh</div><div class="FixedLine">[+] Running 0/2</div><div class="FixedLine"> ⠿ web Error                              6.4s</div><div class="FixedLine"> ⠿ server Error                           6.4s</div><div class="FixedLine">[+] Building 480.1s (24/25)</div><div class="FixedLine">...</div><div class="FixedLine"> ⠿ Network ch09-03_ecom-network  Created  0.1s</div><div class="FixedLine"> ⠿ Container zookeeper           Created  0.1s</div><div class="FixedLine"> ⠿ Container postgres-docker     Created  0.0s</div><div class="FixedLine"> ⠿ Container product-server      Created  0.0s</div><div class="FixedLine"> ⠿ Container kafka               Created  0.0s</div><div class="FixedLine"> ⠿ Container product-web         Created  0.0s</div><div class="FixedLine">Attaching to kafka, postgres-docker, product-server, product-web, zookeeper</div><div class="FixedLine">postgres-docker  |</div><div class="FixedLine">postgres-docker  | <span id="ITerm81">PostgreSQL Database directory</span> appears to contain a database; Skipping initialization</div><div class="FixedLine">...</div><div class="FixedLine">zookeeper        | zookeeper 12:40:10.68</div><div class="FixedLine">zookeeper        | zookeeper 12:40:10.68 Welcome to the Bitnami zookeeper container</div><div class="FixedLine">...</div><div class="FixedLine">kafka            | [2022-06-05 12:40:16,663] INFO Session establishment complete on server zookeeper/172.19.0.3:2181, session id = 0x1000008b2470000, negotiated timeout = 18000 (org.apache.zookeeper.ClientCnxn)</div><div class="FixedLine">kafka            | [2022-06-05 12:40:16,667] INFO [ZooKeeperClient Kafka server] Connected. (kafka.zookeeper.ZooKeeperClient)</div><div class="FixedLine">product-server   |</div><div class="FixedLine">product-server   |   .   ____          _            __ _ _</div><div class="FixedLine">product-server   |  /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">product-server   | ( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine">product-server   |  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">product-server   |   '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine">product-server   |  =========|_|==============|___/=/_/_/_/</div><div class="FixedLine">product-server   |  :: Spring Boot ::                (v3.2.0)</div><div class="FixedLine">product-server   |</div><div class="FixedLine">...</div><div class="FixedLine">product-web      |</div><div class="FixedLine">product-web      |   .   ____          _            __ _ _</div><div class="FixedLine">product-web      |  /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">product-web      | ( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine">product-web      |  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">product-web      |   '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine">product-web      |  =========|_|==============|___/=/_/_/_/</div><div class="FixedLine">product-web      |  :: Spring Boot ::                (v3.2.0)</div><div class="FixedLine">product-web      |</div><div class="FixedLine">...</div><div class="FixedLine">product-web      | 2022-06-05 12:40:26 INFO  StartupInfoLogger.logStarted:61 - Started EcomProductWebMicroserviceApplication in 10.874 seconds (JVM running for 14.179)</div><div class="FixedLine">...</div><div class="FixedLine">product-server   | 2022-06-05 12:40:33 INFO  StartupInfoLogger.logStarted:61 - Started EcomProductServerMicroserviceApplication in 17.581 seconds (JVM running for 21.825)</div><div class="FixedLine">product-web      | 2022-06-05 12:40:42 INFO  ProductRestController.getAllProducts:77 - Start</div><div class="FixedLine">product-web      | 2022-06-05 12:40:42 INFO  ProductRestController.getAllProducts:111 - Ending</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-27</span><p class="SimplePara">The Completed Docker Compose Up Command</p></div></div></div></div>

          <p class="Para" id="Par103">Listing <span class="InternalRef"><a href="#PC34">9-27</a></span> shows the five containers up and running, as well as the <span id="ITerm82">microservices</span> log indicating that they are executing user-initiated transactions from the web browser.</p>

          <p class="Para" id="Par104">Once the containers are up and running, you can test the application.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec18">

          <h3 class="Heading">Testing the Microservice Containers</h3>

          <div class="Para" id="Par105">Once the five containers are up and running, you can access the Product Web microservice. However, as mentioned in Appendix E, you have to get the <span id="ITerm83">Minikube IP</span> first. See Listing <span class="InternalRef"><a href="#PC35">9-28</a></span>.<div class="ProgramCode" id="PC35"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch07-02 binil$ minikube ip</div><div class="FixedLine">192.168.64.5</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch07-02 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-28</span><p class="SimplePara">Finding Minikube IP</p></div></div></div></div>

          <p class="Para" id="Par106">You can now access the Product Web microservice using a browser with the URL formed with the <span id="ITerm84">Minikube IP</span>.</p>

          <p class="Para ParaOneEmphasisChild" id="Par107"><span class="EmphasisFontCategoryNonProportional ">http://192.168.64.5:8080/product.html</span></p>

          <p class="Para" id="Par108">Refer to the section titled “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the <span id="ITerm85">Product Web microservice container</span>.</p>

          <p class="Para" id="Par109">While you test the microservices, keep watching the log windows. To determine the container IDs and keep watching the log windows, refer to Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span>.</p>

          <div class="Para" id="Par110">Once you have tested the <span id="ITerm86">microservices</span>, you can stop and remove the microservice containers and clean the environment using the script in Listing <span class="InternalRef"><a href="#PC36">9-29</a></span>.<div class="ProgramCode" id="PC36"><div class="LineGroup"><div class="FixedLine">docker-compose down</div><div class="FixedLine">docker rmi -f ecom/product-web</div><div class="FixedLine">docker rmi -f ecom/product-server</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-29</span><p class="SimplePara">The Script to Bring Down Microservices Docker Containers (ch09\ch09-03\clean.sh)</p></div></div></div></div>

          <div class="Para" id="Par111">You can execute this script to stop and remove the <span id="ITerm87">microservice</span> containers and clean the environment, as shown in Listing <span class="InternalRef"><a href="#PC37">9-30</a></span>.<div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-01 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch09/ch09-03</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$ sh clean.sh</div><div class="FixedLine">[+] Running 6/5</div><div class="FixedLine"> ⠿ Container kafka               Removed   1.1s</div><div class="FixedLine"> ⠿ Container product-web         Removed   0.3s</div><div class="FixedLine"> ⠿ Container product-server      Removed   0.3s</div><div class="FixedLine"> ⠿ Container postgres-docker     Removed   0.1s</div><div class="FixedLine"> ⠿ Container zookeeper           Removed   0.5s</div><div class="FixedLine"> ⠿ Network ch09-03_ecom-network  Removed   0.0s</div><div class="FixedLine">Untagged: ecom/product-server:latest</div><div class="FixedLine">Deleted: sha256:41ff845a1401143729e9979ad6239d5298bb8556536d0fd...</div><div class="FixedLine">Untagged: ecom/product-web:latest</div><div class="FixedLine">Deleted: sha256:7c979090f142559b149b6b7f1518189fb33a85af0eaddae...</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-30</span><p class="SimplePara">Stopping Microservice Containers and Cleaning the Environment</p></div></div></div></div>

          <div class="Para" id="Par112">You can also watch the logs in the server-side console while executing the <span class="EmphasisFontCategoryNonProportional ">clean.sh</span> script, as shown in Listing <span class="InternalRef"><a href="#PC38">9-31</a></span>.<div class="ProgramCode" id="PC38"><div class="LineGroup"><div class="FixedLine">...</div><div class="FixedLine">product-web exited with code 143</div><div class="FixedLine">product-web exited with code 0</div><div class="FixedLine">...</div><div class="FixedLine">product-server exited with code 143</div><div class="FixedLine">kafka            | [2022-06-05 12:44:34,332] INFO [KafkaServer id=1001] shut down completed (kafka.server.KafkaServer)</div><div class="FixedLine">product-server exited with code 0</div><div class="FixedLine">...</div><div class="FixedLine">postgres-docker  | LOG:  database system is shut down</div><div class="FixedLine">postgres-docker exited with code 0</div><div class="FixedLine">postgres-docker exited with code 0</div><div class="FixedLine">kafka exited with code 143</div><div class="FixedLine">kafka exited with code 0</div><div class="FixedLine">zookeeper exited with code 143</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-03 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-31</span><p class="SimplePara">Server-side Logs While Cleaning the Environment</p></div></div></div></div>

          <p class="Para" id="Par113">This completes the example of composing microservices with PostgreSQL and Kafka containers.</p>

          <p class="Para" id="Par114">For the completeness, the next section covers composing <span id="ITerm88">microservices</span> with MongoDB and Kafka containers.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec19">

        <h2 class="Heading">Composing Microservices with MongoDB and Kafka</h2>

        <p class="Para" id="Par115">Here again this example reuses the microservices from the section titled “Microservices Using MongoDB with CrudRepository” in Chapter <span class="ExternalRef"><a href="Capítulo-05.html"><span class="RefSource">3</span></a></span>.</p>

        <p class="Para" id="Par116">This example uses the same two microservices—a consumer and a provider microservice. However, they communicate with each other using a <span id="ITerm89">Kafka messaging channel</span>.</p>

        <section class="Section2 RenderAsSection2" id="Sec20">

          <h3 class="Heading">Composing the Container Topology</h3>

          <div class="Para" id="Par117">For this current design, you need a complete <span id="ITerm90">container-based deployment topology</span>, as shown in Figure <span class="InternalRef"><a href="#Fig4">9-4</a></span>. The Product Web and Product Server microservices are containerized, and the Product Server microservice will connect to a MongoDB database, again deployed within a container. All communications between the Product Web microservice and the <span id="ITerm91">Product Server microservice</span> are through Kafka.<figure class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img alt="" aria-describedby="d64e3041" src="../images/619782_1_En_9_Chapter/Imagem-105.jpg" style="width:35.15em"/><div class="TextObject" id="d64e3041"><p class="Para" id="Par140">A diagram illustrates the microservice containers. It includes products web mu S, product server mu S, container engine, host O S, product web mu S, product server mu S, and hardware.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 9-4</span><p class="SimplePara">Composing <span id="ITerm92">microservice</span> containers</p></div></figcaption></figure></div>

          <p class="Para" id="Par118">Here, the Product Web and Product Server containers provide business services, whereas the Mongo container provides application services for persisting state. <span id="ITerm93">Kafka containers</span> provide infrastructure services, so they are not shown as part of any specific (business) microservice.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec21">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par119">The <span id="ITerm94">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch09\ch09-04</span> folder and the code organization is shown in Listing <span class="InternalRef"><a href="#PC26">9-20</a></span>. Much of the source code in this example is similar to <span class="EmphasisFontCategoryNonProportional ">ch03\ch03-02</span>, which was explained in detail in Chapter <span class="ExternalRef"><a href="Capítulo-05.html"><span class="RefSource">3</span></a></span>, in the section titled “Microservices Using MongoDB and CrudRepository.” In the section titled “CRUD Microservices over Kafka on MongoDB” in Chapter <span class="ExternalRef"><a href="Capítulo-08.html"><span class="RefSource">6</span></a></span>, you saw the code required for the Product Web and Product Server microservices to communicate with each other over the Kafka messaging channel, so those details are not covered again here. Further, you also saw Docker Compose-based deployment of the topology of a major portion of Figure <span class="InternalRef"><a href="#Fig4">9-4</a></span> in the section titled “Composing Microservice with MongoDB Containers.”</p>

          <div class="Para" id="Par120">A major part of the <span class="EmphasisFontCategoryNonProportional ">docker-compose.yml</span> <span id="ITerm95">file</span> is similar to the one shown in Listing <span class="InternalRef"><a href="#PC27">9-21</a></span>. Listing <span class="InternalRef"><a href="#PC39">9-32</a></span> shows only the changes.<div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine">version: "3"</div></div><div class="LineGroup"><div class="FixedLine">services:</div></div><div class="LineGroup"><div class="FixedLine">...</div><div class="FixedLine">    db:</div><div class="FixedLine">        image: mongo:3.6</div><div class="FixedLine">        container_name: mongo</div><div class="FixedLine">        ports:</div><div class="FixedLine">            - "27017:27017"</div><div class="FixedLine">        networks:</div><div class="FixedLine">            - ecom-network</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-32</span><p class="SimplePara">The Docker Compose YAML File (ch09\ch09-04\docker-compose.yml)</p></div></div></div></div>

          <p class="Para" id="Par121">In fact, the MongoDB configuration in Listing <span class="InternalRef"><a href="#PC39">9-32</a></span> has become simpler in this case.</p>

          <p class="Para" id="Par122">The Dockerfile for the microservices is similar to the previous example in Listing <span class="InternalRef"><a href="#PC29">9-22</a></span>. This too is configured as a three-stage build.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec22">

          <h3 class="Heading">Run Containers Using Docker Compose</h3>

          <p class="Para" id="Par123">The <span class="EmphasisFontCategoryNonProportional ">ch09\ch09-04</span> folder contains the scripts required to build and run these examples. The first step is to start a Minikube single-node Kubernetes cluster so that you have a Docker Daemon up. Refer to Appendix E for a quick reference to the <span id="ITerm96">container commands</span>.</p>

          <div class="Para" id="Par124">Assuming the Minikube single-node Kubernetes cluster is up and running, Listing <span class="InternalRef"><a href="#PC40">9-33</a></span> shows the simple script that contains a single command to build and run the complete application with all the defined containers.<div class="ProgramCode" id="PC40"><div class="LineGroup"><div class="FixedLine">docker-compose up</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-33</span><p class="SimplePara">The Script to Build and Run Microservices Docker Containers (ch09\ch09-04\makeandrun.sh)</p></div></div></div></div>

          <div class="Para" id="Par125">Listing <span class="InternalRef"><a href="#PC41">9-34</a></span> builds the microservices and the <span id="ITerm97">Docker images</span> and then runs the containers.<div class="ProgramCode" id="PC41"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-04 binil$ pwd</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-04 binil$ sh makeandrun.sh</div><div class="FixedLine">[+] Running 0/2</div><div class="FixedLine"> ⠿ server Error</div><div class="FixedLine"> ⠿ web Error</div><div class="FixedLine">[+] Building 402.1s (24/25)</div><div class="FixedLine">...</div><div class="FixedLine"> =&gt; [ecom/product-server prebuild 4/5] COPY ./kafka-request-reply-util</div><div class="FixedLine"> =&gt; [ecom/product-server prebuild 5/5] RUN mvn clean install</div><div class="FixedLine"> =&gt; [ecom/product-server build 2/4] COPY --from=prebuild /root/.m2 /root/</div><div class="FixedLine"> =&gt; [ecom/product-server build 3/4] COPY ./01-ProductServer.</div><div class="FixedLine">...</div><div class="FixedLine"> =&gt; [ecom/product-web build 4/4] RUN mvn clean package</div><div class="FixedLine"> =&gt; [ecom/product-web stage-2 2/2] COPY --from=build ./target/*.jar app.j</div><div class="FixedLine"> =&gt; [ecom/product-server] exporting to image</div><div class="FixedLine"> =&gt; =&gt; exporting layers</div><div class="FixedLine">...</div><div class="FixedLine">[+] Running 6/4</div><div class="FixedLine"> ⠿ Network ch09-04_ecom-network  Created</div><div class="FixedLine"> ⠿ Container mongo               Created</div><div class="FixedLine"> ⠿ Container zookeeper           Created</div><div class="FixedLine"> ⠿ Container kafka               Created</div><div class="FixedLine"> ⠿ Container product-server      Created</div><div class="FixedLine"> ⠿ Container product-web         Created</div><div class="FixedLine">Attaching to kafka, mongo, product-server, product-web, zookeeper</div><div class="FixedLine">zookeeper       | zookeeper 13:38:33.77</div><div class="FixedLine">zookeeper       | zookeeper 13:38:33.77 Welcome to the Bitnami zookeeper container</div><div class="FixedLine">...</div><div class="FixedLine">mongo           | 2022-06-05T13:38:34.066+0000 I CONTROL  [initandlisten] MongoDB starting : pid=1 port=27017 dbpath=/data/db 64-bit host=87f677f2efd6</div><div class="FixedLine">...</div><div class="FixedLine">kafka           | kafka 13:38:35.16</div><div class="FixedLine">kafka           | kafka 13:38:35.16 Welcome to the Bitnami kafka container</div><div class="FixedLine">...</div><div class="FixedLine">kafka           |</div><div class="FixedLine">kafka           | kafka 13:38:35.60 INFO  ==&gt; ** Starting Kafka **</div><div class="FixedLine">...</div><div class="FixedLine">product-server  |</div><div class="FixedLine">product-server  |   .   ____          _            __ _ _</div><div class="FixedLine">kafka           | [2022-06-05 13:38:39,863] INFO [ZooKeeperClient Kafka server] Waiting until connected. (kafka.zookeeper.ZooKeeperClient)</div><div class="FixedLine">product-server  |  /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">product-server  | ( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine">product-server  |  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">product-server  |   '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine">product-server  |  =========|_|==============|___/=/_/_/_/</div><div class="FixedLine">product-server  |  :: Spring Boot ::                (v3.2.0)</div><div class="FixedLine">product-server  |</div><div class="FixedLine">...</div><div class="FixedLine">product-server  | 2022-06-05 13:38:40 INFO  StartupInfoLogger.logStarting:55 - Starting EcomProductServerMicroserviceApplication v0.0.1-SNAPSHOT using Java 1.8.0_212 on 0ee4c7da5620 with PID 1 (/app.jar started by root in /)</div><div class="FixedLine">product-web     |</div><div class="FixedLine">product-web     |   .   ____          _            __ _ _</div><div class="FixedLine">product-web     |  /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">product-web     | ( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine">product-web     |  \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">product-web     |   '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine">product-web     |  =========|_|==============|___/=/_/_/_/</div><div class="FixedLine">product-web     |  :: Spring Boot ::                (v3.2.0)</div><div class="FixedLine">product-web     |</div><div class="FixedLine">...</div><div class="FixedLine">product-web     | 2022-06-05 13:38:40 INFO  StartupInfoLogger.logStarting:55 - Starting EcomProductWebMicroserviceApplication v0.0.1-SNAPSHOT using Java 1.8.0_212 on 4acbe5c92061 with PID 1 (/app.jar started by root in /)</div><div class="FixedLine">kafka           | [2022-06-05 13:38:40,890] INFO KafkaConfig values:</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-34</span><p class="SimplePara">The Completed Docker Compose Up Command</p></div></div></div></div>

          <p class="Para" id="Par126">Listing <span class="InternalRef"><a href="#PC41">9-34</a></span> shows all five containers up and running, as well as the <span id="ITerm98">microservices log</span> indicating they are waiting to respond to the transactions initiated from the web browser.</p>

          <p class="Para" id="Par127">Once the containers are up and running, you can test the application.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec23">

          <h3 class="Heading">Testing the Microservice Containers</h3>

          <div class="Para" id="Par128">Once all five containers are up and running, you can access the <span id="ITerm99">Product Web microservice</span>. However, as mentioned in Appendix E, you have to get the Minikube IP first. See Listing <span class="InternalRef"><a href="#PC42">9-35</a></span>.<div class="ProgramCode" id="PC42"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch07-02 binil$ minikube ip</div><div class="FixedLine">192.168.64.5</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch07-02 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-35</span><p class="SimplePara">Finding Minikube IP</p></div></div></div></div>

          <p class="Para" id="Par129">You can now access the Product Web microservice using a browser with the URL formed with the Minikube IP.</p>

          <p class="Para ParaOneEmphasisChild" id="Par130"><span class="EmphasisFontCategoryNonProportional ">http://192.168.64.5:8080/product.html</span></p>

          <p class="Para" id="Par131">Refer to the section titled “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the <span id="ITerm100">Product Web microservice container</span>.</p>

          <p class="Para" id="Par132">While you test the microservices, keep watching the log windows. To determine the container IDs and keep watching the log windows, refer to Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span>.</p>

          <div class="Para" id="Par133">Once the testing is complete, you can stop and remove the microservice containers and clean the environment using the script in Listing <span class="InternalRef"><a href="#PC43">9-36</a></span>.<div class="ProgramCode" id="PC43"><div class="LineGroup"><div class="FixedLine">docker-compose down</div><div class="FixedLine">docker rmi -f ecom/product-server</div><div class="FixedLine">docker rmi -f ecom/product-web</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-36</span><p class="SimplePara">The Script to Bring Down Microservices Docker Containers (ch09\ch09-04\clean.sh)</p></div></div></div></div>

          <div class="Para" id="Par134">You can execute the script in Listing <span class="InternalRef"><a href="#PC44">9-37</a></span> to stop and remove the microservice containers and clean the environment.<div class="ProgramCode" id="PC44"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-04 binil$ sh clean.sh</div><div class="FixedLine">[+] Running 6/5</div><div class="FixedLine"> ⠿ Container kafka               Removed      1.5s</div><div class="FixedLine"> ⠿ Container product-web         Removed      0.4s</div><div class="FixedLine"> ⠿ Container product-server      Removed      0.4s</div><div class="FixedLine"> ⠿ Container mongo               Removed      0.3s</div><div class="FixedLine"> ⠿ Container zookeeper           Removed      0.5s</div><div class="FixedLine"> ⠿ Network ch09-04_ecom-network  Removed      0.0s</div><div class="FixedLine">Untagged: ecom/product-server:latest</div><div class="FixedLine">Deleted: sha256:d0cb4d2302a2891120ae3f5b28616ebaaa85a5f25177f2c...</div><div class="FixedLine">Untagged: ecom/product-web:latest</div><div class="FixedLine">Deleted: sha256:b54513d0dc3a3d5b791c988114aebb7c46dbfee106d6f0d...</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch09-04 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-37</span><p class="SimplePara">Stopping Microservice Containers and Cleaning the Environment</p></div></div></div></div>

          <p class="Para" id="Par135">You can also watch the logs in the server side console while executing the <span class="EmphasisFontCategoryNonProportional ">clean.sh</span> script.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec24">

        <h2 class="Heading">Summary</h2>

        <p class="Para" id="Par136">Chapter <span class="ExternalRef"><a href="Capítulo-09.html"><span class="RefSource">7</span></a></span> introduced Docker containers and Chapter <span class="ExternalRef"><a href="Capítulo-10.html"><span class="RefSource">8</span></a></span> explained how Docker containers can be used to better manage microservice applications. Tools like Docker Compose and Kubernetes help you further when you have more than a handful of microservices as a part of your aggregate application. This chapter showed how <span id="ITerm101">Docker Compose</span> helps you when you have many business microservices, application services, and infrastructure services. Many of these services can be deployed as separate containers and this is where Docker Compose helps you manage their dependencies and lifecycles during deployment and operations. You don’t need to stop with Docker; you can also consider full-fledged container orchestration tools including but not limited to Kubernetes. You’ll do that in the next chapter.</p>

      </section>

    </div>

  </div>

</body>

</html>