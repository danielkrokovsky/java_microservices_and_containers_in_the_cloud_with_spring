<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en">

<head>
  <title>Automating Kubernetes Deployment and Helm</title>
  <link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>

<body>

  <div epub:type="chapter" role="doc-chapter">

    <div class="ChapterContextInformation">

      <div class="ContextInformation" id="b979-8-8688-0555-4_12"><div class="ChapterCopyright">© The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature 2024</div><span class="ContextInformationAuthorEditorNames">B. A. Christudas</span><span class="ContextInformationBookTitles"><span class="BookTitle">Java Microservices and Containers in the Cloud</span></span><span class="ChapterDOI"><a href="https://doi.org/10.1007/979-8-8688-0555-4_12">https://doi.org/10.1007/979-8-8688-0555-4_12</a></span></div>

    </div>

    <!--Begin Abstract-->

    <div class="MainTitleSection">

      <h1 class="ChapterTitle" lang="en">12. Automating Kubernetes Deployment and Helm</h1>

    </div>

    <div class="AuthorGroup">

      <div class="AuthorNames"><span class="Author"><span class="AuthorName">Binildas A. Christudas</span><sup><a href="#Aff2">1</a> <span class="ContactIcon"> </span></sup></span></div>

      <div class="Affiliations">

        <div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">NBCRA 45, Christbin, Thiruvananthapuram, Kerala, India</div></div>

        <div class="ClearBoth"> </div>

      </div>

    </div>

    <!--End Abstract-->

    <div class="Fulltext">

      <p class="Para" id="Par2">The journey from monoliths to microservices includes <span id="ITerm1">objectives</span> like selective scalability, parallel release, and so on. However, as you create more microservices and your application grows, it becomes increasingly difficult to manage. <span id="ITerm2">Kubernetes</span> simplifies the process by grouping multiple microservices into a single deployment. Managing Kubernetes applications across the development lifecycle brings its own set of challenges, including version management, configuring environment variables, resource allocation, updating, and rollbacks. Helm provides one of the most appropriate solutions to this problem, making deployments more consistent, repeatable, and reliable. This chapter looks again at the need for automation and as a part of that it introduces Helm with the help of the multi-microservices example.</p>

      <p class="Para" id="Par3">The objective here is to understand the automation steps and then introduce Helm. To start, I strip down the example application to a bare minimum so that you can concentrate just on the application automation aspects. Once I introduce Helm, I bring back the same multi-microservices example and show you how Helm makes sense when the microservices complexity increases.</p>

      <div class="Para" id="Par4">The following concepts are covered in this chapter:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par5">Reintroducing the Hello World Spring Boot microservices</p></li><li><p class="Para" id="Par6">Automating Docker interactions</p></li><li><p class="Para" id="Par7">Automating Kubernetes interactions</p></li><li><p class="Para" id="Par8">Introducing Helm</p></li><li><p class="Para" id="Par9">Using Helm to deploy a multi-microservice</p></li><li><p class="Para" id="Par10">Using Helmfile to deploy a multi-microservice</p></li></ul></div></div>

      <p class="Para" id="Par11">Let’s start by reintroducing the “Hello World” microservice example.</p>

      <section class="Section1 RenderAsSection1" id="Sec1">

        <h2 class="Heading">Introducing a Simple Java Microservice</h2>

        <p class="Para" id="Par12">You saw one simple microservice example in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span>. This section uses a similar, but even simpler, microservice to start with.</p>

        <section class="Section2 RenderAsSection2" id="Sec2">

          <h3 class="Heading">Designing Your Simple Microservices</h3>

          <div class="Para" id="Par13">This simple <span id="ITerm3">microservice</span> has a single component or Java class, which is a REST controller (see Figure <span class="InternalRef"><a href="#Fig1">12-1</a></span>).<figure class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img alt="" aria-describedby="d64e219" src="../images/619782_1_En_12_Chapter/Imagem-126.jpg" style="width:27.98em"/><div class="TextObject" id="d64e219"><p class="Para" id="Par215">A diagram illustrates the simple microservice. It includes browser, rest A P I, application controller, and end user.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-1</span><p class="SimplePara">A simple <span id="ITerm4">microservice</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par14">Let’s investigate the project structure as well.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec3">

          <h3 class="Heading">Code Organization</h3>

          <div class="Para" id="Par15">The source <span id="ITerm5">code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized as shown in Listing <span class="InternalRef"><a href="#PC1">12-1</a></span>, inside the <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-01</span> folder.<div class="ProgramCode" id="PC1"><div class="LineGroup"><div class="FixedLine">./ch12-01/</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── make.sh</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">├── run.sh</div><div class="FixedLine">└── src</div><div class="FixedLine">    └── main</div><div class="FixedLine">        ├── java</div><div class="FixedLine">        │   └── com</div><div class="FixedLine">        │       └── acme</div><div class="FixedLine">        │           └── ecom</div><div class="FixedLine">        │               └── product</div><div class="FixedLine">        │                   └── Application.java</div><div class="FixedLine">        └── resources</div><div class="FixedLine">            ├── application.yml</div><div class="FixedLine">            └── log4j2-spring.xml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-1</span><p class="SimplePara">Spring Boot Microservices Source Code Organization</p></div></div></div></div>

          <p class="Para" id="Par16">This <span id="ITerm6">code</span> follows the standard Maven structure so that the <span class="EmphasisFontCategoryNonProportional ">pom.xml</span> file is in the root directory.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec4">

          <h3 class="Heading">Understanding the Source Code</h3>

          <div class="Para" id="Par17">The single <span id="ITerm7">application</span> component is the <span class="EmphasisFontCategoryNonProportional ">Application.java</span> class, which is a REST controller (see Listing <span class="InternalRef"><a href="#PC2">12-2</a></span>).<div class="ProgramCode" id="PC2"><div class="LineGroup"><div class="FixedLine">@SpringBootApplication</div><div class="FixedLine">@RestController</div><div class="FixedLine">public class Application {</div></div><div class="LineGroup"><div class="FixedLine">    private static final Logger LOGGER =</div><div class="FixedLine">        LoggerFactory.getLogger(Application.class);</div></div><div class="LineGroup"><div class="FixedLine">    private static volatile long times = 0L;</div></div><div class="LineGroup"><div class="FixedLine">    @RequestMapping("/")</div><div class="FixedLine">    public String home() {</div></div><div class="LineGroup"><div class="FixedLine">        LOGGER.info("Start");</div><div class="FixedLine">        ++times;</div><div class="FixedLine">        LOGGER.debug("Inside hello.Application.home() : {}",</div><div class="FixedLine">            times);</div><div class="FixedLine">        LOGGER.info("Returning...");</div><div class="FixedLine">        return "Hello Docker World : " + times;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    public static void main(String[] args) {</div></div><div class="LineGroup"><div class="FixedLine">        SpringApplication.run(Application.class, args);</div><div class="FixedLine">        LOGGER.info("Started...");</div><div class="FixedLine">    }</div><div class="FixedLine">}<span id="ITerm8"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-2</span><p class="SimplePara">Application REST Controller (ch12/ch12-01/src/main/java/com/acme/ecom/product\Application.java)</p></div></div></div></div>

          <p class="Para" id="Par18">This is a Spring REST annotated class, so you should be able to access it using a browser.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec5">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par19">The <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-01</span> folder contains the Maven scripts required to <span id="ITerm9">build</span> and run these examples. See Listing <span class="InternalRef"><a href="#PC3">12-3</a></span>.<div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-01 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-01</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-01 binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO] ---------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] ---------------------------------------------------</div><div class="FixedLine">[INFO] Total time:  1.569 s</div><div class="FixedLine">[INFO] Finished at: 2023-05-20T11:17:49+05:30</div><div class="FixedLine">[INFO] ---------------------------------------------------</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-01 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-3</span><p class="SimplePara">Building the Microservice Using Scripts</p></div></div></div></div>

          <div class="Para" id="Par20"><span id="ITerm10">Run</span> the microservice as the next step, as shown in Listing <span class="InternalRef"><a href="#PC4">12-4</a></span>.<div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-01 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-01</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-01 binil$ sh run.sh</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2023-05-20 11:19:04 INFO  StartupInfoLogger.logStarting:51 - Starting Application v0.0.1-SNAPSHOT ...</div><div class="FixedLine">2023-05-20 11:19:04 DEBUG StartupInfoLogger.logStarting:52 - Running with Spring Boot v3.0.6...</div><div class="FixedLine">2023-05-20 11:19:04 INFO  SpringApplication.logStartupProfileInfo:632 - No active profile set...</div><div class="FixedLine">2023-05-20 11:19:05 INFO  StartupInfoLogger.logStarted:57 - Started Application ...</div><div class="FixedLine">2023-05-20 11:19:05 INFO  Application.main:50 - Started...</div><div class="FixedLine">2023-05-20 11:19:10 INFO  Application.home:40 - Start</div><div class="FixedLine">2023-05-20 11:19:10 DEBUG Application.home:42 - Inside hello.Application.home() : 1</div><div class="FixedLine">2023-05-20 11:19:10 INFO  Application.home:43 - Returning...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-4</span><p class="SimplePara">Running the Microservice Using Scripts</p></div></div></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec6">

          <h3 class="Heading">Testing the Microservice</h3>

          <p class="Para" id="Par21">Once the <span id="ITerm11">microservice</span> is up, you can access the web application by using your browser and pointing to this URL:</p>

          <p class="Para ParaOneEmphasisChild" id="Par22"><span class="EmphasisFontCategoryNonProportional ">http://127.0.0.1:8080/</span></p>

          <div class="Para" id="Par23">You can alternatively use cURL to access the microservice, as shown in Listing <span class="InternalRef"><a href="#PC5">12-5</a></span>.<div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ curl http://127.0.0.1:8080/</div><div class="FixedLine">Hello Docker World : 1</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-5</span><p class="SimplePara">Testing the Microservice Using <span id="ITerm12">cURL</span></p></div></div></div></div>

          <p class="Para" id="Par24">In the next three examples, you will increase the automation level of build and packaging for container-based deployment for this microservice. After that, I introduce Helm.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec7">

        <h2 class="Heading">Automating the Docker Build</h2>

        <p class="Para" id="Par25">In this section, you containerize the example and deploy it in Docker. This section uses <span class="EmphasisFontCategoryNonProportional ">dockerfile-maven-plugin</span> to integrate Maven with Docker.</p>

        <section class="Section2 RenderAsSection2" id="Sec8">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par26">The source code for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-02</span> folder.</p>

          <div class="Para" id="Par27">You have the single application component, the <span class="EmphasisFontCategoryNonProportional ">Application.java</span> class, which is a REST controller. The additional code tells the Maven <span id="ITerm13">script</span> to use the <span class="EmphasisFontCategoryNonProportional ">dockerfile-maven-plugin</span>. See Listing <span class="InternalRef"><a href="#PC6">12-6</a></span>.<div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">&lt;/project&gt;</div><div class="FixedLine">    ...</div><div class="FixedLine">    &lt;build&gt;</div><div class="FixedLine">        &lt;plugins&gt;</div><div class="FixedLine">            ...</div><div class="FixedLine">            &lt;plugin&gt;</div><div class="FixedLine">                &lt;groupId&gt;com.spotify&lt;/groupId&gt;</div><div class="FixedLine">                &lt;artifactId&gt;</div><div class="FixedLine">                    dockerfile-maven-plugin</div><div class="FixedLine">                &lt;/artifactId&gt;</div><div class="FixedLine">                &lt;version&gt;1.4.13&lt;/version&gt;</div><div class="FixedLine">                &lt;configuration&gt;</div><div class="FixedLine">                    &lt;repository&gt;</div><div class="FixedLine">                        ${docker.image.prefix}/</div><div class="FixedLine">                            ${project.artifactId}</div><div class="FixedLine">                    &lt;/repository&gt;</div><div class="FixedLine">                &lt;/configuration&gt;</div><div class="FixedLine">            &lt;/plugin&gt;</div><div class="FixedLine">        &lt;/plugins&gt;</div><div class="FixedLine">    &lt;/build&gt;</div><div class="FixedLine">&lt;/project&gt;<span id="ITerm14"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-6</span><p class="SimplePara">Spotify Maven Plugin (ch12/ch12-02/pom.xml)</p></div></div></div></div>

          <p class="Para" id="Par28">The Spotify Maven plugin runs the Docker command for you using your Dockerfile, as if you were doing it on the command terminal. You can use it to automate the Docker build. There are a few configuration options for the Docker image tag, and so on, but it keeps the Docker knowledge in your application concentrated in a Dockerfile, which many people prefer.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec9">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <p class="Para" id="Par29">The <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-02</span> folder contains the Maven scripts required to build and run the examples.</p>

          <div class="Para" id="Par30">Since you need a Docker runtime, first bring <span id="ITerm15">Minikube</span> up. Refer to Appendix E for a quick reference to the Minikube-based Kubernetes setup and commands. See Listing <span class="InternalRef"><a href="#PC7">12-7</a></span>.<div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ minikube start</div><div class="FixedLine"><span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e660" src="../images/619782_1_En_12_Chapter/Imagem-129.gif" style="width:1.12em"/><span class="TextObject" id="d64e660"><span class="Para" id="Par218">A smiling emoji representing the minikube.</span></span></span>  minikube v1.30.1 on Darwin 13.3</div><div class="FixedLine"><span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e668" src="../images/619782_1_En_12_Chapter/Imagem-130.gif" style="width:1.12em"/><span class="TextObject" id="d64e668"><span class="Para" id="Par219">A star emoji indicating the hyperkit driver based on existing profile.</span></span></span>  Using the hyperkit driver based on existing profile</div><div class="FixedLine"><span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e676" src="../images/619782_1_En_12_Chapter/Imagem-131.gif" style="width:0.81em"/><span class="TextObject" id="d64e676"><span class="Para" id="Par220">A thumbs up emoji.</span></span></span>   Starting control plane node minikube in cluster minikube</div><div class="FixedLine"><span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e684" src="../images/619782_1_En_12_Chapter/Imagem-132.gif" style="width:0.94em"/><span class="TextObject" id="d64e684"><span class="Para" id="Par221">An emoji representing the restarting existing hyperkit.</span></span></span>   Restarting existing hyperkit VM for "minikube" ...</div><div class="FixedLine"><span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e692" src="../images/619782_1_En_12_Chapter/Imagem-133.gif" style="width:1.12em"/><span class="TextObject" id="d64e692"><span class="Para" id="Par222">An emoji representing the preparation of Kubernetes.</span></span></span>  Preparing Kubernetes v1.26.3 on Docker 20.10.23 ...</div><div class="FixedLine">...</div><div class="FixedLine"><span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e702" src="../images/619782_1_En_12_Chapter/Imagem-134.gif" style="width:1.06em"/><span class="TextObject" id="d64e702"><span class="Para" id="Par223">An emoji representing the verifying ingress addon.</span></span></span>  Verifying ingress addon...</div><div class="FixedLine"><span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e710" src="../images/619782_1_En_12_Chapter/Imagem-135.gif" style="width:1.12em"/><span class="TextObject" id="d64e710"><span class="Para" id="Par224">A star emoji indicating the enabled addons.</span></span></span>  Enabled addons: ingress-dns, storage-provisioner, default-storageclass, ingress</div><div class="FixedLine"><span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e718" src="../images/619782_1_En_12_Chapter/Imagem-136.gif" style="width:1.12em"/><span class="TextObject" id="d64e718"><span class="Para" id="Par225">A emoji representing the project done.</span></span></span>  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-7</span><p class="SimplePara">Starting Minikube</p></div></div></div></div>

          <p class="Para" id="Par31">Also, set the <span id="ITerm16">minikube</span> environment variables in your work terminal.</p>

          <div class="Para" id="Par32">You have to use the <span class="EmphasisFontCategoryNonProportional ">mvn dockerfile:build</span> command, which will create the <span id="ITerm17">Docker image</span>, so do that now. See Listing <span class="InternalRef"><a href="#PC8">12-8</a></span>.<div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-02 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-02</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-04 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-02 binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] -&lt; com.acme.ecom.product:spring-boot-docker-k8s-helm &gt;-</div><div class="FixedLine">[INFO] Building Spring Boot μS 0.0.1-SNAPSHOT</div><div class="FixedLine">[INFO] ---------------------- [ jar ]---------------------</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO] Successfully built 0c23b3413de1</div><div class="FixedLine">[INFO] Successfully tagged binildas/spring-boot-docker-k8s-helm:latest</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO] Successfully built binildas/spring-boot-docker-k8s-helm:latest</div><div class="FixedLine">[INFO] -------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] -------------------------------------------------</div><div class="FixedLine">[INFO] Total time:  13.935 s</div><div class="FixedLine">[INFO] Finished at: 2023-05-20T11:54:39+05:30</div><div class="FixedLine">[INFO] --------------------------------------------------</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-02 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-8</span><p class="SimplePara">Building the Microservice and the Docker Image</p></div></div></div></div>

          <div class="Para" id="Par33">This log <span id="ITerm18">states</span> that <span class="EmphasisFontCategoryNonProportional ">binildas/spring-boot-docker-k8s-helm:latest</span> has been built. You can inspect the local Docker registry to view the newly created image, as shown in Listing <span class="InternalRef"><a href="#PC9">12-9</a></span>.<div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ docker images</div><div class="FixedLine">REPOSITORY                           TAG    IMAGE ID</div><div class="FixedLine">binildas/spring-boot-docker-k8s-helm latest 0c23b3413de1</div><div class="FixedLine">...</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-9</span><p class="SimplePara">Inspecting the <span id="ITerm19">Docker Images</span></p></div></div></div></div>

          <p class="Para" id="Par34">In this example, whatever automation you intended (image creation alone) has already been completed, so you can do the rest of the stages manually.</p>

          <div class="Para" id="Par35">Now push the image to the Docker public registry. Since my Docker registry already has that image, I first delete it from the terminal. For that, I will get a <span id="ITerm20">token</span>. See Listing <span class="InternalRef"><a href="#PC10">12-10</a></span>.<div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ HUB_TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d '{"username": "binildas" , "password": "********" }' https://hub.docker.com/v2/users/login/ | jq -r .token)</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ echo $HUB_TOKEN</div><div class="FixedLine">eyJ4NWMiOlsiTUlJQytUQ0NBc...</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$<span id="ITerm21"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-10</span><p class="SimplePara">Retrieving a Docker Hub Token</p></div></div></div></div>

          <div class="Para" id="Par36">Using that token, you can delete the <span class="EmphasisFontCategoryNonProportional ">binildas/spring-boot-docker-k8s-helm</span> <span id="ITerm22">image</span> from the public Docker registry, as shown in Listing <span class="InternalRef"><a href="#PC11">12-11</a></span>.<div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ curl -i -X DELETE -H "Accept: application/json" -H "Authorization: JWT $HUB_TOKEN" https://hub.docker.com/v2/repositories/binildas/spring-boot-docker-k8s-helm/tags/latest/</div><div class="FixedLine">HTTP/1.1 204 No Content</div><div class="FixedLine">date: Sat, 20 May 2023 06:08:59 GMT</div><div class="FixedLine">x-ratelimit-limit: 600</div><div class="FixedLine">x-ratelimit-reset: 1684562998</div><div class="FixedLine">x-ratelimit-remaining: 600</div><div class="FixedLine">x-trace-id: f6de7fa45a63c1eb6b076df17971cc37</div><div class="FixedLine">server: nginx</div><div class="FixedLine">x-frame-options: deny<span id="ITerm23"></span></div><div class="FixedLine">x-content-type-options: nosniff</div><div class="FixedLine">x-xss-protection: 1; mode=block</div><div class="FixedLine">strict-transport-security: max-age=31536000</div></div><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-11</span><p class="SimplePara">Deleting Images from Public Docker Hub</p></div></div></div></div>

          <div class="Para" id="Par37">Now, to manually push the image to the public Docker Hub, you must <span id="ITerm24">log</span> in to Docker from the terminal, as shown in Listing <span class="InternalRef"><a href="#PC12">12-12</a></span>.<div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ docker login</div><div class="FixedLine">Authenticating with existing credentials...</div><div class="FixedLine">WARNING! Your password will be stored unencrypted in /Users/binil/.docker/config.json.</div><div class="FixedLine">Configure a credential helper to remove this warning. See</div><div class="FixedLine">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</div></div><div class="LineGroup"><div class="FixedLine">Login Succeeded<span id="ITerm25"></span></div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-12</span><p class="SimplePara">Logging In to the Docker Hub from Terminal</p></div></div></div></div>

          <div class="Para" id="Par38">You can manually push the <span id="ITerm26">image</span> to the Docker Hub (from this terminal), as shown in Listing <span class="InternalRef"><a href="#PC13">12-13</a></span>.<div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ docker push binildas/spring-boot-docker-k8s-helm:latest</div><div class="FixedLine">The push refers to repository [docker.io/binildas/spring-boot-docker-k8s-helm]</div><div class="FixedLine">250c3b6ce2b0: Pushed</div><div class="FixedLine">1bc0685fedc8: Pushed</div><div class="FixedLine">cc66d1dae976: Pushed</div><div class="FixedLine">ceaf9e1ebef5: Pushed</div><div class="FixedLine">9b9b7f3d56a0: Pushed</div><div class="FixedLine">f1b5933fe4b5: Pushed</div><div class="FixedLine">latest: digest: sha256:083ad89fa86e9852ba783eadb5f9c174e746ba1e0cc8404f24cc6d76fdcd9345 size: 1575</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-13</span><p class="SimplePara">Manually Pushing an Image to Docker Hub</p></div></div></div></div>

          <div class="Para" id="Par39">To demonstrate the Docker pull to happen from the public Docker Hub, delete the image from the local <span id="ITerm27">Docker registry</span>, as shown in Listing <span class="InternalRef"><a href="#PC14">12-14</a></span>.<div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ docker rmi binildas/spring-boot-docker-k8s-helm<span id="ITerm28"></span></div><div class="FixedLine">Untagged: binildas/spring-boot-docker-k8s-helm:latest</div><div class="FixedLine">Untagged: binildas/spring-boot-docker-k8s-helm@sha256:083ad...</div><div class="FixedLine">...</div><div class="FixedLine">Deleted: sha256:9889cb2fe045eb9f5b7b3811796377440f5f6890fda...</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-14</span><p class="SimplePara">Deleting an Image from the Local Docker Registry</p></div></div></div></div>

          <div class="Para" id="Par40">You can now attempt to bring up the application. Use this command:<div class="ProgramCode" id="PC15"><div class="LineGroup"><div class="FixedLine">docker run -it -p 8080:8080 binildas/spring-boot-docker-k8s-helm:latest</div></div></div></div>

          <div class="Para" id="Par41">In that process, you must first pull the image from the public Docker Hub and instantiate the <span id="ITerm29">container</span>. See Listing <span class="InternalRef"><a href="#PC16">12-15</a></span>.<div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-02 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-02</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-02 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-02 binil$ sh run.sh</div><div class="FixedLine">Unable to find image 'binildas/spring-boot-docker-k8s-helm:latest' locally</div><div class="FixedLine">latest: Pulling from binildas/spring-boot-docker-k8s-helm</div><div class="FixedLine">5843afab3874: Already exists</div><div class="FixedLine">53c9466125e4: Already exists</div><div class="FixedLine">d8d715783b80: Already exists</div><div class="FixedLine">af78a462dd1f: Pull complete</div><div class="FixedLine">71d05ae2a767: Pull complete</div><div class="FixedLine">04170f3d7f6b: Pull complete</div><div class="FixedLine">Digest: sha256:275170154dd952be90cffdff0b585d28975a47070d75f59e5f782862bb36a864</div><div class="FixedLine">Status: Downloaded newer image for binildas/spring-boot-docker-k8s-helm:latest</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)<span id="ITerm30"></span></div></div><div class="LineGroup"><div class="FixedLine">2023-05-20 07:07:33 INFO  StartupInfoLogger.logStarting:51 - Starting Application using Java...</div><div class="FixedLine">2023-05-20 07:07:33 DEBUG StartupInfoLogger.logStarting:52 - Running with Spring Boot v3.0.6...</div><div class="FixedLine">2023-05-20 07:07:33 INFO  SpringApplication.logStartupProfileInfo:632 - No active ...</div><div class="FixedLine">2023-05-20 07:07:35 INFO  StartupInfoLogger.logStarted:57 - Started Application ...</div><div class="FixedLine">2023-05-20 07:07:35 INFO  Application.main:50 - Started...</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-15</span><p class="SimplePara">Pull Image and Start Container</p></div></div></div></div>

          <p class="Para" id="Par42">Once the application is running, you are ready to test the application.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec10">

          <h3 class="Heading">Testing the Microservice</h3>

          <div class="Para" id="Par43">You need to find the <span id="ITerm31">Minikube IP</span> first, as shown in Listing <span class="InternalRef"><a href="#PC17">12-16</a></span>.<div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ minikube ip</div><div class="FixedLine">192.168.64.6</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-16</span><p class="SimplePara">Finding the Minikube IP</p></div></div></div></div>

          <p class="Para" id="Par44">Once the microservice is up, you can access the web application using your browser and pointing to this URL:</p>

          <p class="Para ParaOneEmphasisChild" id="Par45"><span class="EmphasisFontCategoryNonProportional ">http://192.168.64.6:8080/</span></p>

          <div class="Para" id="Par46">You can alternatively use cURL to access the microservice, as shown in Listing <span class="InternalRef"><a href="#PC5">12-5</a></span>.<div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ docker ps -a</div><div class="FixedLine">CONTAINER ID   IMAGE                                              COMMAND                    CREATED             STATUS            PORTS                    NAMES</div><div class="FixedLine">f39c79e72b6f   binildas/spring-boot-docker-k8s-helm:latest   "java -cp app:app/li..."   18 minutes ago      Up 18 minutes       0.0.0.0:8080-&gt;8080/tcp   sad_chandrasekhar</div><div class="FixedLine">...</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ eval $</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-17</span><p class="SimplePara">Listing the Running <span id="ITerm32">Containers</span></p></div></div></div></div>

          <p class="Para" id="Par47">The next three examples increase the automation level of build and packaging.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec11">

        <h2 class="Heading">Automating Docker Push</h2>

        <p class="Para" id="Par48">This example shows how to automate the Docker push of images too, which is one step more than the previous example.</p>

        <p class="Para" id="Par49">The example uses Google’s <span class="EmphasisFontCategoryNonProportional ">jib-maven-plugin</span> to integrate Maven with Docker.</p>

        <section class="Section2 RenderAsSection2" id="Sec12">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par50">The source code for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-03</span> folder.</p>

          <div class="Para" id="Par51">The single application component is the <span class="EmphasisFontCategoryNonProportional ">Application.java</span> class, which is a REST controller. You have already seen this level of automation in the second example in Chapter <span class="ExternalRef"><a href="Capítulo-09.html"><span class="RefSource">7</span></a></span>, but you will do this in the current example too for the sake of completeness. Also, you are doing more configurations to the <span class="EmphasisFontCategoryNonProportional ">jib</span> plugin, so the <span id="ITerm33">Maven</span> configurations are shown in Listing <span class="InternalRef"><a href="#PC19">12-18</a></span>.<div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine">&lt;project&gt;</div><div class="FixedLine">    ...</div><div class="FixedLine">    &lt;build&gt;</div><div class="FixedLine">        &lt;plugins&gt;</div></div><div class="LineGroup"><div class="FixedLine">            &lt;plugin&gt;</div><div class="FixedLine">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="FixedLine">                &lt;artifactId&gt;</div><div class="FixedLine">                    spring-boot-maven-plugin</div><div class="FixedLine">                &lt;/artifactId&gt;</div><div class="FixedLine">            &lt;/plugin&gt;</div></div><div class="LineGroup"><div class="FixedLine">            &lt;plugin&gt;</div><div class="FixedLine">                &lt;groupId&gt;com.google.cloud.tools&lt;/groupId&gt;</div><div class="FixedLine">                &lt;artifactId&gt;</div><div class="FixedLine">                    jib-maven-plugin</div><div class="FixedLine">                &lt;/artifactId&gt;</div><div class="FixedLine">                &lt;version&gt;3.3.2&lt;/version&gt;</div><div class="FixedLine">                &lt;configuration&gt;</div><div class="FixedLine">                    &lt;to&gt;<span id="ITerm34"></span></div><div class="FixedLine">                        &lt;image&gt;</div><div class="FixedLine">                            binildas/${project.artifactId}</div><div class="FixedLine">                        &lt;/image&gt;</div><div class="FixedLine">                    &lt;/to&gt;</div><div class="FixedLine">                    &lt;container&gt;</div><div class="FixedLine">                        &lt;creationTime&gt;</div><div class="FixedLine">                            USE_CURRENT_TIMESTAMP</div><div class="FixedLine">                        &lt;/creationTime&gt;</div><div class="FixedLine">                        &lt;ports&gt;</div><div class="FixedLine">                            &lt;port&gt;8080&lt;/port&gt;</div><div class="FixedLine">                        &lt;/ports&gt;</div><div class="FixedLine">                    &lt;/container&gt;</div><div class="FixedLine">                &lt;/configuration&gt;</div><div class="FixedLine">            &lt;/plugin&gt;</div></div><div class="LineGroup"><div class="FixedLine">        &lt;/plugins&gt;</div><div class="FixedLine">    &lt;/build&gt;</div><div class="FixedLine">&lt;/project&gt;<span id="ITerm35"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-18</span><p class="SimplePara">Maven pom xml (ch12/ch12-03/pom.xml)</p></div></div></div></div>

          <p class="Para" id="Par52">Refer to the second example in Chapter <span class="ExternalRef"><a href="Capítulo-09.html"><span class="RefSource">7</span></a></span>, where it explains how to configure the Maven settings configuration file, and so on, for the Docker Hub credential setting in Listing 7-22. This chapter goes straight to building and pushing the image.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec13">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par53">The <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-03</span> folder contains the Maven scripts required to build and run the examples. The <span class="EmphasisFontCategoryNonProportional ">mvn clean compile jib:build</span> command is used to <span id="ITerm36">build</span> the example, as shown in Listing <span class="InternalRef"><a href="#PC20">12-19</a></span>.<div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-03 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-03</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-03 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-03 binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[WARNING]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] -&lt; com.acme.ecom.product:spring-boot-docker-k8s-helm &gt;-</div><div class="FixedLine">[INFO] Building Spring Boot μS 0.0.1-SNAPSHOT</div><div class="FixedLine">[INFO] --------------------------------[ jar ]----------------</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO] Using credentials from Docker config (/Users/binil/.docker/config.json) for ...</div><div class="FixedLine">[INFO] The base image requires auth. Trying again for eclipse-temurin:17-jre...</div><div class="FixedLine">[INFO] Using credentials from Docker config (/Users/binil/.docker/config.json) for ...</div><div class="FixedLine">[INFO] Using base image with digest: sha256:620beab172aa...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Container entrypoint set to [java, -cp, @/app/jib-classpath-file, com.acme.ecom.product.Application]</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Built and pushed image as binildas/spring-boot-docker-k8s-helm</div><div class="FixedLine">[INFO] Executing tasks:</div><div class="FixedLine">[INFO] [==============================] 100.0% complete</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS<span id="ITerm37"></span></div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] Total time:  27.088 s</div><div class="FixedLine">[INFO] Finished at: 2023-05-20T13:09:48+05:30</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-03 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-19</span><p class="SimplePara">Building the Microservice and Pushing the Docker Image</p></div></div></div></div>

          <div class="Para" id="Par54">You can <span id="ITerm38">run</span> the microservice as the next step. Use the <span class="EmphasisFontCategoryNonProportional ">docker run -it -p 8080:8080 binildas/spring-boot-docker-k8s-helm:latest</span> command to run this example, as shown in Listing <span class="InternalRef"><a href="#PC21">12-20</a></span>.<div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-03 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-03</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-03 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-03 binil$ sh run.sh</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2023-05-20 07:45:25 INFO  StartupInfoLogger.logStarting:51 - Starting Application using Java 17-ea ...</div><div class="FixedLine">2023-05-20 07:45:25 DEBUG StartupInfoLogger.logStarting:52 - Running with Spring Boot v3.0.6...</div><div class="FixedLine">2023-05-20 07:45:25 INFO  SpringApplication.logStartupProfileInfo:632 - No active profile set...<span id="ITerm39"></span></div><div class="FixedLine">2023-05-20 07:45:27 INFO  StartupInfoLogger.logStarted:57 - Started Application in 2.809 seconds ...</div><div class="FixedLine">2023-05-20 07:45:27 INFO  Application.main:50 - Started...</div><div class="FixedLine">2023-05-20 07:46:08 INFO  Application.home:40 - Start</div><div class="FixedLine">2023-05-20 07:46:08 DEBUG Application.home:42 - Inside hello.Application.home() : 1</div><div class="FixedLine">2023-05-20 07:46:08 INFO  Application.home:43 - Returning...</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-20</span><p class="SimplePara">Running the Microservice Using Scripts</p></div></div></div></div>

          <p class="Para" id="Par55">Once the application is running, you are ready to test the application.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec14">

          <h3 class="Heading">Testing the Microservice</h3>

          <p class="Para" id="Par56">You need to find the Minikube IP first, as shown in Listing <span class="InternalRef"><a href="#PC6">12-6</a></span>. Once the <span id="ITerm40">microservice</span> is up, you can access the web application using your browser and pointing to this URL:</p>

          <p class="Para ParaOneEmphasisChild" id="Par57"><span class="EmphasisFontCategoryNonProportional ">http://192.168.64.6:8080/</span></p>

          <p class="Para" id="Par58">You can alternatively use cURL to access the microservice, as shown in Listing <span class="InternalRef"><a href="#PC5">12-5</a></span>.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec15">

        <h2 class="Heading">Automating Kubernetes Deployment</h2>

        <p class="Para" id="Par59">Having seen the different build automations for Docker, you automate the Kubernetes deployment in this example. In fact, you have been using automation for Kubernetes deployment in many of the examples in the previous chapters, especially in Chapters <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span> and <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span>. Therefore, I do not explain every detail again; instead just explaining how to build and run the code. The Spotify Maven plugin is used for the automation, the details of which you learned in the second example in this chapter.</p>

        <section class="Section2 RenderAsSection2" id="Sec16">

          <h3 class="Heading">Code Organization</h3>

          <div class="Para" id="Par60">The source code for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source <span id="ITerm41">code</span> for this example is organized as shown in Listing <span class="InternalRef"><a href="#PC22">12-21</a></span>, inside the <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-04</span> folder.<div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">./ch12-04/</div><div class="FixedLine">├── Dockerfile</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── k8s</div><div class="FixedLine">│   ├── deployment.yml</div><div class="FixedLine">│   └── service.yml</div><div class="FixedLine">├── make.sh</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">├── run.sh</div><div class="FixedLine">└── src</div><div class="FixedLine">    └── main</div><div class="FixedLine">        ├── java</div><div class="FixedLine">        │   └── com</div><div class="FixedLine">        │       └── acme</div><div class="FixedLine">        │           └── ecom</div><div class="FixedLine">        │               └── product</div><div class="FixedLine">        │                   └── Application.java</div><div class="FixedLine">        └── resources</div><div class="FixedLine">            ├── application.yml</div><div class="FixedLine">            └── log4j2-spring.xml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-21</span><p class="SimplePara">Spring Boot Microservices Source Code Organization</p></div></div></div></div>

          <p class="Para" id="Par61">This follows the standard Maven structure so that the <span class="EmphasisFontCategoryNonProportional ">pom.xml</span> file is in the root directory.</p>

          <p class="Para" id="Par62">In Chapters <span class="ExternalRef"><a href="Capítulo-12.html"><span class="RefSource">10</span></a></span> and <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span>, you learned about the Kubernetes deployment descriptors, so I do not explain them here. Instead, you’ll build and run the example.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec17">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par63">The <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-04</span> folder contains the Maven scripts required to build and run these examples. The <span class="EmphasisFontCategoryNonProportional ">mvn clean package dockerfile:build</span> command is used to <span id="ITerm42">build</span> the example, as shown in Listing <span class="InternalRef"><a href="#PC23">12-22</a></span>.<div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-04 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-04</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-04 binil$ eval $(minikube docker-env)clear</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-04 binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-22</span><p class="SimplePara">Building the Microservice Using Scripts</p></div></div></div></div>

          <div class="Para" id="Par64">You can <span id="ITerm43">run</span> the microservice as the next step. The single script called <span class="EmphasisFontCategoryNonProportional ">run.sh</span> consolidates all the commands, as shown in Listing <span class="InternalRef"><a href="#PC24">12-23</a></span>.<div class="ProgramCode" id="PC24"><div class="LineGroup"><div class="FixedLine">eval $(minikube docker-env)</div><div class="FixedLine">kubectl create -f ./k8s/deployment.yml</div><div class="FixedLine">kubectl create -f ./k8s/service.yml</div><div class="FixedLine">minikube service springboothelm --url</div><div class="FixedLine">sleep 3</div><div class="FixedLine">kubectl get pods</div><div class="FixedLine">kubectl get services</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-23</span><p class="SimplePara">Script for Running the Microservice Containers (ch12/ch12-04/run.sh)</p></div></div></div></div>

          <div class="Para" id="Par65">You can now execute this script, as shown in Listing <span class="InternalRef"><a href="#PC25">12-24</a></span>.<div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-04 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-04</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-04 binil$ eval $(minikube docker-env)clear</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-04 binil$ sh run.sh</div><div class="FixedLine">deployment.apps/springboothelm created</div><div class="FixedLine">service/springboothelm created<span id="ITerm44"></span></div><div class="FixedLine">http://192.168.64.6:30048</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-24</span><p class="SimplePara">Running the Microservice Containers Using Scripts</p></div></div></div></div>

          <p class="Para" id="Par66">Once the services are up and running, you can test the example.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec18">

          <h3 class="Heading">Testing the Microservice</h3>

          <p class="Para" id="Par67">You need to find the Minikube IP first, as shown in Listing <span class="InternalRef"><a href="#PC17">12-16</a></span>. You can then <span id="ITerm45">access</span> the web application by using your browser and pointing to this URL:</p>

          <p class="Para ParaOneEmphasisChild" id="Par68"><span class="EmphasisFontCategoryNonProportional ">http://192.168.64.6:8080/</span></p>

          <p class="Para" id="Par69">You can alternatively use cURL to access the microservice, as shown in Listing <span class="InternalRef"><a href="#PC5">12-5</a></span>.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec19">

        <h2 class="Heading">Helm</h2>

        <p class="Para" id="Par70">In the previous example and in many other examples in the previous two chapters, you saw YAML files used for Kubernetes deployments. When the number of microservices increases and when the number of <span id="ITerm46">deployment environments</span> increases, you have to deal with many YAML files. For example, my current organization sells SaaS services for airline passenger reservation services and airline cargo reservation services, along with other services. We need to have a core product that can operate at Level 4 SaaS maturity, which means the same instance should functionally adapt to the requirements of multiple airlines (called tenants). At the same time, these products need to be deployed in <span id="ITerm47">multiple environments</span>, like Development, Testing, Staging, and so on. Helm is a handy tool that maintains a single deployment YAML file with version information. This file lets you set up and manage a very large Kubernetes cluster with a few commands.</p>

        <section class="Section2 RenderAsSection2" id="Sec20">

          <h3 class="Heading">What Is Helm?</h3>

          <p class="Para" id="Par71"><span id="ITerm48">Helm</span> is a package manager for Kubernetes. It helps in installing, upgrading, uninstalling, and rolling back workloads in a Kubernetes cluster. Like yum and apt, which are popular package managers for Linux distributions, Helm treats the deployments as applications being installed on a Kubernetes platform.</p>

          <p class="Para" id="Par72">Helm needs you to store your Kubernetes manifest files in a specific folder structure. This folder structure is treated as one package. Helm packages are called <em class="EmphasisTypeItalic ">charts</em>. Helm <span id="ITerm49">charts</span> can be nested to help install multiple applications using a single hierarchical folder structure. For convenience in managing the chart as well as several versions of the same Helm chart, these folders can also be archived and stored in a repository.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec21">

          <h3 class="Heading">Helm Nomenclature</h3>

          <div class="Para" id="Par73">Helm uses three main concepts that you need to be familiar with:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par74"><span id="ITerm50">Chart</span>: As explained, a chart contains all that is required for a Kubernetes deployment along with a few Helm-specific files in a certain folder structure. This includes all the YAML configuration files for deployments, services, secrets, and config maps that define the deployed state of your application.</p></li><li><p class="Para" id="Par75"><span id="ITerm51">Config</span>: This includes one or more YAML files that have the required configuration information for deploying a Kubernetes application. Resources in the Kubernetes cluster are deployed based on these values.</p></li><li><p class="Para" id="Par76"><span id="ITerm52">Release</span>: A running instance of a chart is called a release. When you run the <span class="EmphasisFontCategoryNonProportional ">helm install</span> command, it pulls the config, merges with the chart files, and deploys all the Kubernetes resources. One chart can have multiple releases.</p></li></ul></div></div>

          <p class="Para" id="Par77">With these basic constructs under your belt, the next section looks at the Helm architecture.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec22">

          <h3 class="Heading">Client-Server Helm Architecture</h3>

          <div class="Para" id="Par78">Helm Kubernetes has two main <span id="ITerm53">components</span>—the client (CLI) and the server (Tiller). Helm works on a client-server model, as <span id="ITerm54">shown</span> in Figure <span class="InternalRef"><a href="#Fig2">12-2</a></span>.<figure class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img alt="" aria-describedby="d64e1948" src="../images/619782_1_En_12_Chapter/Imagem-127.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1948"><p class="Para" id="Par216">A helm architecture has the following components. User. Helm client. Kubernetes Cluster.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-2</span><p class="SimplePara">Helm architecture</p></div></figcaption></figure></div>

          <div class="Para" id="Par79">This section investigates the two main <span id="ITerm55">components</span> of the Helm architecture:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par80">Tiller: Tiller is a server installed in the Kubernetes cluster and Helm manages Kubernetes applications through this component. Tiller interacts with the Kubernetes API server for application release operations—install, upgrade, query, and remove Kubernetes resources. For quick development purposes, it can also be run locally and configured to talk to a remote Kubernetes cluster.</p></li><li><p class="Para" id="Par81">Client (CLI): Similar to any client-server model, the Helm client lives on the local workstation of the user and the Tiller server on the <span id="ITerm56">Kubernetes</span> cluster to execute what is needed. You can think of CLI as used to push the resources you need. Tiller runs inside the Kubernetes cluster and manages (creating/updating/deleting) the resources of the Helm charts.</p><p class="Para ParaTypeImportant" id="Par82"><strong class="EmphasisTypeBold ">Note</strong> Subsequent to Helm 2 (Helm v2.16.7), the Tiller server is deprecated. However, that does not affect the examples in this book.</p></li></ul></div></div>

          <p class="Para" id="Par83">With this background, the next section explains how Helm works.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec23">

          <h3 class="Heading">How Helm Works</h3>

          <div class="Para" id="Par84">To understand this concept, recall the first example in Chapter <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span>. In the <span id="ITerm57">Product Server</span> microservice, you defined three replicas for the server instance, as shown in Listing <span class="InternalRef"><a href="#PC26">12-25</a></span>.<div class="ProgramCode" id="PC26"><div class="LineGroup"><div class="FixedLine">apiVersion: apps/v1</div><div class="FixedLine">kind: Deployment</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: product-server</div><div class="FixedLine">  ...</div><div class="FixedLine">spec:</div><div class="FixedLine">  replicas: 3</div><div class="FixedLine">  ...</div><div class="FixedLine">  template:</div><div class="FixedLine">    ...</div><div class="FixedLine">    spec:</div><div class="FixedLine">      containers:</div><div class="FixedLine">      - name: product-server</div><div class="FixedLine">        ...</div><div class="FixedLine">        env:</div><div class="FixedLine">          - name: DB_SERVER<span id="ITerm58"></span></div><div class="FixedLine">            value: postgres</div><div class="FixedLine">          - name: spring.kafka.bootstrap-servers</div><div class="FixedLine">            value: kafka-1-ip-service:9092</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-25</span><p class="SimplePara">The Product Server Pod YAML File (ch11\ch11-01\product-server-deployment.yml)</p></div></div></div></div>

          <p class="Para" id="Par85">Suppose that you need only one instance in staging. To do this, you need to update the <span class="EmphasisFontCategoryNonProportional ">replica</span> value in the descriptor and deploy it in Kubernetes. A better approach is to use Helm so you can parameterize the fields depending on the environment. In this example, instead of using a static value for replicas, you can use the value for these fields from another file. This file is called <span class="EmphasisFontCategoryNonProportional ">values.yaml</span><span id="ITerm59"></span>. In this manner, Helm helps you separate the configurable field value from the actual YAML descriptors.</p>

          <p class="Para" id="Par86">In the next section, you’ll learn more by doing.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec24">

        <h2 class="Heading">Helm Package Microservice</h2>

        <p class="Para" id="Par87">This section shows you how to Helm-enable the previous example in this chapter. As mentioned in Appendix E, I assume that you have installed Helm on your machine.</p>

        <section class="Section2 RenderAsSection2" id="Sec25">

          <h3 class="Heading">Code Organization</h3>

          <div class="Para" id="Par88">The source <span id="ITerm60">code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for the example is organized as shown in Listing <span class="InternalRef"><a href="#PC26">12-25</a></span>, inside the <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-05</span> folder. This follows the standard Maven structure so that the <span class="EmphasisFontCategoryNonProportional ">pom.xml</span> file is in the root directory. This also contains a new folder called <span class="EmphasisFontCategoryNonProportional ">springboothelm</span>, with many files inside it, as shown in Listing <span class="InternalRef"><a href="#PC27">12-26</a></span>.<div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine">./ch12-05/</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── make.sh</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">├── springboothelm</div><div class="FixedLine">│   ├── Chart.yaml</div><div class="FixedLine">│   ├── charts<span id="ITerm61"></span></div><div class="FixedLine">│   ├── templates</div><div class="FixedLine">│   │   ├── NOTES.txt</div><div class="FixedLine">│   │   ├── _helpers.tpl</div><div class="FixedLine">│   │   ├── deployment.yaml</div><div class="FixedLine">│   │   ├── ingress.yaml</div><div class="FixedLine">│   │   ├── service.yaml</div><div class="FixedLine">│   │   ├── serviceaccount.yaml</div><div class="FixedLine">│   │   └── tests</div><div class="FixedLine">│   │       └── test-connection.yaml</div><div class="FixedLine">│   └── values.yaml</div><div class="FixedLine">└── src</div><div class="FixedLine">    └── main</div><div class="FixedLine">        ├── java</div><div class="FixedLine">        │   └── com</div><div class="FixedLine">        │       └── acme</div><div class="FixedLine">        │           └── ecom</div><div class="FixedLine">        │               └── product</div><div class="FixedLine">        │                   └── Application.java</div><div class="FixedLine">        └── resources</div><div class="FixedLine">            ├── application.yml</div><div class="FixedLine">            └── log4j2-spring.xml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-26</span><p class="SimplePara">Spring Boot Microservices Source Code Organization</p></div></div></div></div>

          <p class="Para" id="Par89">Don’t panic; you don’t need to hand-create all these files. Instead, you can auto-generate many of them.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec26">

          <h3 class="Heading">Creating Your First Helm Chart</h3>

          <p class="Para" id="Par90">Before you start creating your first <span id="ITerm62">Helm chart</span>, make sure Minikube is running as mentioned in Listing <span class="InternalRef"><a href="#PC7">12-7</a></span>, since you need to have a Kubernetes cluster.</p>

          <div class="Para" id="Par91">Next, from the source code downloaded for this example (<span class="EmphasisFontCategoryNonProportional ">ch12\ch12-05</span>), delete the <span class="EmphasisFontCategoryNonProportional ">springboothelm</span> folder. Then, from the root of the project folder, create your first Helm chart. See Listing <span class="InternalRef"><a href="#PC28">12-27</a></span>.<div class="ProgramCode" id="PC28"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-05</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm create springboothelm</div><div class="FixedLine">Creating springboothelm</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ tree ./springboothelm/</div><div class="FixedLine">./springboothelm/</div><div class="FixedLine">├── Chart.yaml</div><div class="FixedLine">├── charts</div><div class="FixedLine">├── templates</div><div class="FixedLine">│   ├── NOTES.txt</div><div class="FixedLine">│   ├── _helpers.tpl</div><div class="FixedLine">│   ├── deployment.yaml</div><div class="FixedLine">│   ├── hpa.yaml</div><div class="FixedLine">│   ├── ingress.yaml</div><div class="FixedLine">│   ├── service.yaml</div><div class="FixedLine">│   ├── serviceaccount.yaml</div><div class="FixedLine">│   └── tests</div><div class="FixedLine">│       └── test-connection.yaml</div><div class="FixedLine">└── values.yaml</div></div><div class="LineGroup"><div class="FixedLine">3 directories, 10 files</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-27</span><p class="SimplePara">Creating Your First Helm Chart</p></div></div></div></div>

          <div class="Para" id="Par92">Let’s look at <span class="EmphasisFontCategoryNonProportional ">Chart.yaml</span><span id="ITerm63"></span> first. This file contains all the metadata about the Helm chart example. See Listing <span class="InternalRef"><a href="#PC29">12-28</a></span>.<div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine">apiVersion: v2</div><div class="FixedLine">name: springboothelm</div><div class="FixedLine">description: A Helm chart for Kubernetes</div><div class="FixedLine">type: application</div><div class="FixedLine">version: 0.1.0</div><div class="FixedLine">appVersion: "1.16.0"</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-28</span><p class="SimplePara">The Chart YAML File (ch12/ch12-05/springboothelm\Chart.yaml)</p></div></div></div></div>

          <p class="Para" id="Par93">The <span class="EmphasisFontCategoryNonProportional ">apiVersion</span>, <span class="EmphasisFontCategoryNonProportional ">name</span>, and <span class="EmphasisFontCategoryNonProportional ">version</span> fields are mandatory. There are no strict rules for the <span class="EmphasisFontCategoryNonProportional ">apiVersion</span>. Each chart should have its own version number and it should follow the Semantic Versioning 2.0.</p>

          <div class="Para" id="Par94">Listing <span class="InternalRef"><a href="#PC30">12-29</a></span> shows the <span class="EmphasisFontCategoryNonProportional ">values.yaml</span> <span id="ITerm64">file</span>.<div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine"># Default values for springboothelm.</div><div class="FixedLine"># This is a YAML-formatted file.</div><div class="FixedLine"># Declare variables to be passed into your templates.</div></div><div class="LineGroup"><div class="FixedLine">replicaCount: 1</div></div><div class="LineGroup"><div class="FixedLine">image:</div><div class="FixedLine">  repository: binildas/spring-boot-docker-k8s-helm</div><div class="FixedLine">  pullPolicy: IfNotPresent</div></div><div class="LineGroup"><div class="FixedLine">imagePullSecrets: []</div><div class="FixedLine">nameOverride: ""</div><div class="FixedLine">fullnameOverride: ""</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-29</span><p class="SimplePara">The Values YAML File (ch12/ch12-05/springboothelm/values.yaml)</p></div></div></div></div>

          <div class="Para" id="Par95">This file is quite verbose, but luckily you don’t need to manage all its contents. For the purposes here, you just need to <span id="ITerm65">update</span> two lines:<div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine">repository: binildas/spring-boot-docker-k8s-helm</div><div class="FixedLine">port: 8080</div></div></div></div>

          <div class="Para" id="Par96">The next configuration you need to update is <span class="EmphasisFontCategoryNonProportional ">deployment.yaml</span>. As the name suggests, it is used for deployment purposes. Listing <span class="InternalRef"><a href="#PC32">12-30</a></span> shows the <span class="EmphasisFontCategoryNonProportional ">deployment.yaml</span> <span id="ITerm66">file</span>.<div class="ProgramCode" id="PC32"><div class="LineGroup"><div class="FixedLine">apiVersion: apps/v1</div><div class="FixedLine">kind: Deployment</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: {{ include "springboothelm.fullname" . }}</div><div class="FixedLine">  labels:</div><div class="FixedLine">    {{- include "springboothelm.labels" . | nindent 4 }}</div><div class="FixedLine">spec:</div><div class="FixedLine">  replicas: {{ .Values.replicaCount }}</div><div class="FixedLine">  selector:</div><div class="FixedLine">    matchLabels:</div><div class="FixedLine">      {{- include "springboothelm.selectorLabels" . | nindent 6 }}</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-30</span><p class="SimplePara">The Deployment YAML File (ch12/ch12-05/springboothelm/templates/deployment.yaml)</p></div></div></div></div>

          <div class="Para" id="Par97">This file is also quite verbose, but luckily you don’t need to manage all its contents either. For the purposes here, you just need to <span id="ITerm67">update</span> one line:<div class="ProgramCode" id="PC33"><div class="LineGroup"><div class="FixedLine">containerPort: 8080</div></div></div></div>

          <p class="Para" id="Par98">You need to do this because you need to deploy the Spring Boot application on port <span class="EmphasisFontCategoryNonProportional ">8080</span>.</p>

          <p class="Para" id="Par99">The <span class="EmphasisFontCategoryNonProportional ">service.yaml</span> <span id="ITerm68">file</span> is used to expose the Kubernetes <span class="EmphasisFontCategoryNonProportional ">springboothelm</span> deployment as service. You don’t need to make any changes to the <span class="EmphasisFontCategoryNonProportional ">service.yaml</span> file.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec27">

          <h3 class="Heading">Confirming Helm Chart Accuracy</h3>

          <div class="Para" id="Par100">You are almost ready with your first Helm chart for your Spring Boot application. It’s smart to check the <span class="EmphasisFontCategoryNonProportional ">service.yaml</span> and <span class="EmphasisFontCategoryNonProportional ">deployment.yaml</span> files to confirm everything looks fine. For that, you should get out from the <span class="EmphasisFontCategoryNonProportional ">springboothelm</span> directory (on the project root folder), and then execute the <span id="ITerm69">command</span> in Listing <span class="InternalRef"><a href="#PC34">12-31</a></span>.<div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-05</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm template springboothelm</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-31</span><p class="SimplePara">Template Helm Chart</p></div></div></div></div>

          <p class="Para" id="Par101">Running this command will return the <span class="EmphasisFontCategoryNonProportional ">service.yaml</span>, <span class="EmphasisFontCategoryNonProportional ">deployment.yaml</span>, and <span class="EmphasisFontCategoryNonProportional ">test-connection.yaml</span> files with actual values so that you can verify whether all is right.</p>

          <div class="Para" id="Par102">As an optional step, there is one more sanitary command provided by Helm, called <span id="ITerm70"><span class="EmphasisFontCategoryNonProportional ">lint</span></span>, which you can use to identify possible issues in advance. See Listing <span class="InternalRef"><a href="#PC35">12-32</a></span>.<div class="ProgramCode" id="PC35"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-05</div></div><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm lint springboothelm</div><div class="FixedLine">==&gt; Linting springboothelm</div><div class="FixedLine">[INFO] Chart.yaml: icon is recommended</div></div><div class="LineGroup"><div class="FixedLine">1 chart(s) linted, 0 chart(s) failed</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-32</span><p class="SimplePara">Use lint on the Helm Chart</p></div></div></div></div>

          <div class="Para" id="Par103">You can also use the following <span class="EmphasisFontCategoryNonProportional ">-dry-run</span> <span id="ITerm71">command</span> to verify your Spring Boot Helm chart. See Listing <span class="InternalRef"><a href="#PC36">12-33</a></span>.<div class="ProgramCode" id="PC36"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-05</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm install springboothelm --debug --dry-run springboothelm</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-33</span><p class="SimplePara">Dry Run of the Helm Chart</p></div></div></div></div>

          <p class="Para" id="Par104">If there is something wrong with your Helm chart configuration, this check will prompt you about it immediately.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec28">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par105">The <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-05</span> folder contains the Maven scripts required to build and run the examples. First, you need to build the microservices and push the image to the public Docker Hub. You do this using the <span class="EmphasisFontCategoryNonProportional ">mvn clean compile jib:build</span> <span id="ITerm72">command</span>, as shown in Listing <span class="InternalRef"><a href="#PC37">12-34</a></span>.<div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-05</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Built and pushed image as binildas/spring-boot-docker-k8s-helm</div><div class="FixedLine">[INFO] Executing tasks:</div><div class="FixedLine">[INFO] [===========================   ] 91.7% complete</div><div class="FixedLine">[INFO] &gt; launching layer pushers</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] -----------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] -----------------------------------------------</div><div class="FixedLine">[INFO] Total time:  13.205 s<span id="ITerm73"></span></div><div class="FixedLine">[INFO] Finished at: 2023-05-20T16:06:58+05:30</div><div class="FixedLine">[INFO] -----------------------------------------------</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-34</span><p class="SimplePara">Building the Microservice and Pushing the Docker Image</p></div></div></div></div>

          <div class="Para" id="Par106">Once the image is pushed, you can <span id="ITerm74">install</span> the application, as shown in Listing <span class="InternalRef"><a href="#PC38">12-35</a></span>.<div class="ProgramCode" id="PC38"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-05</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm install myfirstspringboot springboothelm</div><div class="FixedLine">NAME: myfirstspringboot</div><div class="FixedLine">LAST DEPLOYED: Mon May 29 23:32:19 2023</div><div class="FixedLine">NAMESPACE: default</div><div class="FixedLine">STATUS: deployed</div><div class="FixedLine">REVISION: 1</div><div class="FixedLine">NOTES:</div><div class="FixedLine">1. Get the application URL by running these commands:</div><div class="FixedLine">     NOTE: It may take a few minutes for the LoadBalancer IP to be available.</div><div class="FixedLine">           You can watch the status of by running 'kubectl get --namespace default svc -w myfirstspringboot-springboothelm'</div><div class="FixedLine">  export SERVICE_IP=$(kubectl get svc --namespace default myfirstspringboot-springboothelm --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")</div><div class="FixedLine">  echo http://$SERVICE_IP:8080</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-35</span><p class="SimplePara">Helm Install the Microservice</p></div></div></div></div>

          <div class="Para" id="Par107">The installation command includes two names:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par108"><span class="EmphasisFontCategoryNonProportional ">myfirstspringboot</span>: It’s a release name for your Helm chart. If you don’t provide one, Helm will <span id="ITerm75">generate</span> its own release name.</p></li><li><p class="Para" id="Par109"><span class="EmphasisFontCategoryNonProportional ">springboothelm</span>: This is your actual chart name, which you created earlier.</p></li></ul></div></div>

          <div class="Para" id="Par110">You can now <span id="ITerm76">verify</span> the installation, as shown in Listing <span class="InternalRef"><a href="#PC39">12-36</a></span>.<div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm list -a</div><div class="FixedLine">NAME                   NAMESPACE      REVISION      UPDATED                                   STATUS        CHART                     APP VERSION</div><div class="FixedLine">myfirstspringboot      default        1             2023-05-29 23:32:19.571111 +0530 IST      deployed      springboothelm-0.1.0      latest</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-36</span><p class="SimplePara">Verify the Helm Installation</p></div></div></div></div>

          <div class="Para" id="Par111">You can also verify this installation in the <span id="ITerm77">Kubernetes cluster</span>, as shown in Listing <span class="InternalRef"><a href="#PC40">12-37</a></span>.<div class="ProgramCode" id="PC40"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl get all</div><div class="FixedLine">NAME                                                    READY   STATUS    RESTARTS   AGE</div><div class="FixedLine">pod/myfirstspringboot-springboothelm-5575ff4d84-pvgzv   1/1     Running   0          88s</div></div><div class="LineGroup"><div class="FixedLine">NAME                                       TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</div><div class="FixedLine">service/kubernetes                         ClusterIP      10.96.0.1      &lt;none&gt;        443/TCP          12d</div><div class="FixedLine">service/myfirstspringboot-springboothelm   LoadBalancer   10.103.65.93   &lt;pending&gt;     8080:31530/TCP   88s</div></div><div class="LineGroup"><div class="FixedLine">NAME                                               READY   UP-TO-DATE   AVAILABLE   AGE</div><div class="FixedLine">deployment.apps/myfirstspringboot-springboothelm   1/1     1            1           88s</div></div><div class="LineGroup"><div class="FixedLine">NAME                                                          DESIRED   CURRENT   READY   AGE</div><div class="FixedLine">replicaset.apps/myfirstspringboot-springboothelm-5575ff4d84   1         1         1       88s<span id="ITerm78"></span></div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-37</span><p class="SimplePara">Verify the Helm-Based Deployment in Kubernetes</p></div></div></div></div>

          <p class="Para" id="Par112">Once it’s all set, you are ready to test the example.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec29">

          <h3 class="Heading">Testing the Microservice</h3>

          <div class="Para" id="Par113">To test the <span id="ITerm79">application</span>, first find the URL for the deployed application, as shown in Listing <span class="InternalRef"><a href="#PC41">12-38</a></span>.<div class="ProgramCode" id="PC41"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ minikube service myfirstspringboot-springboothelm</div><div class="FixedLine">|-----------|----------------------------------|-------------|---------------------------|</div><div class="FixedLine">| NAMESPACE |               NAME               | TARGET PORT |            URL                       |</div><div class="FixedLine">|-----------|----------------------------------|-------------|---------------------------|</div><div class="FixedLine">| default   | myfirstspringboot-springboothelm | http/8080   | http://192.168.64.6:31530 |</div><div class="FixedLine">|-----------|----------------------------------|-------------|---------------------------|</div><div class="FixedLine"><span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e2863" src="../images/619782_1_En_12_Chapter/Imagem-137.gif" style="width:1.12em"/><span class="TextObject" id="d64e2863"><span class="Para" id="Par226">A flower emoji.</span></span></span>  Opening service default/myfirstspringboot-springboothelm in default browser...</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ minikube service myfirstspringboot-springboothelm --url</div><div class="FixedLine">http://192.168.64.6:31530</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-38</span><p class="SimplePara">Finding the URL for the Deployed Application</p></div></div></div></div>

          <p class="Para" id="Par114">You can now access the application, as shown in Listing <span class="InternalRef"><a href="#PC5">12-5</a></span>.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec30">

          <h3 class="Heading">Helm Release Upgrades</h3>

          <p class="Para" id="Par115">Helm <span id="ITerm80">upgrades</span> help you create new releases of the application. To test that, you will make little changes to the application.</p>

          <p class="Para" id="Par116">First, you need to update the version in <span class="EmphasisFontCategoryNonProportional ">Chart.yaml</span> from <span class="EmphasisFontCategoryNonProportional ">0.1.0</span> to <span class="EmphasisFontCategoryNonProportional ">0.1.1</span></p>

          <p class="Para" id="Par117">Next, update the <span class="EmphasisFontCategoryNonProportional ">replicaCount</span> in <span class="EmphasisFontCategoryNonProportional ">values.yaml</span> from <span class="EmphasisFontCategoryNonProportional ">1</span> to <span class="EmphasisFontCategoryNonProportional ">2.</span></p>

          <div class="Para" id="Par118">You are now ready to upgrade the release, as shown in Listing <span class="InternalRef"><a href="#PC42">12-39</a></span>.<div class="ProgramCode" id="PC42"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-05</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm upgrade myfirstspringboot .</div><div class="FixedLine">Error: Chart.yaml file is missing</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-05</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm upgrade myfirstspringboot .</div><div class="FixedLine">Error: Chart.yaml file is missing</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm upgrade myfirstspringboot springboothelm</div><div class="FixedLine">Release "myfirstspringboot" has been upgraded. Happy Helming!</div><div class="FixedLine">NAME: myfirstspringboot</div><div class="FixedLine">LAST DEPLOYED: Mon May 29 23:39:52 2023</div><div class="FixedLine">NAMESPACE: default</div><div class="FixedLine">STATUS: deployed</div><div class="FixedLine">REVISION: 2</div><div class="FixedLine">NOTES:</div><div class="FixedLine">1. Get the application URL by running these commands:</div><div class="FixedLine">     NOTE: It may take a few minutes for the LoadBalancer IP to be available.</div><div class="FixedLine">           You can watch the status of by running 'kubectl get --namespace default svc -w myfirstspringboot-springboothelm'</div><div class="FixedLine">  export SERVICE_IP=$(kubectl get svc --namespace default myfirstspringboot-springboothelm --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")</div><div class="FixedLine">  echo http://$SERVICE_IP:8080</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-39</span><p class="SimplePara">Upgrading the Helm Release</p></div></div></div></div>

          <div class="Para" id="Par119">You can verify your <span id="ITerm81">installation</span> again, as shown in Listing <span class="InternalRef"><a href="#PC43">12-40</a></span>.<div class="ProgramCode" id="PC43"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm list -a</div><div class="FixedLine">NAME                   NAMESPACE      REVISION      UPDATED                                   STATUS        CHART                     APP VERSION</div><div class="FixedLine">myfirstspringboot      default        2             2023-05-29 23:39:52.906387 +0530 IST      deployed      springboothelm-0.1.1      latest</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-40</span><p class="SimplePara">Verify the Helm Installation</p></div></div></div></div>

          <p class="Para" id="Par120">You can see that the <span class="EmphasisFontCategoryNonProportional ">REVISION</span> count is now <span class="EmphasisFontCategoryNonProportional ">2</span>.</p>

          <div class="Para" id="Par121">You can also verify the installation in the Kubernetes cluster, as shown in Listing <span class="InternalRef"><a href="#PC44">12-41</a></span>.<div class="ProgramCode" id="PC44"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl get all</div><div class="FixedLine">NAME                                                    READY   STATUS    RESTARTS   AGE</div><div class="FixedLine">pod/myfirstspringboot-springboothelm-5575ff4d84-pvgzv   1/1     Running   0          8m2s</div><div class="FixedLine">pod/myfirstspringboot-springboothelm-5575ff4d84-zqhq4   1/1     Running   0          29s</div></div><div class="LineGroup"><div class="FixedLine">NAME                                       TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</div><div class="FixedLine">service/kubernetes                         ClusterIP      10.96.0.1      &lt;none&gt;        443/TCP          12d</div><div class="FixedLine">service/myfirstspringboot-springboothelm   LoadBalancer   10.103.65.93   &lt;pending&gt;     8080:31530/TCP   8m2s</div></div><div class="LineGroup"><div class="FixedLine">NAME                                               READY   UP-TO-DATE   AVAILABLE   AGE</div><div class="FixedLine">deployment.apps/myfirstspringboot-springboothelm   2/2     2            2           8m2s</div></div><div class="LineGroup"><div class="FixedLine">NAME                        DESIRED   CURRENT   READY   AGE</div><div class="FixedLine">replicaset.apps/myfirstspringboot-springboothelm-5575ff4d84   2         2         2       8m2s<span id="ITerm82"></span></div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-41</span><p class="SimplePara">Verify the Helm-Based Deployment in Kubernetes</p></div></div></div></div>

          <p class="Para" id="Par122">You can see you have successfully upgraded the replica count from <span class="EmphasisFontCategoryNonProportional ">1</span> to <span class="EmphasisFontCategoryNonProportional ">2</span> for the <span class="EmphasisFontCategoryNonProportional ">myfirstspringboot-springboothelm</span> service.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec31">

          <h3 class="Heading">Helm Release Rollback</h3>

          <div class="Para" id="Par123">You might wonder if you can roll back the changes you made from upgrading from <span id="ITerm83">Release</span> 1 to 2? See Listing <span class="InternalRef"><a href="#PC45">12-42</a></span> to do just that.<div class="ProgramCode" id="PC45"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm rollback myfirstspringboot 1</div><div class="FixedLine">Rollback was a success! Happy Helming!</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-42</span><p class="SimplePara">Roll Back the Helm Upgrade</p></div></div></div></div>

          <div class="Para" id="Par124">You can then verify that the rollback was successful by using the code in Listing <span class="InternalRef"><a href="#PC46">12-43</a></span>.<div class="ProgramCode" id="PC46"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm list -a</div><div class="FixedLine">NAME                   NAMESPACE      REVISION      UPDATED                                   STATUS        CHART                     APP VERSION</div><div class="FixedLine">myfirstspringboot      default        3             2023-05-29 23:42:25.252089 +0530 IST      deployed      springboothelm-0.1.0      latest</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-43</span><p class="SimplePara">Verify the Helm Installation</p></div></div></div></div>

          <div class="Para" id="Par125">As you can see, you have successfully rolled back the release to the previous version. One interesting thing about Helm is that it still updates the <span class="EmphasisFontCategoryNonProportional ">REVISION</span> to the next sequence, <span class="EmphasisFontCategoryNonProportional ">3</span>. See Listing <span class="InternalRef"><a href="#PC47">12-44</a></span>.<div class="ProgramCode" id="PC47"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl get all</div><div class="FixedLine">NAME                                                    READY   STATUS    RESTARTS   AGE</div><div class="FixedLine">pod/myfirstspringboot-springboothelm-5575ff4d84-pvgzv   1/1     Running   0          10m</div></div><div class="LineGroup"><div class="FixedLine">NAME                                       TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</div><div class="FixedLine">service/kubernetes                         ClusterIP      10.96.0.1      &lt;none&gt;        443/TCP          12d<span id="ITerm84"></span></div><div class="FixedLine">service/myfirstspringboot-springboothelm   LoadBalancer   10.103.65.93   &lt;pending&gt;     8080:31530/TCP   10m</div></div><div class="LineGroup"><div class="FixedLine">NAME                                               READY   UP-TO-DATE   AVAILABLE   AGE</div><div class="FixedLine">deployment.apps/myfirstspringboot-springboothelm   1/1     1            1           10m</div></div><div class="LineGroup"><div class="FixedLine">NAME                        DESIRED   CURRENT   READY   AGE</div><div class="FixedLine">replicaset.apps/myfirstspringboot-springboothelm-5575ff4d84   1         1         1       10m</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-44</span><p class="SimplePara">Verify the Helm-Based Deployment in Kubernetes</p></div></div></div></div>

          <div class="Para" id="Par126">As a last step, you can also delete the release, as shown in Listing <span class="InternalRef"><a href="#PC48">12-45</a></span>.<div class="ProgramCode" id="PC48"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm delete myfirstspringboot</div><div class="FixedLine">release "myfirstspringboot" uninstalled</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-45</span><p class="SimplePara">Deleting a Helm Release</p></div></div></div></div>

          <div class="Para" id="Par127">You can then verify that it was deleted, as shown in Listings <span class="InternalRef"><a href="#PC49">12-46</a></span> and <span class="InternalRef"><a href="#PC50">12-47</a></span>.<div class="ProgramCode" id="PC49"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$ helm list -a</div><div class="FixedLine">NAME      NAMESPACE      REVISION      UPDATED      STATUS      CHART      APP VERSION<span id="ITerm85"></span></div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-05 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-46</span><p class="SimplePara">Verify the Helm Installation</p></div></div></div><div class="ProgramCode" id="PC50"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ kubectl get all</div><div class="FixedLine">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP  PORT(S)  AGE</div><div class="FixedLine">service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;       443/TCP  12d</div><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-47</span><p class="SimplePara">Verify the Helm-Based Deployment in Kubernetes</p></div></div></div></div>

          <p class="Para" id="Par128">I hope you enjoyed your first Helming exercise. In the next section, you will Helm-release the multi-microservice example.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec32">

        <h2 class="Heading">Helm-Packaging Multi-Microservices</h2>

        <p class="Para" id="Par129">You learned how Helm can enable the packaging and deployment of microservices in Kubernetes in the previous sections. However, that example is not complex enough to enable you to appreciate the true benefits of Helm. This section shows you how to use Helm to package and deploy your multi-microservices projects.</p>

        <section class="Section2 RenderAsSection2" id="Sec33">

          <h3 class="Heading">Designing Helm-Based Deployment Topology</h3>

          <div class="Para" id="Par130">This example follows the <span id="ITerm86">deployment topology</span> from Figure <span class="ExternalRef"><a href="Capítulo-13.html#Fig3"><span class="RefSource">11-3</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span>. The Product Web and Product Server microservices are containerized, and the Product Server microservice will connect to a PostgreSQL database, again deployed within a container. All these containers will now be inside Kubernetes. Ingress is an additional component for routing and an Adminer UI component manages the PostgreSQL DB. See Figure <span class="InternalRef"><a href="#Fig3">12-3</a></span>.<figure class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img alt="" aria-describedby="d64e3277" src="../images/619782_1_En_12_Chapter/Imagem-128.jpg" style="width:35.15em"/><div class="TextObject" id="d64e3277"><p class="Para" id="Par217">A diagram illustrates the deployment topology. It includes user, browser, helm client, Kubernetes cluster, host O S, and hardware.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 12-3</span><p class="SimplePara">Deployment topology for <span id="ITerm87">microservices</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par131">The next sections look at the code for this deployment.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec34">

          <h3 class="Heading">Code Organization</h3>

          <p class="Para" id="Par132">The source <span id="ITerm88">code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-06</span> folder.</p>

          <div class="Para" id="Par133">Before you get into the source code for this example, take another look at the source code organization of the similar example (<span class="EmphasisFontCategoryNonProportional ">ch11\ch11-03</span>) from Listing <span class="ExternalRef"><a href="Capítulo-13.html#PC32"><span class="RefSource">11-32</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span>. It’s shown again in Listing <span class="InternalRef"><a href="#PC51">12-48</a></span>.<div class="ProgramCode" id="PC51"><div class="LineGroup"><div class="FixedLine">./ch11-03/</div><div class="FixedLine">├── 01-ProductServer</div><div class="FixedLine">│   ├── make.sh</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── main</div><div class="FixedLine">├── 02-ProductWeb</div><div class="FixedLine">│   ├── make.sh</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── main</div><div class="FixedLine">├── Dockerfile</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── adminer-deployment.yaml</div><div class="FixedLine">├── adminer-svc.yaml</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── ingress-controller.yaml</div><div class="FixedLine">├── makeandrun.sh</div><div class="FixedLine">├── pom.xml<span id="ITerm89"></span></div><div class="FixedLine">├── postgres-config.yml</div><div class="FixedLine">├── postgres-deployment.yml</div><div class="FixedLine">├── postgres-pvc.yml</div><div class="FixedLine">├── postgres-svc.yml</div><div class="FixedLine">├── product-server-deployment.yml</div><div class="FixedLine">├── product-server-service.yml</div><div class="FixedLine">├── product-web-deployment.yml</div><div class="FixedLine">└── product-web-service.yml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-48</span><p class="SimplePara">Example 11-03 Source Code Organization</p></div></div></div></div>

          <p class="Para" id="Par134">For two business services, you can see how many YAML files are required. A little consolidation can be done, say by merging the deployment and service definitions of Product Server microservice into a single YAML file, and so on. But it still doesn’t fix another problem, the problem of duplication. How do you avoid copy-pasting major file content just to replace a couple of values? It would be nice if there was a way to define a template for both business objects (the Product Server and Product Web microservices) and then inject values into specific fields. Helm can help you in this regard.</p>

          <div class="Para" id="Par135">The source code for this example is organized as shown in Listing <span class="InternalRef"><a href="#PC52">12-49</a></span>, inside the <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-06</span> folder. This is the same example you saw in Chapter <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span>. You will now use Helm for deployment.<div class="ProgramCode" id="PC52"><div class="LineGroup"><div class="FixedLine">./ch12-06/</div><div class="FixedLine">├── 01-ProductServer</div><div class="FixedLine">│   ├── Dockerfile</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── 02-ProductWeb</div><div class="FixedLine">│   ├── Dockerfile</div><div class="FixedLine">│   ├── pom.xml<span id="ITerm90"></span></div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── Dockerfile</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── acme-postgres.yaml</div><div class="FixedLine">├── acme-product-server.yaml</div><div class="FixedLine">├── acme-product-web.yaml</div><div class="FixedLine">├── adminer.yaml</div><div class="FixedLine">├── app</div><div class="FixedLine">│   ├── Chart.yaml</div><div class="FixedLine">│   ├── charts</div><div class="FixedLine">│   ├── templates</div><div class="FixedLine">│   │   ├── deployment.yaml</div><div class="FixedLine">│   │   └── service.yaml</div><div class="FixedLine">│   └── values.yaml</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── ingress</div><div class="FixedLine">│   ├── Chart.lock</div><div class="FixedLine">│   ├── Chart.yaml</div><div class="FixedLine">│   ├── charts</div><div class="FixedLine">│   │   └── nginx-ingress-1.36.0.tgz</div><div class="FixedLine">│   ├── templates</div><div class="FixedLine">│   │   └── ingress.yaml</div><div class="FixedLine">│   └── values.yaml</div><div class="FixedLine">├── ingress.yaml</div><div class="FixedLine">├── make.sh</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">├── postgres<span id="ITerm91"></span></div><div class="FixedLine">│   ├── Chart.yaml</div><div class="FixedLine">│   ├── charts</div><div class="FixedLine">│   ├── templates</div><div class="FixedLine">│   │   ├── config.yaml</div><div class="FixedLine">│   │   ├── deployment.yaml</div><div class="FixedLine">│   │   ├── pcv.yaml</div><div class="FixedLine">│   │   └── service.yaml</div><div class="FixedLine">│   └── values.yaml</div><div class="FixedLine">└── run.sh</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-49</span><p class="SimplePara">Example 12-06 Source Code Organization</p></div></div></div></div>

          <p class="Para" id="Par136">You can see that the number of YAML configuration files at the top level of the project root folder has been reduced. There are more subfolders and many new files inside them, but I promise, it’s not going to be too bad.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec35">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par137">This section assumes that you have enabled Ingress in Minikube and added the required hostnames to your host files, as mentioned in the third example in Chapter <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span>.</p>

          <p class="Para" id="Par138">This example starts by creating the Helm charts one by one. In the process, you also see how charts common for more than one component can be useful. I assume that you have a project root folder called <span class="EmphasisFontCategoryNonProportional ">ch12/ch12-06</span>, which currently has only the <span class="EmphasisFontCategoryNonProportional ">README.txt</span> file in it. Rather, copy the chapter code from the book’s source code download and delete any files and folders not mentioned explicitly right now. Of course, after creating the charts, copy any other files required from the book’s code to your project root.</p>

          <section class="Section3 RenderAsSection3" id="Sec36">

            <h4 class="Heading">Helm Chart for PostgreSQL</h4>

            <div class="Para" id="Par139">You’ll start by creating the first chart, the chart for <span id="ITerm92">PostgreSQL</span> database. See Listing <span class="InternalRef"><a href="#PC53">12-50</a></span>.<div class="ProgramCode" id="PC53"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/ch12/ch12-06</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ ls</div><div class="FixedLine">README.txt</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ helm create postgres</div><div class="FixedLine">Creating postgres</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ ls</div><div class="FixedLine">README.txt      postgres</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ rm -r ./postgres/templates/*</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ touch ./postgres/templates/deployment.yaml</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ touch ./postgres/templates/pcv.yaml<span id="ITerm93"></span></div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ touch ./postgres/templates/service.yaml</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ touch ./postgres/templates/config.yaml</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-50</span><p class="SimplePara">Creating a PostgreSQL Helm Chart</p></div></div></div></div>

            <p class="Para" id="Par140">You <span id="ITerm94">delete</span> all of those files generated in the <span class="EmphasisFontCategoryNonProportional ">./postgres/template</span> folder. Then you create four new files inside the <span class="EmphasisFontCategoryNonProportional ">./postgres/template</span> folder—<span class="EmphasisFontCategoryNonProportional ">deployment.yaml, pcv.yaml</span>, <span class="EmphasisFontCategoryNonProportional ">service.yaml</span>, and <span class="EmphasisFontCategoryNonProportional ">config.yaml</span>. You will fill these new files with the files from the book’s code.</p>

            <p class="Para" id="Par141">Copy the <span id="ITerm95">contents</span> from the respective files in <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/postgres/templates/*</span> to the four files.</p>

            <div class="Para" id="Par142">Listing <span class="InternalRef"><a href="#PC54">12-51</a></span> <span id="ITerm96">investigates</span> selected portions of these files.<div class="ProgramCode" id="PC54"><div class="LineGroup"><div class="FixedLine">apiVersion: apps/v1</div><div class="FixedLine">kind: Deployment</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: {{ .Values.postgres.name }}</div><div class="FixedLine">  labels:</div><div class="FixedLine">    app: {{ .Values.postgres.name }}</div><div class="FixedLine">    group: {{ .Values.postgres.group }}</div><div class="FixedLine">spec:</div><div class="FixedLine">  replicas: {{ .Values.replicaCount }}</div><div class="FixedLine">  selector:</div><div class="FixedLine">    matchLabels:</div><div class="FixedLine">      app: {{ .Values.postgres.name }}</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-51</span><p class="SimplePara">The Postgres Deployment YAML File (ch12/ch12-06/postgres/templates/deployment.yaml)</p></div></div></div></div>

            <div class="Para" id="Par143">The Go template-based placeholders are referring to values located in the <span class="EmphasisFontCategoryNonProportional ">values.yaml</span> <span id="ITerm97">file</span>. The <span class="EmphasisFontCategoryNonProportional ">values.yaml</span> files should be in the root folder of the chart. To make it clear with an example, the placeholder <span class="EmphasisFontCategoryNonProportional ">{{ .</span><span class="ExternalRef"><a href="http://values.postgres.name"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">Values.postgres.name</span></span></a></span> <span class="EmphasisFontCategoryNonProportional ">}}</span> in <span class="EmphasisFontCategoryNonProportional ">deployment.yaml</span> will be filled with the value in Listing <span class="InternalRef"><a href="#PC55">12-52</a></span>.<div class="ProgramCode" id="PC55"><div class="LineGroup"><div class="FixedLine">postgres:</div><div class="FixedLine">  name: postgres</div></div><div class="LineGroup"><div class="FixedLine">Now Copy contents from BookCode/ch12/ch12-06/postgres/values.yaml to the file in your project folder ./postgres/values.yaml</div><div class="FixedLine">Listing 12-51. The postgres values YAML file (ch12/ch12-06/postgres/values.yaml)</div><div class="FixedLine">replicaCount: 1</div></div><div class="LineGroup"><div class="FixedLine">postgres:</div><div class="FixedLine">  name: postgres</div><div class="FixedLine">  group: db</div><div class="FixedLine">  container:</div><div class="FixedLine">    image: postgres:9.6-alpine</div><div class="FixedLine">    port: 5432</div><div class="FixedLine">  service:</div><div class="FixedLine">    type: ClusterIP<span id="ITerm98"></span></div><div class="FixedLine">    port: 5432</div><div class="FixedLine">  volume:</div><div class="FixedLine">    name: postgres-storage</div><div class="FixedLine">    kind: PersistentVolumeClaim</div><div class="FixedLine">    mountPath: /var/lib/postgresql/data</div><div class="FixedLine">    pvc:</div><div class="FixedLine">      name: postgres-persistent-volume-claim</div><div class="FixedLine">      accessMode: ReadWriteOnce</div><div class="FixedLine">      storage: 4Gi</div><div class="FixedLine">  config:</div><div class="FixedLine">    name: postgres-config</div><div class="FixedLine">    data:</div><div class="FixedLine">      - key: key</div><div class="FixedLine">        value: value</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-52</span><p class="SimplePara">The Postgres Values YAML File (ch12/ch12-06/postgre/values.yaml)</p></div></div></div></div>

            <div class="Para" id="Par144">Let’s now investigate one more file in detail, and the rest of the files will follow the same pattern. The next file to investigate is the template that you need to create for <span class="EmphasisFontCategoryNonProportional ">ClusterIP</span>, which is required to allow other pods inside the cluster to access the pod with <span class="EmphasisFontCategoryNonProportional ">postgres</span>. This is the <span class="EmphasisFontCategoryNonProportional ">./postgres/template/service.yaml</span> file, as <span id="ITerm99">shown</span> in Listing <span class="InternalRef"><a href="#PC56">12-53</a></span>.<div class="ProgramCode" id="PC56"><div class="LineGroup"><div class="FixedLine">apiVersion: v1</div><div class="FixedLine">kind: Service</div><div class="FixedLine">metadata:</div><div class="FixedLine">  name: {{ .Values.postgres.name }}</div><div class="FixedLine">  labels:</div><div class="FixedLine">    group: {{ .Values.postgres.group }}</div><div class="FixedLine">spec:</div><div class="FixedLine">  type: {{ .Values.postgres.service.type }}</div><div class="FixedLine">  selector:</div><div class="FixedLine">    app: {{ .Values.postgres.name }}<span id="ITerm100"></span></div><div class="FixedLine">  ports:</div><div class="FixedLine">    - port: {{ .Values.postgres.service.port }}</div><div class="FixedLine">      targetPort: {{ .Values.postgres.container.port }}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-53</span><p class="SimplePara">The Postgres Service YAML File (ch12/ch12-06/postgres/service.yaml)</p></div></div></div></div>

            <div class="Para" id="Par145">Here again, if you take <span class="EmphasisFontCategoryNonProportional ">{{ .Values.postgres.service.port }}</span> for example, its value will come from the leaf of the <span class="EmphasisFontCategoryNonProportional ">./postgres/values.yaml</span> file:<div class="ProgramCode" id="PC57"><div class="LineGroup"><div class="FixedLine">postgres:</div><div class="FixedLine">  service:</div><div class="FixedLine">    port: 5432</div></div></div></div>

            <p class="Para" id="Par146">The same explanation applies to the <span class="EmphasisFontCategoryNonProportional ">./postgres/pvc.yaml</span> and <span class="EmphasisFontCategoryNonProportional ">./postgres/config.yaml</span> files.</p>

            <p class="Para" id="Par147">You can <span id="ITerm101">update</span> the metadata in the <span class="EmphasisFontCategoryNonProportional ">./Chart.yaml</span> file, which was described in the previous example in this chapter. If you are in doubt, just copy the contents from <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/Chart.yaml</span> to the file in your project folder: <span class="EmphasisFontCategoryNonProportional ">./Chart.yaml</span></p>

            <div class="Para" id="Par148">As a final step for the <span class="EmphasisFontCategoryNonProportional ">postgres</span> chart, you need to create another file that will hold some <span id="ITerm102">Postgres-specific values</span>. Add the file outside the <span class="EmphasisFontCategoryNonProportional ">postgres</span> chart folder.<div class="ProgramCode" id="PC58"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ touch ./acme-postgres.yaml</div></div></div></div>

            <p class="Para" id="Par149">Update this file with the <span class="EmphasisFontCategoryNonProportional ">acme postgres</span> specific values.</p>

            <p class="Para" id="Par150">Then copy the <span id="ITerm103">contents</span> from <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/acme-postgres.yaml</span> to <span class="EmphasisFontCategoryNonProportional ">./acme-postgres.yaml</span></p>

            <div class="Para" id="Par151">To make sure you have done everything right, you may want to execute the <span id="ITerm104">sanity-check commands</span> shown in Listing <span class="InternalRef"><a href="#PC59">12-54</a></span>.<div class="ProgramCode" id="PC59"><div class="LineGroup"><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/ch12/ch12-06</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ helm template postgres</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ helm lint postgres</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ helm install postgres --debug --dry-run postgres</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-54</span><p class="SimplePara">Sanity Checking the Helmfiles</p></div></div></div></div>

          </section>

          <section class="Section3 RenderAsSection3" id="Sec37">

            <h4 class="Heading">Common Chart for Microservices and Adminer</h4>

            <div class="Para" id="Par152">This section demonstrates another advantage of Helm—using common charts, called <span id="ITerm105">template charts</span>—which can be used for more than one release. In this case, you will use it as a common template for the Product Web and Product Server microservices and the Adminer app. You need to create a new Helm chart called <span class="EmphasisFontCategoryNonProportional ">app</span> and repeat the steps for creating the <span class="EmphasisFontCategoryNonProportional ">postgres</span> Helm chart, as shown in Listing <span class="InternalRef"><a href="#PC60">12-55</a></span>.<div class="ProgramCode" id="PC60"><div class="LineGroup"><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/ch12/ch12-06</div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ ls</div><div class="FixedLine">01-ProductServer README.txt            make.sh</div><div class="FixedLine">02-ProductWeb            acme-postgres.yaml      postgres</div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ helm create app</div><div class="FixedLine">Creating app</div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ rm -r ./app/templates/*</div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ touch ./app/templates/deployment.yaml</div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ touch ./app/templates/service.yaml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-55</span><p class="SimplePara">Creating the Chart for the App</p></div></div></div></div>

            <p class="Para" id="Par153">To create <span id="ITerm106">templates</span> for the Postgre Kubernetes objects:</p>

            <p class="Para" id="Par154">Copy the contents from <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/app/templates/*</span> to the applicable files.</p>

            <p class="Para" id="Par155">Create dummy values for the Postgre Kubernetes objects:</p>

            <p class="Para" id="Par156">Copy the contents from <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/app/values.yaml</span> to <span class="EmphasisFontCategoryNonProportional ">./app/values.yaml</span>.</p>

            <div class="Para" id="Par157">Update the metadata in <span class="EmphasisFontCategoryNonProportional ">./app/Charts.yaml</span>.<div class="ProgramCode" id="PC61"><div class="LineGroup"><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ touch ./adminer.yaml</div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ touch ./acme-product-server.yaml</div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ touch ./acme-product-web.yaml</div></div></div></div>

            <p class="Para" id="Par158">Update these files with <span class="EmphasisFontCategoryNonProportional ">acme</span>-specific values.</p>

            <p class="Para" id="Par159">Copy the contents from the corresponding files <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/acme-*.yaml</span> to <span class="EmphasisFontCategoryNonProportional ">./acme-*.yaml</span>.</p>

            <p class="Para" id="Par160">Copy the contents from the corresponding files <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/adminer.yaml</span> to <span class="EmphasisFontCategoryNonProportional ">./adminer.yaml</span>.</p>

          </section>

          <section class="Section3 RenderAsSection3" id="Sec38">

            <h4 class="Heading">Helm Chart for Ingress</h4>

            <div class="Para" id="Par161">The last chart you create is for the Ingress controller. For this, you will create a new Helm chart called <span class="EmphasisFontCategoryNonProportional ">ingress</span> and repeat the steps for creating the <span class="EmphasisFontCategoryNonProportional ">postgres</span> Helm <span id="ITerm107">chart</span>, as shown in Listing <span class="InternalRef"><a href="#PC62">12-56</a></span>.<div class="ProgramCode" id="PC62"><div class="LineGroup"><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ helm create ingress</div><div class="FixedLine">Creating ingress</div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ rm -r ./ingress/templates/*</div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-56</span><p class="SimplePara">Creating a Chart for Ingress</p></div></div></div></div>

            <p class="Para" id="Par162">Create <span class="EmphasisFontCategoryNonProportional ">Chart.yaml</span> for Ingress Kubernetes objects:</p>

            <div class="Para" id="Par163">Copy the contents from <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/ingress/Chart.yaml</span> to <span class="EmphasisFontCategoryNonProportional ">./ingress/Chart.yaml</span>.<div class="ProgramCode" id="PC63"><div class="LineGroup"><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ helm dependency update ./ingress/</div><div class="FixedLine">Saving 1 charts</div><div class="FixedLine">Downloading nginx-ingress from repo https://charts.helm.sh/stable</div><div class="FixedLine">Deleting outdated charts<span id="ITerm108"></span></div><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$</div></div><div class="LineGroup"><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ touch ./ingress/templates/ingress.yaml</div></div></div></div>

            <p class="Para" id="Par164">Copy the contents from <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/ingress/templates/ingress.yaml</span> to <span class="EmphasisFontCategoryNonProportional ">./ingress/templates/ingress.yaml</span>.</p>

            <div class="Para" id="Par165">Copy the contents from <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/ingress/values.yaml</span> to <span class="EmphasisFontCategoryNonProportional ">./ingress/values.yaml.</span><div class="ProgramCode" id="PC64"><div class="LineGroup"><div class="FixedLine">(base) binildass-MBP:ch12-06 binil$ touch ./ingress.yaml</div></div></div></div>

            <p class="Para" id="Par166">Copy the contents from <span class="EmphasisFontCategoryNonProportional ">BookCode/ch12/ch12-06/ingress.yaml</span> to <span class="EmphasisFontCategoryNonProportional ">./ingress.yaml.</span></p>

            <div class="Para" id="Par167">Little mention needs to be done to the <span class="EmphasisFontCategoryNonProportional ">./ingress/Chart.yaml</span> file. See Listing <span class="InternalRef"><a href="#PC65">12-57</a></span>.<div class="ProgramCode" id="PC65"><div class="LineGroup"><div class="FixedLine">apiVersion: v2</div><div class="FixedLine">name: ingress</div><div class="FixedLine">description: A Helm chart for Kubernetes</div><div class="FixedLine">type: application</div><div class="FixedLine">version: 1.1.0</div><div class="FixedLine">appVersion: 1.17.0</div><div class="FixedLine">keywords:</div><div class="FixedLine">  - ingress</div><div class="FixedLine">  - nginx</div><div class="FixedLine">  - api-gateway</div><div class="FixedLine">home: https://github.com/no-account/k8s-helm-helmfile/tree/master/helm</div><div class="FixedLine">maintainers:</div><div class="FixedLine">  - name: Binildas</div><div class="FixedLine">    url: https://github.com/no-account</div><div class="FixedLine">dependencies:</div><div class="FixedLine">  - name: nginx-ingress</div><div class="FixedLine">    version: 1.36.0</div><div class="FixedLine">    repository: https://charts.helm.sh/stable</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-57</span><p class="SimplePara">Chart YAML for Ingress (ch12/ch12-06/ingress/Chart.yaml)</p></div></div></div></div>

            <p class="Para" id="Par168">The - <span class="EmphasisFontCategoryNonProportional ">dependencies:</span> section is newly added compared to other charts. It creates a default backend service that enables the Ingress controller’s features.</p>

            <p class="Para" id="Par169">This <span id="ITerm109">declaration</span> only defines what this chart depends on; it won’t download it automatically during the installation. That is why you have you to install this dependency explicitly, by running the <span class="EmphasisFontCategoryNonProportional ">helm dependency update ./ingress/</span> command. When you run this command, a new file called <span class="EmphasisFontCategoryNonProportional ">nginx-ingress-1.36.0.tgz</span> will appear inside the ./<span class="EmphasisFontCategoryNonProportional ">ingress/charts</span> folder.</p>

          </section>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec39">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par170">The <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-06</span> folder contains the Maven scripts required to build and run these examples. First, you will build the <span id="ITerm110">microservices</span> and release the application to Kubernetes. A single script called <span class="EmphasisFontCategoryNonProportional ">run.sh</span> declares all the commands, as shown in Listing <span class="InternalRef"><a href="#PC66">12-58</a></span>.<div class="ProgramCode" id="PC66"><div class="LineGroup"><div class="FixedLine">mvn -Dmaven.test.skip=true clean package</div><div class="FixedLine">eval $(minikube docker-env)</div><div class="FixedLine">docker build  --build-arg JAR_FILE=02-ProductWeb/target/*.jar -t ecom/product-web .</div><div class="FixedLine">docker build  --build-arg JAR_FILE=01-ProductServer/target/*.jar -t ecom/product-server .</div><div class="FixedLine">helm install -f acme-postgres.yaml postgres ./postgres</div><div class="FixedLine">helm install -f adminer.yaml adminer ./app</div><div class="FixedLine">helm install -f acme-product-server.yaml product-server ./app</div><div class="FixedLine">helm install -f acme-product-web.yaml product-web ./app</div><div class="FixedLine">helm install -f ingress.yaml ingress ./ingress</div><div class="FixedLine">minikube service product-web --url</div><div class="FixedLine">sleep 3</div><div class="FixedLine">helm list<span id="ITerm111"></span></div><div class="FixedLine">kubectl get deployments</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-58</span><p class="SimplePara">Script for Helm Release (ch12/ch12-06/run.sh)</p></div></div></div></div>

          <div class="Para" id="Par171">You can now execute this <span id="ITerm112">script</span>, as shown in Listing <span class="InternalRef"><a href="#PC67">12-59</a></span>.<div class="ProgramCode" id="PC67"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-06</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ sh run.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">Successfully tagged ecom/product-web:latest</div><div class="FixedLine">Successfully tagged ecom/product-server:latest</div><div class="FixedLine">NAME: postgres</div><div class="FixedLine">LAST DEPLOYED: Mon May 22 23:32:05 2023</div><div class="FixedLine">NAMESPACE: default</div><div class="FixedLine">STATUS: deployed</div><div class="FixedLine">REVISION: 1</div><div class="FixedLine">TEST SUITE: None</div><div class="FixedLine">NAME: adminer</div><div class="FixedLine">LAST DEPLOYED: Mon May 22 23:32:06 2023</div><div class="FixedLine">NAMESPACE: default</div><div class="FixedLine">STATUS: deployed</div><div class="FixedLine">REVISION: 1</div><div class="FixedLine">TEST SUITE: None</div><div class="FixedLine">NAME: product-server</div><div class="FixedLine">LAST DEPLOYED: Mon May 22 23:32:06 2023</div><div class="FixedLine">NAMESPACE: default</div><div class="FixedLine">STATUS: deployed</div><div class="FixedLine">REVISION: 1</div><div class="FixedLine">TEST SUITE: None</div><div class="FixedLine">NAME: product-web</div><div class="FixedLine">LAST DEPLOYED: Mon May 22 23:32:06 2023</div><div class="FixedLine">NAMESPACE: default</div><div class="FixedLine">STATUS: deployed</div><div class="FixedLine">REVISION: 1</div><div class="FixedLine">TEST SUITE: None<span id="ITerm113"></span></div><div class="FixedLine">NAME: ingress</div><div class="FixedLine">LAST DEPLOYED: Mon May 22 23:32:06 2023</div><div class="FixedLine">NAMESPACE: default</div><div class="FixedLine">STATUS: deployed</div><div class="FixedLine">REVISION: 1</div><div class="FixedLine">TEST SUITE: None</div><div class="FixedLine">http://192.168.64.6:32216</div><div class="FixedLine">...</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-59</span><p class="SimplePara">Building and Running the Microservice</p></div></div></div></div>

          <p class="Para" id="Par172">That’s all; you are ready to test.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec40">

          <h3 class="Heading">Testing the Microservice</h3>

          <p class="Para" id="Par173">You can access the Product Web <span id="ITerm114">microservice</span> using the hostname you configured.</p>

          <p class="Para" id="Par174"><span class="ExternalRef"><a href="http://products.acme.test/product.html"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://products.acme.test/product.html</span></span></a></span></p>

          <p class="Para" id="Par175">Note the URL address in Figure <span class="InternalRef"><a href="#Fig3">12-3</a></span>. Refer to the section titled “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the Product Web microservice container.</p>

          <p class="Para" id="Par176">While you test the microservices, keep watching the log windows of the pods, as mentioned in Listings <span class="ExternalRef"><a href="Capítulo-13.html#PC10"><span class="RefSource">11-10</span></a></span> through <span class="ExternalRef"><a href="Capítulo-13.html#PC15"><span class="RefSource">11-15</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span>.</p>

          <p class="Para" id="Par177">If you recollect, you also configured the Adminer UI. You will now attempt to access the PostgreSQL database through the Adminer UI. Use the second URL for that:</p>

          <p class="Para" id="Par178"><span class="ExternalRef"><a href="http://adminer.acme.test"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://adminer.acme.test</span></span></a></span></p>

          <p class="Para" id="Par179">Refer to the third example in Chapter <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span> to get more details about <span id="ITerm115">testing</span>.</p>

          <div class="Para" id="Par180">Once you complete the testing process, you can stop and remove the microservice containers and clean the environment. For that, you have a single script, as shown in Listing <span class="InternalRef"><a href="#PC68">12-60</a></span>.<div class="ProgramCode" id="PC68"><div class="LineGroup"><div class="FixedLine">eval $(minikube docker-env)</div><div class="FixedLine">helm delete adminer</div><div class="FixedLine">helm delete product-web</div><div class="FixedLine">helm delete product-server</div><div class="FixedLine">helm delete postgres</div><div class="FixedLine">helm delete ingress-backend</div><div class="FixedLine">helm delete ingress-controller</div><div class="FixedLine">mvn -Dmaven.test.skip=true clean</div><div class="FixedLine">docker rmi -f ecom/product-web</div><div class="FixedLine">docker rmi -f ecom/product-server</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-60</span><p class="SimplePara">Script for Cleaning the Project and the Environment (ch12/ch12-06/clean.sh)</p></div></div></div></div>

          <div class="Para" id="Par181">You can now execute this script to clean the environment, as shown in Listing <span class="InternalRef"><a href="#PC69">12-61</a></span>.<div class="ProgramCode" id="PC69"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-06</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-06 binil$ sh clean.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-61</span><p class="SimplePara">Cleaning the Project and the Environment</p></div></div></div></div>

          <p class="Para" id="Par182">This completes the multi-microservices packaging example with Helm.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec41">

        <h2 class="Heading">Helmfile Packaging Multi-Microservices</h2>

        <p class="Para" id="Par183">In the last example, you used Helm to package and deploy the multi-microservices project. There you defined a generic Helm chart (template) and reused it across multiple microservices only by injecting specific values into the template. In that example, even though you used a single script called <span class="EmphasisFontCategoryNonProportional ">run.sh</span>, to install or update a chart in a cluster, you need to run a specific imperative command. In other words, to change the state of a cluster, you need to run a command that is specific for a given deployment. Helm doesn’t have the feature to install, update, or roll back all applications from an entire cluster with a single command.</p>

        <p class="Para" id="Par184"><span id="ITerm116">Helmfile</span> will help you here, because it allows you to declare a definition of an entire Kubernetes cluster in a single YAML file and bundle multiple Helm releases (installation of Helm charts). It releases them depending on the type of environment (develop, test, production) on which you want to deploy your applications.</p>

        <p class="Para" id="Par185">Let’s deploy the example you released using Helm in the previous section, but this time using Helmfile.</p>

        <section class="Section2 RenderAsSection2" id="Sec42">

          <h3 class="Heading">Code Organization</h3>

          <div class="Para" id="Par186">The source <span id="ITerm117">code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized as shown in Listing <span class="InternalRef"><a href="#PC70">12-62</a></span>, inside the <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-07</span> folder.<div class="ProgramCode" id="PC70"><div class="LineGroup"><div class="FixedLine">./ch12-07/</div><div class="FixedLine">├── 01-ProductServer</div><div class="FixedLine">│   ├── Dockerfile</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── 02-ProductWeb</div><div class="FixedLine">│   ├── Dockerfile</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── ...</div><div class="FixedLine">├── Dockerfile</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── charts</div><div class="FixedLine">│   ├── app</div><div class="FixedLine">│   │   ├── Chart.yaml</div><div class="FixedLine">│   │   ├── charts</div><div class="FixedLine">│   │   ├── templates</div><div class="FixedLine">│   │   │   ├── deployment.yaml</div><div class="FixedLine">│   │   │   └── service.yaml</div><div class="FixedLine">│   │   └── values.yaml</div><div class="FixedLine">│   ├── ingress<span id="ITerm118"></span></div><div class="FixedLine">│   │   ├── Chart.yaml</div><div class="FixedLine">│   │   ├── charts</div><div class="FixedLine">│   │   │   └── nginx-ingress-1.36.0.tgz</div><div class="FixedLine">│   │   ├── templates</div><div class="FixedLine">│   │   │   └── ingress.yaml</div><div class="FixedLine">│   │   └── values.yaml</div><div class="FixedLine">│   └── postgres</div><div class="FixedLine">│       ├── Chart.yaml</div><div class="FixedLine">│       ├── charts</div><div class="FixedLine">│       ├── templates</div><div class="FixedLine">│       │   ├── config.yaml</div><div class="FixedLine">│       │   ├── deployment.yaml</div><div class="FixedLine">│       │   ├── pcv.yaml</div><div class="FixedLine">│       │   └── service.yaml</div><div class="FixedLine">│       └── values.yaml</div><div class="FixedLine">├── clean.sh</div><div class="FixedLine">├── helmfile.yaml</div><div class="FixedLine">├── make.sh</div><div class="FixedLine">├── pom.xml</div><div class="FixedLine">├── run.sh</div><div class="FixedLine">└── values</div><div class="FixedLine">    ├── acme-postgres.yaml</div><div class="FixedLine">    ├── acme-product-server.yaml</div><div class="FixedLine">    ├── acme-product-web.yaml</div><div class="FixedLine">    ├── adminer.yaml<span id="ITerm119"></span></div><div class="FixedLine">    └── ingress.yaml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-62</span><p class="SimplePara">Source Code Organization for Multi-Microservice Helmfile Deployment</p></div></div></div></div>

          <p class="Para" id="Par187">The next section looks at the main aspects of the source code.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec43">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par188">As a prerequisite, I assume that you have enabled Ingress in Minikube and added the required hostnames to your host files, as mentioned in the third example in Chapter <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span>.</p>

          <div class="Para" id="Par189">This example assumes that you have a project root folder called <span class="EmphasisFontCategoryNonProportional ">ch12/ch12-07</span> which is empty. First, bring all the files from <span class="EmphasisFontCategoryNonProportional ">ch12/ch12-06</span> to <span class="EmphasisFontCategoryNonProportional ">ch12/ch12-07</span>. Then, create two new folders called <span class="EmphasisFontCategoryNonProportional ">charts</span> and <span class="EmphasisFontCategoryNonProportional ">values</span> in the project root folder: <span class="EmphasisFontCategoryNonProportional ">ch12/ch12-07</span>. Move <span class="EmphasisFontCategoryNonProportional ">./app</span>, <span class="EmphasisFontCategoryNonProportional ">./ingress</span>, and <span class="EmphasisFontCategoryNonProportional ">./postgres</span> to <span class="EmphasisFontCategoryNonProportional ">./charts</span> and move <span class="EmphasisFontCategoryNonProportional ">./*.yaml</span> to <span class="EmphasisFontCategoryNonProportional ">./values</span>. Then add a new <span class="EmphasisFontCategoryNonProportional ">helmfile.yaml</span> file to the root directory. See Listing <span class="InternalRef"><a href="#PC71">12-63</a></span>.<div class="ProgramCode" id="PC71"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:.Trash binil$ cd /Users/binil/binil/code/mac/mybooks/docker-04/ch12/</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/ch12</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12 binil$ mkdir ch12-07</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12 binil$ cp -r BookCode/ch12/ch12-06/* /Users/binil/binil/code/mac/mybooks/docker-04/ch12/ch12-07/</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ mkdir charts</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ mv ./charts/ ./app</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ mv ./app ./charts/</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ mv ./ingress ./charts/</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ mv ./postgres ./charts/</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ mkdir values</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ mv ./acme*.yaml ./values/</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ mv ./adminer.yaml ./values/</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ mv ./ingress.yaml ./values/</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ touch helmfile.yaml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-63</span><p class="SimplePara">Reorganizing the Multi-Microservice Project for Helmfile</p></div></div></div></div>

          <div class="Para" id="Par190">I explain the major components in Listing <span class="InternalRef"><a href="#PC71">12-63</a></span> here.<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par191"><span class="EmphasisFontCategoryNonProportional ">helmfile.yaml</span>: This is a configuration for a Helmfile, currently blank.</p></li><li><p class="Para" id="Par192"><span class="EmphasisFontCategoryNonProportional ">./charts</span>: Three Helms charts that are templates for each release—<span class="EmphasisFontCategoryNonProportional ">app</span> (for <span class="EmphasisFontCategoryNonProportional ">adminer</span>, <span class="EmphasisFontCategoryNonProportional ">product-web</span> and <span class="EmphasisFontCategoryNonProportional ">product-server</span>), <span class="EmphasisFontCategoryNonProportional ">postgres</span> and <span class="EmphasisFontCategoryNonProportional ">ingress</span>.</p></li><li><p class="Para" id="Par193"><span class="EmphasisFontCategoryNonProportional ">./values</span>: The folder containing values that are specific for each application that will be released.</p></li></ul></div></div>

          <p class="Para" id="Par194">In the last example, in <span class="EmphasisFontCategoryNonProportional ">ch12/ch12-06/ingress/Chart.yaml</span>, <span class="EmphasisFontCategoryNonProportional ">nginx-ingress version 1.36.0</span> is fetched from the repository. Further, you explicitly run the installation command. In this current example, you will remove this part from <span class="EmphasisFontCategoryNonProportional ">ch12/ch12-07/charts/ingress/Chart.yaml</span> and instead mention in <span class="EmphasisFontCategoryNonProportional ">./helmfile.yaml</span> to treat the <span class="EmphasisFontCategoryNonProportional ">nginx-ingress</span> chart as a separate Helm release, apart from the Ingress controller configuration for routing.</p>

          <p class="Para" id="Par195">You can delete the <span class="EmphasisFontCategoryNonProportional ">./charts/ingress/Chart.lock</span> file.</p>

          <div class="Para" id="Par196">Listing <span class="InternalRef"><a href="#PC72">12-64</a></span> shows the <span class="EmphasisFontCategoryNonProportional ">./helmfile.yaml</span> file.<div class="ProgramCode" id="PC72"><div class="LineGroup"><div class="FixedLine">repositories:</div><div class="FixedLine">  - name: stable</div><div class="FixedLine">    url: https://charts.helm.sh/stable</div></div><div class="LineGroup"><div class="FixedLine">releases:</div><div class="FixedLine">  - name: postgres</div><div class="FixedLine">    chart: ./charts/postgres</div><div class="FixedLine">    values:</div><div class="FixedLine">      - ./values/acme-postgres.yaml</div></div><div class="LineGroup"><div class="FixedLine">  - name: adminer</div><div class="FixedLine">    chart: ./charts/app</div><div class="FixedLine">    values:</div><div class="FixedLine">      - ./values/adminer.yaml</div></div><div class="LineGroup"><div class="FixedLine">  - name: product-server</div><div class="FixedLine">    chart: ./charts/app</div><div class="FixedLine">    values:</div><div class="FixedLine">      - ./values/acme-product-server.yaml</div></div><div class="LineGroup"><div class="FixedLine">  - name: product-web</div><div class="FixedLine">    chart: ./charts/app</div><div class="FixedLine">    values:</div><div class="FixedLine">      - ./values/acme-product-web.yaml</div></div><div class="LineGroup"><div class="FixedLine">  - name: ingress-backend</div><div class="FixedLine">    chart: stable/nginx-ingress</div><div class="FixedLine">    version: 1.36.0</div></div><div class="LineGroup"><div class="FixedLine">  - name: ingress-controller</div><div class="FixedLine">    chart: ./charts/ingress</div><div class="FixedLine">    values:</div><div class="FixedLine">      - ./values/ingress.yaml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-64</span><p class="SimplePara">Helmfile (ch12/ch12-07/helmfile.yaml)</p></div></div></div></div>

          <p class="Para" id="Par197">What you have done here is split the Ingress controller from the Ingress backend. The <span class="EmphasisFontCategoryNonProportional ">./charts/ingress/Chart.yaml</span> Helm chart defines only the Ingress controller; the Ingress backend has been moved to <span class="EmphasisFontCategoryNonProportional ">./helmfile.yaml</span>. In <span class="EmphasisFontCategoryNonProportional ">./helmfile.yaml</span>, you determine from which Helm repositories you would like to download charts and then mention all the releases.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec44">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <p class="Para" id="Par198">The <span class="EmphasisFontCategoryNonProportional ">ch12\ch12-07</span> folder contains the Maven scripts required to build and run these examples.</p>

          <div class="Para" id="Par199">As a first step, you need to add the repository to your instance of Helm, which you do only once (you don’t need to do this, since this is included in the single script).<div class="ProgramCode" id="PC73"><div class="LineGroup"><div class="FixedLine">helmfile repos</div></div></div></div>

          <div class="Para" id="Par200">Next, you can install all the charts with a single command:<div class="ProgramCode" id="PC74"><div class="LineGroup"><div class="FixedLine">helmfile sync</div></div></div></div>

          <div class="Para" id="Par201">Now perform the build and release. A single script called <span class="EmphasisFontCategoryNonProportional ">run.sh</span><span id="ITerm120"></span> declares all the commands, as <span id="ITerm121">shown</span> in Listing <span class="InternalRef"><a href="#PC75">12-65</a></span>.<div class="ProgramCode" id="PC75"><div class="LineGroup"><div class="FixedLine">mvn -Dmaven.test.skip=true clean package</div><div class="FixedLine">eval $(minikube docker-env)</div><div class="FixedLine">docker build  --build-arg JAR_FILE=02-ProductWeb/target/*.jar -t ecom/product-web .</div><div class="FixedLine">docker build  --build-arg JAR_FILE=01-ProductServer/target/*.jar -t ecom/product-server .</div><div class="FixedLine">helmfile repos</div><div class="FixedLine">helmfile sync<span id="ITerm122"></span></div><div class="FixedLine">minikube service product-web --url</div><div class="FixedLine">sleep 3</div><div class="FixedLine">helm list</div><div class="FixedLine">kubectl get deployments</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-65</span><p class="SimplePara">Script for Helm Release (ch12/ch12-07/run.sh)</p></div></div></div></div>

          <div class="Para" id="Par202">You can now execute this script, as <span id="ITerm123">shown</span> in Listing <span class="InternalRef"><a href="#PC76">12-66</a></span>.<div class="ProgramCode" id="PC76"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-07</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ sh run.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] Ecom-Product-Server-Microservice  SUCCESS [  3.604 s]</div><div class="FixedLine">[INFO] Ecom-Product-Web-Microservice ... SUCCESS [  0.655 s]</div><div class="FixedLine">[INFO] Ecom ............................ SUCCESS [  0.037 s]</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] Total time:  4.502 s</div><div class="FixedLine">[INFO] Finished at: 2023-05-23T11:35:18+05:30</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">...</div><div class="FixedLine">Successfully tagged ecom/product-web:latest</div><div class="FixedLine">Successfully tagged ecom/product-server:latest</div><div class="FixedLine">Adding repo stable https://charts.helm.sh/stable</div><div class="FixedLine">"stable" has been added to your repositories<span id="ITerm124"></span></div></div><div class="LineGroup"><div class="FixedLine">Adding repo stable https://charts.helm.sh/stable</div><div class="FixedLine">"stable" has been added to your repositories</div></div><div class="LineGroup"><div class="FixedLine">Building dependency release=postgres, chart=charts/postgres</div><div class="FixedLine">Building dependency release=adminer, chart=charts/app</div><div class="FixedLine">Building dependency release=product-web, chart=charts/app</div><div class="FixedLine">Building dependency release=ingress-controller, chart=charts/ingress</div><div class="FixedLine">Building dependency release=product-server, chart=charts/app</div><div class="FixedLine">Upgrading release=product-server, chart=charts/app</div><div class="FixedLine">Upgrading release=product-web, chart=charts/app</div><div class="FixedLine">Upgrading release=ingress-controller, chart=charts/ingress</div><div class="FixedLine">Upgrading release=adminer, chart=charts/app</div><div class="FixedLine">Upgrading release=ingress-backend, chart=stable/nginx-ingress</div><div class="FixedLine">Upgrading release=postgres, chart=charts/postgres</div><div class="FixedLine">Release "product-web" does not exist. Installing it now.</div><div class="FixedLine">NAME: product-web</div><div class="FixedLine">LAST DEPLOYED: Tue May 23 11:35:27 2023</div><div class="FixedLine">NAMESPACE: default</div><div class="FixedLine">STATUS: deployed<span id="ITerm125"></span></div><div class="FixedLine">REVISION: 1</div><div class="FixedLine">TEST SUITE: None</div></div><div class="LineGroup"><div class="FixedLine">...</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-66</span><p class="SimplePara">Releasing the Microservice Containers</p></div></div></div></div>

          <div class="Para" id="Par203">You can also view the newly <span id="ITerm126">released services</span>, as shown in Listing <span class="InternalRef"><a href="#PC77">12-67</a></span>.<div class="ProgramCode" id="PC77"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-07</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ eval $(minikube docker-env)</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ helm list</div><div class="FixedLine">UPDATED RELEASES:</div><div class="FixedLine">NAME                 CHART                  VERSION   DURATION</div><div class="FixedLine">product-web          ./charts/app           0.1.0           1s</div><div class="FixedLine">adminer              ./charts/app           0.1.0           1s</div><div class="FixedLine">product-server       ./charts/app           0.1.0           1s</div><div class="FixedLine">postgres             ./charts/postgres      0.1.0           1s</div><div class="FixedLine">ingress-controller   ./charts/ingress       1.1.0           1s</div><div class="FixedLine">ingress-backend      stable/nginx-ingress   1.36.0          2s</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ pwd</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-67</span><p class="SimplePara">Viewing the Releases of the Microservices</p></div></div></div></div>

          <p class="Para" id="Par204">Once the application is running, you can test it.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec45">

          <h3 class="Heading">Testing the Microservice</h3>

          <p class="Para" id="Par205">Next you can access the Product Web <span id="ITerm127">microservice</span> using the hostname you configured.</p>

          <p class="Para" id="Par206"><span class="ExternalRef"><a href="http://products.acme.test/product.html"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://products.acme.test/product.html</span></span></a></span></p>

          <p class="Para" id="Par207">Note the URL address in Figure <span class="InternalRef"><a href="#Fig3">12-3</a></span>. Refer to the section titled “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the Product Web microservice container.</p>

          <p class="Para" id="Par208">While you test the microservices, keep watching the log windows of the pods, as mentioned in Listings <span class="ExternalRef"><a href="Capítulo-13.html#PC10"><span class="RefSource">11-10</span></a></span> through <span class="ExternalRef"><a href="Capítulo-13.html#PC15"><span class="RefSource">11-15</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span>.</p>

          <p class="Para" id="Par209">If you recollect, you also configured the Adminer UI. You will now attempt to access the PostgreSQL database through the Adminer UI. Use the second URL for that:</p>

          <p class="Para" id="Par210"><span class="ExternalRef"><a href="http://adminer.acme.test"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://adminer.acme.test</span></span></a></span></p>

          <p class="Para" id="Par211">Refer to the third example in Chapter <span class="ExternalRef"><a href="Capítulo-13.html"><span class="RefSource">11</span></a></span> to get more details about testing.</p>

          <div class="Para" id="Par212">Once you complete the testing <span id="ITerm128">process</span>, you can stop and remove the microservice containers and clean the environment, using the <span class="EmphasisFontCategoryNonProportional ">clean.sh</span> script provided, which is like the script in Listing <span class="InternalRef"><a href="#PC68">12-60</a></span>. See Listing <span class="InternalRef"><a href="#PC78">12-68</a></span>.<div class="ProgramCode" id="PC78"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-02 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch12/ch12-07</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch12-07 binil$ sh clean.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-68</span><p class="SimplePara">Cleaning the Project and the Environment</p></div></div></div></div>

          <p class="Para" id="Par213">This completes the multi-microservice example with Helmfile.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec46">

        <h2 class="Heading">Summary</h2>

        <p class="Para" id="Par214">Helm simplifies the process of <span id="ITerm129">application development</span> in Kubernetes by automating the distribution of your applications using a packaging format called a <span id="ITerm130"><em class="EmphasisTypeItalic ">Helm chart</em></span>. <span id="ITerm131">Helmfile</span> allows you to declare a definition of an entire Kubernetes cluster in a single YAML file and bundles multiple Helm releases. These are handy tools to use while installing, managing, and updating hundreds of configurations, which is a normal process in a microservices environment. You saw examples with just enough complexity that you can appreciate their benefits. So far so good. Now isn’t it time to also investigate CI (Continuous <span id="ITerm132">Integration</span>) and CD (Continuous <span id="ITerm133">Deployment</span>) in the context of containers and microservices? That’s what you’ll do in the next chapter.</p>

      </section>

    </div>

  </div>

</body>

</html>