<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en">

<head>
  <title>Microservices in AWS Elastic Compute Cloud</title>
  <link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>

<body>

  <div epub:type="chapter" role="doc-chapter">

    <div class="ChapterContextInformation">

      <div class="ContextInformation" id="b979-8-8688-0555-4_14"><div class="ChapterCopyright">© The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature 2024</div><span class="ContextInformationAuthorEditorNames">B. A. Christudas</span><span class="ContextInformationBookTitles"><span class="BookTitle">Java Microservices and Containers in the Cloud</span></span><span class="ChapterDOI"><a href="https://doi.org/10.1007/979-8-8688-0555-4_14">https://doi.org/10.1007/979-8-8688-0555-4_14</a></span></div>

    </div>

    <!--Begin Abstract-->

    <div class="MainTitleSection">

      <h1 class="ChapterTitle" lang="en">14. Microservices in AWS Elastic Compute Cloud</h1>

    </div>

    <div class="AuthorGroup">

      <div class="AuthorNames"><span class="Author"><span class="AuthorName">Binildas A. Christudas</span><sup><a href="#Aff2">1</a> <span class="ContactIcon"> </span></sup></span></div>

      <div class="Affiliations">

        <div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">NBCRA 45, Christbin, Thiruvananthapuram, Kerala, India</div></div>

        <div class="ClearBoth"> </div>

      </div>

    </div>

    <!--End Abstract-->

    <div class="Fulltext">

      <p class="Para" id="Par2">In a manufacturing enterprise, <span id="ITerm1">dead stock</span> refers to products that are not selling and are no longer in production, but remain on the shelf. Similarly, <span id="ITerm2">obsolete stock</span> refers to products that are no longer being sold and are discontinued, and often cannot be used or sold anymore. The IT industry is also not shielded from similar obsoleteness. Compute, network, and storage devices may become obsolete or useless, and the investment done on this in the past may become unprotected. Cloud computing attempts to address this <span id="ITerm3">obsoleteness</span> to some extent as one of its objectives.</p>

      <p class="Para" id="Par3">This chapter introduces the notion of a public cloud and explains how to deploy microservices in the public cloud.</p>

      <div class="Para" id="Par4">The following concepts are covered in this chapter:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par5">Introduction to cloud computing</p></li><li><p class="Para" id="Par6">Introduction to Amazon Web Services (AWS)</p></li><li><p class="Para" id="Par7">Introduction to Terraform</p></li><li><p class="Para" id="Par8">Provisioning an EC2 in AWS Cloud</p></li><li><p class="Para" id="Par9">Deploying a microservice example in AWS Cloud</p></li></ul></div></div>

      <section class="Section1 RenderAsSection1" id="Sec1">

        <h2 class="Heading">Cloud Computing</h2>

        <p class="Para" id="Par10"><span id="ITerm4">Cloud computing</span> is the on-demand availability of computer system resources as network accessible services—especially computing power, storage, and networking resources—without direct, active management by the user enterprise. <span id="ITerm5">Clouds</span> often have such functions distributed over multiple locations of geography, each of which is a <span id="ITerm6"><em class="EmphasisTypeItalic ">data center</em></span>. Cloud computing relies on sharing these resources to achieve coherence and typically uses a pay-per-usage model, which can help in reducing capital expenses of the user enterprise.</p>

        <section class="Section2 RenderAsSection2" id="Sec2">

          <h3 class="Heading">Public Clouds</h3>

          <p class="Para" id="Par11">Around the <span id="ITerm7">year</span><span id="ITerm8"></span> 2000, Amazon created the subsidiary called Amazon Web Services (AWS) and before too long they introduced Simple Storage Service (S3) and Elastic Compute Cloud (EC2). With this, instead of buying, owning, and maintaining physical data centers and servers, enterprises could access technology services, such as computing power, storage, and databases, on an as-needed basis from AWS.</p>

          <div class="Para" id="Par12">Before too long, many other players also offered similar cloud computing <span id="ITerm9">services</span>. See Figure <span class="InternalRef"><a href="#Fig1">14-1</a></span>.<figure class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img alt="" aria-describedby="d64e245" src="../images/619782_1_En_14_Chapter/Imagem-139.jpg" style="width:27.38em"/><div class="TextObject" id="d64e245"><p class="Para" id="Par128">A diagram has logos of Microsoft Azure, Alibaba Cloud, Google Cloud Platform, a w s, and Oracle Cloud Infrastructure in a cloud.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-1</span><p class="SimplePara">Major <span id="ITerm10">cloud service providers</span></p></div></figcaption></figure></div>

          <div class="Para" id="Par13">A few of the advantages of <span id="ITerm11">cloud computing</span> are worth mentioning:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par14">Agility: The long cycles of hardware and software purchasing followed by further delays of provisioning and testing are cut short by cloud computing, since an enterprise or even an individual developer can spin up resources the instance they need them.</p></li><li><p class="Para" id="Par15">Elasticity: Over-provisioning or extra provisioning for just a few hours or days of seasonal peak in a year is not required since cloud computing allows you to add or reduce resources as and when your scalability needs change. This is like having zero “dead inventory” on the shelf.</p></li><li><p class="Para" id="Par16">Cost savings: There is less upfront investment in IT infrastructure and middleware, so your Capex is greatly reduced. Since cloud providers operate at huge volumes, they achieve economies of scale, a part of which could also be extended to cloud users.</p></li></ul></div></div>

          <p class="Para" id="Par17">Cloud is fast becoming the de facto mode of <span id="ITerm12">IT infrastructure services</span>. Figure <span class="InternalRef"><a href="#Fig1">14-1</a></span> shows a few of the cloud service providers; there are many more in the industry.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec3">

          <h3 class="Heading">Cloud Deployment Models</h3>

          <p class="Para" id="Par18">There are <span id="ITerm13">differences</span> in who owns the cloud computing service and how the service is offered to its customers. Based on that, the Cloud Deployment models are classified into three or more.</p>

          <section class="Section3 RenderAsSection3" id="Sec4">

            <h4 class="Heading">Public Cloud</h4>

            <div class="Para" id="Par19">A <em class="EmphasisTypeItalic ">public cloud</em> is a <span id="ITerm14">subscription</span><span id="ITerm15"></span> service that is offered to all customers who want similar services from their cloud provider. See Figure <span class="InternalRef"><a href="#Fig2">14-2</a></span>.<figure class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img alt="" aria-describedby="d64e323" src="../images/619782_1_En_14_Chapter/Imagem-140.jpg" style="width:35.15em"/><div class="TextObject" id="d64e323"><p class="Para" id="Par129">An illustration overlaps the clouds and blocks of public cloud with Microsoft Azure, multi-cloud with Google Cloud Platform and a w s, hybrid cloud with a w s and rack, enterprise, and on-premises data center with rack and mainframe.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-2</span><p class="SimplePara">Public vs. private vs. hybrid vs. multi-cloud</p></div></figcaption></figure></div>

            <p class="Para" id="Par20">Public cloud <span id="ITerm16">services</span><span id="ITerm17"></span> are offered over the Internet so that any consumer can subscribe to the service.</p>

          </section>

          <section class="Section3 RenderAsSection3" id="Sec5">

            <h4 class="Heading">Private Cloud</h4>

            <p class="Para" id="Par21">A <em class="EmphasisTypeItalic ">private cloud</em> is <span id="ITerm18">infrastructure</span><span id="ITerm19"></span> operated solely for a single organization. It can be managed internally by the organization’s own IT or by a third party and hosted internally or externally.</p>

          </section>

          <section class="Section3 RenderAsSection3" id="Sec6">

            <h4 class="Heading">Hybrid Cloud</h4>

            <p class="Para" id="Par22">A <em class="EmphasisTypeItalic ">hybrid cloud</em> <span id="ITerm20">service</span><span id="ITerm21"></span> is composed of some combination of private, public, and community cloud services, from different service providers. Some organizations use public cloud computing resources to meet temporary high-capacity needs that cannot be met by the private cloud. This capability enables hybrid clouds to employ cloud bursting for <span id="ITerm22">scaling</span><span id="ITerm23"></span> across clouds.</p>

          </section>

          <section class="Section3 RenderAsSection3" id="Sec7">

            <h4 class="Heading">Multi-Cloud</h4>

            <p class="Para" id="Par23">A <em class="EmphasisTypeItalic ">multi-cloud</em><span id="ITerm24"></span><span id="ITerm25"></span> leverages computing services from multiple providers in a single but heterogeneous architecture to reduce reliance on single vendors. The reason might be to increase flexibility through choice so that you are not dependent on a single provider, to mitigate against disasters, and so on.</p>

            <p class="Para" id="Par24">While data consistency and synchronization are aspects to be taken care of, managing hybrid and multi-cloud modes involves more complexities compared to pure private or public modes. Even with single providers, taking care of those aspects in an errorless manner is a non-trivial task. That is a bigger topic with many technical complexities involved, and could be the subject matter for another book in the future.</p>

          </section>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec8">

          <h3 class="Heading">Distributed Computing</h3>

          <div class="Para" id="Par25">The cloud service <span id="ITerm26">model</span><span id="ITerm27"></span> is based on the kind of control users have over how the resources are utilized. Figure <span class="InternalRef"><a href="#Fig3">14-3</a></span> shows the different models.<figure class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img alt="" aria-describedby="d64e429" src="../images/619782_1_En_14_Chapter/Imagem-141.jpg" style="width:35.15em"/><div class="TextObject" id="d64e429"><p class="Para" id="Par130">4 block diagrams of traditional, I a a S, P a a S, and S a a S with their respective data, applications, middleware or runtime, O S, virtualization, compute, network, and storage, and private, public, hybrid, and multi classifications. Traditional has all the services customer-managed, while the rest have an increasing number of services service provider-managed.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-3</span><p class="SimplePara">Cloud service models (adapted from “Practical Microservices Architectural Patterns,” ISBN-13: 978-1484245002)</p></div></figcaption></figure></div>

          <div class="Para" id="Par26">Typically, the cloud <span id="ITerm28">architecture</span><span id="ITerm29"></span> can be mapped to the cloud service model. In the traditional service model, the user, or the enterprise itself, is responsible for managing the whole stack (e.g., the hardware, data center facilities, software, and data), whereas in the cloud service model it varies as follows:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par27"><span id="ITerm30">Infrastructure as a Service (IaaS)</span>: In the IaaS service model, the users request compute power, storage, network, and their associated resources alone and pay for what they use.</p></li><li><p class="Para" id="Par28"><span id="ITerm31">Platform as a Service (PaaS)</span>: In the PaaS model, the users have no control over the underlying infrastructure, such as CPU, network, and storage, as they are abstracted away, below the platform. Instead, it allows application development platforms the creation of applications with supported programming languages and related tools hosted in the cloud and accessed through an interface, mainly a browser. Many times, the application runtime and <span id="ITerm32">middleware</span><span id="ITerm33"></span> are also provided by the CSP, and the user develops, installs, manages, and operates the software application alone and its data.</p></li><li><p class="Para" id="Par29"><span id="ITerm34">Software as a Service (SaaS)</span>: This is the “forget everything” model, where the user doesn’t even own, manage, or operate the application. Applications are run on the cloud infrastructure and are accessible from various client devices. Limited user-configurations are available. Sometimes the same application instance serves the end users of more than one enterprise (tenant); such applications are called multi-tenant.<sup><a epub:type="noteref" href="#Fn1" id="Fn1_source" role="doc-noteref">1</a></sup></p></li></ul></div></div>

          <p class="Para" id="Par31">IaaS and <span id="ITerm35">PaaS</span><span id="ITerm36"></span> are both covered in the examples in this book.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec9">

        <h2 class="Heading">Amazon Web Services (AWS)</h2>

        <div class="Para" id="Par32">Amazon Web Services (AWS) offers <span id="ITerm37">public cloud services</span> over different levels of abstractions of compute, storage, and networking. AWS <span id="ITerm38">infrastructure</span> is distributed globally, and the AWS website provides a glimpse of the global distribution of its data centers. See Figure <span class="InternalRef"><a href="#Fig4">14-4</a></span>.<figure class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img alt="" aria-describedby="d64e528" src="../images/619782_1_En_14_Chapter/Imagem-142.jpg" style="width:35.15em"/><div class="TextObject" id="d64e528"><p class="Para" id="Par131">A world map marks the data center locations as color gradient circles throughout the continents.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-4</span><p class="SimplePara">AWS data center locations (Source: <span class="ExternalRef"><a href="https://aws.amazon.com/about-aws/global-infrastructure/"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">https://aws.amazon.com/about-aws/global-infrastructure/</span></span></a></span>)</p></div></figcaption></figure></div>

        <p class="Para" id="Par33">These services can be accessed by machines using <span id="ITerm39">HTTP protocols</span>. Users can also access AWS services through the AWS command terminal or through the web UI.</p>

        <p class="Para" id="Par34">The next section looks at a few of the AWS services used in the example in the next section.</p>

        <section class="Section2 RenderAsSection2" id="Sec10">

          <h3 class="Heading">VPC</h3>

          <p class="Para" id="Par35">A <span id="ITerm40">Virtual Private Cloud (VPC)</span><span id="ITerm41"></span> is a virtual network dedicated to your AWS account. It is logically isolated from other virtual networks in AWS Cloud. You can specify an IP address range for the VPC, add subnets, add gateways, and associate security groups.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec11">

          <h3 class="Heading">Subnet</h3>

          <p class="Para" id="Par36">A <span id="ITerm42"><em class="EmphasisTypeItalic ">subnet</em></span><span id="ITerm43"></span> is a range of IP addresses in your VPC. You can create AWS resources, such as EC2 instances, in specific subnets. When you create a subnet, you specify its IP addresses, depending on the configuration of the VPC. The IPv4 subnet has an IPv4 CIDR block, but does not have an IPv6 CIDR block. Similarly, an IPv6 subnet has an IPv6 CIDR block, but does not have an IPv4 CIDR block. Dual stack subnets have both blocks.</p>

          <div class="Para" id="Par37">There are two subnet types:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par38"><span id="ITerm44">Public subnets</span>: Have a direct route to an Internet gateway. Resources in a public subnet can access the public Internet.</p></li><li><p class="Para" id="Par39"><span id="ITerm45">Private subnets</span>: Do not have a direct route to an Internet gateway. Resources in a private subnet require a NAT device to access the public Internet.</p></li></ul></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec12">

          <h3 class="Heading">Public Proxy Subnet</h3>

          <div class="Para" id="Par40">If the EC2 instance running in a subnet needs to be reachable via the Internet, you can create a proxy <span id="ITerm46">subnet</span><span id="ITerm47"></span>. Use these steps to do so:<div class="OrderedList"><ol><li class="ListItem"><div class="ItemNumber">1.</div><div class="ItemContent"><p class="Para" id="Par41">Create a subnet spanning a subsection of the IP address range assigned to the VPC.</p></div><div class="ClearBoth"> </div></li><li class="ListItem"><div class="ItemNumber">2.</div><div class="ItemContent"><p class="Para" id="Par42">Create a route table and attach it to the subnet.</p></div><div class="ClearBoth"> </div></li><li class="ListItem"><div class="ItemNumber">3.</div><div class="ItemContent"><p class="Para" id="Par43">Add the <span class="EmphasisFontCategoryNonProportional ">0.0.0.0/0</span> route pointing the Internet gateway to the route table.</p></div><div class="ClearBoth"> </div></li></ol></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec13">

          <h3 class="Heading">NAT Gateway</h3>

          <p class="Para" id="Par44">A <span id="ITerm48">NAT gateway</span><span id="ITerm49"></span> is a <span id="ITerm50">Network Address Translation (NAT)</span> service. You can use a NAT gateway so that instances in a private subnet can connect to services outside your VPC, but external services cannot initiate a connection with those instances.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec14">

          <h3 class="Heading">EC2</h3>

          <p class="Para" id="Par45"><span id="ITerm51">Amazon EC2</span><span id="ITerm52"></span> is a web service that provides secure, resizable compute capacity in the cloud. You will use the T2 instance in a later example. T2 instances are a low-cost, general-purpose instance types that provide a baseline level of CPU performance with the ability to burst above the baseline when needed. T2 instances are one of the lowest-cost Amazon EC2 instance options and are ideal for a variety of general-purpose applications like microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec15">

          <h3 class="Heading">Route Tables</h3>

          <p class="Para" id="Par46">A <span id="ITerm53">route table</span><span id="ITerm54"></span> contains a set of rules, called <em class="EmphasisTypeItalic ">routes</em>, that determine where network traffic from your subnet or gateway is directed.</p>

          <p class="Para" id="Par47">The <em class="EmphasisTypeItalic ">Main</em> route <span id="ITerm55">table</span> automatically comes with your VPC, and it is an implicit route table. It controls the routing for all subnets that are not explicitly associated with any other route table.</p>

          <p class="Para" id="Par48">Each subnet in your VPC must be associated with a route table, which controls the routing for the subnet (the subnet route table).</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec16">

          <h3 class="Heading">Internet Gateway</h3>

          <p class="Para" id="Par49">An <span id="ITerm56">Internet Gateway (IGW)</span><span id="ITerm57"></span> enables your instances to connect to the Internet through the Amazon EC2 network edge. The IGW will translate the public IP addresses of your virtual machines to their private IP addresses using <span id="ITerm58">network address translation (NAT)</span>. All public IP addresses used in the VPC are controlled by this IGW.</p>

          <p class="Para" id="Par50">These AWS services are just representative, not exhaustive. Detailed discussions on these or discussions on more services are beyond the scope of this book.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec17">

        <h2 class="Heading">Infrastructure as Code (IaC)</h2>

        <p class="Para" id="Par51"><span id="ITerm59">Infrastructure as Code (IaC)</span> is where you write and execute code to define, deploy, update, and destroy your infrastructure. Typically, you have been automating infrastructure management using ad hoc scripts, such as .<span class="EmphasisFontCategoryNonProportional ">sh</span> bash <span id="ITerm60">scripts</span>. Such <span id="ITerm61">ad hoc scripts</span> provide a general-purpose tool-based approach, so you need to write complete custom code for every task. But specific and purpose-built tools for IaC provide concise APIs for accomplishing complicated tasks, thus enforcing a particular structure for your code. <span id="ITerm62">Ad hoc scripts</span> are great for small, one-off tasks but when it comes to infrastructures involving multiple moving parts, especially when you want to take care of a number of microservices, bash scripts become a mess of unmaintainable spaghetti. This is where the <span id="ITerm63">IaC</span> tools come to your help.</p>

        <div class="Para" id="Par52">Let’s look at a few <span id="ITerm64">benefits</span> of IaC:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par53"><span id="ITerm65">Self-service</span>: Since you are reading this book, most probably your role in your daily job is that of an application developer, not a system administrator. However, there could be times when you need to have an infrastructure to deploy and test your application components. In my years of experience, I have seen a few system administrators serving the entire big team or the entire organization. Then how do you, as a developer, get an infrastructure in time? If your infrastructure is defined in code, the infrastructure deployment process can be automated, and you can kick off your own deployments to provision the infrastructure whenever necessary.</p></li><li><p class="Para" id="Par54">Version <span id="ITerm66">control</span>: When you have your infrastructure provisioning as code, you can store the IaC in version control so that the entire history of your infrastructure is captured in the commit log. This means, when problems occur and you suspect this is due to changes in your infrastructure, you can simply revert to your previous, known-good version of your provisioning code.</p></li></ul></div></div>

        <p class="Para" id="Par55">The next section looks at one of the tools in the IaC space—Terraform.</p>

        <section class="Section2 RenderAsSection2" id="Sec18">

          <h3 class="Heading">Terraform</h3>

          <p class="Para" id="Par56"><span id="ITerm67">Terraform</span><span id="ITerm68"></span> is an open source IaC tool created by HashiCorp. Terraform is written in the Go language. Terraform can use the authentication mechanism you’re already using with cloud service providers like AWS, Azure, Google Cloud, and so on, and then make API calls. You need to create Terraform configurations, which are text files that specify the infrastructure you want to create.</p>

          <p class="Para" id="Par57">You can define your entire infrastructure, starting with Internet gateways, load balancers, VPCs, subnets, servers, and so on. You do this in Terraform configurations and commit those files to a version control system. You can then run <span class="EmphasisFontCategoryNonProportional ">terraform apply</span> to create your infrastructure on the target cloud. When you need to make some changes to your <span id="ITerm69">infrastructure</span><span id="ITerm70"></span>, you make those changes in the Terraform configuration files, validate those changes through code reviews and tests, commit the updated code to version control, and then run the <span class="EmphasisFontCategoryNonProportional ">terraform apply</span> command again. One aspect to note is that there is no straight way to deploy the same infrastructure in a different cloud provider using the same Terraform configuration, because the cloud providers don’t offer the same types of infrastructure.</p>

          <p class="Para" id="Par58">That’s a quick introduction to public cloud and IaC. The next section puts these <span id="ITerm71">learnings</span><span id="ITerm72"></span> into some code.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec19">

        <h2 class="Heading">Setting Up AWS EC2 Using Terraform</h2>

        <div class="Para" id="Par59">In this section, you use Terraform to create an EC2 compute infrastructure in AWS. I assume that you already have the following prerequisites in your <span id="ITerm73">development machine</span>:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par60">An AWS account that you know how to manage using the AWS web console</p></li><li><p class="Para" id="Par61">An AWS CLI (Command Line Interface) and terminal with secret keys to access the AWS account (optional)</p></li><li><p class="Para" id="Par62">A key pair to access your EC2 instances</p></li><li><p class="Para" id="Par63">Terraform</p></li></ul></div></div>

        <p class="Para" id="Par64">I don’t intend to cover those aspects in this book. If you aren’t familiar with these steps, refer to an appropriate book.<sup><a epub:type="noteref" href="#Fn2" id="Fn2_source" role="doc-noteref">2</a></sup> Appendix F also provides some guidance in using a few of these tools.</p>

        <p class="Para" id="Par66">The next sections use a few of the AWS infrastructure components already discussed for this demonstration.</p>

        <section class="Section2 RenderAsSection2" id="Sec20">

          <h3 class="Heading">Design a Mini Data Center in the Cloud</h3>

          <div class="Para" id="Par67">You will have a very minimal Compute <span id="ITerm74">module</span> in AWS Cloud. Even though the intention is to set up a minimal Compute infrastructure, note that you need a full set of Compute and Network infrastructures for this, which is not trivial. Thanks to Terraform, it will make even such non-trivial tasks accessible to developers like you and me. Figure <span class="InternalRef"><a href="#Fig5">14-5</a></span> shows the targeted Compute module in AWS Cloud.<figure class="Figure" id="Fig5"><div class="MediaObject" id="MO5"><img alt="" aria-describedby="d64e894" src="../images/619782_1_En_14_Chapter/Imagem-143.jpg" style="width:35.15em"/><div class="TextObject" id="d64e894"><p class="Para" id="Par132">A layered block diagram has the following flow, internet, internet gateway under A W S cloud and region, router and route table under V P C, and security group of E C 2 and T 2 under subnet from the outermost to the innermost layer.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-5</span><p class="SimplePara">A mini data center in AWS <span id="ITerm75">Cloud</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par68">The next section gets into the code. It starts by investigating the project structure.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec21">

          <h3 class="Heading">Code Organization</h3>

          <div class="Para" id="Par69">The source <span id="ITerm76">code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span><span class="EmphasisFontCategoryNonProportional ">.</span> The source code for this example is organized as shown in Listing <span class="InternalRef"><a href="#PC1">14-1</a></span>, inside the <span class="EmphasisFontCategoryNonProportional ">ch14\ch14-01</span> folder.<div class="ProgramCode" id="PC1"><div class="LineGroup"><div class="FixedLine">./ch14-01/</div><div class="FixedLine">├── README.txt</div><div class="FixedLine">├── connections.tf</div><div class="FixedLine">├── gateways.tf</div><div class="FixedLine">├── network.tf</div><div class="FixedLine">├── security.tf</div><div class="FixedLine">├── servers.tf</div><div class="FixedLine">├── subnets.tf</div><div class="FixedLine">└── variables.tf</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-1</span><p class="SimplePara"><span id="ITerm77">Terraform EC2 Project Source Code Organization</span></p></div></div></div></div>

          <p class="Para" id="Par70">You can guess what many of these <span id="ITerm78">Terraform</span> files are intended to do from the name of the files, but the next section also covers them.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec22">

          <h3 class="Heading">Understanding the Source Code</h3>

          <div class="Para" id="Par71">This section starts from the first <span id="ITerm79">step</span> of selecting which cloud provider to use and in which geography. See Listing <span class="InternalRef"><a href="#PC2">14-2</a></span>.<div class="ProgramCode" id="PC2"><div class="LineGroup"><div class="FixedLine">provider "aws" {</div><div class="FixedLine">  region = "ap-southeast-1"</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-2</span><p class="SimplePara"><span id="ITerm80">AWS Region Configuration</span> (ch14/ch14-01/connections.tf)</p></div></div></div></div>

          <p class="Para" id="Par72">As mentioned, Terraform helps you manage IT infrastructure across a variety of <span id="ITerm81">public cloud providers</span> (e.g., Amazon Web Services, Microsoft Azure, DigitalOcean) and private cloud and virtualization platforms (e.g., OpenStack, VMware). In this example, it intends to use <span class="EmphasisFontCategoryNonProportional ">aws</span> as the cloud provider. I am using <span class="EmphasisFontCategoryNonProportional ">ap-southeast-1</span>, which is the Singapore region. You can use whichever region you prefer.</p>

          <div class="Para" id="Par73">The next step is to define the VPC, as shown in Listing <span class="InternalRef"><a href="#PC3">14-3</a></span>.<div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine">resource "aws_vpc" "test-env" {</div><div class="FixedLine">  cidr_block = "10.0.0.0/16"</div><div class="FixedLine">  enable_dns_hostnames = true</div><div class="FixedLine">  enable_dns_support = true</div><div class="FixedLine">  tags = {</div><div class="FixedLine">    Name = "bdca-Instance-03"</div><div class="FixedLine">  }</div><div class="FixedLine">}</div><div class="FixedLine">resource "aws_eip" "ip-test-env" {</div><div class="FixedLine">  instance = "${aws_instance.test-ec2-instance.id}"</div><div class="FixedLine">  domain   = "vpc"</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-3</span><p class="SimplePara"><span id="ITerm82">AWS VPC Configuration</span> (ch14/ch14-01/network.tf)</p></div></div></div></div>

          <p class="Para" id="Par74"><span id="ITerm83">Amazon Virtual Private Cloud (Amazon VPC)</span> allows you to launch AWS resources in a logically isolated virtual network. Your AWS account includes a default VPC in each AWS region. Your default VPCs are configured so that you can immediately start launching and connecting to EC2 instances; however, in the example you will be creating your own VPC called <span class="EmphasisFontCategoryNonProportional ">test-env</span><span id="ITerm84"></span>.</p>

          <div class="Para" id="Par75">While creating a VPC in AWS, the CIDR block is used to configure the expanse of your network. The <span id="ITerm85">IP CIDR block</span> gives the range of IP addresses to be allocated to this VPC. It has the format <span class="EmphasisFontCategoryNonProportional ">10.0.0.0/16</span>. The number after the slash <span class="EmphasisFontCategoryNonProportional ">/</span>, <span class="EmphasisFontCategoryNonProportional ">16</span>denotes that any IP address in the range of this CIDR block must consist of the first 16 bits exactly.<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par76">Since the first 16 bits must remain unchanged, it still has remained with 16 bits to take any value.</p></li><li><p class="Para" id="Par77">To understand this further, you can calculate the range of IP addresses in the provided CIDR block <span class="EmphasisFontCategoryNonProportional ">10.0.0.0/16</span>.</p></li></ul></div></div>

          <div class="Para" id="Par78">Remaining bits = 32 - the number after the <span class="EmphasisFontCategoryNonProportional ">/</span> in the <span class="EmphasisFontCategoryNonProportional ">cidr</span> prefix<div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine">= 32 - 16</div><div class="FixedLine">= 16</div></div></div></div>

          <div class="Para" id="Par79">The total number of IP addresses in the <span class="EmphasisFontCategoryNonProportional ">cidr</span> block:<div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">= 2 ^ remaining bits</div><div class="FixedLine">= 2 ^ 16</div><div class="FixedLine">= 65536</div></div></div></div>

          <p class="Para" id="Par80">This calculation is just for your information; a detailed discussion is beyond the scope of this book.</p>

          <p class="Para" id="Par81">The tag called <span class="EmphasisFontCategoryNonProportional ">Name = "bdca-Instance-03"</span> is added so you can identify the VPC.</p>

          <p class="Para" id="Par82"><span id="ITerm86">Elastic IP</span> is a static public IPv4 address, which is not free. You can attach an Elastic IP to the <span class="EmphasisFontCategoryNonProportional ">aws_instance.test-ec2-instance.id</span> instance, which you will see subsequently.</p>

          <div class="Para" id="Par83">Next, you create a subnet. See Listing <span class="InternalRef"><a href="#PC6">14-4</a></span>.<div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">resource "aws_subnet" "subnet-uno" {</div><div class="FixedLine">  cidr_block = "${cidrsubnet(aws_vpc.test-env.cidr_block, 3, 1)}"</div><div class="FixedLine">  vpc_id = "${aws_vpc.test-env.id}"</div><div class="FixedLine">  availability_zone = "ap-southeast-1a"</div><div class="FixedLine">}</div><div class="FixedLine">resource "aws_route_table" "route-table-test-env" {</div><div class="FixedLine">  vpc_id = "${aws_vpc.test-env.id}"</div><div class="FixedLine">route {</div><div class="FixedLine">    cidr_block = "0.0.0.0/0"</div><div class="FixedLine">    gateway_id = "${aws_internet_gateway.test-env-gw.id}"</div><div class="FixedLine">  }</div><div class="FixedLine">tags = {</div><div class="FixedLine">    Name = "test-env-route-table"</div><div class="FixedLine">  }</div><div class="FixedLine">}</div><div class="FixedLine">resource "aws_route_table_association" "subnet-association" {</div><div class="FixedLine">  subnet_id      = "${aws_subnet.subnet-uno.id}"</div><div class="FixedLine">  route_table_id = "${aws_route_table.route-table-test-env.id}"</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-4</span><p class="SimplePara"><span id="ITerm87">AWS Subnet Configuration</span> (ch14/ch14-01/subnets.tf)</p></div></div></div></div>

          <p class="Para" id="Par84">This subnet part also introduces an important feature in Terraform, showing how it references other existing resources by name. Note how the <span class="EmphasisFontCategoryNonProportional ">vpc_id</span> is defined. It refers to an existing resources attribute (the <span class="EmphasisFontCategoryNonProportional ">id</span>), referencing its full terraform name <span class="EmphasisFontCategoryNonProportional ">aws_vpc.test-env.id</span>, which was defined in the previous step.</p>

          <div class="Para" id="Par85">To calculate the subnet address in a given IP network address prefix, you must use the <span class="EmphasisFontCategoryNonProportional ">cidrsubnet</span> <span id="ITerm88">function</span> provided by Terraform, which requires three arguments:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par86"><span id="ITerm89">CIDR prefix</span>: This should be in a CIDR notation, as defined in RFC 4632 Section 3.1, and here you refer to the CIDR of the VPC of which the subnet should be part</p></li><li><p class="Para" id="Par87"><span id="ITerm90"><span class="EmphasisFontCategoryNonProportional ">newbits</span></span>: The CIDR prefix will get extended by this many bits. If the CIDR prefix ends with <span class="EmphasisFontCategoryNonProportional ">/16</span> and the <span class="EmphasisFontCategoryNonProportional ">newbits</span> provided is <span class="EmphasisFontCategoryNonProportional ">4</span>, the CIDR prefix is extended to <span class="EmphasisFontCategoryNonProportional ">/20</span>. (Adding four bits to the 16 bits provided in the CIDR prefix.)</p></li><li><p class="Para" id="Par88"><span id="ITerm91"><span class="EmphasisFontCategoryNonProportional ">netnum</span></span>: Used to populate the additional bits in the prefix. This whole number value cannot contain bits greater than the <span class="EmphasisFontCategoryNonProportional ">newbits</span> provided.</p></li></ul></div></div>

          <div class="Para" id="Par89">To know what value it will finally have, you can use the Terraform console utility. From your development machine terminal, first connect to the Terraform console, and then execute the function, as shown in Listing <span class="InternalRef"><a href="#PC7">14-5</a></span>.<div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:~ binil$ terraform console</div><div class="FixedLine">&gt; cidrsubnet("10.0.0.0/16", 3, 1)</div><div class="FixedLine">"10.0.32.0/19"</div><div class="FixedLine">&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-5</span><p class="SimplePara"><span id="ITerm92">Terraform cidrsubnet Function</span></p></div></div></div></div>

          <p class="Para" id="Par90">Let’s investigate the routing next.</p>

          <p class="Para" id="Par91">Terraform currently provides both a standalone route resource and a route table resource with routes defined inline. You cannot use both methods for the same table. In other words, if you create routes in the <span class="EmphasisFontCategoryNonProportional ">aws_route_table</span>, you cannot associate routes created with <span class="EmphasisFontCategoryNonProportional ">aws_route.</span></p>

          <p class="Para" id="Par92"><span id="ITerm93"><span class="EmphasisFontCategoryNonProportional ">aws_route_table_association</span></span> ties the routing table to your subnet.</p>

          <p class="Para" id="Par93">The resource <span class="EmphasisFontCategoryNonProportional ">aws_route_table route-table-test-env</span> block creates a new route table in the VPC specified by the <span class="EmphasisFontCategoryNonProportional ">vpc_id</span> attribute <span class="EmphasisFontCategoryNonProportional ">aws_vpc.test-env.id</span>. It also defines a route that sends all traffic with destination CIDR <span class="EmphasisFontCategoryNonProportional ">0.0.0.0/0</span> to the Internet gateway specified by the <span class="EmphasisFontCategoryNonProportional ">gateway_id = "${aws_internet_gateway.test-env-gw.id}</span> attribute. The <span class="EmphasisFontCategoryNonProportional ">tags</span> attribute sets a <span class="EmphasisFontCategoryNonProportional ">test-env-route-table</span> name for the route table for easy identification.</p>

          <p class="Para" id="Par94">The <span class="EmphasisFontCategoryNonProportional ">aws_route_table_association</span> block associates the newly created route table with a <span class="EmphasisFontCategoryNonProportional ">subnet_id = "${aws_subnet.subnet-uno.id}"</span> subnet. The <span class="EmphasisFontCategoryNonProportional ">route_table_id</span> attribute refers to the ID of the route table created in the previous block.</p>

          <div class="Para" id="Par95">Listing <span class="InternalRef"><a href="#PC8">14-6</a></span> looks at the <span class="EmphasisFontCategoryNonProportional ">test-env-gw</span> referred to in the previous route.<div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine">resource "aws_internet_gateway" "test-env-gw" {</div><div class="FixedLine">  vpc_id = "${aws_vpc.test-env.id}"</div><div class="FixedLine">tags = {</div><div class="FixedLine">    Name = "test-env-gw"</div><div class="FixedLine">  }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-6</span><p class="SimplePara"><span id="ITerm94">AWS Internet Gateway Configuration</span> (ch14/ch14-01/gateways.tf)</p></div></div></div></div>

          <p class="Para" id="Par96">Attaching this Internet gateway will allow public traffic to come through to the subnet.</p>

          <div class="Para" id="Par97">AWS by default will allow all traffic outside, but when you use Terraform, this is disabled and therefore has to be explicitly stated to allow traffic. To do that, you need to first create a security group to suit your needs. See Listing <span class="InternalRef"><a href="#PC9">14-7</a></span>.<div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine">resource "aws_security_group" "ingress-all-test" {</div><div class="FixedLine">name = "allow-all-sg"</div><div class="FixedLine">vpc_id = "${aws_vpc.test-env.id}"</div><div class="FixedLine">ingress {</div><div class="FixedLine">    cidr_blocks = [</div><div class="FixedLine">      "0.0.0.0/0"</div><div class="FixedLine">    ]</div><div class="FixedLine">    from_port = 22</div><div class="FixedLine">    to_port = 22</div><div class="FixedLine">    protocol = "tcp"</div><div class="FixedLine">  }</div><div class="FixedLine">ingress {</div><div class="FixedLine">    cidr_blocks = [</div><div class="FixedLine">      "0.0.0.0/0"</div><div class="FixedLine">    ]</div><div class="FixedLine">    from_port = 8080</div><div class="FixedLine">    to_port = 8080</div><div class="FixedLine">    protocol = "tcp"</div><div class="FixedLine">  }</div><div class="FixedLine">  egress {</div><div class="FixedLine">   from_port = 0</div><div class="FixedLine">   to_port = 0</div><div class="FixedLine">   protocol = "-1"</div><div class="FixedLine">   cidr_blocks = ["0.0.0.0/0"]</div><div class="FixedLine"> }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-7</span><p class="SimplePara"><span id="ITerm95">AWS Security Group Configuration</span> (ch14/ch14-01/security.tf)</p></div></div></div></div>

          <p class="Para" id="Par98">When you create VPC, it automatically comes with a default security group. Each <span id="ITerm96">EC2 instance</span> that you launch in your VPC is automatically associated with the default security group if you don’t specify a different security group when you launch the instance.</p>

          <p class="Para" id="Par99">A <span id="ITerm97">security group</span> acts as a virtual firewall for your instance to control inbound and outbound traffic. Security groups act at the instance level, not at the subnet level. Therefore, each instance in a subnet in your VPC can be assigned to a different set of security groups. If you don’t specify a particular group at launch time, the instance is automatically assigned to the default security group for the VPC.</p>

          <p class="Para" id="Par100">For each security group, you add rules that control the inbound traffic to instances, and a separate set of rules that control the outbound traffic. The default route in <span id="ITerm98">Internet Protocol Version 4 (IPv4)</span> is designated as the zero-address <span class="EmphasisFontCategoryNonProportional ">0.0.0.0/0</span> in CIDR notation, often called the <span id="ITerm99"><em class="EmphasisTypeItalic ">quad-zero route</em></span><em class="EmphasisTypeItalic ">.</em> The subnet mask is given as <span class="EmphasisFontCategoryNonProportional ">/0</span>, which effectively specifies all networks. <span class="EmphasisFontCategoryNonProportional ">0.0.0.0/0,::/0</span>. This means the source can be any IP address, from any system request. <span class="EmphasisFontCategoryNonProportional ">0.0.0.0/0</span> represents IPv4 and <span class="EmphasisFontCategoryNonProportional ">::/0</span> represents IPv6.</p>

          <p class="Para" id="Par101">The <span id="ITerm100"><span class="EmphasisFontCategoryNonProportional ">ingress-all-test</span></span> you defined allows anyone to connect through port 22. It will also forward all traffic without restriction. Using <span class="EmphasisFontCategoryNonProportional ">vpc_id = "${aws_vpc.test-env.id}"</span> you can attach it to the VPC you created. The <span class="EmphasisFontCategoryNonProportional ">ingress</span> block describes how incoming traffic will be treated. This example defined a rule to accept connections from all IPs on port <span class="EmphasisFontCategoryNonProportional ">22</span>. The <span class="EmphasisFontCategoryNonProportional ">egress</span> block defines the rule for outgoing traffic and this example defined it to allow all.</p>

          <div class="Para" id="Par102">As a final step, you need to define EC2 instances, which are the actual compute module where you want the AWS Cloud to expend computing to crunch the workload. See Listing <span class="InternalRef"><a href="#PC10">14-8</a></span>.<div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">resource "aws_instance" "test-ec2-instance" {</div><div class="FixedLine">  ami = "${var.ami_id}"</div><div class="FixedLine">  instance_type = "t2.micro"</div><div class="FixedLine">  key_name = "${var.ami_key_pair_name}"</div><div class="FixedLine">  security_groups = ["${aws_security_group.ingress-all-test.id}"]</div><div class="FixedLine">tags = {</div><div class="FixedLine">    Name = "${var.ami_name}"</div><div class="FixedLine">  }</div><div class="FixedLine">subnet_id = "${aws_subnet.subnet-uno.id}"</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-8</span><p class="SimplePara"><span id="ITerm101">AWS EC2 Configuration</span> (ch14/ch14-01/servers.tf)</p></div></div></div></div>

          <div class="Para" id="Par103">This code requests an AWS instance of <span class="EmphasisFontCategoryNonProportional ">t2.micro</span>. You then do the security group and subnet associations. One thing you want to note is that we are using variables in three places—for <span class="EmphasisFontCategoryNonProportional ">ami_id</span>, <span class="EmphasisFontCategoryNonProportional ">ami_key_pair_name</span>, and <span class="EmphasisFontCategoryNonProportional ">ami_name</span>. The values come from a few variables defined in another file. See Listing <span class="InternalRef"><a href="#PC11">14-9</a></span>.<div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">variable "ami_name" {}</div><div class="FixedLine">variable "ami_id" {}</div><div class="FixedLine">variable "ami_key_pair_name" {}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-9</span><p class="SimplePara"><span id="ITerm102">Terraform Variables Configuration</span> (ch14/ch14-01/variables.tf)</p></div></div></div></div>

          <p class="Para" id="Par104">These variables are defined for convenience so that the entire <span id="ITerm103">Terraform plan</span> can be used as a template to launch multiple instances if required, providing the option for those variables to take different values. Since you keep the variables empty as shown, Terraform will prompt for them to be given in the terminal as input during Terraform plan execution. The <span class="EmphasisFontCategoryNonProportional ">ami_name</span> variable will be used as a tag and the <span class="EmphasisFontCategoryNonProportional ">ami_id</span> variable is used to find the instance to be launched.</p>

          <p class="Para" id="Par105">You now have almost everything completed, so it’s time to spin up the servers in the cloud.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec23">

          <h3 class="Heading">Build and Spin EC2 Server in the Cloud</h3>

          <div class="Para" id="Par106">Go to the <span class="EmphasisFontCategoryNonProportional ">ch14\ch14-01</span> root folder and <span id="ITerm104">run</span> the <span class="EmphasisFontCategoryNonProportional ">terraform init</span> <span id="ITerm105">command</span>, as shown in Listing <span class="InternalRef"><a href="#PC12">14-10</a></span>.<div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch14-01 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch14/ch14-01</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch14-01-temp binil$ terraform init</div></div><div class="LineGroup"><div class="FixedLine">Initializing the backend...</div></div><div class="LineGroup"><div class="FixedLine">Initializing provider plugins...</div><div class="FixedLine">- Finding latest version of hashicorp/aws...</div><div class="FixedLine">- Installing hashicorp/aws v5.1.0...</div><div class="FixedLine">- Installed hashicorp/aws v5.1.0 (signed by HashiCorp)</div></div><div class="LineGroup"><div class="FixedLine">Terraform has created a lock file .terraform.lock.hcl to record the provider</div><div class="FixedLine">selections it made above. Include this file in your version control repository</div><div class="FixedLine">so that Terraform can guarantee to make the same selections by default when</div><div class="FixedLine">you run "terraform init" in the future.</div></div><div class="LineGroup"><div class="FixedLine">Terraform has been successfully initialized!</div></div><div class="LineGroup"><div class="FixedLine">You may now begin working with Terraform. Try running "terraform plan" to see</div><div class="FixedLine">any changes that are required for your infrastructure. All Terraform commands</div><div class="FixedLine">should now work.</div></div><div class="LineGroup"><div class="FixedLine">If you ever set or change modules or backend configuration for Terraform,</div><div class="FixedLine">rerun this command to reinitialize your working directory. If you forget, other</div><div class="FixedLine">commands will detect it and remind you to do so if necessary.</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch14-01-temp binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-10</span><p class="SimplePara">Terraform <span id="ITerm106">init</span></p></div></div></div></div>

          <p class="Para" id="Par107">The <span id="ITerm107">Terraform binary</span> installed in your machine only contains the basic functionality for Terraform; it does not come with the code for any of the providers (e.g., the AWS Provider, Azure provider, GCP provider, etc.). When you use Terraform the first time, you need to run <span class="EmphasisFontCategoryNonProportional ">terraform init</span><span id="ITerm108"></span> to tell Terraform to inspect the code, determine which providers you’re using, and download the code for them—in this case, it is AWS. This provider code is downloaded into a <span class="EmphasisFontCategoryNonProportional ">terraform</span> folder, which is <span id="ITerm109">Terraform’s scratch directory</span>. Terraform will also record information about the provider code it downloaded into a .<span class="EmphasisFontCategoryNonProportional ">terraform.lock.hcl</span> <span id="ITerm110">file</span>.</p>

          <div class="Para" id="Par108">You can now sanity check your code, as shown in Listing <span class="InternalRef"><a href="#PC13">14-11</a></span>.<div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch14-01 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch14/ch14-01</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch14-01-temp binil$ terraform validate</div><div class="FixedLine">Success! The configuration is valid.</div></div><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch14-01-temp binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-11</span><p class="SimplePara">Validate Terraform Scripts</p></div></div></div></div>

          <div class="Para" id="Par109">The <span class="EmphasisFontCategoryNonProportional ">plan</span> command lets you see what Terraform will do before making any changes. Next, you can validate the <span id="ITerm111">Terraform plan</span>, as shown in Listing <span class="InternalRef"><a href="#PC14">14-12</a></span>.<div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch14-01-temp binil$ terraform plan</div><div class="FixedLine">var.ami_id</div><div class="FixedLine">  Enter a value: ami-061058b2c8f7fb264</div></div><div class="LineGroup"><div class="FixedLine">var.ami_key_pair_name</div><div class="FixedLine">  Enter a value: bdca-key-01</div></div><div class="LineGroup"><div class="FixedLine">var.ami_name</div><div class="FixedLine">  Enter a value: bdca-Instance-03</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-12</span><p class="SimplePara"><span id="ITerm112">Terraform Plan</span></p></div></div></div></div>

          <div class="Para" id="Par110">This is a nice way to sanity-check your code before attempting to create the actual infrastructure. Next you can go about applying the scripts. The <span class="EmphasisFontCategoryNonProportional ">apply</span> command shows you the same plan output and asks you to confirm whether you want to proceed with this plan. See Listing <span class="InternalRef"><a href="#PC15">14-13</a></span>.<div class="ProgramCode" id="PC15"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:005-aws-ec2-ssh binil$ terraform apply</div><div class="FixedLine">var.ami_id</div><div class="FixedLine">  Enter a value: ami-061058b2c8f7fb264</div></div><div class="LineGroup"><div class="FixedLine">var.ami_key_pair_name</div><div class="FixedLine">  Enter a value: bdca-key-01</div></div><div class="LineGroup"><div class="FixedLine">var.ami_name</div><div class="FixedLine">  Enter a value: bdca-Instance-03</div><div class="FixedLine">...</div><div class="FixedLine">Apply complete! Resources: 8 added, 0 changed, 0 destroyed.</div><div class="FixedLine">(base) binildass-MacBook-Pro:005-aws-ec2-ssh binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-13</span><p class="SimplePara"><span id="ITerm113">Terraform Apply</span></p></div></div></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec24">

          <h3 class="Heading">Accessing Your EC2 in AWS Cloud Using SSH</h3>

          <p class="Para" id="Par111">Once your Compute infrastructure is created in AWS, you can access it using <span id="ITerm114">SSH</span>. You can log in to the AWS console and inspect the newly created EC2 instance and get the public IP of it. Further, this example assumes that you have created a key pair in the Amazon EC2 console for the region where you plan to receive data.</p>

          <div class="Para" id="Par112">If you plan to use an SSH client on a macOS or Linux computer to connect to your cloud instance, use the commands in Listing <span class="InternalRef"><a href="#PC16">14-14</a></span> to set the permissions of your <span id="ITerm115">private</span> key file and then <span class="EmphasisFontCategoryNonProportional ">ssh</span> to the instance.<div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:AWS binil$ ls</div><div class="FixedLine">BDCA-01.pem    bdca-key-01.pem</div><div class="FixedLine">(base) binildass-MacBook-Pro:AWS binil$ chmod 600 ./bdca-key-01.pem</div><div class="FixedLine">(base) binildass-MacBook-Pro:001-aws-ec2-ssh-http binil$ ssh -i "/Users/binil/AWS/bdca-key-01.pem" ubuntu@ec2-13-228-93-93.ap-southeast-1.compute.amazonaws.com</div><div class="FixedLine">The authenticity of host 'ec2-13-228-93-93.ap-southeast-1.compute.amazonaws.com (13.228.93.93)' can't be established.</div><div class="FixedLine">ECDSA key fingerprint is SHA256:TK4sg3Pw8w1crRgI/KebZJ///AavY8uSnKwZmFzqTJw.</div><div class="FixedLine">Are you sure you want to continue connecting (yes/no)? yes</div><div class="FixedLine">Warning: Permanently added 'ec2-13-228-93-93.ap-southeast-1.compute.amazonaws.com,13.228.93.93' (ECDSA) to the list of known hosts.</div><div class="FixedLine">Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-1114-aws x86_64)</div><div class="FixedLine">...</div><div class="FixedLine">ubuntu@ip-10-0-53-123:~$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-14</span><p class="SimplePara"><span id="ITerm116">Accessing AWS Cloud EC2 Using SSH</span></p></div></div></div></div>

          <div class="Para" id="Par113">You can next inspect if you have Java <span id="ITerm117">runtime</span> in your EC2 instance, as shown in Listing <span class="InternalRef"><a href="#PC17">14-15</a></span>.<div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine">ubuntu@ip-10-0-53-123:~$ java -version</div><div class="FixedLine">java version "1.8.0_161"</div><div class="FixedLine">Java(TM) SE Runtime Environment (build 1.8.0_161-b12)</div><div class="FixedLine">Java HotSpot(TM) 64-Bit Server VM (build 25.161-b12, mixed mode)</div><div class="FixedLine">ubuntu@ip-10-0-53-123:~$ pwd</div><div class="FixedLine">/home/ubuntu</div><div class="FixedLine">ubuntu@ip-10-0-53-123:~$ ls</div><div class="FixedLine">Nessus-7.0.2-ubuntu1110_amd64.deb</div><div class="FixedLine">ubuntu@ip-10-0-53-123:~$</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-15</span><p class="SimplePara">Verifying Java Runtime in Your AWS Cloud EC2</p></div></div></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec25">

          <h3 class="Heading">Installing JRE in AWS EC2</h3>

          <div class="Para" id="Par114">If you don’t have <span id="ITerm118">Java</span> by default, you can install it. Before that, update the software. Use the <span class="EmphasisFontCategoryNonProportional ">sudo apt update</span> command, which is a Linux/Debian system administration command that updates the list of available packages and their versions stored in the system’s package index. See Listing <span class="InternalRef"><a href="#PC18">14-16</a></span>.<div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine">ubuntu@ip-10-0-53-123:~$ sudo apt update</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-16</span><p class="SimplePara">Updating AWS Cloud EC2 packages</p></div></div></div></div>

          <div class="Para" id="Par115">Then install Java, as shown in Listing <span class="InternalRef"><a href="#PC19">14-17</a></span>.<div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine">ubuntu@ip-10-0-53-123:~$ java -version</div><div class="FixedLine">Command ‘Java’ not found, but can be installed with:</div><div class="FixedLine">sudo apt install openjdk-11-jre-headless</div><div class="FixedLine">sudo apt install default-jre</div><div class="FixedLine">sudo apt install openjdk-17-jre-headless</div><div class="FixedLine">sudo apt install openjdk-18-jre-headless</div><div class="FixedLine">sudo apt install openjdk-19-jre-headless</div><div class="FixedLine">sudo apt install openjdk-8-jre-headless</div><div class="FixedLine">ubuntu@ip-10-0-53-123:~$ sudo apt install openjdk-17-jre-headless</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-17</span><p class="SimplePara"><span id="ITerm119">Installing JRE in AWS Cloud EC2</span></p></div></div></div></div>

          <p class="Para" id="Par116">Now that you have <span id="ITerm120">successfully</span> accessed the new server that you provisioned and set up with JRE in AWS Cloud, you can deploy your microservice in the cloud.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec26">

        <h2 class="Heading">Deploying Microservice in AWS EC2</h2>

        <div class="Para" id="Par117">This example uses the simplest microservice in this book, found in <span class="EmphasisFontCategoryNonProportional ">ch01/ch01-01/</span>. Assuming that you built the microservice as shown in Listing <span class="InternalRef"><a href="#PC20">14-18</a></span> and the .<span class="EmphasisFontCategoryNonProportional ">jar</span> file <span class="EmphasisFontCategoryNonProportional ">Ecom-Product-Web-Microservice-0.0.1-SNAPSHOT.jar</span> is available in the <span class="EmphasisFontCategoryNonProportional ">ch01/ch01-01/target</span> folder, you need to first upload this .<span class="EmphasisFontCategoryNonProportional ">jar</span> file to the EC2 in AWS Cloud using the <span class="EmphasisFontCategoryNonProportional ">secure copy</span> <span id="ITerm121">command</span>.<div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">mvn -Dmaven.test.skip=true clean package</div><div class="FixedLine">java -jar -Dserver.port=8080 ./02-ProductWeb/target/Ecom-Product-Web-Microservice-0.0.1-SNAPSHOT.jar</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-18</span><p class="SimplePara">Commands to Build the Microservice (from Listing <span class="ExternalRef"><a href="Capítulo-03.html#PC5"><span class="RefSource">1-5</span></a></span>)</p></div></div></div></div>

        <p class="Para" id="Par118">The next step is to copy the .<span class="EmphasisFontCategoryNonProportional ">jar</span> file to the cloud.</p>

        <section class="Section2 RenderAsSection2" id="Sec27">

          <h3 class="Heading">Copy the Microservice Executable to the Cloud</h3>

          <div class="Para" id="Par119">You will now copy the microservice .<span class="EmphasisFontCategoryNonProportional ">jar</span> <span id="ITerm122">file</span><span id="ITerm123"></span> from your localhost to the AWS EC2 instance, as shown in Listing <span class="InternalRef"><a href="#PC21">14-19</a></span>.<div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:target binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch01/ch01-01/target</div><div class="FixedLine">(base) binildass-MacBook-Pro:target binil$ scp -i "/Users/binil/AWS/bdca-key-01.pem" /Users/binil/binil/code/mac/mybooks/docker-03/ch01/ch01-01/02-ProductWeb/target/Ecom-Product-Web-Microservice-0.0.1-SNAPSHOT.jar ubuntu@ec2-13-228-93-93.ap-southeast-1.compute.amazonaws.com:/home/ubuntu/</div><div class="FixedLine">Ecom-Product-Web-Microservice-0.0.1-SNAPSHOT.jar                  100%   20MB   1.6MB/s   00:12</div><div class="FixedLine">(base) binildass-MacBook-Pro:target binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-19</span><p class="SimplePara">Upload Microservice Jar File to the Cloud EC2 Using scp</p></div></div></div></div>

          <p class="Para" id="Par120">Once the microservice .<span class="EmphasisFontCategoryNonProportional ">jar</span> <span id="ITerm124">file</span><span id="ITerm125"></span> is copied to the cloud, you can run the Microservice.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec28">

          <h3 class="Heading">Run the Microservice</h3>

          <div class="Para" id="Par121">Since you have the microservice .<span class="EmphasisFontCategoryNonProportional ">jar</span> <span id="ITerm126">file</span>, you can use Java to run the application. See Listing <span class="InternalRef"><a href="#PC22">14-20</a></span>.<div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">ubuntu@ip-10-0-53-123:~$ pwd</div><div class="FixedLine">/home/ubuntu</div><div class="FixedLine">ubuntu@ip-10-0-53-123:~$ ls</div><div class="FixedLine">Ecom-Product-Web-Microservice-0.0.1-SNAPSHOT.jar  Nessus-7.0.2-ubuntu1110_amd64.deb</div><div class="FixedLine">ubuntu@ip-10-0-53-123:~$ java -jar -Dserver.port=8080 ./Ecom-Product-Web-Microservice-0.0.1-SNAPSHOT.jar</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2021-07-03 00:38:41 INFO  StartupInfoLogger.logStarting:55 - Starting EcomProductMicroserviceApplication v0.0.1-SNAPSHOT using Java 1.8.0_161 on ip-10-0-53-123 with PID 4892 (/home/ubuntu/Ecom-Product-Web-Microservice-0.0.1-SNAPSHOT.jar started by ubuntu in /home/ubuntu)</div><div class="FixedLine">2021-07-03 00:38:41 DEBUG StartupInfoLogger.logStarting:56 - Running with Spring Boot v2.4.4, Spring v5.3.5</div><div class="FixedLine">2021-07-03 00:38:41 INFO  SpringApplication.logStartupProfileInfo:662 - No active profile set, falling back to default profiles: default</div><div class="FixedLine">2021-07-03 00:38:46 INFO  InitializationComponent.init:58 - Start</div><div class="FixedLine">2021-07-03 00:38:46 DEBUG InitializationComponent.init:60 - Doing Nothing...</div><div class="FixedLine">2021-07-03 00:38:46 INFO  InitializationComponent.init:62 - End</div><div class="FixedLine">2021-07-03 00:38:49 INFO  StartupInfoLogger.logStarted:61 - Started EcomProductMicroserviceApplication in 9.914 seconds (JVM running for 12.273)</div><div class="FixedLine">2021-07-03 00:41:09 INFO  ProductRestController.getAllProducts:84 - Start</div><div class="FixedLine">2021-07-03 00:41:09 DEBUG ProductRestController.lambda$getAllProducts$0:94 - Product [productId=1, name=Kamsung D3, code=KAMSUNG-TRIOS, title=Kamsung Trios 12 inch , black , 12 px ...., description=, imgUrl=, price=12000.0, productCategoryName=]</div><div class="FixedLine">2021-07-03 00:41:09 DEBUG ProductRestController.lambda$getAllProducts$0:94 - Product [productId=2, name=Lokia Pomia, code=LOKIA-POMIA, title=Lokia 12 inch , white , 14px ...., description=, imgUrl=, price=9000.0, productCategoryName=]</div><div class="FixedLine">2021-07-03 00:41:09 INFO  ProductRestController.getAllProducts:95 – Ending</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-20</span><p class="SimplePara">Run the Microservice in EC2 in AWS</p></div></div></div></div>

          <p class="Para" id="Par122">You can see from the log that the application is built and deployed and is in the running state. You can now test the application.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec29">

          <h3 class="Heading">Test the Microservice Using UI</h3>

          <p class="Para" id="Par123">Once the <span id="ITerm127">microservice</span> is up, you can access the web application using your browser and pointing to the public URL of your EC2:</p>

          <p class="Para" id="Par124"><span class="ExternalRef"><a href="http://ec2-13-228-93-93.ap-southeast-1.compute.amazonaws.com:8080/product.html"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">http://ec2-13-228-93-93.ap-southeast-1.compute.amazonaws.com:8080/product.html</span></span></a></span></p>

          <p class="Para" id="Par125">Refer to the section titled “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the Product Web microservice.</p>

          <div class="Para" id="Par126">Once the testing is complete, you can destroy the cloud infrastructure using the <span class="EmphasisFontCategoryNonProportional ">terraform destroy</span> command, as shown in Listing <span class="InternalRef"><a href="#PC23">14-21</a></span>.<div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:ch14-01 binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch14/ch14-01</div><div class="FixedLine">(base) binildass-MacBook-Pro:ch14-01-temp binil$ terraform destroy</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-21</span><p class="SimplePara">Releasing AWS Resources</p></div></div></div></div>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec30">

        <h2 class="Heading">Summary</h2>

        <p class="Para" id="Par127">From the starting chapter of this book up to the previous chapter, you have traveled from the simplest of microservices to Docker containers and Kubernetes. You have seen multiple, non-trivial design patterns, including NoSQL and messaging brokers. In this chapter, you used IaC to provision an EC2 in AWS Cloud. You also deployed the microservice example from the first chapter in the EC2 and accessed it from your host machine through the Internet. This is a good start, and you can now try to deploy many of these examples from other chapters in the cloud. What is left is Containers and Orchestration in the cloud, which is covered in the next chapter.</p>

      </section>

      <aside aria-label="Footnotes" class="FootnoteSection" epub:type="footnotes">

        <div class="Heading">Footnotes</div>

        <div class="Footnote"><span class="FootnoteNumber"><a href="#Fn1_source">1</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn1" role="doc-footnote"><p class="Para" id="Par30">The author’s company IBS Software provides SaaS services to the airline passenger, cargo, and hospitality industries and the author has patented in-house multi-tenant frameworks from the USPTO on behalf of his company.</p></div><div class="ClearBoth"> </div></div>

        <div class="Footnote"><span class="FootnoteNumber"><a href="#Fn2_source">2</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn2" role="doc-footnote"><p class="Para" id="Par65"><em class="EmphasisTypeItalic ">Programming Amazon EC2,</em> O’Reilly Media; ISBN-13: 978-1449393687</p></div><div class="ClearBoth"> </div></div>

      </aside>

    </div>

  </div>

</body>

</html>