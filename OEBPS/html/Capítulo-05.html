<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en">

<head>
  <title>Onion and Hexagonal Architecture in Practice</title>
  <link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>

<body>

  <div epub:type="chapter" role="doc-chapter">

    <div class="ChapterContextInformation">

      <div class="ContextInformation" id="b979-8-8688-0555-4_3"><div class="ChapterCopyright">© The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature 2024</div><span class="ContextInformationAuthorEditorNames">B. A. Christudas</span><span class="ContextInformationBookTitles"><span class="BookTitle">Java Microservices and Containers in the Cloud</span></span><span class="ChapterDOI"><a href="https://doi.org/10.1007/979-8-8688-0555-4_3">https://doi.org/10.1007/979-8-8688-0555-4_3</a></span></div>

    </div>

    <!--Begin Abstract-->

    <div class="MainTitleSection">

      <h1 class="ChapterTitle" lang="en">3. Onion and Hexagonal Architecture in Practice</h1>

    </div>

    <div class="AuthorGroup">

      <div class="AuthorNames"><span class="Author"><span class="AuthorName">Binildas A. Christudas</span><sup><a href="#Aff2">1</a> <span class="ContactIcon"> </span></sup></span></div>

      <div class="Affiliations">

        <div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">NBCRA 45, Christbin, Thiruvananthapuram, Kerala, India</div></div>

        <div class="ClearBoth"> </div>

      </div>

    </div>

    <!--End Abstract-->

    <div class="Fulltext">

      <p class="Para" id="Par2">Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> introduced the hexagonal architecture. You also saw a few examples in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> and <span class="ExternalRef"><a href="Capítulo-05.html"><span class="RefSource">3</span></a></span> that explained how the concepts of abstract ports are realized by lightweight containers like Spring and Spring Boot to provide on-demand adapters at runtime. This chapter expands on those concepts by introducing the Onion <span id="ITerm1">architecture</span>, with more precise and concrete examples.</p>

      <div class="Para" id="Par3">This chapter covers the following concepts:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par4">Extends the notion of hexagonal architecture in microservices using Spring Boot and PostgreSQL.</p></li><li><p class="Para" id="Par5">Demonstrates hexagonal architecture in action, by plugging in MongoDB in place of PostgreSQL.</p></li><li><p class="Para" id="Par6">Introduces the concept of the Onion architecture.</p></li><li><p class="Para" id="Par7">Introduces GraphQL as a technology means to demonstrate the Onion architecture.</p></li><li><p class="Para" id="Par8">Demonstrates with example the complementary nature of the Hexagonal and Onion architectures.</p></li></ul></div></div>

      <section class="Section1 RenderAsSection1" id="Sec1">

        <h2 class="Heading">Microservices Using PostgreSQL and RestTemplate</h2>

        <p class="Para" id="Par9">In this section, you will tweak the first example of microservices you saw in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span>, but to connect to a PostgreSQL database instead of MongoDB. You will have the same two microservices—a consumer and a provider microservice—communicating with each other using the REST protocol. The provider microservice also interacts with a <span id="ITerm2">PostgreSQL</span>, instead of the MongoDB. Refer to Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span> for the overall design.</p>

        <section class="Section2 RenderAsSection2" id="Sec2">

          <h3 class="Heading">Design the Microservice</h3>

          <div class="Para" id="Par10">You will reuse the hexagonal microservice view shown in Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span>. There are a few <span id="ITerm3">differences</span> with this design, as follows:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par11">The Product Server microservice connects to a PostgreSQL database.</p></li><li><p class="Para" id="Par12">You’ll use Liquibase to initialize the PostgreSQL database.</p></li><li><p class="Para" id="Par13">The <span class="EmphasisFontCategoryNonProportional ">Product</span> entity is less verbose due to the use of the Lombok library.</p></li><li><p class="Para" id="Par14">You’ll use separate entity models—the <span class="EmphasisFontCategoryNonProportional ">ProductOR</span> for the Repository interactions and the <span class="EmphasisFontCategoryNonProportional ">Product</span> for the REST interface.</p></li><li><p class="Para" id="Par15">You’ll use the <span class="EmphasisFontCategoryNonProportional ">mapstruct</span> library to transform entities between the <span class="EmphasisFontCategoryNonProportional ">ProductOR</span> and <span class="EmphasisFontCategoryNonProportional ">Product</span> structures.</p></li></ul></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec3">

          <h3 class="Heading">Understanding the Code</h3>

          <div class="Para" id="Par16">The <span id="ITerm4">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch03\ch03-01</span> folder. You will look at the provider microservice—that is, the Product Server microservice—first. Listing <span class="InternalRef"><a href="#PC1">3-1</a></span> shows the changed repository used to interact with the PostgreSQL.
          
          <div class="ProgramCode" id="PC1"><div class="LineGroup"><div class="FixedLine">@RepositoryRestResource(collectionResourceRel = "productdata",</div><div class="FixedLine">    path = "productdata")</div><div class="FixedLine">public interface ProductRepository extends</div><div class="FixedLine">        CrudRepository&lt;ProductOR, Long&gt; {</div></div><div class="LineGroup"><div class="FixedLine">    public List&lt;ProductOR&gt; findByCode(@Param("code")</div><div class="FixedLine">        String  code);</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-1</span><p class="SimplePara">The Abstract Port for Product Server Microservice to Interact with PostgreSQL (ch03\ch03-02\01-ProductServer\src\main\java\com\acme\ecom\product\repository\ProductRepository.java)</p></div></div></div></div>

          <p class="Para" id="Par17">This port (interface) provides for generic <span id="ITerm5">CRUD operations</span> on a repository, a PostgreSQL in this case. Note that <span class="EmphasisFontCategoryNonProportional ">MongoRepository</span> interacts with MongoDB for all the examples in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span>. However, this example opts for a more generic type of <span class="EmphasisFontCategoryNonProportional ">MongoRepository</span> in the way of <span class="EmphasisFontCategoryNonProportional ">CrudRepository</span> . There is a reason for doing this. I want to demonstrate how a generic port (the driven port with <span class="EmphasisFontCategoryNonProportional ">CrudRepository</span>) can be adapted to connect to different kinds of databases—more specifically to a PostgreSQL database in this example and to a MongoDB database in the next example.</p>

          <div class="Para" id="Par18"><span class="EmphasisFontCategoryNonProportional ">CrudRepository</span> is a Spring Data interface for generic CRUD operations on a repository of a specific type. It provides several methods out-of-the-box to interact with a database. The specific adapter for this port, an adapter to a PostgreSQL database, is provided by Spring based on the configuration in <span class="EmphasisFontCategoryNonProportional ">pom.xml</span> (see Listing <span class="InternalRef"><a href="#PC2">3-2</a></span>).<div class="ProgramCode" id="PC2"><div class="LineGroup"><div class="FixedLine">&lt;dependencies&gt;</div><div class="FixedLine">    &lt;dependency&gt;</div><div class="FixedLine">        &lt;groupId&gt;org.postgresql&lt;/groupId&gt;</div><div class="FixedLine">        &lt;artifactId&gt;postgresql&lt;/artifactId&gt;</div><div class="FixedLine">        &lt;version&gt;42.2.19&lt;/version&gt;</div><div class="FixedLine">        &lt;scope&gt;runtime&lt;/scope&gt;</div><div class="FixedLine">    &lt;/dependency&gt;</div><div class="FixedLine">&lt;/dependencies&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-2</span><p class="SimplePara">The Adapter Hint to Product Server Microservice (ch03\ch03-02\01-ProductServer\ pom.xml)</p></div></div></div></div>

          <div class="Para" id="Par19">Listing <span class="InternalRef"><a href="#PC3">3-3</a></span> shows the REST-capable <span id="ITerm6">HTTP port</span>, using a Spring <span class="EmphasisFontCategoryNonProportional ">RestController</span>.<div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine">@RestController</div><div class="FixedLine">public class ProductRestController {</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    private ProductRepository productRepository;</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    private ProductMapper mapper;</div></div><div class="LineGroup"><div class="FixedLine">    @ApiOperation(value="View a list of all products",</div><div class="FixedLine">        response = Product.class,</div><div class="FixedLine">        responseContainer = "List")</div><div class="FixedLine">    @RequestMapping(value = "/products",</div><div class="FixedLine">        method = RequestMethod.GET,</div><div class="FixedLine">        produces = {MediaType.APPLICATION_JSON_VALUE})</div><div class="FixedLine">    public ResponseEntity&lt;List&lt;Product&gt;&gt; getAllProducts() {</div></div><div class="LineGroup"><div class="FixedLine">        Iterable&lt;ProductOR&gt; iterable =</div><div class="FixedLine">            productRepository.findAll();</div><div class="FixedLine">        List&lt;Product&gt; list = new ArrayList&lt;Product&gt; ();</div><div class="FixedLine">        for(ProductOR productOR:iterable){</div><div class="FixedLine">            list.add(mapper.entityToApi(productOR));</div><div class="FixedLine">        }</div><div class="FixedLine">        if(list.size() == 0){</div><div class="FixedLine">            return new ResponseEntity&lt;List&lt;Product&gt;&gt;(</div><div class="FixedLine">                HttpStatus.NOT_FOUND);</div><div class="FixedLine">        }</div><div class="FixedLine">        return new ResponseEntity&lt;List&lt;Product&gt;&gt;(list,</div><div class="FixedLine">            HttpStatus.OK);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-3</span><p class="SimplePara">REST Based HTTP Port for getAllProducts Product Server (ch03\ch03-02\01-ProductServer\src\main\java\com\acme\ecom\product\controller\ProductRestController.java)</p></div></div></div></div>

          <p class="Para" id="Par20">The REST controller has CRUD methods that synchronize the state of the <span class="EmphasisFontCategoryNonProportional ">Product</span> entity with those in the PostgreSQL database. The <span class="EmphasisFontCategoryNonProportional ">getAllProducts</span> is a Java method that returns a list of all products in the PostgreSQL database, defined through an abstract protocol and format of delivery declared in the HTTP-based REST port. A concrete implementation of this port is then injected (or used to intercept) by Spring and used in the controller in the runtime. They translate the JSON formatted Request data payload from the HTTP delivery channel into a <span class="EmphasisFontCategoryNonProportional ">getAllProducts</span> method call in the application core. To retrieve the actual product entities, the <span class="EmphasisFontCategoryNonProportional ">getAllProducts</span> delegates call to the driven port, <span class="EmphasisFontCategoryNonProportional ">ProductRepository</span>.</p>

          <div class="Para" id="Par21">There are two new utility libraries I need to discuss here. The first one is <span id="ITerm7"><span class="EmphasisFontCategoryNonProportional ">ProductMapper</span></span>, shown in Listing <span class="InternalRef"><a href="#PC4">3-4</a></span>.<div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine">@Mapper(componentModel = "spring")</div><div class="FixedLine">public interface ProductMapper {</div></div><div class="LineGroup"><div class="FixedLine">    Product entityToApi(ProductOR entity);</div><div class="FixedLine">    ProductOR apiToEntity(Product api);</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-4</span><p class="SimplePara">Product Entity Mapper (ch03\ch03-02\01-ProductServer\src\main\java\com\acme\ecom\product\controller\ProductMapper.java)</p></div></div></div></div>

          <div class="Para" id="Par22">This API contains functions that automatically map between two Java Beans, the <span class="EmphasisFontCategoryNonProportional ">ProductOR</span> and the <span class="EmphasisFontCategoryNonProportional ">Product</span> in this case. With <span class="EmphasisFontCategoryNonProportional ">MapStruct</span>, you only need to create the interface, and the library will automatically create a concrete implementation during compile time based on the declaration in <span class="EmphasisFontCategoryNonProportional ">pom.xml</span>. See Listing <span class="InternalRef"><a href="#PC5">3-5</a></span>.<div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">&lt;dependencies&gt;</div><div class="FixedLine">    &lt;dependency&gt;</div><div class="FixedLine">        &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;</div><div class="FixedLine">        &lt;artifactId&gt;mapstruct&lt;/artifactId&gt;</div><div class="FixedLine">        &lt;version&gt;1.5.5.Final&lt;/version&gt;</div><div class="FixedLine">    &lt;/dependency&gt;</div><div class="FixedLine">&lt;/dependencies&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-5</span><p class="SimplePara">Configuring the Mapper in <span id="ITerm8">ProductRestController</span> (ch03\ch03-02\01-ProductServer\pom.xml)</p></div></div></div></div>

          <p class="Para" id="Par23">When you trigger the <span class="EmphasisFontCategoryNonProportional ">MapStruct</span> processing by executing a <span class="EmphasisFontCategoryNonProportional ">mvn clean install</span>, it will generate the implementation class under <span class="EmphasisFontCategoryNonProportional ">/target/generated-sources/annotations/</span>.</p>

          <p class="Para" id="Par24">The rest of the implementation of the REST controller in the Product Server microservice is very similar to Listing <span class="ExternalRef"><a href="Capítulo-03.html#PC1"><span class="RefSource">1-4</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> (with the single exception that instead of the in-memory database, the <span class="EmphasisFontCategoryNonProportional ">ProductRepository</span> port is used to interact with a PostgreSQL repository), so I do not repeat the full code here.</p>

          <div class="Para" id="Par25">Let’s now look at the <span id="ITerm9">Entity classes</span>. The <span class="EmphasisFontCategoryNonProportional ">Product</span> entity class, which is exposed in the API of the Product Server microservice, is shown in Listing <span class="InternalRef"><a href="#PC6">3-6</a></span>.<div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">@Builder</div><div class="FixedLine">@Data</div><div class="FixedLine">@NoArgsConstructor</div><div class="FixedLine">@AllArgsConstructor</div><div class="FixedLine">public class Product{</div></div><div class="LineGroup"><div class="FixedLine">    @ApiModelProperty(position = 1)</div><div class="FixedLine">    private String productId;</div></div><div class="LineGroup"><div class="FixedLine">    @ApiModelProperty(position = 2)</div><div class="FixedLine">    private String name;</div></div><div class="LineGroup"><div class="FixedLine">    @ApiModelProperty(position = 3)</div><div class="FixedLine">    private String code;;</div></div><div class="LineGroup"><div class="FixedLine">    @ApiModelProperty(position = 4)</div><div class="FixedLine">    private String title;</div></div><div class="LineGroup"><div class="FixedLine">    @ApiModelProperty(position = 5)</div><div class="FixedLine">    private Double price;</div><div class="FixedLine">}<span id="ITerm10"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-6</span><p class="SimplePara">The Product Entity (ch03\ch03-02\01-ProductServer\src\main\java\com\acme\ecom\product\model\Product.java)</p></div></div></div></div>

          <p class="Para" id="Par26">Project Lombok’s <span class="EmphasisFontCategoryNonProportional ">@Builder</span> is a useful mechanism for using the Builder pattern without writing boilerplate code. You can apply this annotation to a class or a method.</p>

          <p class="Para" id="Par27"><span class="EmphasisFontCategoryNonProportional ">@Data</span> is a convenient shortcut annotation that bundles the features of <span class="EmphasisFontCategoryNonProportional ">@ToString</span>, <span class="EmphasisFontCategoryNonProportional ">@EqualsAndHashCode</span>, <span class="EmphasisFontCategoryNonProportional ">@Getter</span>/<span class="EmphasisFontCategoryNonProportional ">@Setter</span>, and <span class="EmphasisFontCategoryNonProportional ">@RequiredArgsConstructor</span> together. That is, <span class="EmphasisFontCategoryNonProportional ">@Data</span> generates all the boilerplate that is normally associated with Plain Old Java Objects (POJO) and beans, mainly the getters for all fields, setters for all non-final fields, and the appropriate <span class="EmphasisFontCategoryNonProportional ">toString</span>, equals, and <span class="EmphasisFontCategoryNonProportional ">hashCode</span> implementations that involve the fields of the class, a constructor that initializes all final fields, and all non-final fields with no initializer that have been marked with <span class="EmphasisFontCategoryNonProportional ">@NonNull</span>, in order to ensure the field is never null.</p>

          <div class="Para" id="Par28">Listing <span class="InternalRef"><a href="#PC7">3-7</a></span> shows the <span class="EmphasisFontCategoryNonProportional ">ProductOR</span> entity class used by the <span class="EmphasisFontCategoryNonProportional ">ProductRepository</span> of the Product Server microservice to persist the data in the PostgreSQL database.<div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine">import javax.persistence.Id;</div></div><div class="LineGroup"><div class="FixedLine">@Data</div><div class="FixedLine">@NoArgsConstructor</div><div class="FixedLine">@Entity</div><div class="FixedLine">@Table(name ="product")</div><div class="FixedLine">public class ProductOR{</div></div><div class="LineGroup"><div class="FixedLine">    @GeneratedValue(strategy = GenerationType.IDENTITY)</div><div class="FixedLine">    @Id</div><div class="FixedLine">    @Column(name = "productid")</div><div class="FixedLine">    private Long productId;</div></div><div class="LineGroup"><div class="FixedLine">    @Column(name = "prodname")</div><div class="FixedLine">    private String name;</div></div><div class="LineGroup"><div class="FixedLine">    @Column(name = "code")</div><div class="FixedLine">    private String code;;</div></div><div class="LineGroup"><div class="FixedLine">    @Column(name = "title")</div><div class="FixedLine">    private String title;</div></div><div class="LineGroup"><div class="FixedLine">    @Column(name = "price")</div><div class="FixedLine">    private Double price;</div><div class="FixedLine">}<span id="ITerm11"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-7</span><p class="SimplePara">The ProductOR <span id="ITerm12">Entity</span> (ch03\ch03-02\01-ProductServer\src\main\java\com\acme\ecom\product\model\ProductOR.java)</p></div></div></div></div>

          <p class="Para" id="Par29">You use JPA for persistence. Entities in JPA are nothing but POJOs annotated with <span class="EmphasisFontCategoryNonProportional ">@Entity</span> representing data that can be persisted to the database. An entity represents a table stored in a database. Every instance of an entity represents a row in the table. You must specify <span class="EmphasisFontCategoryNonProportional ">@Entity</span> annotation at the class level. You must also ensure that the entity has a <span class="EmphasisFontCategoryNonProportional ">no-arg</span> constructor and a primary key. The entity name defaults to the name of the class. You can change its name using the <span class="EmphasisFontCategoryNonProportional ">name</span> element <span class="EmphasisFontCategoryNonProportional ">@Entity(name="product")</span>. In some cases, the name of the table in the database and the name of the entity will not be the same. In these cases, you can specify the table name using the <span class="EmphasisFontCategoryNonProportional ">@Table</span> annotation.</p>

          <p class="Para" id="Par30">Each JPA entity must have a primary key that uniquely identifies it. The <span class="EmphasisFontCategoryNonProportional ">@Id</span> annotation defines the primary key. You can generate the identifiers in multiple ways, specified by the <span class="EmphasisFontCategoryNonProportional ">@GeneratedValue</span> annotation. You can choose from four ID-generation strategies with the strategy element. The value can be <span class="EmphasisFontCategoryNonProportional ">AUTO</span>, <span class="EmphasisFontCategoryNonProportional ">TABLE, SEQUENCE</span>, or <span class="EmphasisFontCategoryNonProportional ">IDENTITY</span>.</p>

          <p class="Para" id="Par31">You can also use the <span class="EmphasisFontCategoryNonProportional ">@Column</span> annotation to mention the details of a column in the table. The <span class="EmphasisFontCategoryNonProportional ">@Column</span> annotation has many elements, including <span class="EmphasisFontCategoryNonProportional ">name</span>, <span class="EmphasisFontCategoryNonProportional ">length</span>, <span class="EmphasisFontCategoryNonProportional ">nullable</span>, and <span class="EmphasisFontCategoryNonProportional ">unique</span>.</p>

          <p class="Para" id="Par32">There is another reason to introduce the <span class="EmphasisFontCategoryNonProportional ">ProductOR</span> entity. I want to demonstrate that while using the ports and adapters architecture, you can reuse the core entities and core business services to the maximum. In other words, I want to demonstrate that <span class="EmphasisFontCategoryNonProportional ">Product</span> entity used in this example is reused in the next example too, which will assert the capability to plugging in different driven adapters at runtime, still reusing the core. To do that, the <span class="EmphasisFontCategoryNonProportional ">ProductOR</span> entity will take care of all adapter (database) specific details.</p>

          <div class="Para" id="Par33">The JPA dependency is mentioned in the <span id="ITerm13">Maven configuration</span>. See Listing <span class="InternalRef"><a href="#PC8">3-8</a></span>.<div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine">&lt;dependencies&gt;</div><div class="FixedLine">    &lt;dependency&gt;</div><div class="FixedLine">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="FixedLine">    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</div><div class="FixedLine">    &lt;/dependency&gt;</div><div class="FixedLine">&lt;/dependencies&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-8</span><p class="SimplePara">The JPA Dependency in Maven (ch03\ch03-02\01-ProductServer\ pom.xml)</p></div></div></div></div>

          <div class="Para" id="Par34">The <span class="EmphasisFontCategoryNonProportional ">pom.xml</span> file also reveals the Liquibase dependency. The core component in using Liquibase is the <span class="EmphasisFontCategoryNonProportional ">changeLog</span> <span id="ITerm14">file</span>, which is an XML file that keeps track of all changes that need to run to update the DB. See Listing <span class="InternalRef"><a href="#PC9">3-9</a></span>.<div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine">&lt;databaseChangeLog&gt;</div><div class="FixedLine">    &lt;changeSet id="1" author="Binildas"&gt;</div><div class="FixedLine">        &lt;sqlFile path="01_init_product.sql"</div><div class="FixedLine">            relativeToChangelogFile="true"</div><div class="FixedLine">            splitStatements="true"</div><div class="FixedLine">            stripComments="true"/&gt;</div><div class="FixedLine">        &lt;comment&gt;Create table with Product info&lt;/comment&gt;</div><div class="FixedLine">    &lt;/changeSet&gt;</div><div class="FixedLine">&lt;/databaseChangeLog&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-9</span><p class="SimplePara">The Liquibase Change Log (ch03\ch03-02\01-ProductServer\src\main\resources\db\changelog\db.changelog-master.xml)</p></div></div></div></div>

          <p class="Para" id="Par35">Here, it calls the <span class="EmphasisFontCategoryNonProportional ">01_init_product.sql</span> file, which includes the script to create a product table if it doesn’t exist.</p>

          <div class="Para" id="Par36">Listing <span class="InternalRef"><a href="#PC10">3-10</a></span> shows the Product Server Microservice main <span id="ITerm15">application</span> class.<div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">@SpringBootApplication</div><div class="FixedLine">@EnableJpaRepositories("com.acme.ecom.product.repository")</div><div class="FixedLine">public class EcomProductMicroserviceApplication {</div></div><div class="LineGroup"><div class="FixedLine">    public static void main(String[] args) {</div></div><div class="LineGroup"><div class="FixedLine">        SpringApplication.run(</div><div class="FixedLine">            EcomProductMicroserviceApplication.class, args);</div><div class="FixedLine">    }</div><div class="FixedLine">}<span id="ITerm16"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-10</span><p class="SimplePara">Product Server Microservice Main Application (ch03\ch03-01\01-ProductServer\src\main\java\com\acme\ecom\product\ EcomProductMicroserviceApplication.java)</p></div></div></div></div>

          <p class="Para" id="Par37">To activate the Spring JPA repository support, this example uses the <span class="EmphasisFontCategoryNonProportional ">@EnableJpaRepositories</span> annotation and specifies the package that contains the DAO interfaces.</p>

          <div class="Para" id="Par38">Listing <span class="InternalRef"><a href="#PC11">3-11</a></span> shows the Product Server Microservice <span id="ITerm17">configuration file</span>.<div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">spring.application.name = product-server</div><div class="FixedLine">server.port=8081</div><div class="FixedLine">spring.datasource.url=jdbc:postgresql://${DB_SERVER}/${POSTGRES_DB}</div><div class="FixedLine">spring.datasource.username=${POSTGRES_USER}</div><div class="FixedLine">spring.datasource.password=${POSTGRES_PASSWORD}</div><div class="FixedLine">spring.liquibase.change-log=classpath:/db/changelog/db.changelog-master.xml</div><div class="FixedLine">spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation=true</div><div class="FixedLine">spring.jpa.show-sql=true</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-11</span><p class="SimplePara">The Liquibase Change Log (ch03\ch03-02\01-ProductServer\src\main\resources\application.properties)</p></div></div></div></div>

          <p class="Para" id="Par39">This file expects the PostgreSQL database configuration parameters through the environment context of the Product Server microservice.</p>

          <p class="Para" id="Par40">The Product Web microservice code is very similar to the Product Web microservice code you saw in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span>. I do not repeat the code here; instead, you are advised to refer to Listings <span class="ExternalRef"><a href="Capítulo-04.html#PC6"><span class="RefSource">2-6</span></a></span> through <span class="ExternalRef"><a href="Capítulo-04.html#PC8"><span class="RefSource">2-8</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span>.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec4">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par41">The <span class="EmphasisFontCategoryNonProportional ">ch03\ch03-01</span> folder contains the Maven scripts required to build the examples. As a first step, you need to bring up the PostgreSQL server. Refer to Appendix C to learn how to set up PostgreSQL server and bring it up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC12">3-12</a></span> to bring up PostgreSQL.<div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:~ binil$ pg_ctl -D /Library/PostgreSQL/12/data start</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-12</span><p class="SimplePara">Bringing Up PostgreSQL Server</p></div></div></div></div>

          <div class="Para" id="Par42">Next, take two command terminals and change the directory to the top-level folder of both microservices. Then build and <span id="ITerm18">run</span> the Product Server microservice using the <span class="EmphasisFontCategoryNonProportional ">make.sh</span> and <span class="EmphasisFontCategoryNonProportional ">run.sh</span> scripts, as shown in Listing <span class="InternalRef"><a href="#PC13">3-13</a></span>.<div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch03/ch03-01/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">[INFO] -&lt; com.acme.ecom.product:Ecom-Product-Server-Micro &gt;-</div><div class="FixedLine">...</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] BUILD SUCCESS</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">[INFO] Total time:  3.026 s</div><div class="FixedLine">[INFO] Finished at: 2024-01-03T12:36:02+05:30</div><div class="FixedLine">[INFO] -----------------------------------------------------</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$</div></div><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run.sh</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2024-01-03 12:37:17 INFO  Start.log:50 - Starting EcomProdM…</div><div class="FixedLine">2024-01-03 12:37:20 INFO  InitComponent.init:47 - Start...</div><div class="FixedLine">2024-01-03 12:37:20 DEBUG InitComponent.init:51 - Delete...</div><div class="FixedLine">Hibernate: select pco1_0.categoryid,pco1_0.description,pco1_0.imgurl,pco1_0.name,pco1_0.title from productcategory pco1_0</div><div class="FixedLine">Hibernate: select po1_0.productid,po1_0.category,po1_0.code,po1_0.prodname,po1_0.price,po1_0.title from product po1_0</div><div class="FixedLine">2024-01-03 12:37:20 DEBUG InitializationComponent.init:56 - Creating initial data on start...</div><div class="FixedLine">Hibernate: insert into productcategory (description,imgurl,name,title) values (?,?,?,?)</div><div class="FixedLine">Hibernate: insert into productcategory (description,imgurl,name,title) values (?,?,?,?)</div><div class="FixedLine">Hibernate: insert into product (category,code,prodname,price,title) values (?,?,?,?,?)</div><div class="FixedLine">Hibernate: insert into product (category,code,prodname,price,title) values (?,?,?,?,?)</div><div class="FixedLine">Hibernate: insert into product (category,code,prodname,price,title) values (?,?,?,?,?)</div><div class="FixedLine">Hibernate: insert into product (category,code,prodname,price,title) values (?,?,?,?,?)</div><div class="FixedLine">2024-01-03 12:37:20 INFO  InitComponent.init:105 - End</div><div class="FixedLine">2024-01-03 12:37:21 INFO  Start.log:56 - Started EcomProd...</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-13</span><p class="SimplePara">Build and Run Product Server Microservice Using Scripts</p></div></div></div></div>

          <div class="Para" id="Par43">Note the initialization is being done by inserting a few rows into the PostgreSQL DB while the Product Server microservice starts up. Next, build and run the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC14">3-14</a></span>.<div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch03/ch03-01/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$</div></div><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh run.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-03 12:43:58 INFO  Startup.log:50 - Starting EcomProd</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-03 12:43:59 INFO  InitComponent.init:36 - Start</div><div class="FixedLine">2024-01-03 12:43:59 DEBUG InitComponent.init:38 - Do Nothing</div><div class="FixedLine">2024-01-03 12:43:59 INFO  InitComponent.init:40 - End</div><div class="FixedLine">2024-01-03 12:43:59 INFO  Startup.log:56 - Started EcomProd</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-14</span><p class="SimplePara">Build and Run Product Web Microservice Using Scripts</p></div></div></div></div>

          <p class="Para" id="Par44">Now that both microservices are up and running, you can test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec5">

          <h3 class="Heading">Testing the Microservice</h3>

          <div class="Para" id="Par45">Once <span id="ITerm19">both</span> microservices are up and running, you can inspect your PostgreSQL server using the <span class="EmphasisFontCategoryNonProportional ">psql</span> terminal to make sure the Product Server microservice inserted a few products into the PostgreSQL server during the microservice startup process. Refer to Appendix C to learn how to use the <span class="EmphasisFontCategoryNonProportional ">psql</span> terminal.<div class="ProgramCode" id="PC15"><div class="LineGroup"><div class="FixedLine">postgres=# connect productdb</div><div class="FixedLine">You are now connected to database "productdb" as user "postgres".</div><div class="FixedLine">productdb=# select * from product;</div><div class="FixedLine"> productid |  prodname   |  code   |  title        | price</div><div class="FixedLine">-----------+-------------+---------+---------------+-----</div><div class="FixedLine">         1 | Kamsung D3  | KAMSUNG | Kamsung Tr..  | 12000</div><div class="FixedLine">         2 | Lokia Pomia | LOKIA   | Lokia 1.      |  9009</div><div class="FixedLine">(2 rows)</div></div><div class="LineGroup"><div class="FixedLine">productdb=#</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-15</span><p class="SimplePara">Inspecting the PostgreSQL Server Using a psql Shell</p></div></div></div></div>

          <p class="Para" id="Par46">When all is set, you can access the web application using your browser. Point to this URL:</p>

          <p class="Para ParaOneEmphasisChild" id="Par47"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/product.html</span></p>

          <p class="Para" id="Par48">To test the CRUD operations, follow the instructions described in the subsection, “Test the Microservices Using UI” in the last section of Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span>, titled “Your First Java Microservice.”</p>

          <p class="Para" id="Par49">Once you have executed the test cases in this example, you can move on to the next example, which is intended to demonstrate one of the many great flexibilities of the hexagonal architecture—plug and play.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec6">

        <h2 class="Heading">Microservices Using MongoDB and CrudRepository</h2>

        <p class="Para" id="Par50">This example tweaks the first example of microservices you saw in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span> to connect to a MongoDB, using the <span class="EmphasisFontCategoryNonProportional ">CrudRepository</span> instead of the <span class="EmphasisFontCategoryNonProportional ">MongoRepository</span>. You have the same two microservices—a consumer and a provider microservice—communicating with each other using the REST protocol. The provider microservice also interacts with a MongoDB. Refer to Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span> for the overall design.</p>

        <section class="Section2 RenderAsSection2" id="Sec7">

          <h3 class="Heading">Hexagonal Architecture Revisited</h3>

          <p class="Para" id="Par51">I reused the <span id="ITerm20">hexagonal</span><span id="ITerm21"></span> microservice view shown in Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span>. However, you will be using <span class="EmphasisFontCategoryNonProportional ">CrudRepository</span> instead of <span class="EmphasisFontCategoryNonProportional ">MongoRepository</span>. I want to demonstrate how a generic port (the driven port with <span class="EmphasisFontCategoryNonProportional ">CrudRepository</span> in this case) can be “adapted using suitable adaptors” to connect to different kinds of databases—more specifically to a MongoDB database in this example.</p>

          <p class="Para" id="Par52">Further, I introduced the <span class="EmphasisFontCategoryNonProportional ">ProductOR</span> entity in the last example. The reason for this is that I want to demonstrate that while using the ports and adapters architecture, you can reuse the core entities and business services to the maximum. In other words, I want to demonstrate that you will retain and reuse a <span class="EmphasisFontCategoryNonProportional ">Product</span> entity from the last example in this example too, which will assert the capability to plug in different driven adapters at runtime.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec8">

          <h3 class="Heading">Understanding the Code</h3>

          <div class="Para" id="Par53">The <span id="ITerm22">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch03\ch03-02</span> folder. You will look at the provider microservice—that is, the Product Server microservice—first. Listing <span class="InternalRef"><a href="#PC16">3-16</a></span> starts with the changed Repository used to interact with the PostgreSQL.<div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine">@RepositoryRestResource(collectionResourceRel = "productdata", path = "productdata")</div><div class="FixedLine">public interface ProductRepository extends</div><div class="FixedLine">        CrudRepository&lt;ProductOR, String&gt; {</div></div><div class="LineGroup"><div class="FixedLine">    public List&lt;ProductOR&gt; findByCode(@Param("code")</div><div class="FixedLine">        String  code);</div><div class="FixedLine">    public List&lt;ProductOR&gt; findByCategory(@Param("category")</div><div class="FixedLine">        String  category);</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-16</span><p class="SimplePara">The Abstract Port for Product Server Microservice to Interact with MongoDB (ch03\ch03-02\01-ProductServer\src\main\java\com\acme\ecom\product\repository\ProductRepository.java</p></div></div></div></div>

          <div class="Para" id="Par54">This example retains the <span class="EmphasisFontCategoryNonProportional ">CrudRepository</span> for generic CRUD operations on a repository of a specific type. The specific adapter for this port, an adapter to a MongoDB database, is provided by Spring based on the configuration in <span class="EmphasisFontCategoryNonProportional ">pom.xml</span>; see Listing <span class="InternalRef"><a href="#PC17">3-17</a></span>.<div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine">&lt;dependencies&gt;</div><div class="FixedLine">    &lt;dependency&gt;</div><div class="FixedLine">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="FixedLine">        &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;/artifactId&gt;</div><div class="FixedLine">    &lt;/dependency&gt;</div><div class="FixedLine">    &lt;dependency&gt;</div><div class="FixedLine">        &lt;groupId&gt;javax.persistence&lt;/groupId&gt;</div><div class="FixedLine">        &lt;artifactId&gt;javax.persistence-api&lt;/artifactId&gt;</div><div class="FixedLine">        &lt;version&gt;2.2&lt;/version&gt;</div><div class="FixedLine">    &lt;/dependency&gt;</div><div class="FixedLine">&lt;/dependencies&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-17</span><p class="SimplePara">The Product Server Microservice Maven File (ch03\ch03-02\01-ProductServer\pom.xml)</p></div></div></div></div>

          <p class="Para" id="Par55">I also changed the persistence dependency to its API alone.</p>

          <p class="Para" id="Par56">The rest of the implementation of the REST controller in the Product Server microservice is very similar to the code in Listing <span class="ExternalRef"><a href="Capítulo-03.html#PC4"><span class="RefSource">1-4</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> (with the single exception that instead of the in-memory database, the <span class="EmphasisFontCategoryNonProportional ">ProductRepository</span> port is used to interact with a MongoDB repository), hence I do not repeat the full code here.</p>

          <div class="Para" id="Par57">The <span class="EmphasisFontCategoryNonProportional ">Product</span> entity class is similar to the previous example, as shown in Listing <span class="InternalRef"><a href="#PC6">3-6</a></span>. I have retained this class as the API entity, hence I have its counterpart <span class="EmphasisFontCategoryNonProportional ">ProductOR</span> to manage the DB interactions. The code for <span class="EmphasisFontCategoryNonProportional ">ProductOR</span> is very similar to that shown in the previous example in Listing <span class="InternalRef"><a href="#PC7">3-7</a></span> with subtle differences, which are commented out and replaced with new code in Listing <span class="InternalRef"><a href="#PC18">3-18</a></span>.<div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine">import org.springframework.data.annotation.Id;</div><div class="FixedLine">//import javax.persistence.Id;</div></div><div class="LineGroup"><div class="FixedLine">    @Data</div><div class="FixedLine">    @NoArgsConstructor</div><div class="FixedLine">    @Entity</div><div class="FixedLine">    @Table(name ="product")</div><div class="FixedLine">    public class ProductOR{</div></div><div class="LineGroup"><div class="FixedLine">    @GeneratedValue(strategy = GenerationType.IDENTITY)</div><div class="FixedLine">    @Id</div><div class="FixedLine">    @Column(name = "productid")</div><div class="FixedLine">    //private Long productId;</div><div class="FixedLine">    private String productId;</div></div><div class="LineGroup"><div class="FixedLine">    @Column(name = "prodname")</div><div class="FixedLine">    private String name;</div></div><div class="LineGroup"><div class="FixedLine">    @Column(name = "code")</div><div class="FixedLine">    private String code;;</div></div><div class="LineGroup"><div class="FixedLine">    @Column(name = "title")</div><div class="FixedLine">    private String title;</div></div><div class="LineGroup"><div class="FixedLine">    @Column(name = "price")</div><div class="FixedLine">    private Double price;</div></div><div class="LineGroup"><div class="FixedLine">    @Column(name = "category")</div><div class="FixedLine">    private String category;</div></div><div class="LineGroup"><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-18</span><p class="SimplePara">The <span id="ITerm23">ProductOR Entity</span> (ch03\ch03-02\01-ProductServer\src\main\java\com\acme\ecom\product\model\ProductOR.java)</p></div></div></div></div>

          <p class="Para" id="Par58">If you ask MongoDB to auto-generate an ID for the <span class="EmphasisFontCategoryNonProportional ">Long</span> type, it will complain, so I changed the ID to <span class="EmphasisFontCategoryNonProportional ">String</span>. Next, I changed the <span class="EmphasisFontCategoryNonProportional ">@Id</span> annotation from <span class="EmphasisFontCategoryNonProportional ">javax.persistence</span> to that of <span class="EmphasisFontCategoryNonProportional ">springframework</span> so that the ID value is exposed through the API methods. <span class="EmphasisFontCategoryNonProportional ">ProductOR</span> thus shields the impedance mismatch across databases from the <span class="EmphasisFontCategoryNonProportional ">Product</span> entity class. This makes the <span class="EmphasisFontCategoryNonProportional ">Product</span> entity reusable.</p>

          <p class="Para" id="Par59">The rest of the classes in the Product Server microservice are similar to what you saw in the previous example. The code for the Product Web microservice is also unchanged from the previous example, so it’s not repeated here.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec9">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par60">The <span class="EmphasisFontCategoryNonProportional ">ch03\ch03-02</span> folder contains the Maven scripts required to build the examples. As a first step, you need to bring up the MongoDB server. Refer to Appendix B to learn how you can set up a MongoDB server and bring it up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC19">3-19</a></span> to bring up MongoDB.<div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine">(base) binildass-MBP:bin binil$ pwd</div><div class="FixedLine">/Users/binil/Applns/mongodb/mongodb-macos-x86_64-4.2.8/bin</div><div class="FixedLine">(base) binildass-MBP:bin binil$ mongod --dbpath /usr/local/var/mongodb --logpath /usr/local/var/log/mongodb/mongo.log</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-19</span><p class="SimplePara">Bringing Up the MongoDB Server</p></div></div></div></div>

          <div class="Para" id="Par61">Next, take two command terminals and change the directory to the top-level folder of both microservices. Then, build and <span id="ITerm24">run</span> the Product Server microservice using the <span class="EmphasisFontCategoryNonProportional ">make.sh</span> and <span class="EmphasisFontCategoryNonProportional ">run.sh</span> scripts, as shown in Listing <span class="InternalRef"><a href="#PC20">3-20</a></span>.<div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch03/ch03-02/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-03 13:13:59 INFO  Startup.log:50 - Starting EcomProd</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-03 13:14:01 INFO  InitComponent.init:47 - Start...</div><div class="FixedLine">2024-01-03 13:14:01 DEBUG InitComponent.init:51 - Delete ...</div><div class="FixedLine">2024-01-03 13:14:01 DEBUG InitComponent.init:56 - Create init</div><div class="FixedLine">2024-01-03 13:14:01 INFO  InitComponent.init:105 - End</div><div class="FixedLine">2024-01-03 13:14:01 INFO  Startup.log:56 - Started EcomProd</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-20</span><p class="SimplePara">Build and Run Product Server Microservice Using Scripts</p></div></div></div></div>

          <div class="Para" id="Par62">Next, build and run the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC21">3-21</a></span>.<div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch03/ch03-02/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-03 13:17:09 INFO  Startup.log:50 - Starting EcomProd</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-03 13:17:10 INFO  InitComponent.init:37 - Start</div><div class="FixedLine">2024-01-03 13:17:10 DEBUG InitComponent.init:39 - Do Nothing</div><div class="FixedLine">2024-01-03 13:17:10 INFO  InitComponent.init:41 - End</div><div class="FixedLine">2024-01-03 13:17:10 INFO  Startup.log:56 - Started EcomProd…</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-21</span><p class="SimplePara">Build and Run Product Web Microservice Using Scripts</p></div></div></div></div>

          <p class="Para" id="Par63">Now that both microservices are up and running, you can test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec10">

          <h3 class="Heading">Testing the Microservices</h3>

          <div class="Para" id="Par64">Once both <span id="ITerm25">microservices</span> are up and running, you can inspect your MongoDB server using the Mongo terminal to make sure the Product Server Microservice inserted a few products into the MongoDB server during the microservice startup. See Listing <span class="InternalRef"><a href="#PC22">3-22</a></span>.<div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">&gt; db.productOR.find()</div><div class="FixedLine">{ "_id" : ObjectId("61a5e3bc80e0e72c72097305"), "name" : "Kamsung Mobile", "code" : "KAMSUNG-TRIOS", "title" : "Tablet Trios 12 inch , black , 12 px ....", "price" : 12000, "category" : "Mobile", "_class" : "com.acme.ecom.product.model.ProductOR" }</div><div class="FixedLine">{ "_id" : ObjectId("61a5e3bc80e0e72c72097306"), "name" : "Lokia Mobile", "code" : "LOKIA-POMIA", "title" : "Lokia 12 inch , white , 14px ....", "price" : 9000, "category" : "Mobile", "_class" : "com.acme.ecom.product.model.ProductOR" }</div><div class="FixedLine">{ "_id" : ObjectId("61a5e3bc80e0e72c72097307"), "name" : "Mapple Mobile", "code" : "MAPPLE-EPHONE", "title" : "Mapple 7 inch, purple, 14px ....", "price" : 8000, "category" : "Mobile", "_class" : "com.acme.ecom.product.model.ProductOR" }</div><div class="FixedLine">{ "_id" : ObjectId("61a5e3bc80e0e72c72097308"), "name" : "Mapple Tablet", "code" : "MAPPLE-PAD", "title" : "Mapple 11 inch , grey, 140px ....", "price" : 19000, "category" : "Tablet", "_class" : "com.acme.ecom.product.model.ProductOR" }</div><div class="FixedLine">&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-22</span><p class="SimplePara">Inspect MongoDB Server Using a Mongo Shell</p></div></div></div></div>

          <p class="Para" id="Par65">When all is set, you can access the web application using your browser. Point to this URL:</p>

          <p class="Para ParaOneEmphasisChild" id="Par66"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/product.html</span></p>

          <p class="Para" id="Par67">To test the CRUD operations, follow the instructions described in the subsection, “Test the Microservices Using UI” in the last section of Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span>, titled “Your First Java Microservice.”</p>

          <p class="Para" id="Par68">It’s now time to consolidate your learning so far and introduce the next concept, the Onion architecture.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec11">

        <h2 class="Heading">The Onion Architecture</h2>

        <p class="Para" id="Par69">The layering principle enables software architects to separate concerns. Software architects have been successfully building layered software architectures for decades, and today these layered principles have gained traction with the widespread adoption of the microservices architecture. Let’s look at what layering has to do with onions.</p>

        <section class="Section2 RenderAsSection2" id="Sec12">

          <h3 class="Heading">Onion Architecture Design</h3>

          <div class="Para" id="Par70">In the ports and adapters <span id="ITerm26">architecture</span> explained in the previous chapters, you learned about defining abstract ports and adapters that shield the core business services and entities from the context and intent of the software. In other words, these ports and adapters isolate the software application core from the infrastructure and peripheral concerns by writing adapter code so that the infrastructure and peripheral code does not leak into the application core. The Onion architecture depicts enterprise applications with multiple layers, and some of these layers in the business logic might be recognizable from the principles of domain driven design. A typical Onion architecture is depicted in Figure <span class="InternalRef"><a href="#Fig1">3-1</a></span>.<figure class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img alt="" aria-describedby="d64e1819" src="../images/619782_1_En_3_Chapter/Imagem-027.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1819"><p class="Para" id="Par133">A model diagram has a 4-layer concentric circle with entities, domain services, application services, and infrastructure layer dependency from the innermost to the outermost layer. The layers include model aggregates, progress, business service, controller, message listener, client, and browser and store with driver ports.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 3-1</span><p class="SimplePara">Onion architecture</p></div></figcaption></figure></div>

          <div class="Para" id="Par71">Referring to Figure <span class="InternalRef"><a href="#Fig1">3-1</a></span>, the two <span id="ITerm27">core principles</span> in software architecture are:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par72">Outer layers depend on inner layers</p></li><li><p class="Para" id="Par73">Outer layers are transparent to inner layers</p></li></ul></div></div>

          <p class="Para" id="Par74">Referring to Figure <span class="InternalRef"><a href="#Fig1">3-1</a></span>, the direction of coupling of layers is toward the center, providing you with an independent object model (domain model), which in its core depends on nothing. This inner layer contains the data and the logic to manipulate data that is specific to the domain of the application itself.</p>

          <p class="Para" id="Par75">Many times, you’ll also encounter logic that involves multiple entities, and such domain logic may not belong to a specific entity. Such logic could also be reused, so that calls for another layer, called the Business Services layer. These Business services—aka domain services<span class="EmphasisTypeStrikethrough ">—</span>have the role of receiving a set of entities and performing some business logic on them. Such domain services could aggregate more domain services and business entities too (refer to Figure <span class="ExternalRef"><a href="Capítulo-03.html#Fig14"><span class="RefSource">1-14</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span>).</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec13">

          <h3 class="Heading">Onion vs. Hexagonal Architecture</h3>

          <p class="Para" id="Par76">The ports and adapters defined in the <span id="ITerm28">hexagonal architecture</span> are a means to isolate the software application core from the infrastructure and peripheral concerns. These peripherals could be a user interface, whatever type of user interface it might be, like a browser, a mobile device, a scanner, and so on. Similarly, infrastructure code could connect the application core to tools like a database, a third-party system, a printer, and so on. The infrastructure layer, which becomes the outermost onion ring, depicts this in the Onion architecture in Figure <span class="InternalRef"><a href="#Fig1">3-1</a></span>. You can also visualize them as being placed in the boundary of the hexagon, as abstract ports and adapters.</p>

          <p class="Para" id="Par77">These ports and adapters are connected to the inner layers through what we call <span id="ITerm29"><em class="EmphasisTypeItalic ">application services</em></span>. These are technical services handling protocol and format transformations and optimizations. For example, a REST controller is an application service exposing entities as JSON through an HTTP transport. Similarly, persistence abstractions to a specific type of database could be done using a repository interface, as you saw in the first two examples in this chapter, which again are kinds of application services. Thus, this second layer of the onion are the inner, reusable layers.</p>

          <p class="Para" id="Par78">Having discussed enough theory, let’s look at some practical examples. If you turn back to the two previous examples in this chapter, you can visualize how the domain entities (<span class="EmphasisFontCategoryNonProportional ">Product</span>) are reused across different persistence abstractions across a PostgreSQL and a MongoDB database, which are driven interfaces. I will now extend the same example further to demonstrate how ports can be defined to allow multiple driver abstractions. To be more specific, you have seen how a REST interface to the microservices provides fine abstractions as driver ports. I will plug in another port, one using a <span id="ITerm30">GraphQL technology</span>, to the same microservices in the outermost ring of the onion so that inner rings of the same onion can be reused.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec14">

        <h2 class="Heading">GraphQL</h2>

        <p class="Para" id="Par79"><span id="ITerm31">GraphQL</span> is an open-source data query and manipulation language for APIs, and a runtime for fulfilling queries with existing data. GraphQL was developed internally by Facebook in 2012. The GraphQL project was later moved from Facebook to the newly established GraphQL Foundation, hosted by the non-profit Linux Foundation. I will quickly go through GraphQL so you can appreciate the next example in this chapter.</p>

        <section class="Section2 RenderAsSection2" id="Sec15">

          <h3 class="Heading">GraphQL Explained</h3>

          <p class="Para" id="Par80">GraphQL enables clients to ask for exactly what they need and nothing more, thus making it easier to evolve APIs over time. It allows clients to define the structure of the required data, and the same structure of the data is returned from the server, therefore preventing excessively large amounts of data from being returned. It is highly desirable in low profile devices like mobiles, IOT, and so on. It allows the client to navigate to child resources in a single request, and thus enables multiple queries in a single request.</p>

          <div class="Para" id="Par81">GraphQL uses the notion of named queries and mutations instead of a standard mandatory set of actions. This helps to put the control where it belongs, with the API developer on specifying what is possible, and with the API consumer on what is desired. Listing <span class="InternalRef"><a href="#PC23">3-23</a></span> shows an example query.<div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine">query {</div><div class="FixedLine">    products(count: 10, offset: 0) {</div><div class="FixedLine">        productId</div><div class="FixedLine">        code</div><div class="FixedLine">        productCategory {</div><div class="FixedLine">            id</div><div class="FixedLine">            name</div><div class="FixedLine">            title</div><div class="FixedLine">        }</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-23</span><p class="SimplePara">A GraphQL Query</p></div></div></div></div>

          <div class="Para" id="Par82">This GraphQL query is intended to do the following:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par83">Request the ten most recently added products</p></li><li><p class="Para" id="Par84">For each product, request the <span class="EmphasisFontCategoryNonProportional ">productId</span> and <span class="EmphasisFontCategoryNonProportional ">code</span></p></li><li><p class="Para" id="Par85">For each product request, its <span class="EmphasisFontCategoryNonProportional ">productCategory</span>, returning the <span class="EmphasisFontCategoryNonProportional ">id</span>, <span class="EmphasisFontCategoryNonProportional ">name</span>, and <span class="EmphasisFontCategoryNonProportional ">title</span> of the corresponding product category</p></li></ul></div></div>

          <p class="Para" id="Par86">In a traditional REST API, this either requires 11 requests—one for the initial products query and ten for their corresponding <span class="EmphasisFontCategoryNonProportional ">productCategory</span>—or it needs to include the <span class="EmphasisFontCategoryNonProportional ">productCategory</span> details along with the post details, making the payload large.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec16">

        <h2 class="Heading">Onion Architecture Microservice Example</h2>

        <p class="Para" id="Par87">This example tweaks the previous example of microservices. It uses the same two microservices—a consumer and a provider microservice—communicating with each other using the REST protocol. The provider microservice also interacts with a MongoDB. The consumer microservice exposes an additional port based on GraphQL.</p>

        <section class="Section2 RenderAsSection2" id="Sec17">

          <h3 class="Heading">Onion Design for the Microservice</h3>

          <div class="Para" id="Par88">If you superimpose the hexagonal microservice view shown in Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span> on to the Onion architecture view in Figure <span class="InternalRef"><a href="#Fig1">3-1</a></span> in this chapter, you get Figure <span class="InternalRef"><a href="#Fig2">3-2</a></span>.<figure class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img alt="" aria-describedby="d64e2025" src="../images/619782_1_En_3_Chapter/Imagem-028.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2025"><p class="Para" id="Par134">A model diagram of product-web-microservice connects the end user to the 4-layer concentric circle with entities, domain services, application services, and infrastructure layer dependency and their respective microservices. It leads to product rest controller, product entity, and mongo D B under product-server-microservice.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 3-2</span><p class="SimplePara">Onion architecture for the Consumer and Provider <span id="ITerm32">microservices</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par89">In both microservices shown in Figure <span class="InternalRef"><a href="#Fig2">3-2</a></span>, you use HTTP ports at the REST interfaces, which specify how a user’s browser or some other HTTP client can use the application core. For the Product Web microservice, you specify an additional port based on GraphQL. You can also define a business service intended to demonstrate that the business service instances from the inner layers are reused by the outer layers of the Onion architecture, just like how they reuse the business entity classes.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec18">

          <h3 class="Heading">Code Organization</h3>

          <div class="Para" id="Par90">The source <span id="ITerm33">code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The code for this example is organized as shown in Listing <span class="InternalRef"><a href="#PC24">3-24</a></span>, inside the <span class="EmphasisFontCategoryNonProportional ">ch03\ch03-03</span> folder. This follows the standard Maven structure, so <span class="EmphasisFontCategoryNonProportional ">pom.xml</span> is in the root of the directory. Code organization for the relevant portion of the Product Web microservice alone is shown, since the Product Server microservice is similar to what you have seen already.<div class="ProgramCode" id="PC24"><div class="LineGroup"><div class="FixedLine">./ch03-03/</div><div class="FixedLine">├── 01-ProductServer</div><div class="FixedLine">│   ├── ...</div><div class="FixedLine">│   .</div><div class="FixedLine">├── 02-ProductWeb</div><div class="FixedLine">│   ├── pom.xml</div><div class="FixedLine">│   └── src</div><div class="FixedLine">│       └── main</div><div class="FixedLine">│           ├── java</div><div class="FixedLine">│           │   └── com</div><div class="FixedLine">│           │       └── acme</div><div class="FixedLine">│           │           └── ecom</div><div class="FixedLine">│           │               └── product</div><div class="FixedLine">│           │                   ├── EcomProductApp.java</div><div class="FixedLine">│           │                   ├── InitComponent.java</div><div class="FixedLine">│           │                   ├── config</div><div class="FixedLine">│           │                   │   └── SwaggerConfig.java</div><div class="FixedLine">│           │                   ├── controller</div><div class="FixedLine">│           │                   │   ├─ GraphQLController.java</div><div class="FixedLine">│           │                   │   ├─ RestController.java</div><div class="FixedLine">│           │                   │   └── RestControlConf.java</div><div class="FixedLine">│           │                   ├── graphql</div><div class="FixedLine">│           │                   │   ├── GraphqlConfig.java</div><div class="FixedLine">│           │                   │   ├── ProdCategoryDao.java</div><div class="FixedLine">│           │                   │   └── ProductDao.java</div><div class="FixedLine">│           │                   ├── model</div><div class="FixedLine">│           │                   │   ├── Product.java</div><div class="FixedLine">│           │                   │   └── ProductCategory.java</div><div class="FixedLine">│           │                   └── service</div><div class="FixedLine">│           │                       └── ProdBusService.java</div><div class="FixedLine">│           └── resources</div><div class="FixedLine">│               ├── application.yml</div><div class="FixedLine">│               ├── graphql</div><div class="FixedLine">│               │   └── schema.graphqls</div><div class="FixedLine">│               ├── log4j2-spring.xml</div><div class="FixedLine">│               └── static</div><div class="FixedLine">│                   ├── ...</div><div class="FixedLine">│                   .</div><div class="FixedLine">└── pom.xml</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-24</span><p class="SimplePara">Spring Boot Source Code Organization</p></div></div></div></div>

          <div class="Para" id="Par91">I added the following new folders and files, which are explained next:<div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine">ch03\ch03-03\02-ProductWeb\src\main\java\com\acme\ecom\product\graphql</div><div class="FixedLine">ch03\ch03-03\02-ProductWeb\src\main\java\com\acme\ecom\product\service</div><div class="FixedLine">ch03\ch03-03\02-ProductWeb\src\main\resources\graphql\schema.graphqls</div></div></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec19">

          <h3 class="Heading">Understanding the Code</h3>

          <p class="Para" id="Par92">This section looks at the changes in the provider microservice—that is, the Product Server microservice—first.</p>

          <div class="Para" id="Par93">Much of the REST controller’s implementation in the Product Server microservice is similar to the code in Listing <span class="ExternalRef"><a href="Capítulo-03.html#PC4"><span class="RefSource">1-4</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> (with the exception that instead of the in-memory database, the <span class="EmphasisFontCategoryNonProportional ">ProductRepository</span> and <span class="EmphasisFontCategoryNonProportional ">ProductCategoryRepository</span> ports are used to interact with a MongoDB repository), hence I do not repeat the full code here. However, I introduced two new methods for <span id="ITerm34"><span class="EmphasisFontCategoryNonProportional ">ProductRestController</span></span><span class="EmphasisFontCategoryNonProportional ">,</span> as shown in Listing <span class="InternalRef"><a href="#PC26">3-25</a></span>.<div class="ProgramCode" id="PC26"><div class="LineGroup"><div class="FixedLine">@RestController</div><div class="FixedLine">public class ProductRestController {</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    private ProductRepository productRepository;</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    private ProductCategoryRepository</div><div class="FixedLine">        productCategoryRepository;</div></div><div class="LineGroup"><div class="FixedLine">    @RequestMapping(value =</div><div class="FixedLine">        "/productsbycat/{productcategoryname}",</div><div class="FixedLine">        method = RequestMethod.GET,</div><div class="FixedLine">        produces = {MediaType.APPLICATION_JSON_VALUE})</div><div class="FixedLine">    public ResponseEntity&lt;List&lt;Product&gt;&gt;</div><div class="FixedLine">            getProductsByCategory(</div><div class="FixedLine">        @PathVariable("productcategoryname") String</div><div class="FixedLine">            productCategoryName) {</div></div><div class="LineGroup"><div class="FixedLine">        List&lt;ProductOR&gt; productORs =</div><div class="FixedLine">            productRepository.findByCategory(</div><div class="FixedLine">                productCategoryName);</div><div class="FixedLine">        if(productORs.isEmpty()){</div><div class="FixedLine">            return new ResponseEntity&lt;</div><div class="FixedLine">                List&lt;Product&gt;&gt;(HttpStatus.NOT_FOUND);</div><div class="FixedLine">        }</div><div class="FixedLine">        List&lt;Product&gt; list = new ArrayList&lt;Product&gt; ();</div><div class="FixedLine">        for(ProductOR productOR:productORs){</div><div class="FixedLine">            list.add(productMapper.entityToApi(productOR));</div><div class="FixedLine">        }</div><div class="FixedLine">        return new ResponseEntity&lt;</div><div class="FixedLine">            List&lt;Product&gt;&gt;(list, HttpStatus.OK);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @RequestMapping(value =</div><div class="FixedLine">        "/category/{category}", method = RequestMethod.GET,</div><div class="FixedLine">        produces = MediaType.APPLICATION_JSON_VALUE)</div><div class="FixedLine">    public ResponseEntity&lt;ProductCategory&gt; getCategory(</div><div class="FixedLine">        @PathVariable("category") String category) {</div></div><div class="LineGroup"><div class="FixedLine">        List&lt;ProductCategoryOR&gt; productCategoryORs =</div><div class="FixedLine">            productCategoryRepository.findByName(category);</div><div class="FixedLine">        if(productCategoryORs.isEmpty()){</div><div class="FixedLine">            return new ResponseEntity&lt;ProductCategory&gt;(</div><div class="FixedLine">                HttpStatus.NOT_FOUND);</div><div class="FixedLine">        }</div><div class="FixedLine">        ProductCategoryOR firstProductCategoryOR =</div><div class="FixedLine">            productCategoryORs.iterator().next();</div><div class="FixedLine">        return new ResponseEntity&lt;ProductCategory&gt;(</div><div class="FixedLine">            productCategoryMapper.entityToApi(</div><div class="FixedLine">                firstProductCategoryOR), HttpStatus.OK);</div><div class="FixedLine">    }</div><div class="FixedLine">}<span id="ITerm35"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-25</span><p class="SimplePara">REST Based HTTP Port for Product Category Based Queries in Product Server (ch03\ch03-03\01-ProductServer\src\main\java\com\acme\ecom\product\controller\ProductRestController.java)</p></div></div></div></div>

          <p class="Para" id="Par94">These two new methods use their respective repositories to retrieve corresponding entities, which will be utilized by the GraphQL implementation, which I explain soon.</p>

          <div class="Para" id="Par95">Listing <span class="InternalRef"><a href="#PC27">3-26</a></span> looks at the consumer microservice—the Product Web microservice. This starts with the REST capable HTTP port, using a Spring <span id="ITerm36"><span class="EmphasisFontCategoryNonProportional ">RestController</span></span>.<div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine">@CrossOrigin</div><div class="FixedLine">@RestController</div><div class="FixedLine">public class ProductRestController{</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    private ProductBusinessService productBusinessService;</div></div><div class="LineGroup"><div class="FixedLine">    @RequestMapping(value = "/productsweb",</div><div class="FixedLine">        method = RequestMethod.GET,</div><div class="FixedLine">        produces = {MediaType.APPLICATION_JSON_VALUE})</div><div class="FixedLine">    public ResponseEntity&lt;List&lt;Product&gt;&gt; getAllProducts() {</div></div><div class="LineGroup"><div class="FixedLine">        List&lt;Product&gt; productList =</div><div class="FixedLine">            productBusinessService.getAllProducts();</div><div class="FixedLine">        return new ResponseEntity&lt;</div><div class="FixedLine">            List&lt;Product&gt;&gt;(productList, HttpStatus.OK);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-26</span><p class="SimplePara">REST Based HTTP Port for getAllProducts Product Web (ch03\ch03-03\02-ProductWeb\src\main\java\com\acme\ecom\product\controller\ProductRestController.java)</p></div></div></div></div>

          <div class="Para" id="Par96">The notable aspect in the Product Web microservice is that it delegates all calls to a <span class="EmphasisFontCategoryNonProportional ">ProductBusinessService.</span> Here, the <span class="EmphasisFontCategoryNonProportional ">ProductRestController</span> is an application service class, whereas the <span class="EmphasisFontCategoryNonProportional ">ProductBusinessService</span> is a business service class. The rest of the methods in the <span class="EmphasisFontCategoryNonProportional ">ProductRestController</span> are not repeated here for brevity. Listing <span class="InternalRef"><a href="#PC28">3-27</a></span> inspects the <span id="ITerm37">business service class</span>.<div class="ProgramCode" id="PC28"><div class="LineGroup"><div class="FixedLine">@Service</div><div class="FixedLine">public class ProductBusinessService{</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${acme.PRODUCT_SERVICE_BY_CAT_URL}")</div><div class="FixedLine">    private String PRODUCT_SERVICE_BY_CAT_URL;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${acme.PRODUCT_CATEGORY_URL}")</div><div class="FixedLine">    private String PRODUCT_CATEGORY_URL;</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    private RestTemplate restTemplate;</div></div><div class="LineGroup"><div class="FixedLine">    public List&lt;Product&gt; getProductsForCategory(String name) {</div></div><div class="LineGroup"><div class="FixedLine">        ParameterizedTypeReference&lt;List&lt;Product&gt;&gt;</div><div class="FixedLine">            responseTypeRef = new ParameterizedTypeReference&lt;</div><div class="FixedLine">                List&lt;Product&gt;&gt;() {};</div><div class="FixedLine">        ResponseEntity&lt;List&lt;Product&gt;&gt; entity =</div><div class="FixedLine">            restTemplate.exchange(</div><div class="FixedLine">                PRODUCT_SERVICE_BY_CAT_URL + "/" + name,</div><div class="FixedLine">                HttpMethod.GET, (HttpEntity&lt;Product&gt;) null,</div><div class="FixedLine">                responseTypeRef);</div><div class="FixedLine">        List&lt;Product&gt; productList = entity.getBody();</div><div class="FixedLine">        return productList;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    public ProductCategory getProductCategory(</div><div class="FixedLine">            String productCategoryName) {</div></div><div class="LineGroup"><div class="FixedLine">        String uri = PRODUCT_CATEGORY_URL + "/" +</div><div class="FixedLine">            productCategoryName;</div><div class="FixedLine">        ProductCategory productCategory =</div><div class="FixedLine">            restTemplate.getForObject(uri,</div><div class="FixedLine">                ProductCategory.class);</div><div class="FixedLine">        return productCategory;</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-27</span><p class="SimplePara">The Product Business Service (ch03\ch03-03\02-ProductWeb\src\main\java\com\acme\ecom\product\service\ ProductBusinessService.java)<span id="ITerm38"></span></p></div></div></div></div>

          <p class="Para" id="Par97"><span class="EmphasisFontCategoryNonProportional ">@Service</span> annotates classes at the service layer, which are special cases of <span class="EmphasisFontCategoryNonProportional ">@Component</span>. You may mark the beans with <span class="EmphasisFontCategoryNonProportional ">@Service</span> to indicate that they’re holding the business logic. The typical implementation pattern within the product business service is shown in Listing <span class="InternalRef"><a href="#PC28">3-27</a></span>. You can see that the calls are directed to the respective methods in the Product Server microservice.</p>

          <div class="Para" id="Par98">You have now come to the <span id="ITerm39">GraphQL implementation</span>. GraphQL should have a schema describing the API. You need to have these .<span class="EmphasisFontCategoryNonProportional ">graphqls</span> or <span class="EmphasisFontCategoryNonProportional ">.gqls</span> schema files under the <span class="EmphasisFontCategoryNonProportional ">src/main/resources/graphql/**</span> location so that Spring Boot can pick them up automatically. See Listing <span class="InternalRef"><a href="#PC29">3-28</a></span>.<div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine">type Product {</div><div class="FixedLine">    productId: ID!</div><div class="FixedLine">    name: String!</div><div class="FixedLine">    code: String!</div><div class="FixedLine">    title: String!</div><div class="FixedLine">    price: Float!</div><div class="FixedLine">    productCategory: ProductCategory!</div><div class="FixedLine">}</div></div><div class="LineGroup"><div class="FixedLine">type ProductCategory {</div><div class="FixedLine">    id: ID!</div><div class="FixedLine">    name: String!</div><div class="FixedLine">    title: String!</div><div class="FixedLine">    description: String!</div><div class="FixedLine">    imgUrl: String!</div><div class="FixedLine">    products: [Product]!</div><div class="FixedLine">}</div></div><div class="LineGroup"><div class="FixedLine"># The Root Query for the application</div><div class="FixedLine">type Query {</div><div class="FixedLine">    products(count: Int, offset: Int): [Product]!</div><div class="FixedLine">}</div></div><div class="LineGroup"><div class="FixedLine"># The Root Mutation for the application</div><div class="FixedLine">type Mutation {</div><div class="FixedLine">    writeProduct(name: String!, code: String!, title: String!, price: Float!, category: String!) : Product!</div><div class="FixedLine">}<span id="ITerm40"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-28</span><p class="SimplePara">The Product GraphQL Schema (ch03\ch03-03\02-ProductWeb\src\main\resources\graphql\schema.graphqls)</p></div></div></div></div>

          <p class="Para" id="Par99">This scheme is made up of type definitions. Each type has one or more fields, which each take zero or more arguments and return a specific type. The <span class="EmphasisFontCategoryNonProportional ">!</span> at the end of some names indicates that they are non-nullable types. The graph shows the way these fields are nested with each other.</p>

          <p class="Para" id="Par100">The GraphQL schema in Listing <span class="InternalRef"><a href="#PC29">3-28</a></span> is for the Product definitions, describing a product, a category of the product, and a root query to get the most recently added products. There must be exactly one root query, and up to one root mutation. The root query needs to have special beans defined in the Spring context to handle the various fields in this root query.</p>

          <div class="Para" id="Par101">Next, you need to resolve the <span id="ITerm41">root query</span>. As stated, it needs to have specially annotated methods to handle the various fields. You do this by annotating the handler methods with <span class="EmphasisFontCategoryNonProportional ">@QueryMapping</span> annotations and then placing them inside standard <span class="EmphasisFontCategoryNonProportional ">@Controller</span> components in the application. This registers the annotated classes as data-fetching components in the GraphQL application, as shown in Listing <span class="InternalRef"><a href="#PC30">3-29</a></span>.<div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine">@Controller</div><div class="FixedLine">public class ProductGraphQLController {</div></div><div class="LineGroup"><div class="FixedLine">    private ProductDao productDao;</div><div class="FixedLine">    private ProductCategoryDao productCategoryDao;</div></div><div class="LineGroup"><div class="FixedLine">    public ProductGraphQLController(ProductDao productDao,</div><div class="FixedLine">            ProductCategoryDao productCategoryDao) {</div></div><div class="LineGroup"><div class="FixedLine">        this.productDao = productDao;</div><div class="FixedLine">        this.productCategoryDao = productCategoryDao;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @QueryMapping</div><div class="FixedLine">    public List&lt;Product&gt; products(@Argument int count,</div><div class="FixedLine">            @Argument int offset) {</div></div><div class="LineGroup"><div class="FixedLine">        return productDao.getProducts(count, offset);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-29</span><p class="SimplePara">The <span id="ITerm42">Root Query</span> Resolver (/ch03/ch03-03/02-ProductWeb/src/main/java/com/acme/ecom/product/controller/ ProductGraphQLController.java)</p></div></div></div></div>

          <p class="Para" id="Par102">As you can see, I define the method products, which I’ll use to handle any GraphQL queries for the <span class="EmphasisFontCategoryNonProportional ">Products</span> field in the schema defined earlier. The method should also have parameters annotated with <span class="EmphasisFontCategoryNonProportional ">@Argument</span> that correspond to the related parameters in the schema. The method must return the right return type for the type in the GraphQL scheme. You can use any simple types like <span class="EmphasisFontCategoryNonProportional ">Int</span>, <span class="EmphasisFontCategoryNonProportional ">String</span>, <span class="EmphasisFontCategoryNonProportional ">List</span>, and so on, with the equivalent Java types, and the GraphQL runtime just maps them automatically.</p>

          <div class="Para" id="Par103">Any complex type in the GraphQL server is represented by a corresponding Java bean. The same Java class will always represent the same GraphQL type. Any fields or methods on the Java bean that don’t map onto the GraphQL schema will be silently ignored without causing any problems. In this case, <span class="EmphasisFontCategoryNonProportional ">Product</span> and <span class="EmphasisFontCategoryNonProportional ">ProductCategory</span> are both non-trivial to load. Hence the <span class="EmphasisFontCategoryNonProportional ">@SchemaMapping</span> annotation maps the handler method to a field with the same name in the schema and uses it as the <span class="EmphasisFontCategoryNonProportional ">DataFetcher</span><span id="ITerm43"></span> for that field, as shown in Listing <span class="InternalRef"><a href="#PC31">3-30</a></span>.<div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine">@Controller</div><div class="FixedLine">public class ProductGraphQLController {</div></div><div class="LineGroup"><div class="FixedLine">    @SchemaMapping</div><div class="FixedLine">    public ProductCategory productCategory(Product product) {</div></div><div class="LineGroup"><div class="FixedLine">        return productCategoryDao.getProductCategory(</div><div class="FixedLine">            product.getCategory());</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @SchemaMapping</div><div class="FixedLine">    public List&lt;Product&gt; products(</div><div class="FixedLine">            ProductCategory productCategory) {</div></div><div class="LineGroup"><div class="FixedLine">        return productDao.getProductsForCategory(</div><div class="FixedLine">            productCategory.getName());</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-30</span><p class="SimplePara">The Root Query Resolver (/ch03/ch03-03/02-ProductWeb/src/main/java/com/acme/ecom/product/controller/ ProductGraphQLController.java)</p></div></div></div></div>

          <p class="Para" id="Par104">If the client doesn’t request a field explicitly, the GraphQL Server won’t do the work to retrieve it. In this case, if the client retrieves a product and doesn’t ask for the <span class="EmphasisFontCategoryNonProportional ">ProductCategory</span> field, the <span class="EmphasisFontCategoryNonProportional ">productCategory()</span> method won’t be executed, and the <span class="EmphasisFontCategoryNonProportional ">productCategoryDao</span> call won’t be made.</p>

          <div class="Para" id="Par105">Listing <span class="InternalRef"><a href="#PC32">3-31</a></span> shows the <span id="ITerm44">Data Fetcher class</span>.<div class="ProgramCode" id="PC32"><div class="LineGroup"><div class="FixedLine">public class ProductDao {</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    private ProductBusinessService productBusinessService;</div></div><div class="LineGroup"><div class="FixedLine">    public List&lt;Product&gt; getProducts(int count, int offset) {</div></div><div class="LineGroup"><div class="FixedLine">        List&lt;Product&gt; productList =</div><div class="FixedLine">            productBusinessService.getAllProducts();</div><div class="FixedLine">        return productList.stream().skip(offset).</div><div class="FixedLine">            limit(count).collect(Collectors.toList());</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-31</span><p class="SimplePara">Product Data Fetcher (/ch03/ch03-03/02-ProductWeb/src/main/java/com/acme/ecom/product/graphql/ ProductDAO.java)</p></div></div></div></div>

          <p class="Para" id="Par106">This Data Fetcher delegates calls to the product business service you have already seen. You will later see that the instances of this product business service are pooled or reused regardless of through which port the client request is reaching the server.</p>

          <div class="Para" id="Par107">Once you have defined the abstract GraphQL based port, Spring Boot GraphQL Starter offers an elegant way to get a GraphQL server running, by defining the <span id="ITerm45">respective dependencies</span> in <span class="EmphasisFontCategoryNonProportional ">pom.xml</span>, as shown in Listing <span class="InternalRef"><a href="#PC33">3-32</a></span>.<div class="ProgramCode" id="PC33"><div class="LineGroup"><div class="FixedLine">&lt;dependencies&gt;</div><div class="FixedLine">    &lt;dependency&gt;</div><div class="FixedLine">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="FixedLine">        &lt;artifactId&gt;spring-boot-starter-graphql&lt;/artifactId&gt;</div><div class="FixedLine">    &lt;/dependency&gt;</div></div><div class="LineGroup"><div class="FixedLine">    &lt;dependency&gt;</div><div class="FixedLine">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="FixedLine">        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div class="FixedLine">    &lt;/dependency&gt;</div><div class="FixedLine">&lt;/dependencies&gt;<span id="ITerm46"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-32</span><p class="SimplePara">The Product Web Microservice Maven Dependency (ch03\ch03-03\02-ProductWeb\pom.xml)</p></div></div></div></div>

          <p class="Para" id="Par108">GraphQL is transport-agnostic. Hence I’ve included the web starter in this config. This will expose the GraphQL API over HTTP using Spring MVC on the default <span class="EmphasisFontCategoryNonProportional ">/graphql</span> endpoint.</p>

          <div class="Para" id="Par109">GraphQL also has a nice companion UI tool called GraphiQL. This UI can communicate with any GraphQL-compliant server and execute queries and mutations against it. See Figure <span class="InternalRef"><a href="#Fig3">3-3</a></span>.<figure class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img alt="" aria-describedby="d64e2898" src="../images/619782_1_En_3_Chapter/Imagem-029.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2898"><p class="Para" id="Par135">A screenshot of the Graphi Q L browser tab has a toolbar with the play, prettify, history, and docs buttons at the top followed by a 28-line code below. It gives the welcome message followed by a description of Graphi Q L and an example of a query with field and subfield functions along with the keyboard shortcuts.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 3-3</span><p class="SimplePara">GraphiQL query <span id="ITerm47">browser</span></p></div></figcaption></figure></div>

          <div class="Para" id="Par110">Lastly, you need to configure the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC34">3-33</a></span>.<div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine">spring:</div><div class="FixedLine">    application:</div><div class="FixedLine">        name: product-web</div><div class="FixedLine">    graphql:</div><div class="FixedLine">        graphiql:</div><div class="FixedLine">            enabled: true</div><div class="FixedLine">server:</div><div class="FixedLine">    port: 8080</div><div class="FixedLine">acme:</div><div class="FixedLine">    PRODUCT_SERVICE_URL: http://localhost:8081/products</div><div class="FixedLine">    PRODUCT_CATEGORY_URL: http://localhost:8081/category</div><div class="FixedLine">    PRODUCT_SERVICE_BY_CAT_URL: http://localhost:8081/productsbycat</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-33</span><p class="SimplePara">The Product Web Microservice Configuration (ch03\ch03-03\02-ProductWeb\src\main\resources\application.yml)</p></div></div></div></div>

          <p class="Para" id="Par111">Most of these configurations here are trivial. What you need to look explicitly at is the GraphQL’s companion tool, GraphiQL. This UI tool can communicate with any GraphQL Server and helps to develop and consume against a GraphQL API. Spring GraphQL comes with a default GraphQL page that is exposed at the <span class="EmphasisFontCategoryNonProportional ">/graphiql</span> endpoint. This endpoint is disabled by default, but it can be turned on by enabling the <span class="EmphasisFontCategoryNonProportional ">spring.graphql.graphiql.enabled</span> property, which is done in Listing <span class="InternalRef"><a href="#PC34">3-33</a></span>. This works as a quick but neat in-browser way to write and test queries, particularly during development and <span id="ITerm48">testing</span>.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec20">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par112">The <span class="EmphasisFontCategoryNonProportional ">ch03\ch03-03</span> folder contains the Maven scripts required to build these examples. As a first step, you need to bring up the MongoDB server. Refer to Appendix B to learn how to set up MongoDB server and bring it up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC35">3-34</a></span> to bring up MongoDB.<div class="ProgramCode" id="PC35"><div class="LineGroup"><div class="FixedLine">(base) binildass-MBP:bin binil$ pwd</div><div class="FixedLine">/Users/binil/Applns/mongodb/mongodb-macos-x86_64-4.2.8/bin</div><div class="FixedLine">(base) binildass-MBP:bin binil$ mongod --dbpath /usr/local/var/mongodb --logpath /usr/local/var/log/mongodb/mongo.log</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-34</span><p class="SimplePara">Bringing Up the MongoDB Server</p></div></div></div></div>

          <div class="Para" id="Par113">Next, take two command terminals and change the directory to the top-level folder of both microservices. Then, build and <span id="ITerm49">run</span> the Product Server microservice using the <span class="EmphasisFontCategoryNonProportional ">make.sh</span> and <span class="EmphasisFontCategoryNonProportional ">run.sh</span> scripts, as shown in Listing <span class="InternalRef"><a href="#PC36">3-35</a></span>.<div class="ProgramCode" id="PC36"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch03/ch03-03/01-ProductServer</div><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$</div></div><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-21 20:44:22 INFO  Startup.log:50 - Starting EcomProd</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-21 20:44:23 INFO  InitComponent.init:47 - Start...</div><div class="FixedLine">2024-01-21 20:44:23 DEBUG InitComponent.init:51 – Delete…</div><div class="FixedLine">2024-01-21 20:44:23 DEBUG InitComponent.init:56 – Create…</div><div class="FixedLine">2024-01-21 20:44:23 INFO  InitComponent.init:105 - End</div><div class="FixedLine">2024-01-21 20:44:24 INFO  Startup.log:56 - Started EcomProd</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-35</span><p class="SimplePara">Build and Run Product Server Microservice Using Scripts</p></div></div></div></div>

          <div class="Para" id="Par114">Next, build and run the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC37">3-36</a></span>.<div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch03/ch03-03/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$</div></div><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh run.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-21 20:46:04 INFO  Startup.log:50 - Starting EcomProd</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-21 20:46:05 INFO  InitComponent.init:37 - Start</div><div class="FixedLine">2024-01-21 20:46:05 DEBUG InitComponent.init:39 - Do Nothing</div><div class="FixedLine">2024-01-21 20:46:05 INFO  InitComponent.init:41 - End</div><div class="FixedLine">2024-01-21 20:46:06 INFO  Startup.log:56 - Started EcomProd….</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-36</span><p class="SimplePara">Build and Run Product Web Microservice Using Scripts</p></div></div></div></div>

          <p class="Para" id="Par115">Now that both microservices are up and running, you can test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec21">

          <h3 class="Heading">Testing the Microservice</h3>

          <div class="Para" id="Par116">Once both microservices are up and <span id="ITerm50">running</span>, you can inspect your MongoDB server using the Mongo terminal to make sure the Product Server microservice inserted a few products into the MongoDB server during the microservice startup. See Listing <span class="InternalRef"><a href="#PC38">3-37</a></span>.<div class="ProgramCode" id="PC38"><div class="LineGroup"><div class="FixedLine">&gt; db.productOR.find()</div><div class="FixedLine">{ "_id" : ObjectId("61a71908b1690955cc51afff"), "name" : "Kamsung Mobile", "code" : "KAMSUNG-TRIOS", "title" : "Tablet Trios 12 inch , black , 12 px ....", "price" : 12000, "category" : "Mobile", "_class" : "com.acme.ecom.product.model.ProductOR" }</div><div class="FixedLine">{ "_id" : ObjectId("61a71908b1690955cc51b000"), "name" : "Lokia Mobile", "code" : "LOKIA-POMIA", "title" : "Lokia 12 inch , white , 14px ....", "price" : 9000, "category" : "Mobile", "_class" : "com.acme.ecom.product.model.ProductOR" }</div><div class="FixedLine">{ "_id" : ObjectId("61a71908b1690955cc51b001"), "name" : "Mapple Mobile", "code" : "MAPPLE-EPHONE", "title" : "Mapple 7 inch, purple, 14px ....", "price" : 8000, "category" : "Mobile", "_class" : "com.acme.ecom.product.model.ProductOR" }</div><div class="FixedLine">{ "_id" : ObjectId("61a71908b1690955cc51b002"), "name" : "Mapple Tablet", "code" : "MAPPLE-PAD", "title" : "Mapple 11 inch , grey, 140px ....", "price" : 19000, "category" : "Tablet", "_class" : "com.acme.ecom.product.model.ProductOR" }</div><div class="FixedLine">&gt; db.productCategoryOR.find()</div><div class="FixedLine">{ "_id" : ObjectId("61a71908b1690955cc51affd"), "name" : "Mobile", "title" : "Mobiles and Tablet", "description" : "Mobile phones", "imgUrl" : "mobile.jpg", "_class" : "com.acme.ecom.product.model.ProductCategoryOR" }</div><div class="FixedLine">{ "_id" : ObjectId("61a71908b1690955cc51affe"), "name" : "Tablet", "title" : "Tablet like pads", "description" : "Tablet pads", "imgUrl" : "tablet.jpg", "_class" : "com.acme.ecom.product.model.ProductCategoryOR" }</div><div class="FixedLine">&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-37</span><p class="SimplePara">Inspecting MongoDB Server Using a Mongo Shell</p></div></div></div></div>

          <p class="Para" id="Par117">When all is set, you can access the web application using your browser. Point to this URL:</p>

          <p class="Para ParaOneEmphasisChild" id="Par118"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/product.html</span></p>

          <p class="Para" id="Par119">To test the CRUD operations, follow the instructions described in the subsection, “Test the Microservices Using UI” in the last section of Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span>, titled “Your First Java Microservice.” Before you try to test more methods, let’s pause to inspect a few other aspects.</p>

          <div class="Para" id="Par120">When you fire this URL in the browser, you need to pay attention to the Product Web microservice terminal, as shown in Listing <span class="InternalRef"><a href="#PC39">3-38</a></span>.<div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine">...</div><div class="FixedLine">2024-01-21 20:47:47 INFO  ProductRestController.getAllProducts:70 - Start</div><div class="FixedLine">2024-01-21 20:47:47 INFO  ProductBusinessService.getAllProducts:64 - Start. I am instance: com.acme.ecom.product.service.<strong class="EmphasisTypeBold ">ProductBusinessService@528729a9</strong></div><div class="FixedLine">2024-01-21 20:47:47 INFO  ProductBusinessService.getAllProducts:69 - Ending...</div><div class="FixedLine">2024-01-21 20:47:47 INFO  ProductRestController.getAllProducts:74 - Ending...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-38</span><p class="SimplePara">Inspecting the Product Web Microservice Terminal</p></div></div></div></div>

          <p class="Para" id="Par121">As a next step, test the GraphQL based port.</p>

          <div class="Para" id="Par122">In a command terminal, execute a cURL <span id="ITerm51">command</span> targeted to the GraphQL port, as shown in Listing <span class="InternalRef"><a href="#PC40">3-39</a></span>.<div class="ProgramCode" id="PC40"><div class="LineGroup"><div class="FixedLine">curl --request POST 'localhost:8080/graphql' --header 'Content-Type: application/json' --data-raw '{"query":"query {products(count: 2, offset: 0) {productId name code}}"}'</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-39</span><p class="SimplePara">cURL Request to GraphQL Endpoint</p></div></div></div></div>

          <div class="Para" id="Par123">Again, you need to pay attention to the Product Web microservice terminal, as shown in Listing <span class="InternalRef"><a href="#PC41">3-40</a></span>.<div class="ProgramCode" id="PC41"><div class="LineGroup"><div class="FixedLine">...</div><div class="FixedLine">2024-01-21 20:51:05 INFO  ProductGraphQLController.products:54 - Start</div><div class="FixedLine">2024-01-21 20:51:05 INFO  ProductDao.getProducts:54 - Start</div><div class="FixedLine">2024-01-21 20:51:05 INFO  ProductBusinessService.getAllProducts:64 - Start. I am instance: com.acme.ecom.product.service.<strong class="EmphasisTypeBold ">ProductBusinessService@528729a9</strong></div><div class="FixedLine">2024-01-21 20:51:05 INFO  ProductBusinessService.getAllProducts:69 - Ending...</div><div class="FixedLine">2024-01-21 20:51:05 INFO  ProductDao.getProducts:56 - Ending...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-40</span><p class="SimplePara">Inspecting the Product Web Microservice Terminal</p></div></div></div></div>

          <p class="Para" id="Par124">As mentioned, you can see from the Product Web microservice terminal that the instances of the product business service are pooled or reused regardless of which port the client request is reaching the server.</p>

          <div class="Para" id="Par125">You can execute more variants of this request using the <span id="ITerm52">cURL commands</span> in Listing <span class="InternalRef"><a href="#PC42">3-41</a></span>.<div class="ProgramCode" id="PC42"><div class="LineGroup"><div class="FixedLine">curl --request POST 'localhost:8080/graphql' --header 'Content-Type: application/json' --data-raw '{"query":"query {products(count: 2, offset: 0) {productId code productCategory {id name title}}}"}'</div></div><div class="LineGroup"><div class="FixedLine">curl --request POST 'localhost:8080/graphql' --header 'Content-Type: application/json' --data-raw '{"query":"query {products(count: 2, offset: 0) {productId code productCategory {id name products {productId}}}}"}'</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 3-41</span><p class="SimplePara">More cURL Requests to GraphQL Endpoint</p></div></div></div></div>

          <p class="Para" id="Par126">Alternatively, access the GraphiQL UI from this URL:</p>

          <p class="Para ParaOneEmphasisChild" id="Par127"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/graphiql</span></p>

          <div class="Para" id="Par128">Fire this Request to get the response in the GraphiQL UI (see Figure <span class="InternalRef"><a href="#Fig4">3-4</a></span>):<div class="ProgramCode" id="PC43"><div class="LineGroup"><div class="FixedLine">{products(count: 2, offset: 0) {productId name code}}</div></div></div><figure class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img alt="" aria-describedby="d64e3277" src="../images/619782_1_En_3_Chapter/Imagem-030.jpg" style="width:31.7em"/><div class="TextObject" id="d64e3277"><p class="Para" id="Par136">A screenshot of the Graphi Q L browser tab has a toolbar at the top, and 2 sections below. The left section of query variables has a 2-line code with functions for products and product i d name code. The right section has several lines of code with functions for data, products, product i d, and others.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 3-4</span><p class="SimplePara">GraphiQL top-level <span id="ITerm53">query</span></p></div></figcaption></figure></div>

          <div class="Para" id="Par129">You can next fire the following Request to get a more detailed response in the GraphiQL UI (see Figure <span class="InternalRef"><a href="#Fig5">3-5</a></span>):<div class="ProgramCode" id="PC44"><div class="LineGroup"><div class="FixedLine">{products(count: 2, offset: 0) {productId code productCategory {id name title}}}</div></div></div><figure class="Figure" id="Fig5"><div class="MediaObject" id="MO5"><img alt="" aria-describedby="d64e3298" src="../images/619782_1_En_3_Chapter/Imagem-031.jpg" style="width:31.6em"/><div class="TextObject" id="d64e3298"><p class="Para" id="Par137">A screenshot of the Graphi Q L browser tab has a toolbar at the top, and 2 sections below. The left section of query variables has a 3-line code with functions for products, product i d code product category, and others. The right section has several lines of code with functions for data, products, product i d, code, product category, i d, and others.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 3-5</span><p class="SimplePara">GraphiQL first-level dependency query</p></div></figcaption></figure></div>

          <div class="Para" id="Par130">A further detailed response can be received in the GraphiQL UI by firing this request (see Figure <span class="InternalRef"><a href="#Fig6">3-6</a></span>):<div class="ProgramCode" id="PC45"><div class="LineGroup"><div class="FixedLine">{products(count: 2, offset: 0) {productId code productCategory {id name products {productId}}}}</div></div></div><figure class="Figure" id="Fig6"><div class="MediaObject" id="MO6"><img alt="" aria-describedby="d64e3319" src="../images/619782_1_En_3_Chapter/Imagem-032.jpg" style="width:31.62em"/><div class="TextObject" id="d64e3319"><p class="Para" id="Par138">A screenshot of the Graphi Q L browser tab has a toolbar at the top, and 2 sections below. The left section of query variables has a 4-line code with functions for products, product i d code, i d name, product i d, and others. The right section has several lines of code with functions for data, products, product i d, code, product category, and others.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 3-6</span><p class="SimplePara">GraphiQL second-level dependency query</p></div></figcaption></figure></div>

          <p class="Para" id="Par131">Observe the server-side logs when you execute these queries. It will be evident that the single query from the client device is mapped to multiple internal server side calls. If you alternate sending requests to the REST Controller and the GraphQL Controller that forms the outer onion rings, you can also identify from the server-side logs that the Service class (and for that matter, the entity classes) that forms the inner onion rings and their instances are being reused. Here, you have the Onion architecture in action!</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec22">

        <h2 class="Heading">Summary</h2>

        <p class="Para" id="Par132">I started this chapter by looking into how the pluggable nature of ports and adaptors comes into play in enterprise applications by showcasing the plugging in of a MongoDB in place of PostgreSQL. This plugin is a key characteristic of the hexagonal architecture. Next, you looked at the complementary nature of the hexagonal architecture and the Onion architecture. I demonstrated once again a flexible way of adding more ports in a hexagonal architecture so that the core of the application remains undisturbed. Equally important is the layered notion in the Onion architecture, where the outer layers depend on the inner layers, and as you move more and more toward the inner layers, you explore the core of the business domain where reusability of the core is a desirable objective. You should now have a solid understanding of the options available in the Microservices Architecture paradigm. You are now equipped to learn about the next-level concepts of events and messaging in microservices, which are covered in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>.</p>

      </section>

    </div>

  </div>

</body>

</html>