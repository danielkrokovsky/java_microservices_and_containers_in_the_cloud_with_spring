<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en">

<head>
  <title>Production Grade Message Oriented Microservices</title>
  <link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>

<body>

  <div epub:type="chapter" role="doc-chapter">

    <div class="ChapterContextInformation">

      <div class="ContextInformation" id="b979-8-8688-0555-4_6"><div class="ChapterCopyright">© The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature 2024</div><span class="ContextInformationAuthorEditorNames">B. A. Christudas</span><span class="ContextInformationBookTitles"><span class="BookTitle">Java Microservices and Containers in the Cloud</span></span><span class="ChapterDOI"><a href="https://doi.org/10.1007/979-8-8688-0555-4_6">https://doi.org/10.1007/979-8-8688-0555-4_6</a></span></div>

    </div>

    <!--Begin Abstract-->

    <div class="MainTitleSection">

      <h1 class="ChapterTitle" lang="en">6. Production Grade Message Oriented Microservices</h1>

    </div>

    <div class="AuthorGroup">

      <div class="AuthorNames"><span class="Author"><span class="AuthorName">Binildas A. Christudas</span><sup><a href="#Aff2">1</a> <span class="ContactIcon"> </span></sup></span></div>

      <div class="Affiliations">

        <div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">NBCRA 45, Christbin, Thiruvananthapuram, Kerala, India</div></div>

        <div class="ClearBoth"> </div>

      </div>

    </div>

    <!--End Abstract-->

    <div class="Fulltext">

      <p class="Para" id="Par2"><span id="ITerm1"></span>Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span> explained how messaging middleware can play a key role in providing a bridge for microservices to communicate with each other in a loosely coupled manner. Messaging channels are typically characterized by the asynchronous style of interaction, but Chapters <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span> and <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span> attempted to show how a synchronous user experience can be attained, even over asynchronous messaging channels. This is the first step in providing confidence that loosely coupled, messaging-based microservice interactions can be leveraged to implement many, if not all, your functional use cases. As mentioned in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span>, many engineers are still skeptical on whether they can use events and the event paradigm for inter-microservices communication in a synchronous manner to implement a full data management paradigm. This chapter attempts to address that skepticism.</p>

      <p class="Para" id="Par3">This chapter is fully hands on, with examples. An overview and working experience with the examples in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span> is required for you to quickly understand the enhanced examples in this chapter.</p>

      <div class="Para" id="Par4">This chapter covers the following <span id="ITerm2">concepts</span>:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par5">Protocols and message formats for message exchange</p></li><li><p class="Para" id="Par6">Full CRUD (create, read, update, delete) functionality across microservices using Kafka in between</p></li><li><p class="Para" id="Par7">CRUD using MongoDB and PostgreSQL DB</p></li><li><p class="Para" id="Par8">A quick look at a few integration-patterns</p></li></ul></div></div>

      <section class="Section1 RenderAsSection1" id="Sec1">

        <h2 class="Heading">Inter-Microservices Wire Level Options</h2>

        <p class="Para" id="Par9">There are pros and cons when we talk about message-oriented microservices. One of the main aspects relates to the inter-microservice <span id="ITerm3">communication</span> format options. Let’s investigate those in the next section.</p>

        <section class="Section2 RenderAsSection2" id="Sec2">

          <h3 class="Heading">XML-RPC and SOAP</h3>

          <p class="Para" id="Par10"><span id="ITerm4">XML-RPC and SOAP</span> have been the cornerstone of remote service invocation using web services for more than a decade. A web service is described by a WSDL (Web Services Description <span id="ITerm5">Language</span>) document, which acts as the contract between the service provider and service consumer. A WSDL document describes how the web service is bound to a messaging protocol—in the case of the web services, the SOAP protocol.</p>

          <div class="Para" id="Par11">A WSDL SOAP binding can be either an RPC-oriented binding or a document-oriented binding.<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par12"><strong class="EmphasisTypeBold ">RPC-oriented style:</strong> Web services that use the RPC (Remote Procedure Call)-oriented style are interface-driven. Here the client applications invoke a <span id="ITerm6">web service method</span> (call a remote procedure) by sending parameter values of the request and receiving parameter values of the response. The body of the SOAP request includes a wrapper XML element for this method. The parameters of this method are embedded as child elements inside this wrapper element.</p></li><li><p class="Para" id="Par13"><strong class="EmphasisTypeBold ">Document-oriented style:</strong> Web services that use the <span id="ITerm7">document-oriented style</span> are document (more precisely, XML document) driven. Here, the client applications send parameters to the web service as XML documents, instead of as discrete sets of parameter values. The body of the SOAP request and response messages contain one or more XML documents. The document-oriented style is flatter than the RPC-oriented style and does not require the use of wrapper elements.</p></li></ul></div></div>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec3">

          <h3 class="Heading">REST and JSON-RPC</h3>

          <p class="Para" id="Par14">In the recent past, whenever somebody wanted to start building an HTTP API, they pretty much exclusively used REST as the de facto architectural style, over alternative approaches such as XML-RPC and SOAP. REST specifies a client-server relationship, where server-side data is made available through representations of data in simple formats, often JSON and XML. These representations for resources or collections of resources are then potentially modifiable, with actions or more precisely with HTTP actions. Relationships between data are made discoverable via a method known as <em class="EmphasisTypeItalic ">hypermedia</em>. <span id="ITerm8">Hypermedia</span> is fundamental to REST and is essentially just the concept of providing links to other resources. In the section titled “HATEOAS and HAL” in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span>, you have learned about this.</p>

          <p class="Para" id="Par15"><span id="ITerm9">JSON-RPC</span> is a remote procedure call protocol encoded in JSON. It is like the XML-RPC protocol, defining only a few data types and commands. JSON-RPC allows for notifications (data sent to the server that does not require a response) and for multiple calls to be sent to the server, which may be answered asynchronously.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec4">

          <h3 class="Heading">RPC vs. Messaging</h3>

          <p class="Para" id="Par16">The fundamental difference between these two protocols is that an RPC framework is synchronous. You make a call, and you aren’t done until you receive the response. Messaging on the other hand is asynchronous. You send the message, and either you don’t expect a response, or you don’t know when it will come back, if at all!</p>

          <p class="Para" id="Par17">If your caller needs information from a response from the service(s) you are requesting or calling, you should use an RPC, because you can’t return to your caller until you have the information you need from the provider. If your caller doesn’t need information from a downstream service, you can use <span id="ITerm10">messaging</span>. Fire your message and forget it, since you are not expecting (rather, cannot expect) to receive a response.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec5">

          <h3 class="Heading">RPC Style Messaging</h3>

          <p class="Para" id="Par18">As described, a messaging paradigm tries to enforce a fire-and-forget messaging <span id="ITerm11">style</span>, but it is possible to use properly designed message queues to perform and mimic RPC, as explained in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span>. Figure <span class="ExternalRef"><a href="Capítulo-07.html#Fig7"><span class="RefSource">5-7</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span> depicts different reply channels for microservice communications, whereas Figure <span class="ExternalRef"><a href="Capítulo-07.html#Fig8"><span class="RefSource">5-8</span></a></span> depicts different reply partitions for microservices communicating with each other. In both scenarios, you can simulate synchronous style request-responses between participating microservices across messaging channels.</p>

          <p class="Para" id="Par19">Unlike with the XML-RPC or SOAP scenario, when microservices communicate over plain messaging channels, they are not hard bound to a strict message invocation schema—a WSDL kind of mechanism which acts as the contract between the service provider and service consumer is missing. Hence, you need to weave a mechanism to specify “what action to perform.” HTTP provides standard verbs to provide semantic meaning for the intention of the action being taken.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec6">

          <h3 class="Heading">HTTP Methods for CRUD on Resources</h3>

          <p class="Para" id="Par20">RPC-based APIs are great for actions (that is, procedures or commands), whereas REST-based APIs are great for modeling your domain (that is, resources or entities), making CRUD (create, read, update, <span id="ITerm12">delete</span>) available for all your data. REST uses <span id="ITerm13">HTTP methods</span> such as GET, POST, PUT, DELETE, OPTIONS and, hopefully, PATCH, to provide semantic meaning for the intention of the action being taken.</p>

          <div class="Para" id="Par21">The main methods in HTTP you can leverage for implementing REST are listed here:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par22">GET: GET is the simplest HTTP operation and its intention is to retrieve a resource from the server. 200 OK is the status code for a successful operation. All GET operations should be <em class="EmphasisTypeItalic ">idempotent</em>, which means regardless of how many times you repeat the operation with the same parameters, there should not be any change in state for the resource.</p></li><li><p class="Para" id="Par23">POST: HTTP POST provides an option for clients to send information to the server. POST is recommended for creating a new resource (even though it can also update an existing resource).</p></li><li><p class="Para" id="Par24">PUT:<sup><a epub:type="noteref" href="#Fn1" id="Fn1_source" role="doc-noteref">1</a></sup> HTTP PUT also provides an option for clients to send information to the server; however, the usage semantics of PUT are slightly different from that of POST, as per HTTP. Using PUT, you can send a “new object” to the server to be placed at a location in the server represented by the URI, so the intent should be to replace the resource with a new one. A PUT request is idempotent as far as a single client is concerned. If only a subset of data elements is provided in a PUT request, the rest will be replaced with empty or null.</p></li><li><p class="Para" id="Par26">DELETE: DELETE allows clients to remove a resource from the server. The URI identifies the resource to be deleted. The resource may not have to be removed immediately; instead, it can be done by an asynchronous or long-running operation behind the scenes.</p></li></ul></div></div>

          <p class="Para" id="Par27">REST is not only CRUD, but things are done through mainly CRUD-based operations.</p>

          <p class="Para" id="Par28">RPC, however, does not strictly follow standard HTTP verbs. Most use only GET and POST, with GET being used to retrieve information and POST being used for everything else. It is common to see RPC APIs using something like POST <span class="EmphasisFontCategoryNonProportional ">/deleteBar</span>, with a body of <span class="EmphasisFontCategoryNonProportional ">{ "id": 10 }</span>, instead of the REST approach, which would be DELETE <span class="EmphasisFontCategoryNonProportional ">/bars/10</span>.</p>

          <p class="Para" id="Par29">JSON (JavaScript Object <span id="ITerm14">Notation</span>) is an open standard file format and data interchange format that uses human-readable text to store and transmit data objects consisting of attribute–value pairs and arrays (or other serializable values). If you want to continue using this format, instead of sync style HTTP transport, you can use async style messaging transport. But when you don’t use standard HTTP, you miss the opportunity to use standard HTTP verbs and any of their associated advantages.</p>

          <p class="Para" id="Par30">The next section looks at two examples demonstrating a few of these discission items. Specifically, we will adhere to REST for the end point APIs and we will attempt to stick to JSON for inter-microservice communication over Kafka.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec7">

        <h2 class="Heading">CRUD Microservices Over Kafka on MongoDB</h2>

        <p class="Para" id="Par31">This example tweaks the same set of microservices in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span>. A consumer and a provider microservice communicate with each other using Kafka as the messaging channel. The provider microservice stores the entity in a MongoDB <span id="ITerm15">database</span>. Moreover, when the browser sends the request to the first (consumer) microservice, it uses async HTTP. Even though it uses async HTTP, the example emulates a sync-style user experience at the browser level.</p>

        <p class="Para" id="Par32">As with the example in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span>, this example is demonstrated with multiple instances of the consumer and provider microservices, and it uses multiple clients while testing the service.</p>

        <p class="Para" id="Par33">This example introduces a new functional feature. It emulates a full CRUD (Create, Read, Update and Delete) feature through the microservice interactions, using Kafka as the messaging channel.</p>

        <section class="Section2 RenderAsSection2" id="Sec8">

          <h3 class="Heading">Design CRUD Over Async Channel on MongoDB</h3>

          <div class="Para" id="Par34">This example uses the modified version of the hexagonal microservice view shown in Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span>, which you also visited in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span>, so that both microservices communicate through an async channel. Apache Kafka is used as the messaging channel, which is inherently asynchronous. The <span id="ITerm16">objectives</span> of this example are multifold:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par35">To invoke synchronous-style communication over the Kafka-based async channel.</p></li><li><p class="Para" id="Par36">To demonstrate that multiple consumer types or multiple instances of the same consumer type can connect to one or more instances of the provider microservice and still receive the right responses corresponding to the respective request alone.</p></li><li><p class="Para" id="Par37">To demonstrate that the full set of CRUD actions can be orchestrated over the async channel.</p></li><li><p class="Para" id="Par38">To provide a sync-style experience to the users at the browser end, even though the example uses async HTTP.</p></li><li><p class="Para" id="Par39">To demonstrate that the browser can consume from fully compliant HATEOAS interfaces.</p></li></ul></div><figure class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img alt="" aria-describedby="d64e489" src="../images/619782_1_En_6_Chapter/Imagem-064.jpg" style="width:35.15em"/><div class="TextObject" id="d64e489"><p class="Para" id="Par151">A microservice design has the following components. User. Browser. REST A P I. Product web microservice instances. Product server microservice instances.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 6-1</span><p class="SimplePara">Microservice design over async channel using partitions</p></div></figcaption></figure></div>

          <p class="Para" id="Par40">As shown in Figure <span class="InternalRef"><a href="#Fig1">6-1</a></span>, this example will leverage <span id="ITerm17">Kafka partitions</span> as the main concurrency mechanism in the async channel between the microservices. This async topic is divided into one or more partitions, five in this case, enabling the producer and consumer loads to be scaled. The consumers are shared evenly across the partitions, allowing for the consumer load to be linearly scaled by increasing the provider instances and their provisioned partitions.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec9">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par41">The <span id="ITerm18">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch06\ch06-01</span> folder. Much of the source code for this example is similar to that in <span class="EmphasisFontCategoryNonProportional ">ch05\ch05-01</span>. I explained in detail how to set up consumer and provider microservices that communicate with each other using a messaging channel. This section covers only the changes.</p>

          <div class="Para" id="Par42">The main class to inspect is a new container class for the <span class="EmphasisFontCategoryNonProportional ">Product</span> <span id="ITerm19">entity</span> (see Listing <span class="InternalRef"><a href="#PC1">6-1</a></span>), which has the following functions:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par43">Acts as a container to transport collections of resources between microservices</p></li><li><p class="Para" id="Par44">Acts as a schema specification</p></li></ul></div></div>

          <div class="Para" id="Par45">

            <div class="ProgramCode" id="PC1">

              <div class="LineGroup">

                <div class="FixedLine">public class Products {</div>

              </div>

              <div class="LineGroup">

                <div class="FixedLine">    public static final String CREATE = "Create";</div>

                <div class="FixedLine">    public static final String DELETE = "Delete";</div>

                <div class="FixedLine">    public static final String DELETE_ALL = "Delete_All";</div>

                <div class="FixedLine">    public static final String UPDATE = "Update";</div>

                <div class="FixedLine">    public static final String RETREIVE_ALL = "Retreive_All";</div>

                <div class="FixedLine">    public static final String RETREIVE_DETAILS =</div>

                <div class="FixedLine">        "Retreive_Details";</div>

              </div>

              <div class="LineGroup">

                <div class="FixedLine">    public static final String SUCCESS = "Success";</div>

                <div class="FixedLine">    public static final String FAILURE = "Failure";</div>

              </div>

              <div class="LineGroup">

                <div class="FixedLine">    private String operation;</div>

                <div class="FixedLine">    private List&lt;Product&gt; products;</div>

              </div>

              <div class="LineGroup">

                <div class="FixedLine">    public String getOperation() {</div>

                <div class="FixedLine">        return operation;</div>

                <div class="FixedLine">    }</div>

                <div class="FixedLine">    public void setOperation(String operation) {</div>

                <div class="FixedLine">        this.operation = operation;</div>

                <div class="FixedLine">    }</div>

              </div>

              <div class="LineGroup">

                <div class="FixedLine">    public List&lt;Product&gt; getProducts() {</div>

                <div class="FixedLine">        return products;</div>

                <div class="FixedLine">    }</div>

                <div class="FixedLine">    public void setProducts(List&lt;Product&gt; products) {</div>

                <div class="FixedLine">        this.products = products;</div>

                <div class="FixedLine">    }</div>

                <div class="FixedLine">}</div>

              </div>

              <div class="Caption" lang="en">

                <div class="CaptionContent"><span class="CaptionNumber">Listing 6-1</span><p class="SimplePara">The Container Class for Product Entity (ch06\ch06-01\02-ProductWeb\src\main\java\com\acme\ecom\product\model\Products.java)</p></div>

              </div>

            </div>

          </div>

          <p class="Para" id="Par46">The <span class="EmphasisFontCategoryNonProportional ">Products</span> class lists counterparts for CRUD HTTP verbs as constant literals. The <span class="EmphasisFontCategoryNonProportional ">attribute</span> operation is used to specify the action intended to be performed during the request phase. In the response phase, the same operation specifies the outcome of the request processing as “Success” or “Failure”. Next, the <span class="EmphasisFontCategoryNonProportional ">products</span> collection may contain one or more <span class="EmphasisFontCategoryNonProportional ">Product</span> entity. In the request phase, the <span class="EmphasisFontCategoryNonProportional ">products</span> attribute contains one <span class="EmphasisFontCategoryNonProportional ">Product</span> entity, whose attribute values correspond to the parameters of the operation to be performed. In the response phase of the operation, the same <span class="EmphasisFontCategoryNonProportional ">products</span> collection may contain one or more <span class="EmphasisFontCategoryNonProportional ">Product</span> entities corresponding to the response of the performed operation.</p>

          <p class="Para" id="Par47">This method of piggybacking the request and response parameters and operations as payload is not the best, most elegant way, but it does the job.</p>

          <div class="Para" id="Par48">Listing <span class="InternalRef"><a href="#PC2">6-2</a></span> shows the configuration class used by the Product Web microservice.<div class="ProgramCode" id="PC2"><div class="LineGroup"><div class="FixedLine">@Configuration</div><div class="FixedLine">public class KafkaConfig {</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public CompletableFutureReplyingKafkaOperations&lt;String,</div><div class="FixedLine">            Products, Products&gt; replyKafkaTemplate() {</div></div><div class="LineGroup"><div class="FixedLine">        CompletableFutureReplyingKafkaTemplate&lt;String,</div><div class="FixedLine">                Products, Products&gt;</div><div class="FixedLine">            requestReplyKafkaTemplate = new</div><div class="FixedLine">                CompletableFutureReplyingKafkaTemplate&lt;&gt;(</div><div class="FixedLine">                    requestProducerFactory(),</div><div class="FixedLine">                    replyListenerContainer());</div><div class="FixedLine">        requestReplyKafkaTemplate.setDefaultTopic(</div><div class="FixedLine">            requestTopic);</div><div class="FixedLine">        requestReplyKafkaTemplate.setDefaultReplyTimeout(</div><div class="FixedLine">            Duration.of(replyTimeout, ChronoUnit.MILLIS));</div><div class="FixedLine">        return requestReplyKafkaTemplate;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public ConsumerFactory&lt;String, Products&gt;</div><div class="FixedLine">            replyConsumerFactory() {</div></div><div class="LineGroup"><div class="FixedLine">        JsonDeserializer&lt;Products&gt; jsonDeserializer =</div><div class="FixedLine">            new JsonDeserializer&lt;&gt;();</div><div class="FixedLine">        jsonDeserializer.addTrustedPackages(</div><div class="FixedLine">            Products.class.getPackage().getName());</div><div class="FixedLine">        return new DefaultKafkaConsumerFactory&lt;&gt;(</div><div class="FixedLine">            consumerConfigs(), new StringDeserializer(),</div><div class="FixedLine">            jsonDeserializer);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public KafkaMessageListenerContainer&lt;String, Products&gt;</div><div class="FixedLine">            replyListenerContainer() {</div></div><div class="LineGroup"><div class="FixedLine">        ContainerProperties containerProperties =</div><div class="FixedLine">            new ContainerProperties(replyTopic);</div><div class="FixedLine">        return new KafkaMessageListenerContainer&lt;&gt;(</div><div class="FixedLine">            replyConsumerFactory(), containerProperties);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-2</span><p class="SimplePara">Kafka Configuration for Product Web Microservice (ch06\ch06-01\02-ProductWeb\src\main\java\com\acme\ecom\product\KafkaConfig.java)</p></div></div></div></div>

          <p class="Para" id="Par49">This code configures <span class="EmphasisFontCategoryNonProportional ">CompletableFutureReplyingKafkaTemplate</span>, specifying that <span class="EmphasisFontCategoryNonProportional ">Products</span> is sent as the request and <span class="EmphasisFontCategoryNonProportional ">Products</span> is expected as the response.</p>

          <div class="Para" id="Par50">Listing <span class="InternalRef"><a href="#PC3">6-3</a></span> inspects a single method in the Product Web controller. Other methods are implemented in a similar fashion, so that code is not replicated here for brevity.<div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine">@RestController</div><div class="FixedLine">public class ProductRestController{</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    private CompletableFutureReplyingKafkaOperations&lt;String,</div><div class="FixedLine">            Products, Products&gt; replyingKafkaTemplate;</div></div><div class="LineGroup"><div class="FixedLine">    @RequestMapping(value = "/productsweb",</div><div class="FixedLine">        method = RequestMethod.GET,</div><div class="FixedLine">        produces = {MediaType.APPLICATION_JSON_VALUE})</div><div class="FixedLine">    public DeferredResult&lt;ResponseEntity&lt;CollectionModel&lt;</div><div class="FixedLine">            com.acme.ecom.product.hateoas.model.Product&gt;&gt;&gt;</div><div class="FixedLine">            getAllProducts(){</div></div><div class="LineGroup"><div class="FixedLine">        DeferredResult&lt;ResponseEntity&lt;CollectionModel&lt;</div><div class="FixedLine">            com.acme.ecom.product.hateoas.model.Product&gt;&gt;&gt;</div><div class="FixedLine">            deferredResult = new DeferredResult&lt;&gt;();</div></div><div class="LineGroup"><div class="FixedLine">        Products productsRequest = new Products();</div><div class="FixedLine">        productsRequest.setOperation(Products.RETREIVE_ALL);</div></div><div class="LineGroup"><div class="FixedLine">        CompletableFuture&lt;Products&gt; completableFuture =</div><div class="FixedLine">            replyingKafkaTemplate.requestReply(</div><div class="FixedLine">                requestTopic, productsRequest);</div></div><div class="LineGroup"><div class="FixedLine">        completableFuture.thenAccept(products -&gt; {</div><div class="FixedLine">            List&lt;com.acme.ecom.product.model.Product&gt;</div><div class="FixedLine">                productList = products.getProducts();</div><div class="FixedLine">        CollectionModel&lt;com.acme.ecom.product.hateoas.</div><div class="FixedLine">            model.Product&gt; result = CollectionModel.of(</div><div class="FixedLine">                list, links);</div><div class="FixedLine">        deferredResult.setResult(new ResponseEntity&lt;</div><div class="FixedLine">            CollectionModel&lt;com.acme.ecom.product.</div><div class="FixedLine">                hateoas.model.Product&gt;&gt;(result,</div><div class="FixedLine">                    HttpStatus.OK));</div><div class="FixedLine">        return deferredResult;</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-3</span><p class="SimplePara">REST Controller for Product Web Microservice (ch06\ch06-01\02-ProductWeb\src\main\java\com\acme\ecom\product\controller\ProductRestController.java)</p></div></div></div></div>

          <p class="Para" id="Par51">While sending the request message to retrieve all the products from the Product Server microservice, you specify the operation as <span class="EmphasisFontCategoryNonProportional ">Products.RETREIVE_ALL</span>. Even though you send an empty <span class="EmphasisFontCategoryNonProportional ">Products</span> collection <span class="EmphasisFontCategoryNonProportional ">productsRequest</span> along with the request, it’s not relevant or used here. However, for a few other methods, you could use this same <span class="EmphasisFontCategoryNonProportional ">productsRequest</span> collection to send request parameters. You then use <span class="EmphasisFontCategoryNonProportional ">CompletableFutureReplyingKafkaOperations</span>, which was configured in the previous step to send the request message and to receive its corresponding response message in a synchronous style, even though the underlying request and response message semantics are two separate asynchronous messages.</p>

          <div class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant" id="FPar1">

            <div class="Heading">Note</div>

            <p class="Para FirstParaInFormalPara" id="Par52">A detailed explanation of <span class="EmphasisFontCategoryNonProportional ">CompletableFutureReplyingKafkaOperations</span> and its usage pattern appears in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span>.</p>

          </div>

          <div class="Para" id="Par53">On the Product Server microservice side, you must also configure and specify the <span class="EmphasisFontCategoryNonProportional ">Products</span> container class as passing to and from the wire, as shown in Listing <span class="InternalRef"><a href="#PC4">6-4</a></span>.<div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine">@Configuration</div><div class="FixedLine">@EnableKafka</div><div class="FixedLine">public class KafkaConfig {</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public ConsumerFactory&lt;String, Products&gt;</div><div class="FixedLine">            requestConsumerFactory() {</div></div><div class="LineGroup"><div class="FixedLine">        JsonDeserializer&lt;Products&gt; jsonDeserializer =</div><div class="FixedLine">            new JsonDeserializer&lt;&gt;();</div><div class="FixedLine">        jsonDeserializer.addTrustedPackages(Products.class.</div><div class="FixedLine">            getPackage().getName());</div><div class="FixedLine">        return new DefaultKafkaConsumerFactory&lt;&gt;(</div><div class="FixedLine">            consumerConfigs(), new StringDeserializer(),</div><div class="FixedLine">            jsonDeserializer);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public KafkaListenerContainerFactory&lt;</div><div class="FixedLine">            ConcurrentMessageListenerContainer&lt;String,</div><div class="FixedLine">            Products&gt;&gt; requestReplyListenerContainerFactory(){</div></div><div class="LineGroup"><div class="FixedLine">        ConcurrentKafkaListenerContainerFactory&lt;String,</div><div class="FixedLine">            Products&gt; factory =</div><div class="FixedLine">            new ConcurrentKafkaListenerContainerFactory&lt;&gt;();</div><div class="FixedLine">        factory.setConsumerFactory(requestConsumerFactory());</div><div class="FixedLine">        factory.setReplyTemplate(replyTemplate());</div><div class="FixedLine">        return factory;</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-4</span><p class="SimplePara">Kafka Configuration for Product Server Microservice (ch06\ch06-01\01-ProductServer\src\main\java\com\acme\ecom\product\KafkaConfig.java)</p></div></div></div></div>

          <div class="Para" id="Par54">The <span class="EmphasisFontCategoryNonProportional ">ProductListener</span> is the message listener at the Product Server microservice. <span class="EmphasisFontCategoryNonProportional ">ProductListener</span> first resolves which operation to perform by inspecting the <span class="EmphasisFontCategoryNonProportional ">operation</span> attribute and invoking the respective method. See Listing <span class="InternalRef"><a href="#PC5">6-5</a></span>.<div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">@Component</div><div class="FixedLine">public class ProductListener {</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    private ProductRepository productRepository;</div></div><div class="LineGroup"><div class="FixedLine">    @KafkaListener(topics = "${kafka.topic.product.request}",</div><div class="FixedLine">            containerFactory =</div><div class="FixedLine">                "requestReplyListenerContainerFactory")</div><div class="FixedLine">    @SendTo</div><div class="FixedLine">    public Products listenWithHeaders(</div></div><div class="LineGroup"><div class="FixedLine">        ConsumerRecord&lt;String, Products&gt; record){</div><div class="FixedLine">        Products productsRequest = record.value();</div><div class="FixedLine">        Products productsResponse = resolveAndExecute(</div><div class="FixedLine">            productsRequest);</div><div class="FixedLine">        return productsResponse;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    private Products resolveAndExecute(Products products) {</div></div><div class="LineGroup"><div class="FixedLine">        Products productsToReturn = null;</div><div class="FixedLine">        if(products.getOperation().equals(</div><div class="FixedLine">                Products.RETREIVE_DETAILS)){</div><div class="FixedLine">            productsToReturn = getProduct(products);</div><div class="FixedLine">        }</div><div class="FixedLine">        else if(products.getOperation().equals(</div><div class="FixedLine">                Products.RETREIVE_ALL)){</div><div class="FixedLine">            productsToReturn = getAllProducts(products);</div><div class="FixedLine">        }</div><div class="FixedLine">        else if(products.getOperation().equals(</div><div class="FixedLine">                Products.CREATE)){</div><div class="FixedLine">            productsToReturn = createProduct(products);</div><div class="FixedLine">        }</div><div class="FixedLine">        else if(products.getOperation().equals(</div><div class="FixedLine">                Products.UPDATE)){</div><div class="FixedLine">            productsToReturn = updateProduct(products);</div><div class="FixedLine">        }</div><div class="FixedLine">        else if(products.getOperation().equals(</div><div class="FixedLine">                Products.DELETE)){</div><div class="FixedLine">            productsToReturn = deleteProduct(products);</div><div class="FixedLine">        }</div><div class="FixedLine">        else {</div><div class="FixedLine">            LOGGER.debug("Inside else. Undefined Operation!");</div><div class="FixedLine">        }</div><div class="FixedLine">        return productsToReturn;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    private Products getAllProducts(Products products) {</div></div><div class="LineGroup"><div class="FixedLine">        Products productsToReturn = new Products();</div><div class="FixedLine">        List&lt;Product&gt; productListToReturn =</div><div class="FixedLine">            productRepository.findAll();</div><div class="FixedLine">        productsToReturn.setOperation(Products.SUCCESS);</div><div class="FixedLine">        productsToReturn.setProducts(productListToReturn);</div><div class="FixedLine">        return productsToReturn;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    //other code goes here</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-5</span><p class="SimplePara">Kafka Listener for Product Server Microservice (ch06\ch06-01\01-ProductServer\src\main\java\com\acme\ecom\product\kafka\client\ProductListener.java)</p></div></div></div></div>

          <p class="Para" id="Par55">Here again a single method is shown in the <span class="EmphasisFontCategoryNonProportional ">ProductListener</span>, called <span class="EmphasisFontCategoryNonProportional ">getAllProducts</span>. Other methods are implemented in similar ways, so their code is not replicated here.</p>

          <p class="Para" id="Par56">You are also advised to refer to the second example in the section titled “Microservices Using MongoDB and CrudRepository” in Chapter <span class="ExternalRef"><a href="Capítulo-05.html"><span class="RefSource">3</span></a></span>, which explains how the Product Server microservice connects to a MongoDB to perform the complete set of CRUD operations.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec10">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par57">The <span class="EmphasisFontCategoryNonProportional ">ch06\ch06-01</span> folder contains the Maven scripts required to <span id="ITerm20">build</span> the examples. As a first step, you need to bring up the Kafka broker. Refer to Appendix D to learn how to set up a Kafka server and bring it up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC6">6-6</a></span> to bring up Kafka from the Kafka installation location.<div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">bin/zookeeper-server-start.sh config/zookeeper.properties</div><div class="FixedLine">bin/kafka-server-start.sh config/server.properties</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-6</span><p class="SimplePara">Commands to Bring Up Kafka Broker</p></div></div></div></div>

          <div class="Para" id="Par58">As a next step, you need to bring up the MongoDB server. Refer to Appendix B to learn how to set up a MongoDB server and bring it up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC7">6-7</a></span> to bring up MongoDB.<div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine">(base) binildass-MBP:bin binil$ pwd</div><div class="FixedLine">/Users/binil/Applns/mongodb/mongodb-macos-x86_64-4.2.8/bin</div><div class="FixedLine">(base) binildass-MBP:bin binil$ mongod --dbpath /usr/local/var/mongodb --logpath /usr/local/var/log/mongodb/mongo.log</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-7</span><p class="SimplePara">Commands to Bring Up MongoDB</p></div></div></div></div>

          <div class="Para" id="Par59">Next, you need to build and install the utility library from Callista Enterprise (see Listing <span class="InternalRef"><a href="#PC8">6-8</a></span>). Refer to Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span> for a brief introduction to this library.<div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:kafka-request-reply-util binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/kafka-request-reply-util</div><div class="FixedLine">(base) binildass-MacBook-Pro:kafka-request-reply-util binil$ mvn clean install</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-8</span><p class="SimplePara">Commands to Build and Install the Utility Library from Callista Enterprise</p></div></div></div></div>

          <div class="Para" id="Par60">Next, use two command terminals and change the directory to the top-level folder of both microservices. First, build the Product Server microservice using the <span class="EmphasisFontCategoryNonProportional ">make.sh</span> scripts, as shown in Listing <span class="InternalRef"><a href="#PC9">6-9</a></span>.<div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh make.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-9</span><p class="SimplePara">Commands to Build the Product Server Microservice</p></div></div></div></div>

          <div class="Para" id="Par61">Next, build the Product Web Microservice, as shown in Listing <span class="InternalRef"><a href="#PC10">6-10</a></span>.<div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-10</span><p class="SimplePara">Commands to Build the Product Web Microservice</p></div></div></div></div>

          <p class="Para" id="Par62">This example tests three instances of the Product Server microservice and another three instances of the Product Web microservice.</p>

          <div class="Para" id="Par63">To start, bring up the first instance of the Product Server microservice, as shown in Listing <span class="InternalRef"><a href="#PC11">6-11</a></span>.<div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/01-ProductServer</div><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ sh run1.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-11</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 1</p></div></div></div></div>

          <div class="Para" id="Par64">Next, you’ll bring up the second instance of the Product Server microservice, as shown in Listing <span class="InternalRef"><a href="#PC11">6-11</a></span>.<div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/01-ProductServer</div><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ sh run2.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-12</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 2</p></div></div></div></div>

          <div class="Para" id="Par65">Finally, bring up the third instance of the Product Server microservice, as shown in Listing <span class="InternalRef"><a href="#PC13">6-13</a></span>.<div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/01-ProductServer</div><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ sh run3.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-13</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 3</p></div></div></div></div>

          <div class="Para" id="Par66">Next, run the instances of the Product Web microservice. As a first step, Listing <span class="InternalRef"><a href="#PC14">6-14</a></span> shows how to run the first instance.<div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh run1.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-14</span><p class="SimplePara">Commands to Run the Product Web Microservice Instance 1</p></div></div></div></div>

          <div class="Para" id="Par67">Next, bring up the second instance of the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC15">6-15</a></span>.<div class="ProgramCode" id="PC15"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh run2.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-15</span><p class="SimplePara">Commands to Run the Product Web Microservice Instance 2</p></div></div></div></div>

          <div class="Para" id="Par68">As a last step, bring up the third instance of the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC16">6-16</a></span>.<div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh run3.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-16</span><p class="SimplePara">Commands to Run the Product Web Microservice Instance 3</p></div></div></div></div>

          <div class="Para" id="Par69">Figure <span class="InternalRef"><a href="#Fig2">6-2</a></span> shows the process of accessing multiple instances of these microservices.<figure class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img alt="" aria-describedby="d64e1363" src="../images/619782_1_En_6_Chapter/Imagem-065.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1363"><p class="Para" id="Par152">A screenshot contains the code for testing the microservices using multiple instances.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 6-2</span><p class="SimplePara">Testing the microservices using multiple instances</p></div></figcaption></figure></div>

          <p class="Para" id="Par70">Now that both microservices are up and running, you can test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec11">

          <h3 class="Heading">Testing the Microservices</h3>

          <p class="Para" id="Par71">In order to test these microservices, refer to the <span id="ITerm21">“Testing</span> Parallel Request Processing” section in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span>. Alternatively, you can use the following section.</p>

          <div class="Para" id="Par72">There is more than one way to test these microservices. One way is to use three browser instances and point to the URLs in Listing <span class="InternalRef"><a href="#PC17">6-17</a></span> to test the microservices.<div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/product.html</div><div class="FixedLine">http://localhost:8081/product.html</div><div class="FixedLine">http://localhost:8082/product.html</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-17</span><p class="SimplePara">Testing the Microservice Using Browsers</p></div></div></div></div>

          <p class="Para" id="Par73">Follow the detailed instructions described in the section titled “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test the CRUD operations.</p>

          <div class="Para" id="Par74">Alternatively, you can now take three (or even more) separate terminals to run cURL client commands concurrently. Listing <span class="InternalRef"><a href="#PC17">6-17</a></span> shows cURL clients sending requests to the Product Web microservice.<div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:~ binil$ curl http://localhost:8080/productsweb</div><div class="FixedLine">binildass-MacBook-Pro:~ binil$ curl http://localhost:8081/productsweb</div><div class="FixedLine">binildass-MacBook-Pro:~ binil$ curl http://localhost:8082/productsweb</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-18</span><p class="SimplePara">cURL Clients that Fire Requests to the Product Web Microservice at Different Ports</p></div></div></div></div>

          <div class="Para" id="Par75">You can also endurance-test the microservices by keeping the cURL clients firing continuously, as shown in Listings <span class="InternalRef"><a href="#PC19">6-19</a></span> through <span class="InternalRef"><a href="#PC21">6-21</a></span>.<div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh loopcurl1.sh</div><div class="FixedLine">{"_embedded":{"products":[{"productId":"1","name":"Kamsung D3","code":"KAMSUNG-TRIOS","title":"Kamsung Trios 12 inch , black , 12 px ....","price":12000.0,"_links":{"self":{"href":"/products/1"}}},{"productId":"2","name":"Lokia Pomia","code":"LOKIA-POMIA","title":"Lokia 12 inch , white , 14px ....","price":9000.0,"_links":{"self":{"href":"/products/2"}}}]},"_links":{"self":{"href":"/productsweb"},"getAllProducts":{"href":"/productsweb"}}}</div><div class="FixedLine">------------------------------------------</div><div class="FixedLine">Current date: Mon Dec 13 13:37:04 IST 2021</div><div class="FixedLine">==========================================</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-19</span><p class="SimplePara">Endurance Test Using cURL Client 1</p></div></div></div><div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh loopcurl2.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-20</span><p class="SimplePara">Endurance Test Using cURL Client 2</p></div></div></div><div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-01/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh loopcurl3.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-21</span><p class="SimplePara">Endurance Test Using cURL Client 3</p></div></div></div></div>

          <p class="Para" id="Par76">This completes the first example. This example has attempted to demonstrate many of the concepts covered in the book so far. For the completeness of this discussion, the next section covers a PostgreSQL version of this example.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec12">

        <h2 class="Heading">CRUD Microservices Over Kafka on PostgreSQL</h2>

        <p class="Para" id="Par77">This example tweaks the same set of microservices you saw in the previous section. A consumer and provider microservice communicate with each other using Kafka as the messaging channel. The provider microservice stores the entity in a <span id="ITerm22">PostgreSQL database</span> instead of in MongoDB. When the browser sends a request to the first (consumer) microservice, it uses async HTTP. Even though the code uses async HTTP, it emulates a sync-style user experience at the browser level.</p>

        <p class="Para" id="Par78">As with the previous example, this example aims to demonstrate multiple instances of the consumer and provider microservices and uses multiple clients while testing this service.</p>

        <section class="Section2 RenderAsSection2" id="Sec13">

          <h3 class="Heading">Design CRUD Over Async Channel on PostgreSQL</h3>

          <div class="Para" id="Par79">This example uses the modified <span id="ITerm23">version</span> of the hexagonal microservice view shown in Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span>, which was revisited in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span> and tweaked slightly in the previous example. Here, both microservices communicate through an async channel. The example uses Apache Kafka as the messaging channel, which is inherently asynchronous.<figure class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img alt="" aria-describedby="d64e1559" src="../images/619782_1_En_6_Chapter/Imagem-066.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1559"><p class="Para" id="Par153">A microservice design starts with the user, followed by browser, rest A P I, product web microservice instances, and product server microservice instances.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 6-3</span><p class="SimplePara">Microservice design over <span id="ITerm24">async channel</span> using partitions</p></div></figcaption></figure></div>

          <p class="Para" id="Par80">The noticeable change from the previous example is that the provider microservice stores the entity in a PostgreSQL database instead of using a MongoDB database. This change is marked in Figure <span class="InternalRef"><a href="#Fig3">6-3</a></span>.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec14">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par81">The <span id="ITerm25">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch06\ch06-02</span> folder.</p>

          <p class="Para" id="Par82">The only change in the code <span id="ITerm26">from</span> the previous example is that the provider microservice stores the entity in a PostgreSQL database instead of using a MongoDB database. The code needed for the provider microservice to store the entity in a PostgreSQL database and perform complete CRUD operations is described in detail in the section titled “Understanding the Code” in the first example in Chapter <span class="ExternalRef"><a href="Capítulo-05.html"><span class="RefSource">3</span></a></span>. You are directed to refer to that section for explanations.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec15">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par83">The <span class="EmphasisFontCategoryNonProportional ">ch06\ch06-02</span> folder contains the Maven scripts required to <span id="ITerm27">build</span> these examples. As a first step, you need to bring up the Kafka broker. Refer to Appendix D to learn how to set up a Kafka server and bring it up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC22">6-22</a></span> to bring up Kafka from the Kafka installation location.<div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">bin/zookeeper-server-start.sh config/zookeeper.properties</div><div class="FixedLine">bin/kafka-server-start.sh config/server.properties</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-22</span><p class="SimplePara">Commands to Bring Up Kafka Broker</p></div></div></div></div>

          <div class="Para" id="Par84">Next, you need to bring up the PostgreSQL DB server. Refer to Appendix C to learn how to set up PostgreSQL server and bring it up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC23">6-23</a></span> to bring up PostgreSQL.<div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:~ binil$ pg_ctl -D /Library/PostgreSQL/12/data start</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-23</span><p class="SimplePara">Bringing Up PostgreSQL Server</p></div></div></div></div>

          <div class="Para" id="Par85">Next, you need to build and install the utility library from Callista Enterprise (see Listing <span class="InternalRef"><a href="#PC24">6-24</a></span>). Refer to Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span> for a brief introduction to this library.<div class="ProgramCode" id="PC24"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:kafka-request-reply-util binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-02/kafka-request-reply-util</div><div class="FixedLine">(base) binildass-MacBook-Pro:kafka-request-reply-util binil$ mvn clean install</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-24</span><p class="SimplePara">Commands to Build and Install the <span id="ITerm28">Utility Library</span> from Callista Enterprise</p></div></div></div></div>

          <div class="Para" id="Par86">Next, use two command terminals and change the directory to the top-level folder of both microservices. Then build the Product Server microservice using the <span class="EmphasisFontCategoryNonProportional ">make.sh</span> scripts, as shown in Listing <span class="InternalRef"><a href="#PC25">6-25</a></span>.<div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-02/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh make.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-25</span><p class="SimplePara">Commands to Build the Product Server Microservice</p></div></div></div></div>

          <div class="Para" id="Par87">Next, build the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC26">6-26</a></span>.<div class="ProgramCode" id="PC26"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-02/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-26</span><p class="SimplePara">Commands to Build the Product Web Microservice</p></div></div></div></div>

          <p class="Para" id="Par88">You will test using three instances of the Product Server microservice and another three instances of the Product Web microservice.</p>

          <div class="Para" id="Par89">First, bring up the first instance of the Product Server microservice, as shown in Listing <span class="InternalRef"><a href="#PC27">6-27</a></span>.<div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-02/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run1.sh</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2023-05-16 22:02:45 INFO  StartupInfoLogger.logStarting:51 - Starting EcomProductServerMicroservice...</div><div class="FixedLine">...</div><div class="FixedLine">Running Changeset: db/changelog/initial-schema_inventory.xml::product::Binildas</div><div class="FixedLine">Running Changeset: db/changelog/initial-schema_inventory.xml::addAutoIncrement...</div><div class="FixedLine">Running Changeset: db/changelog/initial-schema_inventory.xml::insert-product-01::Binildas</div><div class="FixedLine">Running Changeset: db/changelog/initial-schema_inventory.xml::insert-product-02::Binildas</div></div><div class="LineGroup"><div class="FixedLine">UPDATE SUMMARY</div><div class="FixedLine">Run:                          4</div><div class="FixedLine">Previously run:               0</div><div class="FixedLine">Filtered out:                 0</div><div class="FixedLine">-------------------------------</div><div class="FixedLine">Total change sets:            4</div></div><div class="LineGroup"><div class="FixedLine">Liquibase: Update has been successful.</div><div class="FixedLine">2024-03-04 17:52:57 INFO  InitializationComponent.init:42 - Start</div><div class="FixedLine">2024-03-04 17:52:57 INFO  InitializationComponent.init:70 - End</div><div class="FixedLine">2024-03-04 17:52:58 INFO  StartupInfoLogger.logStarted:56 - Started EcomProductServerMicroserviceApplication in 4.665 seconds (process running for 5.577)</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-27</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 1</p></div></div></div></div>

          <div class="Para" id="Par90">Next, bring up the second instance of the Product Server microservice, as shown in Listing <span class="InternalRef"><a href="#PC28">6-28</a></span>.<div class="ProgramCode" id="PC28"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-02/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ java -jar -Dserver.port=8084 -DDB_SERVER=127.0.0.1:5432 -DPOSTGRES_DB=productdb -DPOSTGRES_USER=postgres -DPOSTGRES_PASSWORD=postgre -Dspring.kafka.consumer.group-id=product-server ./target/Ecom-Product-Server-Microservice-0.0.1-SNAPSHOT.jar</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-28</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 2</p></div></div></div></div>

          <div class="Para" id="Par91">Finally, bring up the third instance of the Product Server microservice, as shown in Listing <span class="InternalRef"><a href="#PC29">6-29</a></span>.<div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ java -jar -Dserver.port=8085 -DDB_SERVER=127.0.0.1:5432 -DPOSTGRES_DB=productdb -DPOSTGRES_USER=postgres -DPOSTGRES_PASSWORD=postgre -Dspring.kafka.consumer.group-id=product-server ./target/Ecom-Product-Server-Microservice-0.0.1-SNAPSHOT.jar</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-29</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 3</p></div></div></div></div>

          <div class="Para" id="Par92">Next, run the instances of the Product Web microservice. As a first step, run the first instance. See Listing <span class="InternalRef"><a href="#PC30">6-30</a></span>.<div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-02/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh run1.sh</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2024-03-04 17:54:06 INFO  StartupInfoLogger.logStarted:56 - Started EcomProductWebMicroserviceApplication in 2.322 seconds (process running for 2.981)</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-30</span><p class="SimplePara">Commands to Run the Product Web Microservice Instance 1</p></div></div></div></div>

          <div class="Para" id="Par93">Next, bring up the second instance of the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC31">6-31</a></span>.<div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-02/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ java -jar target/Ecom-Product-Microservice-0.0.1-SNAPSHOT.jar  -Dserver.port=8081</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-31</span><p class="SimplePara">Commands to Run the Product Web Microservice Instance 2</p></div></div></div></div>

          <div class="Para" id="Par94">As a last step, bring up the third instance of the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC32">6-32</a></span>.<div class="ProgramCode" id="PC32"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ java -jar target/Ecom-Product-Microservice-0.0.1-SNAPSHOT.jar  -Dserver.port=8082</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-32</span><p class="SimplePara">Commands to Run the Product Web Microservice Instance 3</p></div></div></div></div>

          <p class="Para" id="Par95">Now that both microservices are up and running, you can test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec16">

          <h3 class="Heading">Testing the Microservice</h3>

          <p class="Para" id="Par96">To <span id="ITerm29">test</span> the microservices, you are directed to refer to the “Testing Parallel Request Processing” section in Chapter <span class="ExternalRef"><a href="Capítulo-07.html"><span class="RefSource">5</span></a></span>. Alternatively, we will follow as below.</p>

          <div class="Para" id="Par97">There is more than one way to test these microservices. One way to test them is to use three browser instances to point to the URLs shown in Listing <span class="InternalRef"><a href="#PC33">6-33</a></span>.<div class="ProgramCode" id="PC33"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/product.html</div><div class="FixedLine">http://localhost:8081/product.html</div><div class="FixedLine">http://localhost:8082/product.html</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-33</span><p class="SimplePara">Testing the Microservice Using Browsers</p></div></div></div></div>

          <p class="Para" id="Par98">Follow the detailed instructions described in the section “Test the Microservice Using UI” in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span> to test these CRUD operations.</p>

          <div class="Para" id="Par99">Alternatively, you can now use three (or more) separate terminals to run cURL client commands concurrently. Listing <span class="InternalRef"><a href="#PC34">6-34</a></span> shows the cURL clients sending requests to the Product Web microservice.<div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:~ binil$ curl http://localhost:8080/productsweb</div><div class="FixedLine">...</div></div><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:~ binil$ curl http://localhost:8081/productsweb</div><div class="FixedLine">...</div></div><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:~ binil$ curl http://localhost:8082/productsweb</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-34</span><p class="SimplePara">cURL Clients to Fire Requests to Product Web Microservice at Different Ports</p></div></div></div></div>

          <div class="Para" id="Par100">You can also endurance-test the microservices by keeping the cURL clients firing continuously, as shown in Listings <span class="InternalRef"><a href="#PC35">6-35</a></span> through <span class="InternalRef"><a href="#PC37">6-37</a></span>.<div class="ProgramCode" id="PC35"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-02/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh loopcurl1.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-35</span><p class="SimplePara">Endurance Test Using cURL Client 1</p></div></div></div><div class="ProgramCode" id="PC36"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-02/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh loopcurl2.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-36</span><p class="SimplePara">Endurance Test using cURL Client 2</p></div></div></div><div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-03/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh loopcurl3.sh</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-37</span><p class="SimplePara">Endurance Test using cURL Client 3</p></div></div></div></div>

          <p class="Para" id="Par101">This completes the second example, using PostgreSQL.</p>

          <p class="Para" id="Par102">Before I close this chapter, the next section quickly explains an important concept called <em class="EmphasisTypeItalic ">integration patterns.</em> They show how such standard and defined patterns provide value to architectures involving Message Oriented Middleware (MOM).</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec17">

        <h2 class="Heading">Aggregating Responses from Multiple Microservices</h2>

        <p class="Para" id="Par103">All through the previous chapters and the previous sections in this chapter, you have seen different combinations in which you can mix and match the transport connectivity options between microservices to simulate different message exchange patterns. To complete this discussion, this section looks at an integration pattern called an <em class="EmphasisTypeItalic ">aggregator</em>. You can use this pattern to <span id="ITerm30">aggregate</span> responses from multiple microservices.</p>

        <section class="Section2 RenderAsSection2" id="Sec18">

          <h3 class="Heading">Aggregator Integration Pattern</h3>

          <div class="Para" id="Par104">Let’s first look at what an aggregator <span id="ITerm31">pattern</span> is. An <em class="EmphasisTypeItalic ">aggregator</em> is a stateful filter used to collect and store individual messages until a complete set of related messages has been received. The aggregator can then filter, compose, and publish a single message distilled from the individual messages. See Figure <span class="InternalRef"><a href="#Fig4">6-4</a></span>.<figure class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img alt="" aria-describedby="d64e2103" src="../images/619782_1_En_6_Chapter/Imagem-067.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2103"><p class="Para" id="Par154">A diagram illustrates the aggregator integration pattern. Books are ordered by the users to the publishers, which is then requested and replied, and the response are made by aggregator integration.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 6-4</span><p class="SimplePara">Aggregator integration pattern</p></div></figcaption></figure></div>

          <p class="Para" id="Par105">Figure <span class="InternalRef"><a href="#Fig4">6-4</a></span> depicts a typical travel booking scenario done by travel agents. The Booking Order microservice is used by the travel agent to fulfill the booking request on behalf of a traveler. The Booking Order microservice can also be used by a traveler directly through the web or mobile apps. Assuming the booking has to be done for a combined itinerary involving hotel accommodations, air travel, and airport drop-off and pickup, these individual fulfillment inventory items will be owned by different third-party providers—a Hotel microservice, an Air microservice, and a Cab microservice, in this case. These different inventory owner microservices will pick up the booking request and try to fulfill the respective booking component and send a response message back to the reply queue. Now comes the part of the aggregator.</p>

          <p class="Para" id="Par106">The aggregator, being a stateful filter, can wait for multiple replies until a timeout. The aggregator can then compose from the individual response messages and publish a single message to the Booking Order microservice.</p>

          <p class="Para" id="Par107">The next section looks at some working code to show this pattern.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec19">

          <h3 class="Heading">Design the Microservice Aggregator</h3>

          <p class="Para" id="Par108">This example uses the <span id="ITerm32">now-familiar</span> Product Web and Product Server microservices domain. As shown in Figure <span class="InternalRef"><a href="#Fig5">6-5</a></span>, users interact with the Product Web microservice from a browser. The Product Web microservice in turn invokes the Product Server microservice. The Product Server microservice retrieves data from a database, from an in-memory database in this example, and sends the response.</p>

          <p class="Para" id="Par109">Inter-microservice communication happens over a messaging channel.</p>

          <div class="Para" id="Par110">Moreover, the request message is relayed to more than one service provider. The objective is to enable the Product Web microservice to relay requests to more than one service provider and receive responses from all or many of these service providers. The Product Web microservice acts as an aggregator and stores individual messages until a complete set of related messages has been received. The aggregator can then filter, compose, and publish a single message distilled from the individual messages to the browser. See Figure <span class="InternalRef"><a href="#Fig5">6-5</a></span>.<figure class="Figure" id="Fig5"><div class="MediaObject" id="MO5"><img alt="" aria-describedby="d64e2146" src="../images/619782_1_En_6_Chapter/Imagem-068.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2146"><p class="Para" id="Par155">A diagram illustrates the microservices aggregator. Users interact with the product web microservice from the browser. The service retrieves data from the database, and sends the response.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 6-5</span><p class="SimplePara">Microservices aggregator</p></div></figcaption></figure></div>

          <p class="Para" id="Par111">To keep the complexity of the example under control, it does not use different kinds of provider microservices. Instead, the example uses different instances of the same kind of microservice. However, note that nothing prevents you from having different kinds of provider microservices responding to the same request message.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec20">

          <h3 class="Heading">Understanding the Source Code</h3>

          <p class="Para" id="Par112">The <span id="ITerm33">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch06\ch06-03</span> folder, which was explained in detail. The additional wiring plugs in an aggregator between the two microservices and the mechanism used to relay the single request from the Product Web microservice to more than one (instance of the) provider microservice, which you will see in the code in this section.</p>

          <div class="Para" id="Par113">Spring Kafka provides <span class="EmphasisFontCategoryNonProportional ">AggregatingReplyingKafkaTemplate</span>, a replying template that aggregates multiple replies with the same correlation ID. <span class="EmphasisFontCategoryNonProportional ">AggregatingReplyingKafkaTemplate</span> is a listener that handles a batch of incoming Kafka messages. The list of batch messages is created from the consumer records object returned by a poll. <span class="EmphasisFontCategoryNonProportional ">AggregatingReplyingKafkaTemplate</span> extends the behavior of <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate&lt;K,V,R&gt;</span> from Spring, which extends the behavior of <span class="EmphasisFontCategoryNonProportional ">KafkaTemplate</span> to provide request-reply semantics. You saw this in detail in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>, so I only explain the additional features of <span class="EmphasisFontCategoryNonProportional ">AggregatingReplyingKafkaTemplate</span>, as configured in Listing <span class="InternalRef"><a href="#PC38">6-38</a></span>.<div class="ProgramCode" id="PC38"><div class="LineGroup"><div class="FixedLine">import org.springframework.kafka.requestreply.AggregatingReplyingKafkaTemplate;</div></div><div class="LineGroup"><div class="FixedLine">@Configuration</div><div class="FixedLine">public class KafkaConfig {</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${product.topic.reply.numProviders}")</div><div class="FixedLine">    private int numProviders;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${product.topic.reply.aggregatingTimeout}")</div><div class="FixedLine">    private long aggregatingTimeout;</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public AggregatingReplyingKafkaTemplate&lt;String, String,</div><div class="FixedLine">            Products&gt; replyKafkaTemplate(ProducerFactory&lt;</div><div class="FixedLine">            String, String&gt; pf,</div><div class="FixedLine">            KafkaMessageListenerContainer&lt;String,</div><div class="FixedLine">            Collection&lt;ConsumerRecord&lt;String, Products&gt;&gt;&gt;</div><div class="FixedLine">            replyContainer){</div></div><div class="LineGroup"><div class="FixedLine">        AggregatingReplyingKafkaTemplate&lt;String, String,</div><div class="FixedLine">            Products&gt; replyTemplate =</div><div class="FixedLine">            new AggregatingReplyingKafkaTemplate&lt;&gt;(pf,</div><div class="FixedLine">                    replyContainer,(list, timeout) -&gt; {</div></div><div class="LineGroup"><div class="FixedLine">                LOGGER.debug("list.size() : {}; timeout : {}",</div><div class="FixedLine">                    list.size(), timeout);</div><div class="FixedLine">                return (list.size() == numProviders) ||</div><div class="FixedLine">                    (timeout);</div><div class="FixedLine">            });</div></div><div class="LineGroup"><div class="FixedLine">        replyTemplate.setReturnPartialOnTimeout(true);</div><div class="FixedLine">        replyTemplate.setSharedReplyTopic(true);</div><div class="FixedLine">        replyTemplate.setDefaultReplyTimeout(</div><div class="FixedLine">            java.time.Duration.ofSeconds(aggregatingTimeout));</div><div class="FixedLine">        return replyTemplate;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public KafkaMessageListenerContainer&lt;String, Collection&lt;</div><div class="FixedLine">            ConsumerRecord&lt;String, Products&gt;&gt;&gt;</div><div class="FixedLine">            replyContainer(ConsumerFactory&lt;String,</div><div class="FixedLine">            Collection&lt;ConsumerRecord&lt;String, Products&gt;&gt;&gt; cf){</div></div><div class="LineGroup"><div class="FixedLine">        ContainerProperties containerProperties =</div><div class="FixedLine">            new ContainerProperties(requestReplyTopic);</div><div class="FixedLine">        containerProperties.setAckMode(AckMode.MANUAL);</div><div class="FixedLine">        return new KafkaMessageListenerContainer&lt;String,</div><div class="FixedLine">            Collection&lt;ConsumerRecord&lt;</div><div class="FixedLine">            String, Products&gt;&gt;&gt;(cf, containerProperties);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-38</span><p class="SimplePara">The Product Web Kafka Configuration (ch06\ch06-03\02-ProductWeb\src\main\java\com\acme\ecom\product\KafkaConfig.java)</p></div></div></div></div>

          <p class="Para" id="Par114">The <span class="EmphasisFontCategoryNonProportional ">replyContainer</span> bean creates properties for a container that will subscribe to the specified topic—<span class="EmphasisFontCategoryNonProportional ">requestReplyTopic</span> in this case. You can configure this listener container to consume more than one topic. The replies must then contain the correlation ID header (used to aggregate). The framework will create a container that subscribes to all topics matching the specified pattern to get dynamically assigned partitions.</p>

          <p class="Para" id="Par115">Using the <span class="EmphasisFontCategoryNonProportional ">replyContainer</span>, you configure an <span class="EmphasisFontCategoryNonProportional ">AggregatingReplyingKafkaTemplate</span>, specifying that you expect a collection of <span class="EmphasisFontCategoryNonProportional ">ConsumerRecord</span>-containing <span class="EmphasisFontCategoryNonProportional ">Products</span>. Then you set <span class="EmphasisFontCategoryNonProportional ">replyTemplate.setReturnPartialOnTimeout(true)</span>, which simply means that the template will consult the release strategy upon timeout. The template does this with the timeout argument set to <span class="EmphasisFontCategoryNonProportional ">true</span>, to tell the strategy it’s a timeout rather than a delivery call. When it’s set to <span class="EmphasisFontCategoryNonProportional ">true</span>, it releases a partial result. You can also take many actions and look at (and possibly modify) the list to decide whether you want to release or discard.</p>

          <div class="Para" id="Par116">In this case, you run the following test:<div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine">return (list.size() == numProviders) || (timeout);</div></div></div></div>

          <p class="Para" id="Par117">One more parameter (<span class="EmphasisFontCategoryNonProportional ">numProviders</span>) is configured in this example. You set <span class="EmphasisFontCategoryNonProportional ">numProviders</span> (in this case, in <span class="EmphasisFontCategoryNonProportional ">application.properties</span>) to <span class="EmphasisFontCategoryNonProportional ">3</span>, as shown in Listing <span class="InternalRef"><a href="#PC40">6-39</a></span>. This is because you have three instances of the Product Server microservice. Once you receive response messages from the three Product Server microservice instances, you no longer want to wait for more responses.</p>

          <p class="Para" id="Par118">By specifying <span class="EmphasisFontCategoryNonProportional ">replyTemplate.setSharedReplyTopic(true)</span>, you indicate that multiple templates are using the same topic for replies. This simply changes logs for unexpected replies to debug instead of error.</p>

          <div class="Para" id="Par119">The <span class="EmphasisFontCategoryNonProportional ">replyTemplate.setDefaultReplyTimeout()</span> will set a timeout to check this release strategy in this example.<div class="ProgramCode" id="PC40"><div class="LineGroup"><div class="FixedLine">product.topic.reply.numProviders: 3</div><div class="FixedLine">product.topic.reply.aggregatingTimeout: 6</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-39</span><p class="SimplePara">The Product Web Kafka Configuration (ch06\ch06-03\02-ProductWeb\src\main\resources\application.properties)</p></div></div></div></div>

          <div class="Para" id="Par120">You can tweak this value by changing the value for <span class="EmphasisFontCategoryNonProportional ">aggregatingTimeout</span> in <span class="EmphasisFontCategoryNonProportional ">application.properties</span> of the Product Web microservice to test different scenarios. Listing <span class="InternalRef"><a href="#PC41">6-40</a></span> shows the dynamics of the aggregator code.<div class="ProgramCode" id="PC41"><div class="LineGroup"><div class="FixedLine">@RestController</div><div class="FixedLine">public class ProductRestController{</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    AggregatingReplyingKafkaTemplate&lt;String, String, Products&gt;</div><div class="FixedLine">        kafkaTemplate;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.topic.request-topic}")</div><div class="FixedLine">    private String requestTopic;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.topic.requestreply-topic}")</div><div class="FixedLine">    private String requestReplyTopic;</div></div><div class="LineGroup"><div class="FixedLine">    @RequestMapping(value = "/productsweb", method =</div><div class="FixedLine">            RequestMethod.GET,</div><div class="FixedLine">            produces = {MediaType.APPLICATION_JSON_VALUE})</div><div class="FixedLine">    public ResponseEntity&lt;List&lt;Product&gt;&gt; getAllProducts()</div><div class="FixedLine">            throws InterruptedException,</div><div class="FixedLine">            ExecutionException, TimeoutException {</div></div><div class="LineGroup"><div class="FixedLine">        ProducerRecord&lt;String, String&gt; record =</div><div class="FixedLine">            new ProducerRecord&lt;String, String&gt;(</div><div class="FixedLine">                requestTopic, "All");</div><div class="FixedLine">        record.headers().add(new RecordHeader(</div><div class="FixedLine">            KafkaHeaders.REPLY_TOPIC,</div><div class="FixedLine">            requestReplyTopic.getBytes()));</div><div class="FixedLine">        RequestReplyFuture&lt;String, String, Collection&lt;</div><div class="FixedLine">                ConsumerRecord&lt;String, Products&gt;&gt;&gt;</div><div class="FixedLine">            sendAndReceive =</div><div class="FixedLine">                kafkaTemplate.sendAndReceive(record);</div></div><div class="LineGroup"><div class="FixedLine">        SendResult&lt;String, String&gt; sendResult =</div><div class="FixedLine">            sendAndReceive.getSendFuture().get();</div><div class="FixedLine">        sendResult.getProducerRecord().headers().forEach(</div><div class="FixedLine">            header -&gt; LOGGER.trace(header.key() + ":" +</div><div class="FixedLine">                header.value().toString()));</div></div><div class="LineGroup"><div class="FixedLine">        sendAndReceive.getSendFuture().get(30,</div><div class="FixedLine">            TimeUnit.SECONDS);</div><div class="FixedLine">        ConsumerRecord&lt;String, Collection&lt;ConsumerRecord&lt;</div><div class="FixedLine">                String, Products&gt;&gt;&gt;</div><div class="FixedLine">            consumerRecords = sendAndReceive.get();</div></div><div class="LineGroup"><div class="FixedLine">        Collection&lt;ConsumerRecord&lt;String,</div><div class="FixedLine">                Products&gt;&gt; consumerRecord =</div><div class="FixedLine">            consumerRecords.value();</div><div class="FixedLine">        List&lt;Product&gt; products =new ArrayList&lt;Product&gt;();</div><div class="FixedLine">        for(ConsumerRecord&lt;String, Products&gt;</div><div class="FixedLine">                temp:consumerRecord) {</div><div class="FixedLine">            products.addAll(temp.value().getProducts());</div><div class="FixedLine">        }</div><div class="FixedLine">    return new ResponseEntity(products, HttpStatus.OK);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-40</span><p class="SimplePara">The Product Web REST Controller (ch06\ch06-03\02-ProductWeb\src\main\java\com\acme\ecom\product\controller\ProductRestController.java)</p></div></div></div></div>

          <p class="Para" id="Par121">For an explanation of the code in Listing <span class="InternalRef"><a href="#PC41">6-40</a></span>, see the section titled “Sync over Async Microservices” in Chapter <span class="ExternalRef"><a href="Capítulo-06.html"><span class="RefSource">4</span></a></span>. Here, I explain only the new code for fulfilling the aggregation. <span class="EmphasisFontCategoryNonProportional ">sendAndReceive</span> sends the request and <span class="EmphasisFontCategoryNonProportional ">AggregatingReplyingKafkaTemplate</span> receives a <span class="EmphasisFontCategoryNonProportional ">ConsumerRecord</span>, which by itself is a <span class="EmphasisFontCategoryNonProportional ">Collection</span> of <span class="EmphasisFontCategoryNonProportional ">ConsumerRecord</span>s containing a <span class="EmphasisFontCategoryNonProportional ">Collection</span> of <span class="EmphasisFontCategoryNonProportional ">Product</span>s retrieved from each instance of the Product Server microservice (a <span class="EmphasisFontCategoryNonProportional ">Collection</span> of <span class="EmphasisFontCategoryNonProportional ">Collection</span>)!</p>

          <p class="Para" id="Par122">You can disassemble the <span class="EmphasisFontCategoryNonProportional ">ConsumerRecord</span> of <span class="EmphasisFontCategoryNonProportional ">Collection</span> of <span class="EmphasisFontCategoryNonProportional ">ConsumerRecord</span> of <span class="EmphasisFontCategoryNonProportional ">Collection</span> of <span class="EmphasisFontCategoryNonProportional ">Product</span>s, flatten it, and aggregate it into a single <span class="EmphasisFontCategoryNonProportional ">ArrayList</span> and return. Note that you are not doing any filtering, de-duplication, or any such transformations here. However, you are free to do any further processing based on your requirements.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec21">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par123">The <span class="EmphasisFontCategoryNonProportional ">ch06\ch06-03</span> folder contains the Maven scripts required to <span id="ITerm34">build</span> the examples. First, you need to bring up the Kafka broker. Refer to Appendix D to learn how to set up Kafka server and bring it up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC42">6-41</a></span> to bring up Kafka from the Kafka installation location.<div class="ProgramCode" id="PC42"><div class="LineGroup"><div class="FixedLine">bin/zookeeper-server-start.sh config/zookeeper.properties</div><div class="FixedLine">bin/kafka-server-start.sh config/server.properties</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-41</span><p class="SimplePara">Commands to Bring Up Kafka Broker</p></div></div></div></div>

          <div class="Para" id="Par124">Next, use two command terminals and change the directory to the top-level folder of both microservices. Then build the Product Server microservice using the <span class="EmphasisFontCategoryNonProportional ">make.sh</span> scripts, as shown in Listing <span class="InternalRef"><a href="#PC43">6-42</a></span>.<div class="ProgramCode" id="PC43"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-03/01-ProductServer</div><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-42</span><p class="SimplePara">Commands to Build the Product Server Microservice</p></div></div></div></div>

          <div class="Para" id="Par125">Next, build the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC44">6-43</a></span>.<div class="ProgramCode" id="PC44"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch06/ch06-03/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-43</span><p class="SimplePara">Commands to Build the Product Web Microservice</p></div></div></div></div>

          <p class="Para" id="Par126">You will test this example with three instances of the Product Server microservice and a single instance of the Product Web microservice.</p>

          <div class="Para" id="Par127">Listing <span class="InternalRef"><a href="#PC45">6-44</a></span> shows how to bring up the first instance of the Product Server microservice.<div class="ProgramCode" id="PC45"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch06/ch06-03/01-ProductServer</div><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ java -jar -Dserver.port=8081 -D<strong class="EmphasisTypeBold ">spring.kafka.consumer.group-id=product-server1</strong> -Dcom.acme.ecom.product.kafka.client.productlistener.<strong class="EmphasisTypeBold ">sleeptimeout=2</strong> ./target/Ecom-Product-Server-Microservice-0.0.1-SNAPSHOT.jar</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-44</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 1</p></div></div></div></div>

          <div class="Para" id="Par128">Next, bring up the second instance of the Product Server microservice, as shown in Listing <span class="InternalRef"><a href="#PC46">6-45</a></span>.<div class="ProgramCode" id="PC46"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch06/ch06-03/01-ProductServer</div><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ java -jar -Dserver.port=8082 -D<strong class="EmphasisTypeBold ">spring.kafka.consumer.group-id=product-server2</strong> -Dcom.acme.ecom.product.kafka.client.productlistener.<strong class="EmphasisTypeBold ">sleeptimeout=10</strong> ./target/Ecom-Product-Server-Microservice-0.0.1-SNAPSHOT.jar</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-45</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 2</p></div></div></div></div>

          <div class="Para" id="Par129">Finally, bring up the third instance of the Product Server microservice, as shown in Listing <span class="InternalRef"><a href="#PC47">6-46</a></span>.<div class="ProgramCode" id="PC47"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch06/ch06-03/01-ProductServer</div><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ java -jar -Dserver.port=8083 -D<strong class="EmphasisTypeBold ">spring.kafka.consumer.group-id=product-server3</strong> -Dcom.acme.ecom.product.kafka.client.productlistener.<strong class="EmphasisTypeBold ">sleeptimeout=3</strong> ./target/Ecom-Product-Server-Microservice-0.0.1-SNAPSHOT.jar</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-46</span><p class="SimplePara">Commands to Run the Product Server Microservice Instance 3</p></div></div></div></div>

          <p class="Para" id="Par130">Note one aspect in Listings <span class="InternalRef"><a href="#PC45">6-44</a></span> through <span class="InternalRef"><a href="#PC47">6-46</a></span>:—the value passed for the environment variable <span class="EmphasisFontCategoryNonProportional ">spring.kafka.consumer.group-id</span>. The example configures different values for this so that the message consumers (or the provider microservices) are in different groups (<span class="EmphasisFontCategoryNonProportional ">group.id</span>). If they are all in the same group, only one of them will consume the request. By specifying all three instances of the Product Server microservices to be in different consumer groups, all of them will consume the same request message.</p>

          <div class="Para" id="Par131">Next, run the Product Web microservice instance, as shown in Listing <span class="InternalRef"><a href="#PC48">6-47</a></span>.<div class="ProgramCode" id="PC48"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch06/ch06-03/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh run.sh</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine">:: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2022-05-22 10:41:45 INFO  org.springframework.boot.StartupInfoLogger.logStarting:55 - Starting EcomProductWeb...</div><div class="FixedLine">2022-05-22 10:41:45 DEBUG org.springframework.boot.StartupInfoLogger.logStarting:56 - Running with Spring Boot ...</div><div class="FixedLine">2022-05-22 10:41:45 INFO  org.springframework.boot.SpringApplication.logStartupProfileInfo:651 - No active ...</div><div class="FixedLine">2022-05-22 10:41:47 INFO  org.springframework.boot.StartupInfoLogger.logStarted:61 - Started EcomProductWeb...</div><div class="FixedLine">2022-05-22 10:41:57 INFO  com.acme.ecom.product.controller.ProductRestController.getAllProducts:71 - Start</div><div class="FixedLine">2022-05-22 10:41:57 INFO  com.acme.ecom.product.controller.ProductRestController.getAllProducts:72 - Thread : Thread[http-nio-8080-exec-5,5,main]</div><div class="FixedLine">2022-05-22 10:41:59 DEBUG com.acme.ecom.product.KafkaConfig.lambda$replyKafkaTemplate$0:129 - <strong class="EmphasisTypeBold ">list.size() : 1; timeout : false</strong></div><div class="FixedLine">2022-05-22 10:42:00 DEBUG com.acme.ecom.product.KafkaConfig.lambda$replyKafkaTemplate$0:129 - <strong class="EmphasisTypeBold ">list.size() : 2; timeout : false</strong></div><div class="FixedLine">2022-05-22 10:42:03 DEBUG com.acme.ecom.product.KafkaConfig.lambda$replyKafkaTemplate$0:129 - <strong class="EmphasisTypeBold ">list.size() : 2; timeout : true</strong></div><div class="FixedLine">2022-05-22 10:42:03 DEBUG com.acme.ecom.product.controller.ProductRestController.getAllProducts:83 - Reply success ...</div><div class="FixedLine">2022-05-22 10:42:03 INFO  com.acme.ecom.product.controller.ProductRestController.getAllProducts:84 - Thread : Thread[http-nio-8080-exec-5,5,main]</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-47</span><p class="SimplePara">Commands to Run the Aggregator—the Product Web Microservice Instance</p></div></div></div></div>

          <div class="Para" id="Par132">Refer to Listings <span class="InternalRef"><a href="#PC45">6-44</a></span> through <span class="InternalRef"><a href="#PC47">6-46</a></span>, where the <span class="EmphasisFontCategoryNonProportional ">sleeptimeout</span> is configured for the three Product microservice instances respectively as:<div class="ProgramCode" id="PC49"><div class="LineGroup"><div class="FixedLine">-Dcom.acme.ecom.product.kafka.client.productlistener.<strong class="EmphasisTypeBold ">sleeptimeout=2</strong></div><div class="FixedLine">-Dcom.acme.ecom.product.kafka.client.productlistener.<strong class="EmphasisTypeBold ">sleeptimeout=10</strong></div><div class="FixedLine">-Dcom.acme.ecom.product.kafka.client.productlistener.<strong class="EmphasisTypeBold ">sleeptimeout=3</strong></div></div></div></div>

          <div class="Para" id="Par133">Now, referring to Listing <span class="InternalRef"><a href="#PC30">6-30</a></span>, you have configured the following in the Product Web microservice so that it will time out in six seconds:<div class="ProgramCode" id="PC50"><div class="LineGroup"><div class="FixedLine">product.topic.reply.aggregatingTimeout: 6</div></div></div></div>

          <p class="Para" id="Par134">It will receive responses from the Product Server microservice instances 1 and 3 alone.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec22">

          <h3 class="Heading">Testing the Microservice</h3>

          <p class="Para" id="Par135">When all is set, you can access the web application using your <span id="ITerm35">browser</span> and pointing to this URL (see Figure <span class="InternalRef"><a href="#Fig6">6-6</a></span>):</p>

          <div class="Para" id="Par136"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/product.html</span><figure class="Figure" id="Fig6"><div class="MediaObject" id="MO6"><img alt="" aria-describedby="d64e2863" src="../images/619782_1_En_6_Chapter/Imagem-069.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2863"><p class="Para" id="Par156">A screenshot contains the following providers. Kamsung. Lokia. Kamsung. Lokia Pomia.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 6-6</span><p class="SimplePara">Testing the microservices, showing results from two of the three service providers</p></div></figcaption></figure></div>

          <p class="Para" id="Par137">As described, the example uses three instances of the Product Server microservice instead of three different microservice types, so all of them will reply with the same response. But in Listing <span class="InternalRef"><a href="#PC46">6-45</a></span>, there is a delay called <span class="EmphasisFontCategoryNonProportional ">sleeptimeout=10</span> for one of the Product Server microservices. Listing <span class="InternalRef"><a href="#PC40">6-39</a></span> shows <span class="EmphasisFontCategoryNonProportional ">aggregatingTimeout: 6</span> for the Product Web microservice, so the <span class="EmphasisFontCategoryNonProportional ">AggregatingReplyingKafkaTemplate</span> of the Product Web microservice will not wait for the response from this instance of the Product Server microservice.</p>

          <p class="Para" id="Par138">Since you are not doing any filtering, de-duplication, or any such transformation, you’ll see duplicated line items from the responses of two instances of the Product Server microservices.</p>

          <div class="Para" id="Par139">Listing <span class="InternalRef"><a href="#PC51">6-48</a></span> shows the logging by the <span class="EmphasisFontCategoryNonProportional ">AggregatingReplyingKafkaTemplate</span> on the Product Web microservice.<div class="ProgramCode" id="PC51"><div class="LineGroup"><div class="FixedLine">list.size() : 1; timeout : false</div><div class="FixedLine">list.<strong class="EmphasisTypeBold ">size() : 2</strong>; timeout : false</div><div class="FixedLine">list.<strong class="EmphasisTypeBold ">size() : 2</strong>; timeout : <strong class="EmphasisTypeBold ">true</strong></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-48</span><p class="SimplePara">Aggregator Times Out</p></div></div></div></div>

          <p class="Para" id="Par140">Listing <span class="InternalRef"><a href="#PC51">6-48</a></span> shows what is happening when the template is consulting the release strategy upon timeout. The first two lines correspond to when responses are received from the two instances of the Product Web microservice within the timeout limit. The third line corresponds to when the template does this with the timeout argument <span class="EmphasisFontCategoryNonProportional ">set to true</span>, to tell the strategy it’s a timeout rather than a delivery call, so it will not wait for any more responses.</p>

          <p class="Para" id="Par141">This aggregated response is shown in Figure <span class="InternalRef"><a href="#Fig6">6-6</a></span>.</p>

          <div class="Para" id="Par142">In real life, you may not statically configure <span class="EmphasisFontCategoryNonProportional ">product.topic.reply.numProviders</span>, as is done in in Listing <span class="InternalRef"><a href="#PC40">6-39</a></span>. Instead, you have to dynamically form the value of <span class="EmphasisFontCategoryNonProportional ">numProviders</span> based on the minimum number of service providers you expect until there’s a timeout. The typical production design is shown in Figure <span class="InternalRef"><a href="#Fig7">6-7</a></span>, where the travel agent or travel aggregator has contracts with multiple air, hotel, cab and other ancillary service providers. Travel search parameters are relayed to all or preferred inventory providers and the responses from all or many of these preferred providers are aggregated. Filtering, de-duplication, or any transformations can be applied and the result set sorted again, based on a similar set of rules and responses sent to the Booking Service provider Web microservice.<figure class="Figure" id="Fig7"><div class="MediaObject" id="MO7"><img alt="" aria-describedby="d64e2957" src="../images/619782_1_En_6_Chapter/Imagem-070.jpg" style="width:35.15em"/><div class="TextObject" id="d64e2957"><p class="Para" id="Par157">A process diagram illustrate the aggregator connected to the third-party inventory providers.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 6-7</span><p class="SimplePara">Booking aggregator connected to third-party <span id="ITerm36">inventory providers</span></p></div></figcaption></figure></div>

          <div class="Para" id="Par143">I will now change the test condition. Let’s increase the aggregating timeout, as shown in Listing <span class="InternalRef"><a href="#PC52">6-49</a></span>.<div class="ProgramCode" id="PC52"><div class="LineGroup"><div class="FixedLine">product.topic.reply.numProviders: 3</div><div class="FixedLine">product.topic.reply.aggregatingTimeout: 15</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-49</span><p class="SimplePara">The Product Web Kafka Configuration (ch06\ch06-03\02-ProductWeb\src\main\resources\application.properties.</p></div></div></div></div>

          <p class="Para" id="Par144">You increase the aggregating timeout by adjusting the value in Listing <span class="InternalRef"><a href="#PC52">6-49</a></span> so that you are sure you will receive responses from all three instances of the Product Server microservice before the timeout, as configured in Listings <span class="InternalRef"><a href="#PC45">6-44</a></span> through <span class="InternalRef"><a href="#PC47">6-46</a></span>.</p>

          <div class="Para" id="Par145">You have not made any changes to the Product Server microservice, so you could repeat the test with the same running instances of it. But you need to rebuild and rerun the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC53">6-50</a></span>.<div class="ProgramCode" id="PC53"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-03/ch06/ch06-03/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">...</div></div><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh run.sh</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine">:: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2022-05-22 10:53:48 INFO  org.springframework.boot.StartupInfoLogger.logStarting:55 - Starting EcomProductWeb...</div><div class="FixedLine">2022-05-22 10:53:48 DEBUG org.springframework.boot.StartupInfoLogger.logStarting:56 - Running with Spring Boot ...</div><div class="FixedLine">2022-05-22 10:53:48 INFO  org.springframework.boot.SpringApplication.logStartupProfileInfo:651 - No active ...</div><div class="FixedLine">2022-05-22 10:53:50 INFO  org.springframework.boot.StartupInfoLogger.logStarted:61 - Started EcomProductWeb...</div><div class="FixedLine">2022-05-22 10:54:02 INFO  com.acme.ecom.product.controller.ProductRestController.getAllProducts:71 - Start</div><div class="FixedLine">2022-05-22 10:54:02 INFO  com.acme.ecom.product.controller.ProductRestController.getAllProducts:72 - Thread : Thread[http-nio-8080-exec-5,5,main]</div><div class="FixedLine">2022-05-22 10:54:04 DEBUG com.acme.ecom.product.KafkaConfig.lambda$replyKafkaTemplate$0:129 - list.size() : 1; timeout : <strong class="EmphasisTypeBold ">false</strong></div><div class="FixedLine">2022-05-22 10:54:05 DEBUG com.acme.ecom.product.KafkaConfig.lambda$replyKafkaTemplate$0:129 - list.size() : 2; timeout : <strong class="EmphasisTypeBold ">false</strong></div><div class="FixedLine">2022-05-22 10:54:12 DEBUG com.acme.ecom.product.KafkaConfig.lambda$replyKafkaTemplate$0:129 - <strong class="EmphasisTypeBold ">list.size() : 3; timeout : false</strong></div><div class="FixedLine">2022-05-22 10:54:12 DEBUG com.acme.ecom.product.controller.ProductRestController.getAllProducts:83 - Reply success ...</div><div class="FixedLine">2022-05-22 10:54:12 INFO  com.acme.ecom.product.controller.ProductRestController.getAllProducts:84 - Thread : Thread[http-nio-8080-exec-5,5,main]</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-50</span><p class="SimplePara">Rebuild and Run Product Web Microservice Using Scripts</p></div></div></div></div>

          <p class="Para" id="Par146">You can now test the application by accessing the web application using your browser and pointing to this URL (see Figure <span class="InternalRef"><a href="#Fig8">6-8</a></span>):</p>

          <div class="Para" id="Par147"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/product.html</span><figure class="Figure" id="Fig8"><div class="MediaObject" id="MO8"><img alt="" aria-describedby="d64e3074" src="../images/619782_1_En_6_Chapter/Imagem-071.jpg" style="width:35.15em"/><div class="TextObject" id="d64e3074"><p class="Para" id="Par158">A screenshot contains the following service providers. Kamsung. Lokia.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 6-8</span><p class="SimplePara">Testing the microservices, showing results from all the service providers</p></div></figcaption></figure></div>

          <div class="Para" id="Par148">If you observe Listing <span class="InternalRef"><a href="#PC53">6-50</a></span>, you can see that even though the timeout has not occurred, since you received responses from all expected instances of the Product Server microservices, you can terminate waiting at the third delivery call, as shown in Listing <span class="InternalRef"><a href="#PC54">6-51</a></span>.<div class="ProgramCode" id="PC54"><div class="LineGroup"><div class="FixedLine">list.size() : 1; timeout : false</div><div class="FixedLine">list.<strong class="EmphasisTypeBold ">size() : 2</strong>; timeout : false</div><div class="FixedLine">list.<strong class="EmphasisTypeBold ">size() : 3</strong>; timeout : <strong class="EmphasisTypeBold ">false</strong></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-51</span><p class="SimplePara">Aggregator Times Out</p></div></div></div></div>

          <p class="Para" id="Par149">You can see duplicated line items from the three instances of the Product Server microservices in Figure <span class="InternalRef"><a href="#Fig8">6-8</a></span>.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec23">

        <h2 class="Heading">Summary</h2>

        <p class="Para" id="Par150">Starting with the simplest of the microservices in Chapter <span class="ExternalRef"><a href="Capítulo-03.html"><span class="RefSource">1</span></a></span>, you have come a long way in understanding multiple variants of microservices architectures. You have tried and tested many concurrency and integration patterns, with familiar SQL and NoSQL databases. The examples in these chapters can be extracted to use as templates and modified for your daily production use cases. The stage is now set to begin the next journey to Containers, which are covered in the next chapter.</p>

      </section>

      <aside aria-label="Footnotes" class="FootnoteSection" epub:type="footnotes">

        <div class="Heading">Footnotes</div>

        <div class="Footnote"><span class="FootnoteNumber"><a href="#Fn1_source">1</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn1" role="doc-footnote"><p class="Para" id="Par25">As per strict HTTP specifications, the difference between a POST and PUT is in how the server interprets the URI. In a POST, the URI normally identifies an object on the server that can process the included data. In a PUT, the URI identifies a resource in which the server should place the data. So a POST URI generally indicates a program or script that can do processing; a PUT URI is usually the path and name for a resource.</p></div><div class="ClearBoth"> </div></div>

      </aside>

    </div>

  </div>

</body>

</html>