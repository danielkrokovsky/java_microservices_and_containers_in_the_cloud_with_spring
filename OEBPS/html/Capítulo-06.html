<?xml version='1.0' encoding='utf-8'?>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en">

<head>
  <title>Message Oriented Microservices</title>
  <link href="../css/springer_epub.css" rel="styleSheet" type="text/css"/>
</head>

<body>

  <div epub:type="chapter" role="doc-chapter">

    <div class="ChapterContextInformation">

      <div class="ContextInformation" id="b979-8-8688-0555-4_4"><div class="ChapterCopyright">© The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature 2024</div><span class="ContextInformationAuthorEditorNames">B. A. Christudas</span><span class="ContextInformationBookTitles"><span class="BookTitle">Java Microservices and Containers in the Cloud</span></span><span class="ChapterDOI"><a href="https://doi.org/10.1007/979-8-8688-0555-4_4">https://doi.org/10.1007/979-8-8688-0555-4_4</a></span></div>

    </div>

    <!--Begin Abstract-->

    <div class="MainTitleSection">

      <h1 class="ChapterTitle" lang="en">4. Message Oriented Microservices</h1>

    </div>

    <div class="AuthorGroup">

      <div class="AuthorNames"><span class="Author"><span class="AuthorName">Binildas A. Christudas</span><sup><a href="#Aff2">1</a> <span class="ContactIcon"> </span></sup></span></div>

      <div class="Affiliations">

        <div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">NBCRA 45, Christbin, Thiruvananthapuram, Kerala, India</div></div>

        <div class="ClearBoth"> </div>

      </div>

    </div>

    <!--End Abstract-->

    <div class="Fulltext">

      <p class="Para" id="Par2">In the previous chapters of this book, you saw microservices interacting with each other and human actors (end users) interacting with the edge microservice using a client device (a browser). Because microservices are “micro” in nature, multiple microservices must often communicate with each other to meet useful business functionalities. These inter-microservices communications can be within a business domain or across business domains.</p>

      <p class="Para" id="Par3">Microservices are distributed parts of an application that run on multiple processes or services, sometimes even across multiple servers or hosts or even across multiple geographies. Each service instance is typically a computer process. Therefore, inter-microservice communications happen using an <span id="ITerm1">inter-process communication (IPC) protocol</span> such as HTTP or AMQP, or using a binary protocol like TCP, depending on the nature of these microservices.</p>

      <p class="Para" id="Par4">Inter-microservice communication using REST is simple and straightforward. REST in its simplest form is synchronous, in that the client sends a request and waits for a response from the service. Hence the client code or the client-side thread can only continue its task when it receives the HTTP response from the server. While this is okay, there are alternate paradigms that you can use to achieve inter-microservice communication, but in a more flexible and scalable manner. This chapter introduces message-oriented <span id="ITerm2">microservices</span>, whereby microservices can communicate over messaging backbones.</p>

      <div class="Para" id="Par5">This chapter covers the following concepts:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par6">Characteristics of microservices</p></li><li><p class="Para" id="Par7">REST-based request-response style inter-microservices communication</p></li><li><p class="Para" id="Par8">The need for a flexible schema for inter-microservices communication</p></li><li><p class="Para" id="Par9">Introduction to messaging channels</p></li><li><p class="Para" id="Par10">Inter-microservices communication using messaging channels</p></li><li><p class="Para" id="Par11">Bringing flexibility to the request-response style interaction of a web browser</p></li></ul></div></div>

      <section class="Section1 RenderAsSection1" id="Sec1">

        <h2 class="Heading">Characteristics of Microservices</h2>

        <p class="Para" id="Par12">This section starts by looking at typical <span id="ITerm3">characteristics</span> of a microservice application, which will help you understand the need for a new paradigm for inter-microservice communication.</p>

        <section class="Section2 RenderAsSection2" id="Sec2">

          <h3 class="Heading">Microservices Are Autonomous</h3>

          <p class="Para" id="Par13">You know that microservices communicate each other, since a single microservice alone may not be sufficient to fulfill an end-to-end business use case. At the same time, one of the goals of the microservices architecture is that each microservice is <span id="ITerm4">autonomous</span> and is available to the client consumer, even when the other microservices that are part of the end-to-end application flow are down or unhealthy. This is in addition to the basic principle that a microservice owns and encapsulates its own data.</p>

          <div class="Para" id="Par14">When microservices communicate using REST in the typical synchronous style, they are said to be communicating in a point-to-point fashion. Thus, an HTTP transport is a point-to-point channel, which ensures that only one receiver will receive a particular message (see Figure <span class="InternalRef"><a href="#Fig1">4-1</a></span>).<figure class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img alt="" aria-describedby="d64e241" src="../images/619782_1_En_4_Chapter/Imagem-033.jpg" style="width:35.18em"/><div class="TextObject" id="d64e241"><p class="Para" id="Par102">A diagram of a Point-to-point communication system. It depicts a sender on the left, that sends a request to a receiver. </p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 4-1</span><p class="SimplePara"><span id="ITerm5">Point-to-point communication</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par15">Figure <span class="InternalRef"><a href="#Fig1">4-1</a></span> represents an Order microservice. The order is created and then sent to the Dispatch microservice. When you make a call from the Order microservice to the Dispatch microservices (such as performing an HTTP request for a dispatch order event), this call chain can provide a response to a client application. This architecture won’t be resilient enough when some of these microservices fail. To rephrase, if the provider microservice cannot respond within SLA, the consumer microservice will receive an error.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec3">

          <h3 class="Heading">Microservices Are Evolutionary</h3>

          <p class="Para" id="Par16">A better alternative is to employ loose coupling between microservices. You can substitute the HTTP channel with a messaging channel. Here again, the message queue is point-to-point, so you need to use message topics, which are one-to-many. Topics provide Publish-Subscribe semantics, which deliver a copy of a particular event to each subscribed receiver.</p>

          <div class="Para" id="Par17">In a Publish-Subscribe channel, one input channel splits into multiple output channels, one for each subscriber microservice. When an event is published into the channel, the Publish-Subscribe channel delivers a copy of the message to be delivered to each of the output channels. Each output channel has only one subscriber microservice, which is only allowed to consume a message once. In this way, each subscriber only gets the message once; consumed copies disappear from their channels. See Figure <span class="InternalRef"><a href="#Fig2">4-2</a></span>.<figure class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img alt="" aria-describedby="d64e268" src="../images/619782_1_En_4_Chapter/Imagem-034.jpg" style="width:29.7em"/><div class="TextObject" id="d64e268"><p class="Para" id="Par103">A flow diagram of a publish-subscribe channel. It starts with an order delivered by the publisher to the subscriber. The subscriber is dispatched to and notified.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 4-2</span><p class="SimplePara">Publish-subscribe channel</p></div></figcaption></figure></div>

          <p class="Para" id="Par18">This <span id="ITerm6">Publish-Subscribe channel</span> not only brings more autonomy to individual microservices, but it also allows the microservices application to evolve at its own pace over time. In other words, as you can see in Figure <span class="InternalRef"><a href="#Fig2">4-2</a></span>, when the microservices application grows over time and you need to add more microservices, you don’t need to disturb the existing architecture; you don’t even need to restart the existing application deployment!</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec4">

          <h3 class="Heading">The Honeycomb Analogy</h3>

          <div class="Para" id="Par19">The discussions so far bring us to the analogy of a <span id="ITerm7">honeycomb</span> for the microservices architecture. The microservices application architecture starts to grow from the first, single microservice to many more microservices, just like a honeycomb is built (see Figure <span class="InternalRef"><a href="#Fig3">4-3</a></span>).<figure class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img alt="" aria-describedby="d64e311" src="../images/619782_1_En_4_Chapter/Imagem-035.jpg" style="width:35.15em"/><div class="TextObject" id="d64e311"><p class="Para" id="Par104">A flow diagram of honeycomb structures resembling a microservice. It starts with a single hexagonal structure and ends with 6 hexagons of a honeycomb structure.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 4-3</span><p class="SimplePara">Microservices honeycomb analogy</p></div></figcaption></figure></div>

          <p class="Para" id="Par20">The next section looks at the messaging infrastructure as a medium for inter-microservice communication.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec5">

        <h2 class="Heading">Async, Still Request-Reply</h2>

        <p class="Para" id="Par21">I purposefully omitted another important aspect in the previous section, which is the need to have Request Reply semantics for typical inter-microservices communication. Messaging channels are asynchronous, rather typically one way, or request alone. How do you then get the corresponding reply? This section discusses this issue.</p>

        <section class="Section2 RenderAsSection2" id="Sec6">

          <h3 class="Heading">Async Request</h3>

          <p class="Para" id="Par22">HTTP channels are not only synchronous, but they also provide a mechanism for the sender to receive a reply or response. However, as discussed, to realize the full benefits of a message-based architecture, the event delegation mechanism must be inherently asynchronous. There may however be many use cases where a synchronous styled request-reply semantic is still needed. The challenge is then to mimic <span id="ITerm8">request-reply semantics</span> over message channels, which are otherwise one-way channels.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec7">

          <h3 class="Heading">Async Request-Reply</h3>

          <div class="Para" id="Par23">When an application sends a message, how can it get a corresponding response from the receiver through messaging channels? The Request-Reply Enterprise Integration pattern provides a proven mechanism for synchronous styled message exchange over <span id="ITerm9">asynchronous channels</span><span id="ITerm10"></span> (see Figure <span class="InternalRef"><a href="#Fig4">4-4</a></span>).<figure class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img alt="" aria-describedby="d64e360" src="../images/619782_1_En_4_Chapter/Imagem-036.jpg" style="width:35.15em"/><div class="TextObject" id="d64e360"><p class="Para" id="Par105">A flow diagram of a request-reply. A sender dispatched an order at the request of a receiver. A synchronous message is depicted.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 4-4</span><p class="SimplePara">Request reply over async</p></div></figcaption></figure></div>

          <div class="Para" id="Par24">The solution is to send a pair of request-reply messages, each on its own channel. However, there is a problem. A service provider or a receiver (or a server role microservice) can accept requests in a well-known channel that it can advertise. But what about a client’s channel address? Multiple clients can connect to the same microservice process in the server role, and it’s not possible for the server to know or remember the reply channel, since clients come and go, and many more new clients might appear in the future. Instead, one proven way is for the request message to contain a return address that indicates where to send the reply message (see Figure <span class="InternalRef"><a href="#Fig5">4-5</a></span>).<figure class="Figure" id="Fig5"><div class="MediaObject" id="MO5"><img alt="" aria-describedby="d64e382" src="../images/619782_1_En_4_Chapter/Imagem-037.jpg" style="width:35.15em"/><div class="TextObject" id="d64e382"><p class="Para" id="Par106">A diagram of a return address pattern. It starts with 2 requestors that send requests and receive replies from a replier through different channels.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 4-5</span><p class="SimplePara"><span id="ITerm11">Return address pattern</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par25">By attaching the return address along with the request, the replier does not need to know or remember where to send the reply. It can just inspect and infer that from the request. If different messages to the same replier require replies to different places, the replier can infer where to send the corresponding reply for each request. This encapsulates the knowledge of what channels to use for requests and replies within the requestor, so those decisions do not have to be hard-coded within the replier. A return address is placed in the header of a message because it’s not part of the data being transmitted, and the message transport infrastructure doesn’t need to inspect the payload.</p>

          <p class="Para" id="Par26">The next section demonstrates this process in code.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec8">

        <h2 class="Heading">Sync Over Async Microservices</h2>

        <p class="Para" id="Par27">In this example, you will tweak the same set of <span id="ITerm12">microservices</span> you saw earlier. A consumer and a provider microservice will communicate with each other using a messaging channel. The provider microservice stores the entity in an in-memory database, to keep the example simple.</p>

        <section class="Section2 RenderAsSection2" id="Sec9">

          <h3 class="Heading">Design Microservices Over Async Channel</h3>

          <div class="Para" id="Par28">This example slightly modifies the hexagonal microservice view shown in Figure <span class="ExternalRef"><a href="Capítulo-04.html#Fig1"><span class="RefSource">2-1</span></a></span> in Chapter <span class="ExternalRef"><a href="Capítulo-04.html"><span class="RefSource">2</span></a></span> so that both microservices <span id="ITerm13">communicate</span> through an async messaging channel instead of the HTTP channel. Apache Kafka is used as the messaging channel, which is inherently asynchronous. Remember, the objective is to simulate synchronous styled communication over the Kafka-based async channel. See Figure <span class="InternalRef"><a href="#Fig6">4-6</a></span>.<figure class="Figure" id="Fig6"><div class="MediaObject" id="MO6"><img alt="" aria-describedby="d64e442" src="../images/619782_1_En_4_Chapter/Imagem-038.jpg" style="width:35.15em"/><div class="TextObject" id="d64e442"><p class="Para" id="Par107">A flow diagram of communication of microservices. It starts with the incoming command, Rest A P I, entity, request channel, and the final entity.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 4-6</span><p class="SimplePara">Microservices <span id="ITerm14">communicate</span> over async channel</p></div></figcaption></figure></div>

          <p class="Para" id="Par29">The end user request from the browser will reach the Product Web microservice first. The Product Web microservice will delegate the request to the Product Server microservice, but through a message channel. The Product Server microservice could automatically know which channel to send replies to the Product Web microservice, but as discussed earlier, hard-coded assumptions make the software less flexible and more difficult to maintain. In this case, a single Product Server microservice instance could be processing calls from several different requestor types and/or even from multiple instances of the same requestor type, so the reply channel is not the same for every message. It depends on which requestor sent that request message. You can use the return address pattern in this case.</p>

          <p class="Para" id="Par30">Note that the Product Server microservice in this example is using a messaging port, in contrast to the HTTP port used in previous examples. This further validates the aspect of how different ports and adapters in the hexagonal architecture can be plugged in easily, as and when required.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec10">

          <h3 class="Heading">Understanding the Code</h3>

          <p class="Para" id="Par31">The <span id="ITerm15">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch04\ch04-01</span> folder. This section looks at the changes in the consumer microservice—that is, the Product Web microservice—first.</p>

          <div class="Para" id="Par32">The core component used is the <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate&lt;K,V,R&gt;</span> from Spring, which extends the behavior of a <span class="EmphasisFontCategoryNonProportional ">KafkaTemplate</span> to provide request-reply semantics. To set this up, you need a producer (<span class="EmphasisFontCategoryNonProportional ">ProducerFactory</span>) and a <span class="EmphasisFontCategoryNonProportional ">KafkaMessageListenerContainer</span>. Listing <span class="InternalRef"><a href="#PC1">4-1</a></span> shows how to do this using a Kafka <span class="EmphasisFontCategoryNonProportional ">Configuration</span> class.<div class="ProgramCode" id="PC1"><div class="LineGroup"><div class="FixedLine">@Configuration</div><div class="FixedLine">public class KafkaConfig {</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public Map&lt;String, Object&gt; producerConfigs() {</div><div class="FixedLine">        // config values goes here</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public Map&lt;String, Object&gt; consumerConfigs() {</div><div class="FixedLine">        // config values goes here</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public ProducerFactory&lt;String, String&gt; producerFactory() {</div><div class="FixedLine">        return new DefaultKafkaProducerFactory&lt;&gt;(</div><div class="FixedLine">            producerConfigs());</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public KafkaTemplate&lt;String, String&gt; kafkaTemplate() {</div><div class="FixedLine">        return new KafkaTemplate&lt;&gt;(producerFactory());</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public ReplyingKafkaTemplate&lt;String, String, Products&gt;</div><div class="FixedLine">            replyKafkaTemplate(ProducerFactory&lt;</div><div class="FixedLine">            String, String&gt; pf, KafkaMessageListenerContainer&lt;</div><div class="FixedLine">            String, Products&gt; container){</div></div><div class="LineGroup"><div class="FixedLine">        return new ReplyingKafkaTemplate&lt;&gt;(pf, container);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public KafkaMessageListenerContainer&lt;String, Products&gt;</div><div class="FixedLine">            replyContainer(</div><div class="FixedLine">            ConsumerFactory&lt;String, Products&gt; cf) {</div></div><div class="LineGroup"><div class="FixedLine">        ContainerProperties containerProperties =</div><div class="FixedLine">            new ContainerProperties(requestReplyTopic);</div><div class="FixedLine">        return new KafkaMessageListenerContainer&lt;&gt;(cf,</div><div class="FixedLine">            containerProperties);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public ConsumerFactory&lt;String, Products&gt;</div><div class="FixedLine">            consumerFactory() {</div></div><div class="LineGroup"><div class="FixedLine">        return new DefaultKafkaConsumerFactory&lt;&gt;(</div><div class="FixedLine">            consumerConfigs(),</div><div class="FixedLine">            new StringDeserializer(),new JsonDeserializer&lt;&gt;(</div><div class="FixedLine">                Products.class));</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public KafkaListenerContainerFactory&lt;</div><div class="FixedLine">            ConcurrentMessageListenerContainer&lt;</div><div class="FixedLine">            String, Products&gt;&gt;</div><div class="FixedLine">                kafkaListenerContainerFactory() {</div></div><div class="LineGroup"><div class="FixedLine">        ConcurrentKafkaListenerContainerFactory&lt;String,</div><div class="FixedLine">            Products&gt; factory =</div><div class="FixedLine">            new ConcurrentKafkaListenerContainerFactory&lt;&gt;();</div><div class="FixedLine">        factory.setConsumerFactory(consumerFactory());</div><div class="FixedLine">        factory.setReplyTemplate(kafkaTemplate());</div><div class="FixedLine">        return factory;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public KafkaAdmin admin() {</div><div class="FixedLine">        Map&lt;String, Object&gt; configs = new HashMap&lt;&gt;();</div><div class="FixedLine">        configs.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,</div><div class="FixedLine">            bootstrapServers);</div><div class="FixedLine">        return new KafkaAdmin(configs);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    @Bean</div><div class="FixedLine">    public NewTopic requestTopic() {</div><div class="FixedLine">        Map&lt;String, String&gt; configs = new HashMap&lt;&gt;();</div><div class="FixedLine">        configs.put("retention.ms", replyTimeout.toString());</div><div class="FixedLine">        return new NewTopic(requestReplyTopic, 2, (short) 1).</div><div class="FixedLine">            configs(configs);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-1</span><p class="SimplePara">Kafka Configuration for Message Producer (ch04\ch04-01\02-ProductWeb\src\main\java\com\acme\ecom\product\KafkaConfig.java)</p></div></div></div></div>

          <div class="Para" id="Par33">To understand the event transport mechanics, consider how a typical event (aka, a message) will look:<div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><p class="Para" id="Par34">Event key: “Ria”</p></li><li><p class="Para" id="Par35">Event value: “Made a payment of $300 to Ann”</p></li><li><p class="Para" id="Par36">Event timestamp: “Sep. 25, 2021 at 3:06 p.m.”</p></li></ul></div></div>

          <div class="Para" id="Par37">There is an originator for an event, and events are typically time series data. If you look at the template for sending an event, the <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate &lt;K, V, R&gt;</span> offers a return object or a reply object once the message is consumed by the Kafka listener from the provider or producer side. The <span id="ITerm16">type parameters</span> represent:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par38"><span class="EmphasisFontCategoryNonProportional ">K</span> – The key type</p></li><li><p class="Para" id="Par39"><span class="EmphasisFontCategoryNonProportional ">V</span> – The outbound data type</p></li><li><p class="Para" id="Par40"><span class="EmphasisFontCategoryNonProportional ">R</span> – The reply data type</p></li></ul></div></div>

          <p class="Para" id="Par41">Here, the event timestamp shown in the example event could be an optional metadata header. Keys are used to determine the partition in a log in the messaging infrastructure to which a message is appended. Value is the actual payload of the message. When a new event is published to a topic, it is appended to one of the topic’s partitions. <span id="ITerm17">Events</span> with the same event key (e.g., a Customer ID or Account ID) are written to the same partition, and Kafka guarantees that any consumer of a given topic-partition will always read that partition’s events in the same order as they were written.</p>

          <p class="Para" id="Par42">The key and/or value can be null, too. If the key is null, then a random partition will be selected. If the value is null, it can have special “delete” semantics if you enabled the log-compaction policy instead of the log-retention policy for a topic.</p>

          <p class="Para" id="Par43">Using the key to direct to a partition is the default strategy of the producer. Specifying the key so that all events on the same key go to the same partition is important for proper ordering of message processing, if you have multiple consumers in a consumer group<sup><a epub:type="noteref" href="#Fn1" id="Fn1_source" role="doc-noteref">1</a></sup> on a topic. Without a key, two messages on the same key could go to different partitions and be processed by different consumers in the group, out of order.</p>

          <p class="Para" id="Par45">Ultimately, the producer chooses which partition to use. If you specify the partition parameter, it will be used, and the key will be “ignored” even though it’s still written into the topic. This allows you to have a customized partitioning even if you have keys. In other words, the order guarantees come not from the key but from messages being in the same partition. To restate, the routing of messages to partitions doesn’t have to be key-based. You can explicitly specify a partition when creating a <span class="EmphasisFontCategoryNonProportional ">ProducerRecord</span>.</p>

          <p class="Para" id="Par46">This example defines the bean as <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate&lt;String, String, Products&gt;</span>, where you will send a <span class="EmphasisFontCategoryNonProportional ">String</span> type request to Kafka and then get the <span class="EmphasisFontCategoryNonProportional ">Products</span> type object as the reply data type. You will create the Products and the included DTO classes in the next section. To summarize, you set up a <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate</span> that sends request messages with <span class="EmphasisFontCategoryNonProportional ">String</span> keys and receives reply messages with <span class="EmphasisFontCategoryNonProportional ">String</span> keys. The <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate</span> needs to be backed by a <span class="EmphasisFontCategoryNonProportional ">Request ProducerFactory</span>, a <span class="EmphasisFontCategoryNonProportional ">ReplyConsumerFactory</span>, and a <span class="EmphasisFontCategoryNonProportional ">MessageListenerContainer</span>, with corresponding consumer and producer configs, which was done in the <span class="EmphasisFontCategoryNonProportional ">KafkaAdmin</span> in Listing <span class="InternalRef"><a href="#PC1">4-1</a></span>.</p>

          <p class="Para" id="Par47">When you define a <span class="EmphasisFontCategoryNonProportional ">KafkaAdmin</span> bean in the application context, it can automatically add topics to the broker. To do that, you need to add a <span class="EmphasisFontCategoryNonProportional ">NewTopic @Bean</span> for each topic to the application context.</p>

          <p class="Para" id="Par48">The <span class="EmphasisFontCategoryNonProportional ">ContainerProperties</span> contains runtime properties for a listener container. Even though you specify the reply address using <span class="EmphasisFontCategoryNonProportional ">requestReplyTopic</span>, you will later see that this example explicitly sets the return address while sending the message. It creates a single-threaded message listener container using the Java consumer.</p>

          <div class="Para" id="Par49">The REST controller class, which is used in <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate</span>, is configured in <span class="EmphasisFontCategoryNonProportional ">KafkaAdmin</span> in Listing <span class="InternalRef"><a href="#PC2">4-2</a></span>.<div class="ProgramCode" id="PC2"><div class="LineGroup"><div class="FixedLine">@RestController</div><div class="FixedLine">public class ProductRestController{</div></div><div class="LineGroup"><div class="FixedLine">    @Autowired</div><div class="FixedLine">    ReplyingKafkaTemplate&lt;String, String,Products&gt; kafkaTemplate;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.topic.request-topic}")</div><div class="FixedLine">    private String requestTopic;</div></div><div class="LineGroup"><div class="FixedLine">    @Value("${kafka.topic.requestreply-topic}")</div><div class="FixedLine">    private String requestReplyTopic;</div></div><div class="LineGroup"><div class="FixedLine">    @RequestMapping(value = "/productsweb",</div><div class="FixedLine">        method = RequestMethod.GET,</div><div class="FixedLine">        produces = {MediaType.APPLICATION_JSON_VALUE})</div><div class="FixedLine">    public ResponseEntity&lt;Resources&lt;Resource&lt;Product&gt;&gt;&gt;</div><div class="FixedLine">            getAllProducts() throws InterruptedException,</div><div class="FixedLine">            ExecutionException {</div></div><div class="LineGroup"><div class="FixedLine">        ProducerRecord&lt;String, String&gt; record =</div><div class="FixedLine">            new ProducerRecord&lt;String,</div><div class="FixedLine">            String&gt;(requestTopic, "All");</div><div class="FixedLine">        record.headers().add(new RecordHeader(</div><div class="FixedLine">            KafkaHeaders.REPLY_TOPIC,</div><div class="FixedLine">            requestReplyTopic.getBytes()));</div><div class="FixedLine">        RequestReplyFuture&lt;String, String, Products&gt;</div><div class="FixedLine">            sendAndReceive =</div><div class="FixedLine">                kafkaTemplate.sendAndReceive(record);</div><div class="FixedLine">        ConsumerRecord&lt;String, Products&gt; consumerRecord =</div><div class="FixedLine">            sendAndReceive.get();</div><div class="FixedLine">        return new ResponseEntity(consumerRecord.value().</div><div class="FixedLine">            getProducts(), HttpStatus.OK);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-2</span><p class="SimplePara">Kafka Configuration for <span id="ITerm18">Message Producer</span> (ch04\ch04-01\02-ProductWeb\src\main\java\com\acme\ecom\product\controller\ProductRestController.java)</p></div></div></div></div>

          <p class="Para" id="Par50">The REST controller receives the requests from the client device, the browser in this case. Inside the controller, the <span class="EmphasisFontCategoryNonProportional ">requestReplyKafkaTemplate</span> generates and sets a <span class="EmphasisFontCategoryNonProportional ">KafkaHeaders.CORRELATION_ID</span> header. The <span class="EmphasisFontCategoryNonProportional ">CorrelationId</span> should be consumed by the provider microservice and return the same in the header. You need to set the <span class="EmphasisFontCategoryNonProportional ">KafkaHeaders.REPLY_TOPIC</span> header on the request explicitly, even though the same reply topic was redundantly wired into the <span class="EmphasisFontCategoryNonProportional ">replyListenerContainer</span> in the <span class="EmphasisFontCategoryNonProportional ">KafkaConfig</span> earlier.</p>

          <p class="Para" id="Par51">The <span class="EmphasisFontCategoryNonProportional ">sendAndReceive</span> method of <span class="EmphasisFontCategoryNonProportional ">ReplyingKafkaTemplate</span> sends a request and receives a reply with the default timeout. It gives you a <span class="EmphasisFontCategoryNonProportional ">RequestReplyFuture</span>, on which you can call the <span class="EmphasisFontCategoryNonProportional ">get</span>, which will wait if necessary for the computation to complete and then retrieve its result. <span class="EmphasisFontCategoryNonProportional ">Products</span> in this case.</p>

          <div class="Para" id="Par52">Next, look at the <span class="EmphasisFontCategoryNonProportional ">Products</span> <span id="ITerm19">class</span>. See Listing <span class="InternalRef"><a href="#PC3">4-3</a></span>.<div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine">public class Products {</div></div><div class="LineGroup"><div class="FixedLine">    private List&lt;Product&gt; products;</div></div><div class="LineGroup"><div class="FixedLine">    public List&lt;Product&gt; getProducts() {</div><div class="FixedLine">        return products;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    public void setProducts(List&lt;Product&gt; products) {</div><div class="FixedLine">        this.products = products;</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-3</span><p class="SimplePara">The Container Class to Return Collection of Product Entities (ch04\ch04-01\02-ProductWeb\src\main\java\com\acme\ecom\product\model\Products.java)</p></div></div></div></div>

          <p class="Para" id="Par53"><span class="EmphasisFontCategoryNonProportional ">Products</span> is just a container wrapper that holds a collection of <span class="EmphasisFontCategoryNonProportional ">Product</span> instances.</p>

          <div class="Para" id="Par54">The Product Web microservices <span id="ITerm20">configuration</span> is shown in Listing <span class="InternalRef"><a href="#PC4">4-4</a></span>, where the <span class="EmphasisFontCategoryNonProportional ">requestreply-topic</span> refers to the topic to which the provider is supposed to send the response.<div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine">server.port=8080</div><div class="FixedLine">spring.kafka.bootstrap-servers: localhost:9092</div><div class="FixedLine">spring.kafka.consumer.auto-offset-reset: earliest</div><div class="FixedLine">spring.kafka.consumer.group-id: product-web</div><div class="FixedLine">kafka.topic.requestreply-topic: product-req-reply-topic</div><div class="FixedLine">kafka.topic.request-topic=product-req-topic</div><div class="FixedLine">kafka.request-reply.timeout-ms: 20000</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-4</span><p class="SimplePara">The Product Web Microservices Configuration (ch04\ch04-01\02-ProductWeb\src\main\resources\application.properties)</p></div></div></div></div>

          <div class="Para" id="Par55">On the Product Server microservice side, a regular <span class="EmphasisFontCategoryNonProportional ">KafkaListener</span> is listening on the request topic. See Listing <span class="InternalRef"><a href="#PC5">4-5</a></span>.<div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">@Component</div><div class="FixedLine">public class ProductListener {</div></div><div class="LineGroup"><div class="FixedLine">    @KafkaListener(topics = "${kafka.topic.request-topic}")</div><div class="FixedLine">    @SendTo</div><div class="FixedLine">    public Products listen(String request) {</div></div><div class="LineGroup"><div class="FixedLine">        List&lt;Product&gt; productList = getAllTheProducts();</div><div class="FixedLine">        Products products = new Products();</div><div class="FixedLine">        products.setProducts(productList);</div><div class="FixedLine">        return products;</div><div class="FixedLine">    }</div><div class="FixedLine">}<span id="ITerm21"></span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-5</span><p class="SimplePara">The Product Web Microservices Configuration (ch04\ch04-01\01-ProductServer\src\main\java\com\acme\ecom\product\kafka\client\ProductListener.java)</p></div></div></div></div>

          <div class="Para" id="Par56">This listener is decorated with an additional <span class="EmphasisFontCategoryNonProportional ">@SendTo</span> annotation, to provide the reply message. The <span class="EmphasisFontCategoryNonProportional ">Product</span> instances retrieved by the <span class="EmphasisFontCategoryNonProportional ">getAllTheProducts()</span> method and returned by the <span class="EmphasisFontCategoryNonProportional ">listener</span> method is automatically wrapped into a reply message. The <span class="EmphasisFontCategoryNonProportional ">CORRELATION_ID</span> is added, and the reply is posted on the topic specified by the <span class="EmphasisFontCategoryNonProportional ">REPLY_TOPIC</span>. The <span class="EmphasisFontCategoryNonProportional ">@KafkaListener</span> is used to subscribe to the request Kafka topic. Using the annotation, the <span class="EmphasisFontCategoryNonProportional ">@SendTo</span> annotation enables the <span class="EmphasisFontCategoryNonProportional ">listener</span> method to send a response to another reply topic. Figure <span class="InternalRef"><a href="#Fig7">4-7</a></span> illustrates the dynamics of these interactions and is marked with labels in the order of event flow.<figure class="Figure" id="Fig7"><div class="MediaObject" id="MO7"><img alt="" aria-describedby="d64e1098" src="../images/619782_1_En_4_Chapter/Imagem-039.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1098"><p class="Para" id="Par108">A flow diagram of the Kafka template reply. It consists of 2 blocks of product web and server microservices. The replying Kafka template consists of a Kafka producer and reply container.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 4-7</span><p class="SimplePara">Replying Kafka <span id="ITerm22">template</span></p></div></figcaption></figure></div>

          <p class="Para" id="Par57">You have a <span class="EmphasisFontCategoryNonProportional ">KafkaConfig</span> for the provider microservice too, but it’s simple and straightforward compared to the consumer microservice, so it’s not listed here.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec11">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par58">The <span class="EmphasisFontCategoryNonProportional ">ch04\ch04-01</span> folder contains the Maven scripts required to build these examples. As a first step, you need to bring up the Kafka broker. Refer to Appendix D to learn to set up the Kafka server and bring it up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC6">4-6</a></span> to bring up Kafka from the Kafka installation location.<div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">bin/zookeeper-server-start.sh config/zookeeper.properties</div><div class="FixedLine">bin/kafka-server-start.sh config/server.properties</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-6</span><p class="SimplePara">Commands to Bring Up Kafka Broker</p></div></div></div></div>

          <div class="Para" id="Par59">Next, take two command terminals and change the directory to the top-level folder of both microservices. Then, build and run the Product Server microservice using the <span class="EmphasisFontCategoryNonProportional ">make.sh</span> and <span class="EmphasisFontCategoryNonProportional ">run.sh</span> scripts, as shown in Listing <span class="InternalRef"><a href="#PC7">4-7</a></span>.<div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch04/ch04-01/01-ProductServer</div><div class="FixedLine">(base) binildass-MacBook-Pro:01-ProductServer binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$</div></div><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run.sh</div></div><div class="LineGroup"><div class="FixedLine">  .   ____          _            __ _ _</div><div class="FixedLine"> /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="FixedLine">( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \</div><div class="FixedLine"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="FixedLine">  '  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="FixedLine"> =========|_|==============|___/=/_/_/_/</div><div class="FixedLine"> :: Spring Boot ::                (v3.2.0)</div></div><div class="LineGroup"><div class="FixedLine">2024-01-23 11:43:59 INFO  Startup.log:50 - Starting EcomProd</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-23 11:44:00 INFO  InitComponent.init:43 - Start</div><div class="FixedLine">2024-01-23 11:44:00 INFO  InitComponent.init:44 - Doing Nothing...</div><div class="FixedLine">2024-01-23 11:44:00 INFO  InitComponent.init:66 - End</div><div class="FixedLine">2024-01-23 11:44:01 INFO  Startup.log:56 - Started EcomProd</div><div class="FixedLine">2024-01-23 11:56:03 DEBUG ProductListener.listenWithHeaders:58 - Received request : All</div><div class="FixedLine">...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-7</span><p class="SimplePara">Commands to Build and <span id="ITerm23">Run</span> the Product Server Microservice</p></div></div></div></div>

          <div class="Para" id="Par60">Next, build and run the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC8">4-8</a></span>.<div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch04/ch04-01/02-ProductWeb</div><div class="FixedLine">(base) binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$</div></div><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh run.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-23 11:54:08 INFO  StartupInfoLogger.logStarting:50 - Starting EcomProductWebMicro...</div><div class="FixedLine">...</div><div class="FixedLine">2024-01-23 11:54:10 INFO  StartupInfoLogger.logStarted:56 - Started EcomProductWebMicro...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-8</span><p class="SimplePara">Commands to Build and Run the Product Web Microservice</p></div></div></div></div>

          <p class="Para" id="Par61">Now that both microservices are up and running, you can test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec12">

          <h3 class="Heading">Testing the Microservice</h3>

          <p class="Para" id="Par62"><span id="ITerm24">When</span> all is set, you can access the web application using your browser (see Figure <span class="InternalRef"><a href="#Fig8">4-8</a></span>). Point to this URL:</p>

          <div class="Para" id="Par63"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/product.html</span><figure class="Figure" id="Fig8"><div class="MediaObject" id="MO8"><img alt="" aria-describedby="d64e1270" src="../images/619782_1_En_4_Chapter/Imagem-040.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1270"><p class="Para" id="Par109">A screenshot of a tab in Chrome with a Bootstrap data table. The table lists the product names, codes, titles and prices.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 4-8</span><p class="SimplePara">Testing the microservices</p></div></figcaption></figure></div>

          <p class="Para" id="Par64">When you fire the URL in the browser, the request hits the REST controller of the Product Web microservice. From then onwards, the flow is as shown in Figure <span class="InternalRef"><a href="#Fig7">4-7</a></span>.</p>

          <div class="Para" id="Par65">For the completeness of this example, you may also want to list and see the request and the response queues created in the broker, as shown in Listing <span class="InternalRef"><a href="#PC9">4-9</a></span>.<div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:kafka_2.13-2.5.0 binil$ sh ./bin/kafka-topics.sh --zookeeper localhost:2181 --list</div><div class="FixedLine">__consumer_offsets</div><div class="FixedLine">product-req-reply-topic</div><div class="FixedLine">product-req-topic</div><div class="FixedLine">binildass-MacBook-Pro:kafka_2.13-2.5.0 binil$</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-9</span><p class="SimplePara">List the Queues Created in Kafka Broker</p></div></div></div></div>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec13">

        <h2 class="Heading">SEDA and Microservices</h2>

        <p class="Para" id="Par66">Having discussed and executed the examples on how you can perform inter-microservice communications over an async messaging backbone, it’s now time to understand the bigger picture of what you are targeting. The <span id="ITerm25">SEDA</span> (Staged Event Driven <span id="ITerm26">Architecture</span>) concept is used for allowing services to be well-conditioned to be loaded, preventing resources from being overcommitted when demand exceeds service capacity. You will investigate that next and corelate the concept to your enterprise microservices using messaging infrastructure.</p>

        <section class="Section2 RenderAsSection2" id="Sec14">

          <h3 class="Heading">SEDA Architecture</h3>

          <div class="Para" id="Par67">In SEDA, applications consist of a network of event-driven stages connected by explicit queues. This architecture allows services to be well-conditioned to load, preventing resources from being overcommitted when demand exceeds service capacity. SEDA uses a set of dynamic resource controllers to keep stages within their operating regime, despite large fluctuations in load. This is explained in the paper titled “SEDA: An Architecture for Well-Conditioned, Scalable Internet Services” by Matt Welsh, David Culler, and Eric Brewer. The <span id="ITerm27">architecture</span> is shown in Figure <span class="InternalRef"><a href="#Fig9">4-9</a></span>, adapted from this paper.<figure class="Figure" id="Fig9"><div class="MediaObject" id="MO9"><img alt="" aria-describedby="d64e1344" src="../images/619782_1_En_4_Chapter/Imagem-041.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1344"><p class="Para" id="Par110">A diagram of the event queue and handlers for outgoing events. The event handlers consist of thread pools and are connected to controllers.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 4-9</span><p class="SimplePara">A SEDA stage</p></div></figcaption></figure></div>

          <p class="Para" id="Par68">A stage consists of an incoming event queue, a thread pool, and an application-supplied event handler. The stage’s operation is managed by the controller, which adjusts resource allocations and scheduling dynamically. Many such stages can be chained together to create a loosely coupled, end-to-end application continuum.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec15">

          <h3 class="Heading">Microservices Architecture as a Network of Stages</h3>

          <p class="Para" id="Par69">A microservices-based architecture can be designed as a network of <span id="ITerm28">stages</span>, interconnected by event queues. Each microservice can be envisioned as a stage. These event queues are finite; that is, an enqueue operation may fail if the queue wants to reject new entries, say, because it reached a threshold. Caller microservices can use backpressure (by blocking on a full queue) or load shedding (by dropping events) when enqueue operations fail. Alternately, the microservices can take some service-specific action, such as sending an error to the user, or performing an alternate function, such as invoking a Hystrix callback, and so on.</p>

          <div class="Para" id="Par70">What if you attempt to represent inter-microservice interaction using a SEDA style? See Figure <span class="InternalRef"><a href="#Fig10">4-10</a></span>.<figure class="Figure" id="Fig10"><div class="MediaObject" id="MO10"><img alt="" aria-describedby="d64e1375" src="../images/619782_1_En_4_Chapter/Imagem-042.jpg" style="width:35.15em"/><div class="TextObject" id="d64e1375"><p class="Para" id="Par111">A diagram of async microservices with 2 blocks of requester and responsive microservices. A user sends a command to the microservice and gets a response.</p></div></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 4-10</span><p class="SimplePara">Async based microservices architecture as a network of stages</p></div></figcaption></figure></div>

          <p class="Para" id="Par71">Introducing <span id="ITerm29">queues</span> between two microservices in this manner will provide isolation, modularity, and independent load management, but may increase latency. Further, if the provider microservice is not up and running, the promise the consumer microservice can provide to the end user may have to be fulfilled later (or eventually), which will lead to a different user experience from that of the traditional means of executing use cases.</p>

          <p class="Para" id="Par72">Note the blocking manner by which the Product Web microservice has been executing its request it received from the browser. Typical containers in <span id="ITerm30">application servers</span> like in Apache Tomcat normally use a server thread per client request. Under increased load conditions, this necessitates that containers have many threads to serve all the client requests. This limits scalability, which can arise due to running out of memory or exhausting the pool of container threads. Java EE has added asynchronous processing support for servlets and filters from the Servlet 3.0 spec onwards.</p>

          <p class="Para" id="Par73">The next section shows you how you can leverage this to isolate resources from undue blocking with the help of an example.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec16">

        <h2 class="Heading">Async HTTP on Sync over Async Microservices</h2>

        <p class="Para" id="Par74">In this example, you will tweak the same previous set of microservices used in this chapter. A consumer and a provider microservice will communicate with each other using a messaging channel. The provider microservice stores the entity in an in-memory database, to keep the example simple. Moreover, when the browser sends a request to the first (consumer) microservice, the example will use <span id="ITerm31">async HTTP</span><span id="ITerm32"></span> instead of sync HTTP.</p>

        <section class="Section2 RenderAsSection2" id="Sec17">

          <h3 class="Heading">Understanding the Code</h3>

          <div class="Para" id="Par75">The <span id="ITerm33">source code</span> for this book is available on GitHub via the book’s product page, located at <span class="ExternalRef"><a href="http://www.apress.com/9798868805547"><span class="RefSource"><span class="EmphasisFontCategoryNonProportional ">www.apress.com/9798868805547</span></span></a></span>. The source code for this example is organized inside the <span class="EmphasisFontCategoryNonProportional ">ch04\ch04-02</span> folder. Listing <span class="InternalRef"><a href="#PC10">4-10</a></span> looks at the changes in the consumer microservice—that is, the Product Web microservice—first.<div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">public class ProductRestController{</div></div><div class="LineGroup"><div class="FixedLine">    @RequestMapping(value = "/productsweb", method = RequestMethod.GET,</div><div class="FixedLine">        produces = {MediaType.APPLICATION_JSON_VALUE})</div><div class="FixedLine">    public DeferredResult&lt;Products&gt;  getAllProducts()</div><div class="FixedLine">            throws InterruptedException, ExecutionException {</div></div><div class="LineGroup"><div class="FixedLine">        LOGGER.info("Start");</div><div class="FixedLine">        LOGGER.debug("Thread : " + Thread.currentThread());</div><div class="FixedLine">        DeferredResult&lt;Products&gt; deferredResult =</div><div class="FixedLine">            new DeferredResult&lt;&gt;();</div><div class="FixedLine">        ProducerRecord&lt;String, String&gt; record =</div><div class="FixedLine">            new ProducerRecord&lt;String, String&gt;(</div><div class="FixedLine">                requestTopic, "All");</div><div class="FixedLine">        record.headers().add(new RecordHeader(</div><div class="FixedLine">            KafkaHeaders.REPLY_TOPIC,</div><div class="FixedLine">            requestReplyTopic.getBytes()));</div><div class="FixedLine">        record.headers().forEach(header -&gt;</div><div class="FixedLine">            LOGGER.debug(header.key() + ":" +</div><div class="FixedLine">            header.value().toString()));</div><div class="FixedLine">        RequestReplyFuture&lt;String, String, Products&gt;</div><div class="FixedLine">            sendAndReceive =</div><div class="FixedLine">            replyingKafkaTemplate.sendAndReceive(record);</div><div class="FixedLine">        SendResult&lt;String, String&gt; sendResult =</div><div class="FixedLine">            sendAndReceive.getSendFuture().get();</div><div class="FixedLine">        LOGGER.debug("Request success -&gt; " + sendResult);</div><div class="FixedLine">        sendResult.getProducerRecord().headers().forEach(</div><div class="FixedLine">            header -&gt; LOGGER.debug(header.key() + " : " +</div><div class="FixedLine">                new String(header.value())));</div></div><div class="LineGroup"><div class="FixedLine">        sendAndReceive.addCallback(</div><div class="FixedLine">            new ListenableFutureCallback&lt;</div><div class="FixedLine">                ConsumerRecord&lt;String, Products&gt;&gt;() {</div></div><div class="LineGroup"><div class="FixedLine">                @Override</div><div class="FixedLine">                public void onFailure(Throwable ex) {</div><div class="FixedLine">                    LOGGER.debug(Thread.currentThread().</div><div class="FixedLine">                        toString());</div><div class="FixedLine">                    LOGGER.error(ex.getMessage());</div><div class="FixedLine">                }</div><div class="FixedLine">                @Override</div><div class="FixedLine">                public void onSuccess(ConsumerRecord&lt;</div><div class="FixedLine">                    String, Products&gt; consumerRecord) {</div></div><div class="LineGroup"><div class="FixedLine">                    long secondsToSleep = 2;</div><div class="FixedLine">                    LOGGER.debug("Starting to Sleep Seconds :</div><div class="FixedLine">                        " + secondsToSleep);</div><div class="FixedLine">                    try{</div><div class="FixedLine">                        Thread.sleep(1000 * secondsToSleep);</div><div class="FixedLine">                    }</div><div class="FixedLine">                    catch(Exception e) {</div><div class="FixedLine">                        //Logger.error("Error : " + e);</div><div class="FixedLine">                    }</div><div class="FixedLine">                    LOGGER.debug("Awakening from Sleep...");</div><div class="FixedLine">                    LOGGER.debug(Thread.currentThread().</div><div class="FixedLine">                        toString());</div><div class="FixedLine">                    deferredResult.setResult(</div><div class="FixedLine">                        consumerRecord.value());</div><div class="FixedLine">                }</div><div class="FixedLine">            }</div><div class="FixedLine">        );</div><div class="FixedLine">        LOGGER.debug("Thread : " + Thread.currentThread());</div><div class="FixedLine">        LOGGER.info("Ending...");</div><div class="FixedLine">        return deferredResult;</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-10</span><p class="SimplePara">Product Web Microservice REST Controller (ch04\ch04-02\02-ProductWeb\src\main\java\com\acme\ecom\product\controller\ProductRestController.java)</p></div></div></div></div>

          <p class="Para" id="Par76">As you can see, the <span class="EmphasisFontCategoryNonProportional ">getAllProducts</span> method in the REST controller is asynchronous. This means that the HTTP main thread that initiated to serve the <span class="EmphasisFontCategoryNonProportional ">getAllProducts</span> needn’t be blocked until the method is completed. There is also a sleep of two seconds so that you can visualize these methods in the command terminal.</p>

          <div class="Para" id="Par77">A six-second sleep is also included in the Product Server microservice, as shown in Listing <span class="InternalRef"><a href="#PC11">4-11</a></span>.<div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">public class ProductListener {</div></div><div class="LineGroup"><div class="FixedLine">    @KafkaListener(topics = "${kafka.topic.request-topic}")</div><div class="FixedLine">    @SendTo</div><div class="FixedLine">    public Products listenConsumerRecord(ConsumerRecord&lt;</div><div class="FixedLine">            String, String&gt; record){</div></div><div class="LineGroup"><div class="FixedLine">        long secondsToSleep = 6;</div></div><div class="LineGroup"><div class="FixedLine">        LOGGER.info("Start");</div></div><div class="LineGroup"><div class="FixedLine">        //print all headers</div><div class="FixedLine">        record.headers().forEach(header -&gt;</div><div class="FixedLine">            LOGGER.debug(header.key() + ":" +</div><div class="FixedLine">                new String(header.value())));</div></div><div class="LineGroup"><div class="FixedLine">        String brand = record.key();</div><div class="FixedLine">        String request = record.value();</div><div class="FixedLine">        LOGGER.debug("Listen; brand : " + brand);</div><div class="FixedLine">        LOGGER.debug("Listen; request : " + request);</div><div class="FixedLine">        List&lt;Product&gt; productList = getAllTheProducts();</div><div class="FixedLine">        Products products = new Products();</div><div class="FixedLine">        products.setProducts(productList);</div></div><div class="LineGroup"><div class="FixedLine">        LOGGER.debug("Starting to Sleep Seconds : " +</div><div class="FixedLine">            secondsToSleep);</div><div class="FixedLine">        try{</div><div class="FixedLine">            Thread.sleep(1000 * secondsToSleep);</div><div class="FixedLine">        }</div><div class="FixedLine">        catch(Exception e) {</div><div class="FixedLine">            LOGGER.error("Error : " + e);</div><div class="FixedLine">        }</div><div class="FixedLine">        LOGGER.debug("Awakening from Sleep...");</div><div class="FixedLine">        LOGGER.info("Ending...");</div></div><div class="LineGroup"><div class="FixedLine">        return products;</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-11</span><p class="SimplePara">Product Server Microservice Message Listener ch04\ch04-02\01-ProductServer\src\main\java\com\acme\ecom\product\kafka\client\ProductListener.java)</p></div></div></div></div>

          <p class="Para" id="Par78">This sleep delay of six seconds enables the caller (Product Web) microservice to feel the delay. Hence the HTTP main thread “<span class="EmphasisFontCategoryNonProportional ">Thread[http-nio-8080-exec-5,5,main]</span>” in the Product Web microservice that initiated to serve the <span class="EmphasisFontCategoryNonProportional ">getAllProducts</span> from the caller microservice is taken away from the service for this request. Another thread “<span class="EmphasisFontCategoryNonProportional ">Thread[ForkJoinPool.commonPool-worker-1,5,main]</span>” completes the request later, as explained in the next section and shown in Listing <span class="InternalRef"><a href="#PC14">4-14</a></span>.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec18">

          <h3 class="Heading">Build and Run the Microservice</h3>

          <div class="Para" id="Par79">The <span class="EmphasisFontCategoryNonProportional ">ch04\ch04-02</span> folder contains the Maven scripts required to build the examples. As a first step, you need to bring up the Kafka broker. Refer to Appendix D to learn how to set up the Kafka server and bring it up. You need to execute the commands in Listing <span class="InternalRef"><a href="#PC12">4-12</a></span> to bring up Kafka from the Kafka installation location.<div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">bin/zookeeper-server-start.sh config/zookeeper.properties</div><div class="FixedLine">bin/kafka-server-start.sh config/server.properties</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-12</span><p class="SimplePara">Commands to Bring Up Kafka Broker</p></div></div></div></div>

          <div class="Para" id="Par80">Next, take two command terminals and change the directory to the top-level folder of both microservices. Then, build and <span id="ITerm34">run</span> the Product Server microservice using the <span class="EmphasisFontCategoryNonProportional ">make.sh</span> and <span class="EmphasisFontCategoryNonProportional ">run.sh</span> scripts, as shown in Listing <span class="InternalRef"><a href="#PC13">4-13</a></span>.<div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch04/ch04-02/01-ProductServer</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$</div><div class="FixedLine">binildass-MacBook-Pro:01-ProductServer binil$ sh run.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-20 <strong class="EmphasisTypeBold ">19:14:19</strong> INFO  ProductListener.listenConsumerRecord:50 - Start</div><div class="FixedLine">2024-02-20 19:14:19 DEBUG ProductListener.lambda$listenConsumerRecord$0:53 - kafka_replyTopic:product-req-reply-topic</div><div class="FixedLine">2024-02-20 19:14:19 DEBUG ProductListener.lambda$listenConsumerRecord$0:53 - kafka_correlationId:<span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e1758" src="../images/619782_1_En_4_Chapter/Imagem-043.gif" style="width:0.94em"/><span class="TextObject" id="d64e1758"><span class="Para" id="Par112">An illustration of a polygon with a question mark inside.</span></span></span>upI&lt;JN<span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e1765" src="../images/619782_1_En_4_Chapter/Imagem-044.gif" style="width:0.94em"/><span class="TextObject" id="d64e1765"><span class="Para" id="Par113">An illustration of a polygon with a question mark inside.</span></span></span>rI54<span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e1772" src="../images/619782_1_En_4_Chapter/Imagem-045.gif" style="width:0.94em"/><span class="TextObject" id="d64e1772"><span class="Para" id="Par114">An illustration of a polygon with a question mark inside.</span></span></span>($</div><div class="FixedLine">2024-02-20 19:14:19 DEBUG ProductListener.listenConsumerRecord:57 - Listen; brand : null</div><div class="FixedLine">2024-02-20 19:14:19 DEBUG ProductListener.listenConsumerRecord:58 - Listen; request : All</div><div class="FixedLine">2024-02-20 19:14:19 DEBUG ProductListener.listenConsumerRecord:63 - Starting to Sleep Seconds : 6</div><div class="FixedLine">2024-02-20 <strong class="EmphasisTypeBold ">19:14:25</strong> DEBUG ProductListener.listenConsumerRecord:70 - Awakening from Sleep...</div><div class="FixedLine">2024-02-20 19:14:25 INFO  ProductListener.listenConsumerRecord:71 - Ending...</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-13</span><p class="SimplePara">Commands to Build and Run the Product Server Microservice</p></div></div></div></div>

          <div class="Para" id="Par81">Next, build and run the Product Web microservice, as shown in Listing <span class="InternalRef"><a href="#PC14">4-14</a></span>.<div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ pwd</div><div class="FixedLine">/Users/binil/binil/code/mac/mybooks/docker-04/Code/ch04/ch04-02/02-ProductWeb</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh make.sh</div><div class="FixedLine">[INFO] Scanning for projects...</div><div class="FixedLine">[INFO]</div><div class="FixedLine">...</div><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$</div></div><div class="LineGroup"><div class="FixedLine">binildass-MacBook-Pro:02-ProductWeb binil$ sh run.sh</div><div class="FixedLine">...</div><div class="FixedLine">2024-02-20 19:14:19 INFO  ProductRestController.getAllProducts:70 - Start</div><div class="FixedLine">2024-02-20 19:14:19 DEBUG ProductRestController.lambda$getAllProducts$0:74 - kafka_replyTopic:[B@47139a13</div><div class="FixedLine">2024-02-20 <strong class="EmphasisTypeBold ">19:14:19</strong> DEBUG ProductRestController.getAllProducts:76 - Thread : Thread[<strong class="EmphasisTypeBold ">http-nio-8080-exec-5</strong>,5,main]</div><div class="FixedLine">2024-02-20 <strong class="EmphasisTypeBold ">19:14:19</strong> DEBUG ProductRestController.getAllProducts:78 - Request success -&gt; SendResult [producerRecord=ProducerRecord(topic=product-req-topic, partition=null, headers=RecordHeaders(headers = [RecordHeader(key = kafka_replyTopic, value = [112, 114, ...</div><div class="FixedLine">2024-02-20 19:14:19 DEBUG ProductRestController.lambda$getAllProducts$1:79 - kafka_replyTopic : product-req-reply-topic</div><div class="FixedLine">2024-02-20 19:14:19 DEBUG ProductRestController.lambda$getAllProducts$1:79 - kafka_correlationId : <span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e1845" src="../images/619782_1_En_4_Chapter/Imagem-046.gif" style="width:0.94em"/><span class="TextObject" id="d64e1845"><span class="Para" id="Par115">An illustration of a polygon with a question mark inside.</span></span></span>upI&lt;JN<span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e1852" src="../images/619782_1_En_4_Chapter/Imagem-047.gif" style="width:0.94em"/><span class="TextObject" id="d64e1852"><span class="Para" id="Par116">An illustration of a polygon with a question mark inside.</span></span></span>rI54<span class="GlossaryTerm" epub:type="glossterm" role="term"><img alt="" aria-describedby="d64e1859" src="../images/619782_1_En_4_Chapter/Imagem-048.gif" style="width:0.94em"/><span class="TextObject" id="d64e1859"><span class="Para" id="Par117">An illustration of a polygon with a question mark inside.</span></span></span>($</div><div class="FixedLine">2024-02-20 19:14:19 DEBUG ProductRestController.lambda$getAllProducts$1:79 - __TypeId__ : java.lang.String</div><div class="FixedLine">2024-02-20 <strong class="EmphasisTypeBold ">19:14:19</strong> DEBUG ProductRestController.getAllProducts:80 - Thread : Thread[<strong class="EmphasisTypeBold ">http-nio-8080-exec-5</strong>,5,main]</div><div class="FixedLine">2024-02-20 19:14:19 DEBUG ProductRestController.lambda$getAllProducts$2:86 - Thread[ForkJoinPool.commonPool-worker-1,5,main]</div><div class="FixedLine">2024-02-20 <strong class="EmphasisTypeBold ">19:14:19</strong> DEBUG ProductRestController.getAllProducts:142 - Thread : Thread[<strong class="EmphasisTypeBold ">http-nio-8080-exec-5</strong>,5,main]</div><div class="FixedLine">2024-02-20 <strong class="EmphasisTypeBold ">19:14:19</strong> INFO  ProductRestController.getAllProducts:143 - Ending...</div><div class="FixedLine">2024-02-20 <strong class="EmphasisTypeBold ">19:14:25</strong> DEBUG ProductRestController.lambda$getAllProducts$2:88 - Thread[<strong class="EmphasisTypeBold ">ForkJoinPool.commonPool-worker-1</strong>,5,main]</div><div class="FixedLine">2024-02-20 19:14:25 DEBUG ProductRestController.lambda$getAllProducts$3:98 - Starting to Sleep Seconds: 2</div><div class="FixedLine">2024-02-20 19:14:27 DEBUG ProductRestController.lambda$getAllProducts$3:105 - Awakening from Sleep...</div><div class="FixedLine">2024-02-20 <strong class="EmphasisTypeBold ">19:14:27</strong> DEBUG ProductRestController.lambda$getAllProducts$3:106 - Thread[<strong class="EmphasisTypeBold ">ForkJoinPool.commonPool-worker-2</strong>,5,main]</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-14</span><p class="SimplePara">Commands to Build and Run the Product Web Microservice</p></div></div></div></div>

          <p class="Para" id="Par82">Now that both microservices are up and running, you can test the microservices.</p>

        </section>

        <section class="Section2 RenderAsSection2" id="Sec19">

          <h3 class="Heading">Testing the Microservice</h3>

          <p class="Para" id="Par83"><span id="ITerm35">When</span> all is set, you can access the web application using your browser and pointing to this URL:</p>

          <p class="Para ParaOneEmphasisChild" id="Par84"><span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/product.html</span></p>

          <p class="Para" id="Par85">You may have to wait a bit, because the browser will be rendered with the data <em class="EmphasisTypeItalic ">eventually</em>, due to the sleep delays you provisioned in both microservices.</p>

          <div class="Para" id="Par86">After executing the test, carefully observe the multiple threads being logged in the Product Web microservice command terminal in Listing <span class="InternalRef"><a href="#PC14">4-14</a></span>. You need to correlate those logs with the logs in the Product Web microservice command terminal in Listing <span class="InternalRef"><a href="#PC13">4-13</a></span>. This correlation is depicted in Table <span class="InternalRef"><a href="#Tab1">4-1</a></span>. <div class="Table" id="Tab1"><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Table 4-1</span><p class="SimplePara">Event Log for the Async HTTP on Sync Over Async Example</p></div></div><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col class="tcol1 align-left"/><col class="tcol2 align-left"/><col class="tcol3 align-left"/><col class="tcol4 align-left"/><col class="tcol5 align-left"/><col class="tcol6 align-left"/></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Sl. No.</p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Timestamp</p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Microservice</p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">LOC<sup><a epub:type="noteref" href="#Fn2" id="Fn2_source" role="doc-noteref">2</a></sup></p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Thread</p></th><th style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Event</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">19:14:19</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">76</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><span class="EmphasisFontCategoryNonProportional ">http-nio-8080-exec-5</span></p></td><td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Before Invoke Product Web</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">19:14:19</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Server</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">50</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">-</p></td><td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Server Invoked</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">3</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">19:14:19</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Server</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">63</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">-</p></td><td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Server Start 6s sleep</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">4</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">19:14:19</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">80</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><span class="EmphasisFontCategoryNonProportional ">http-nio-8080-exec-5</span></p></td><td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Proceeds after Invocation</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">5</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">19:14:19</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">86</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><span class="EmphasisFontCategoryNonProportional ">ForkJoinPool.commonPool-worker-1</span></p></td><td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><span class="EmphasisTypeStrikethrough ">New</span> Pooled Thread Spun</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">6</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">19:14:19</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">143</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><span class="EmphasisFontCategoryNonProportional ">http-nio-8080-exec-5</span></p></td><td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Exiting</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">7</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">19:14:25</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Server</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">70</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><span class="EmphasisFontCategoryNonProportional ">-</span></p></td><td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Server finishes sleep, returns</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">8</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">19:14:25</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">88</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><span class="EmphasisFontCategoryNonProportional ">ForkJoinPool.commonPool-worker-1</span></p></td><td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Received response from Product Server</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">9</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">19:14:25</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Web</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">98</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara"><span class="EmphasisFontCategoryNonProportional ">ForkJoinPool.commonPool-worker-1</span></p></td><td style="border-bottom: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Web Start 2s sleep</p></td></tr><tr><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">10</p></td><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">19:14:27</p></td><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">Product Web</p></td><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara">106</p></td><td style="border-right: 0.5pt solid ; text-align: left;"><p class="SimplePara"><span class="EmphasisFontCategoryNonProportional ">ForkJoinPool.commonPool-worker-1</span></p></td><td style="text-align: left;"><p class="SimplePara">Product Server finishes sleep, Exits</p></td></tr></tbody></table></div></div>

          <div class="Para" id="Par88">A few aspects of interest are listed here:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div class="Para" id="Par89">As the first step (Sl. No. 1), the worker thread in the Product Web microservice (<span class="EmphasisFontCategoryNonProportional ">http-nio-8080-exec-5</span>) invokes the Product Server microservice.<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par90">Since this invocation is asynchronous (<span class="EmphasisFontCategoryNonProportional ">sendAndReceive.getSendFuture()</span> is async), the worker thread will not wait for a response from the Product Server microservice.</p></li><li><p class="Para" id="Par91">In Steps 4 and 6, the worker thread in the Product Web microservice exits.</p></li></ul></div></div></li><li><div class="Para" id="Par92">As a result of invocation in Step 1, the Product Server microservice gets the hit more or less at the same time as shown in Step 2.<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par93">The Product Server microservice then goes to sleep for six seconds.</p></li><li><p class="Para" id="Par94">While the Product Server microservice sleeps, the invoker worker thread in the Product Web microservice doesn’t wait. Instead, it exits in Steps 4 and 6.</p></li></ul></div></div></li><li><p class="Para" id="Par95">In parallel, as shown in Step 5, the <span class="EmphasisFontCategoryNonProportional ">sendAndReceive.get()</span> method for the response is blocked, but this is in a newly pooled thread.</p></li><li><p class="Para" id="Par96">After the six seconds of sleep, the Product Server microservice completes its sleep in Step 7. The newly pooled thread of the Product Web microservice receives the response in Step 8.</p></li><li><p class="Para" id="Par97">In Step 9, this pooled thread of Product Web microservice starts two seconds of sleep. The rest of the steps are not that important, so you can ignore them.</p></li></ul></div></div>

          <p class="Para" id="Par98">You have not only seen sync style over async channel, but also learned how to release the main worker thread and leverage a pooled thread to continue the processing when the response is available in the message channel.</p>

          <p class="Para" id="Par99">You also learned about another aspect. You might have observed with patience that the browser rendered the data only eventually, after a few seconds of delay, due to the sleep delays you provisioned in both microservices. The interesting fact is the HTTP worker thread that was serving the socket connection from the browser also doesn’t wait. Instead, when the response from the Product Web microservice is available in the HTTP channel, a pooled thread from the HTTP server is attached in order to stream this response back to the browser. This is done under the hood by <span class="EmphasisFontCategoryNonProportional ">DeferredResult</span>.</p>

        </section>

      </section>

      <section class="Section1 RenderAsSection1" id="Sec20">

        <h2 class="Heading">Summary</h2>

        <p class="Para" id="Par100">The objective of this chapter was to introduce events and inter-microservice communication through message channels. You learned how to do this effectively. By using the return address pattern, you can weave the correlated request and response interactions together to provide synchronous user experiences over the asynchronous channels. You also learned about effective programming practices, which enable you to avoid tying up resources unless otherwise absolutely required.</p>

        <p class="Para" id="Par101">By leveraging the Servlet 3 spec of utilizing Async processing at the HTTP level, you also attempted to better manage the HTTP worker threads from a dedicated pool, which can become exhausted otherwise. Incrementing the HTTP thread pool size to a number larger than the optimum will also lead to system resources exhaustion, acting against scalability. An asynchronous servlet enables your application to process incoming requests in an asynchronous manner. A given HTTP worker thread handles an incoming request, and instead of processing the actual workload, it passes the request to another background—a pooled thread—which in turn is responsible for processing the workload and sending the response back to the client. The initial HTTP worker thread can return to the HTTP thread pool as soon as it passes the workload to the background thread, so it becomes available to process more requests from the socket. All of these concepts were demonstrated in the code, but you are not equipped enough yet. What will happen when concurrent requests arrive at the same topic to be consumed by multiple instances of the same type of microservice? The next chapter opens Pandora’s box.</p>

      </section>

      <aside aria-label="Footnotes" class="FootnoteSection" epub:type="footnotes">

        <div class="Heading">Footnotes</div>

        <div class="Footnote"><span class="FootnoteNumber"><a href="#Fn1_source">1</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn1" role="doc-footnote"><p class="Para" id="Par44">A Kafka consumer group is a set of consumers that cooperate to consume data from some topics. The partitions of all the topics are divided among the consumers in the group.</p></div><div class="ClearBoth"> </div></div>

        <div class="Footnote"><span class="FootnoteNumber"><a href="#Fn2_source">2</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn2" role="doc-footnote"><p class="Para" id="Par87">LOC means Line (Number) of Code.</p></div><div class="ClearBoth"> </div></div>

      </aside>

    </div>

  </div>

</body>

</html>